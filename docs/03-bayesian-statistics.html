<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>3&nbsp; Bayesian Statistics – Statistical Inference</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./04-one-sample.html" rel="next">
<link href="./02-likelihood-statistics.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="site_libs/tabwid-1.1.3/tabwid.css" rel="stylesheet">

<script src="site_libs/tabwid-1.1.3/tabwid.js"></script>


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01-frequentist-statistics.html">Statistics</a></li><li class="breadcrumb-item"><a href="./03-bayesian-statistics.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Bayesian Statistics</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Statistical Inference</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Statistics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-frequentist-statistics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Frequentist Statistics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-likelihood-statistics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Likelihood Statistics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-bayesian-statistics.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Bayesian Statistics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Point Estimates</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-one-sample.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">One-Sample</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./pt1-group-differences.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Group Differences</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-continuous-binomial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Continuous ~ Binomial</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-continuous-binomial-pairwise.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Paired Samples t-Test</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-continuous-multinomial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Continuous ~ Multnomial</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-binomial-binomial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Binomial ~ Binomial</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-multinomial-multinomial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Multinomial ~ Multinomial</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-binomial-multinomial-pairwise.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Pairwise Discrete ~ Multinomial</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Association</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-association.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Association</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Reference</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-matrix-algebra.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Matrix Algebra</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#bayes-theorem" id="toc-bayes-theorem" class="nav-link active" data-scroll-target="#bayes-theorem"><span class="header-section-number">3.1</span> Bayes’ Theorem</a></li>
  <li><a href="#bayesian-inference" id="toc-bayesian-inference" class="nav-link" data-scroll-target="#bayesian-inference"><span class="header-section-number">3.2</span> Bayesian Inference</a></li>
  <li><a href="#markov-chain-monte-carlo-mcmc" id="toc-markov-chain-monte-carlo-mcmc" class="nav-link" data-scroll-target="#markov-chain-monte-carlo-mcmc"><span class="header-section-number">3.3</span> Markov Chain Monte Carlo (MCMC)</a>
  <ul>
  <li><a href="#the-classical-approach" id="toc-the-classical-approach" class="nav-link" data-scroll-target="#the-classical-approach"><span class="header-section-number">3.3.1</span> The Classical Approach</a></li>
  <li><a href="#rejection-sampling" id="toc-rejection-sampling" class="nav-link" data-scroll-target="#rejection-sampling"><span class="header-section-number">3.3.2</span> Rejection Sampling</a></li>
  <li><a href="#gibbs-sampler" id="toc-gibbs-sampler" class="nav-link" data-scroll-target="#gibbs-sampler"><span class="header-section-number">3.3.3</span> Gibbs Sampler</a></li>
  <li><a href="#metropolis-hastings" id="toc-metropolis-hastings" class="nav-link" data-scroll-target="#metropolis-hastings"><span class="header-section-number">3.3.4</span> Metropolis-Hastings</a></li>
  <li><a href="#other-notes" id="toc-other-notes" class="nav-link" data-scroll-target="#other-notes"><span class="header-section-number">3.3.5</span> Other Notes</a></li>
  </ul></li>
  <li><a href="#gamma-poisson-and-estimating-counts" id="toc-gamma-poisson-and-estimating-counts" class="nav-link" data-scroll-target="#gamma-poisson-and-estimating-counts"><span class="header-section-number">3.4</span> Gamma Poisson and Estimating Counts</a></li>
  <li><a href="#normal-and-estimating-means" id="toc-normal-and-estimating-means" class="nav-link" data-scroll-target="#normal-and-estimating-means"><span class="header-section-number">3.5</span> Normal and Estimating Means</a>
  <ul>
  <li><a href="#normal-pop-est" id="toc-normal-pop-est" class="nav-link" data-scroll-target="#normal-pop-est"><span class="header-section-number">3.5.1</span> Population Estimate</a></li>
  <li><a href="#regression" id="toc-regression" class="nav-link" data-scroll-target="#regression"><span class="header-section-number">3.5.2</span> Regression</a></li>
  <li><a href="#generalized-linear-models" id="toc-generalized-linear-models" class="nav-link" data-scroll-target="#generalized-linear-models"><span class="header-section-number">3.5.3</span> Generalized Linear Models</a></li>
  <li><a href="#missing-data" id="toc-missing-data" class="nav-link" data-scroll-target="#missing-data"><span class="header-section-number">3.5.4</span> Missing Data</a></li>
  <li><a href="#change-point-regression" id="toc-change-point-regression" class="nav-link" data-scroll-target="#change-point-regression"><span class="header-section-number">3.5.5</span> Change Point Regression</a></li>
  <li><a href="#cluster-analysis" id="toc-cluster-analysis" class="nav-link" data-scroll-target="#cluster-analysis"><span class="header-section-number">3.5.6</span> Cluster Analysis</a></li>
  </ul></li>
  <li><a href="#beta-binomial-and-estimating-proportions" id="toc-beta-binomial-and-estimating-proportions" class="nav-link" data-scroll-target="#beta-binomial-and-estimating-proportions"><span class="header-section-number">3.6</span> Beta Binomial and Estimating Proportions</a></li>
  <li><a href="#zero-inflation-and-latent-variables" id="toc-zero-inflation-and-latent-variables" class="nav-link" data-scroll-target="#zero-inflation-and-latent-variables"><span class="header-section-number">3.7</span> Zero-Inflation and Latent Variables</a></li>
  <li><a href="#dic" id="toc-dic" class="nav-link" data-scroll-target="#dic"><span class="header-section-number">3.8</span> DIC</a></li>
  <li><a href="#monte-carlo-integration" id="toc-monte-carlo-integration" class="nav-link" data-scroll-target="#monte-carlo-integration"><span class="header-section-number">3.9</span> Monte Carlo Integration</a>
  <ul>
  <li><a href="#inverse-sampling" id="toc-inverse-sampling" class="nav-link" data-scroll-target="#inverse-sampling"><span class="header-section-number">3.9.1</span> Inverse Sampling</a></li>
  <li><a href="#rejection-sampling-1" id="toc-rejection-sampling-1" class="nav-link" data-scroll-target="#rejection-sampling-1"><span class="header-section-number">3.9.2</span> Rejection Sampling</a></li>
  <li><a href="#importance-sampling" id="toc-importance-sampling" class="nav-link" data-scroll-target="#importance-sampling"><span class="header-section-number">3.9.3</span> Importance Sampling</a></li>
  </ul></li>
  <li><a href="#metropolis-hastings-1" id="toc-metropolis-hastings-1" class="nav-link" data-scroll-target="#metropolis-hastings-1"><span class="header-section-number">3.10</span> Metropolis-Hastings</a></li>
  <li><a href="#mixed-effects-linear-regression" id="toc-mixed-effects-linear-regression" class="nav-link" data-scroll-target="#mixed-effects-linear-regression"><span class="header-section-number">3.11</span> Mixed Effects Linear Regression</a></li>
  <li><a href="#appendix-bayes-factors" id="toc-appendix-bayes-factors" class="nav-link" data-scroll-target="#appendix-bayes-factors"><span class="header-section-number">3.12</span> Appendix: Bayes Factors</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">3.13</span> Further Reading</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01-frequentist-statistics.html">Statistics</a></li><li class="breadcrumb-item"><a href="./03-bayesian-statistics.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Bayesian Statistics</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Bayesian Statistics</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Bayesian inference is an alternative to classical (aka, frequentist) inference. Both methods assume a data generating mechanism expressed as a likelihood, but while classical inference treats the mechanism as infinitely repeatable, Bayesian inference treats each event as unique. Instead of estimating a single population parameter (usually the mean), Bayesian inference estimates the parameter <em>distribution</em>. In fact Bayesian inference insists that <em>all</em> uncertainties be described by probabilities. Finally, whereas the machinery of classical inference is maximizing likelihood, Bayesian inference updates a prior probability distribution in light of the new information.</p>
<section id="bayes-theorem" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="bayes-theorem"><span class="header-section-number">3.1</span> Bayes’ Theorem</h2>
<p>Bayes’ Theorem is the inverse conditional probability, the probability of the condition given the observed outcome. It reorganizes the relationship between joint probability and conditional probability.</p>
<p><span class="math display">\[
\begin{align}
P(\theta D) = P(\theta|D)P(D) &amp;= P(D|\theta)P(\theta) \\
P(\theta|D) &amp;= \frac{P(D|\theta)P(\theta)}{P(D)}
\end{align}
\]</span></p>
<p>The probability of <span class="math inline">\(\theta\)</span> after observing <span class="math inline">\(D\)</span> is equal to the probability of observing <span class="math inline">\(D\)</span> when <span class="math inline">\(\theta\)</span> is true divided by the probability of observing <span class="math inline">\(D\)</span> under <em>any</em> circumstance.</p>
<ul>
<li><p>Think of <span class="math inline">\(P(\theta)\)</span> as the strength of your belief <em>prior</em> to considering <span class="math inline">\(D\)</span>.</p></li>
<li><p><span class="math inline">\(P(D|\theta)\)</span> is the <em>likelihood</em> of observing <span class="math inline">\(D\)</span> from a generative model with parameter <span class="math inline">\(\theta\)</span>. Likelihoods are probability densities, and are not quite the same as probabilities. For continuous variables, likelihoods will sum to greater than 1.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p></li>
<li><p><span class="math inline">\(P(D)\)</span> is the likelihood of observing <span class="math inline">\(D\)</span> from <em>any</em> prior. It is the <em>marginal distribution</em>, or <em>prior predictive distribution</em> of <span class="math inline">\(D\)</span>. The likelihood divided by the marginal distribution is the proportional adjustment made to the prior in light of the data.</p></li>
<li><p><span class="math inline">\(P(\theta|D)\)</span> is the strength of your belief <em>posterior</em> to considering <span class="math inline">\(D\)</span>.</p></li>
</ul>
<p>One illustration of Bayes’ Theorem is interpreting medical tests. <span class="math inline">\(P(D|\theta)\)</span> is the test’s <em>sensitivity</em>, the probability of a positive test result <span class="math inline">\(D\)</span> when the condition <span class="math inline">\(\theta\)</span> in fact exists. <span class="math inline">\(P(\theta)\)</span> is the probability prior to testing, the general rate. The numerator of Bayes’ Theorem is the joint probability, the probability of having the condition and testing positive, <span class="math inline">\(P(D \theta) = P(D|\theta)P(\theta)\)</span>. However, there is another way to test positive - the false positive, <span class="math inline">\(P(D | \hat{\theta})\)</span>! A test’s <em>specificity</em> is the probability of a negative test result when the condition does not exist. Specificity is the compliment of the false positive, <span class="math inline">\(P(\hat{D} | \hat{\theta}) = 1 - P(D | \hat{\theta})\)</span>. The denominator of Bayes’ Theorem is the overall probability of a positive test result.</p>
<p><span class="math display">\[
\begin{align}
P(\theta|D) &amp;= \frac{P(D|\theta)P(\theta)}{P(D)} \\
&amp;= \frac{P(D|\theta)P(\theta)}{P(D|\theta)P(\theta) + P(D|\hat\theta)P(\hat\theta)} \\
&amp;= \frac{\text{sensitivity} \cdot \text{prior}}{\text{sensitivity} \cdot \text{prior} + (1 - \text{specificity}) \cdot (1 - \text{prior})}
\end{align}
\]</span></p>
<p>Suppose E. Coli is typically present in <span class="math inline">\(P(\theta)\)</span> = 4.5% of samples, and an E. Coli screen has a sensitivity of <span class="math inline">\(P(D|\theta)\)</span> = 95% and a specificity of 1 - <span class="math inline">\(P(D|\hat\theta)\)</span> = 99%. Given a positive test result, what is the probability that E. Coli is actually present?</p>
<p><span class="math display">\[P(\theta|D) = \frac{.95\cdot .045}{.95\cdot .045 + (1 - .99)(1 - .045)} = \frac{.04275}{.05230} = 81.7\%.\]</span></p>
<p>The elements of Bayes’ Theorem come directly from the contingency table. The first row is the positive test result. The probability of E. Coli is the joint probability of E. Coli and a positive test divided by the probability of a positive test.</p>
<div class="cell">
<div class="cell-output-display">
<div class="tabwid tabwid_left"><style>.cl-5f8652fe{}.cl-5f7d23be{font-family:'Arial';font-size:10pt;font-weight:bold;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-5f7d23e6{font-family:'Arial';font-size:10pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-5f810b5a{margin:0;text-align:center;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-5f810b64{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-5f810b65{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-5f812482{width:1.142in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0.75pt solid rgba(102, 102, 102, 1.00);border-right: 0.75pt solid rgba(102, 102, 102, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f81248c{width:1.54in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0.75pt solid rgba(102, 102, 102, 1.00);border-right: 0.75pt solid rgba(102, 102, 102, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f812496{width:0.787in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0.75pt solid rgba(102, 102, 102, 1.00);border-right: 0.75pt solid rgba(102, 102, 102, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f8124b4{width:1.142in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0.75pt solid rgba(102, 102, 102, 1.00);border-right: 0.75pt solid rgba(102, 102, 102, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f8124b5{width:1.54in;background-color:rgba(238, 221, 130, 1.00);vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0.75pt solid rgba(102, 102, 102, 1.00);border-right: 0.75pt solid rgba(102, 102, 102, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f8124be{width:1.54in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0.75pt solid rgba(102, 102, 102, 1.00);border-right: 0.75pt solid rgba(102, 102, 102, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f8124bf{width:0.787in;background-color:rgba(238, 221, 130, 1.00);vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0.75pt solid rgba(102, 102, 102, 1.00);border-right: 0.75pt solid rgba(102, 102, 102, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f8124c0{width:1.142in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0.75pt solid rgba(102, 102, 102, 1.00);border-right: 0.75pt solid rgba(102, 102, 102, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f8124c8{width:1.54in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0.75pt solid rgba(102, 102, 102, 1.00);border-right: 0.75pt solid rgba(102, 102, 102, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f8124c9{width:0.787in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0.75pt solid rgba(102, 102, 102, 1.00);border-right: 0.75pt solid rgba(102, 102, 102, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f8124ca{width:1.142in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0.75pt solid rgba(102, 102, 102, 1.00);border-right: 0.75pt solid rgba(102, 102, 102, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f8124d2{width:1.54in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0.75pt solid rgba(102, 102, 102, 1.00);border-right: 0.75pt solid rgba(102, 102, 102, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-5f8124d3{width:0.787in;background-color:transparent;vertical-align: middle;border-bottom: 0.75pt solid rgba(102, 102, 102, 1.00);border-top: 0.75pt solid rgba(102, 102, 102, 1.00);border-left: 0.75pt solid rgba(102, 102, 102, 1.00);border-right: 0.75pt solid rgba(102, 102, 102, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing="true" class="cl-5f8652fe"><thead><tr style="overflow-wrap:break-word;"><th class="cl-5f812482"><p class="cl-5f810b5a"><span class="cl-5f7d23be"> </span></p></th><th class="cl-5f81248c"><p class="cl-5f810b5a"><span class="cl-5f7d23be">E. Coli</span></p></th><th class="cl-5f81248c"><p class="cl-5f810b5a"><span class="cl-5f7d23be">Safe</span></p></th><th class="cl-5f812496"><p class="cl-5f810b5a"><span class="cl-5f7d23be">Total</span></p></th></tr></thead><tbody><tr style="overflow-wrap:break-word;"><td class="cl-5f8124b4"><p class="cl-5f810b64"><span class="cl-5f7d23e6">Positive Test</span></p></td><td class="cl-5f8124b5"><p class="cl-5f810b65"><span class="cl-5f7d23e6">.95 * .045 = 0.04275</span></p></td><td class="cl-5f8124be"><p class="cl-5f810b65"><span class="cl-5f7d23e6">.01 * .955 = 0.00955</span></p></td><td class="cl-5f8124bf"><p class="cl-5f810b65"><span class="cl-5f7d23e6">0.05230</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5f8124c0"><p class="cl-5f810b64"><span class="cl-5f7d23e6">Negative Test</span></p></td><td class="cl-5f8124c8"><p class="cl-5f810b65"><span class="cl-5f7d23e6">.05 * .045 = 0.00225</span></p></td><td class="cl-5f8124c8"><p class="cl-5f810b65"><span class="cl-5f7d23e6">.99 * .955 = 0.94545</span></p></td><td class="cl-5f8124c9"><p class="cl-5f810b65"><span class="cl-5f7d23e6">0.94770</span></p></td></tr><tr style="overflow-wrap:break-word;"><td class="cl-5f8124ca"><p class="cl-5f810b64"><span class="cl-5f7d23e6">Total</span></p></td><td class="cl-5f8124d2"><p class="cl-5f810b65"><span class="cl-5f7d23e6">0.04500</span></p></td><td class="cl-5f8124d2"><p class="cl-5f810b65"><span class="cl-5f7d23e6">0.95500</span></p></td><td class="cl-5f8124d3"><p class="cl-5f810b65"><span class="cl-5f7d23e6">1.00000</span></p></td></tr></tbody></table></div>
</div>
</div>
</section>
<section id="bayesian-inference" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="bayesian-inference"><span class="header-section-number">3.2</span> Bayesian Inference</h2>
<p>Bayesian inference extends the logic of Bayes’ Theorem by replacing the prior probability <em>estimate</em> that <span class="math inline">\(\theta\)</span> is true with a prior probability <em>distribution</em> that <span class="math inline">\(\theta\)</span> is true. Rather than saying, “I am <em>x</em>% certain <span class="math inline">\(\theta\)</span> is true,” you say “I believe the probability that <span class="math inline">\(\theta\)</span> is true is somewhere in a range that has maximum likelihood at <em>x</em>%”.</p>
<p><span class="math display">\[
f(\theta | D) = \frac{f(D|\theta) f(\theta)}{\int_\Theta f(D|\theta) f(\theta) d\theta}
\]</span></p>
<p>This formula expresses the posterior distribution of <span class="math inline">\(\theta\)</span> as a function of the prior distribution and new information. Let <span class="math inline">\(\Pi(\theta)\)</span> be the prior probability function. <span class="math inline">\(\Pi(\theta)\)</span> has a PMF or PDF <span class="math inline">\(f(\theta)\)</span>, and a set of conditional distributions, <span class="math inline">\(f(D|\theta)\)</span>, called the <em>generative model</em> that express the <em>likelihood</em> of observing <span class="math inline">\(D\)</span> given <span class="math inline">\(\theta\)</span>. The <em>posterior</em> probability distribution of <span class="math inline">\(\theta\)</span>, conditioned on the observance of <span class="math inline">\(D\)</span>, is the joint distribution of <span class="math inline">\(D\)</span> and <span class="math inline">\(\theta\)</span> (aka <em>joint density</em>, the product of the likelihood and the prior) divided by the <em>marginal distribution</em> of <span class="math inline">\(D\)</span> (aka <em>marginal density</em> or <em>prior predictive distribution</em>). For discrete cases, replace the integral with a sum. The numerator makes the posterior proportional to the prior. The denominator is a normalizing constant that scales the likelihood into a proper density function (whose values sum to 1).</p>
<p>It is easier to see how observed evidence shifts the probabilities of the priors into their posterior probabilities by working with discrete priors first. From there it is straight-forward to grasp the more abstract case of continuous prior and posterior distributions.</p>
</section>
<section id="markov-chain-monte-carlo-mcmc" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="markov-chain-monte-carlo-mcmc"><span class="header-section-number">3.3</span> Markov Chain Monte Carlo (MCMC)</h2>
<p>Markov chain Monte Carlo (MCMC) methods are a class of algorithms for random sampling from high-dimensional probability distributions. Whereas Monte Carlo methods draw independent samples from a distribution, MCMC draw samples where the next value is dependent on the prior sample, creating a chain that zeros in on the target. MCMC improves on the less efficient rejection sampling, grid search, etc. methods. An example will show how Bayesian inference works with the less efficient methods, and the more sophisticated MCMC methods.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>The Howell data set contains the height (cm) of 165 adult males. Human height has an <span class="math inline">\(\sim N(\mu, \sigma)\)</span> distribution. What is the expected height of an adult male?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># downloaded this from </span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/rmcelreath/rethinking/blob/master/data/Howell1.csv</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>howell <span class="ot">&lt;-</span> </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_delim</span>(<span class="st">"input/Howell1.csv"</span>, <span class="at">delim =</span> <span class="st">";"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age <span class="sc">&gt;=</span> <span class="dv">18</span>, male <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>howell <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> height)) <span class="sc">+</span> <span class="fu">stat_qq</span>() <span class="sc">+</span> <span class="fu">geom_qq_line</span>() <span class="sc">+</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Adult heights are ~normally distributed."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="the-classical-approach" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="the-classical-approach"><span class="header-section-number">3.3.1</span> The Classical Approach</h3>
<p>The classical approach is to construct a 95% CI around the mean with a <a href="https://mpfoley73.github.io/statistics/one-sample-mean-t-test.html">one-sample mean <em>t</em> test</a>. The mean height is 160.4 (95% CI, 159.4 to 161.3) with standard deviation 6.0.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(howell<span class="sc">$</span>height)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    One Sample t-test

data:  howell$height
t = 342.78, df = 164, p-value &lt; 2.2e-16
alternative hypothesis: true mean is not equal to 0
95 percent confidence interval:
 159.4348 161.2822
sample estimates:
mean of x 
 160.3585 </code></pre>
</div>
</div>
</section>
<section id="rejection-sampling" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="rejection-sampling"><span class="header-section-number">3.3.2</span> Rejection Sampling</h3>
<p>Rejection sampling samples the parameter space (<span class="math inline">\(\mu\)</span> and <span class="math inline">\(\tau\)</span>), then conditions on the observed evidence (<span class="math inline">\(\bar{y}\)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">5</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu =</span> <span class="fu">round</span>(<span class="fu">runif</span>(ITER, <span class="dv">150</span>, <span class="dv">170</span>), <span class="dv">1</span>),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">tau =</span> <span class="fu">round</span>(<span class="fu">runif</span>(ITER, .<span class="dv">3</span>, .<span class="dv">6</span>), <span class="dv">2</span>),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">sampled_height =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(ITER, mu, <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(tau)), <span class="dv">1</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Condition on observed mean (160.4)</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>observed_mean <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">mean</span>(howell<span class="sc">$</span>height), <span class="dv">1</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span> </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sampled_height <span class="sc">==</span> observed_mean) <span class="sc">%&gt;%</span> </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mu_mean =</span> <span class="fu">mean</span>(mu), <span class="at">mu_025 =</span> <span class="fu">quantile</span>(mu, .<span class="dv">025</span>), <span class="at">mu_975 =</span> <span class="fu">quantile</span>(mu, .<span class="dv">975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  mu_mean mu_025 mu_975
    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1    160.   157.   163.</code></pre>
</div>
</div>
<p>This is rather inefficient. We generated 100,000 data points, then conditioned on just the 533 that had the observed mean. Plus, we limited ourselves to one-decimal precision for the search. However, the result, 160.4 (95% CI, 157.3 to 163.4) was close to the classical estimate of 160.4 (95% CI, 159.4 to 161.3)</p>
</section>
<section id="gibbs-sampler" class="level3" data-number="3.3.3">
<h3 data-number="3.3.3" class="anchored" data-anchor-id="gibbs-sampler"><span class="header-section-number">3.3.3</span> Gibbs Sampler</h3>
<p>Section @ref(normal-pop-est) explains that if you have data from a normally distributed population <span class="math inline">\(\sim N(\mu, \sigma)\)</span>, you can use a normal prior for <span class="math inline">\(\mu \sim N(\mu_0, \tau_0)\)</span> where <span class="math inline">\(\tau = 1 / \sigma^2\)</span>, and a gamma prior for <span class="math inline">\(\tau \sim \text{Gamma}(a, b)\)</span>. The posterior distributions are</p>
<p><span class="math display">\[
\begin{align}
\mu|y &amp; \sim N\left( \frac{n \tau \bar{y}}{n \tau + \tau_0}, n \tau + \tau_0 \right) \\
\tau|y &amp; \sim \text{Gamma} \left( a = \frac{n}{2}, b = \frac{1}{2} \sum_i (y_i - \mu)^2 \right)
\end{align}
\]</span></p>
<p>The Gibbs sampler algorithm is to set priors, randomly sample from <code>rnorm()</code> and <code>rgamma()</code> to get posteriors, then make the posteriors the new priors for repeated iterations. After some burn-in period, the posteriors should stabilize. Take the mean and quantiles of the posteriors (minus the burn-in). From prior knowledge, we know average height is <span class="math inline">\(\mu_0 = 175 \pm 10\)</span>. As a rule of thumb, <span class="math inline">\(\pm\)</span> is 2SD, so <span class="math inline">\(\sigma_0 = 5\)</span> and therefore <span class="math inline">\(\tau_0 = 1 / 5^2\)</span>. For gamma, we can use priors <span class="math inline">\(a = .01\)</span> and <span class="math inline">\(b = .01\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterations</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Prior parameter values based on intuition or prior studies.</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>mu_0 <span class="ot">&lt;-</span> <span class="dv">175</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>tau_0 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">5</span><span class="sc">^</span><span class="dv">2</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Monitors to track burn-in.</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>monitor_mu <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>monitor_tau <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the algorithm.</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>(n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(howell))</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 165</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> howell<span class="sc">$</span>height</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>(y_bar <span class="ot">&lt;-</span> <span class="fu">mean</span>(y))</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 160.3585</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>(mu <span class="ot">&lt;-</span> <span class="fu">mean</span>(y))</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 160.3585</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>(tau <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">var</span>(y))</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.027693</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>ITER) {</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mu</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  new_mu <span class="ot">&lt;-</span> (n <span class="sc">*</span> tau <span class="sc">*</span> y_bar) <span class="sc">/</span> (n <span class="sc">*</span> tau <span class="sc">+</span> tau_0)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>  new_tau <span class="ot">&lt;-</span> n <span class="sc">*</span> tau <span class="sc">+</span> tau_0</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  monitor_mu[iter] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, new_mu, <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(new_tau))</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tau</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  new_a <span class="ot">&lt;-</span> a <span class="sc">+</span> n<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  new_b <span class="ot">&lt;-</span> b <span class="sc">+</span> .<span class="dv">5</span> <span class="sc">*</span> <span class="fu">sum</span>((y<span class="sc">-</span>mu)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>  monitor_tau[iter] <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, new_a, new_b)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># update state</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> monitor_mu[iter]</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> monitor_tau[iter]</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Discard burn-in and estimate.</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(monitor_mu[<span class="sc">-</span><span class="dv">500</span>])</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 158.9003</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(monitor_mu[<span class="sc">-</span><span class="dv">500</span>], <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>))</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a><span class="do">##     2.5%    97.5% </span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="do">## 157.8919 159.8737</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Check out the burn-in. Actually looks like it took 1 iteration.</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">index =</span> <span class="dv">1</span><span class="sc">:</span>ITER, <span class="at">M =</span> monitor_mu) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> index, <span class="at">y =</span> M)) <span class="sc">+</span> <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="metropolis-hastings" class="level3" data-number="3.3.4">
<h3 data-number="3.3.4" class="anchored" data-anchor-id="metropolis-hastings"><span class="header-section-number">3.3.4</span> Metropolis-Hastings</h3>
<p>The Metropolis-Hastings model is like MCMC except that the posterior is accepted with probability <span class="math inline">\(\min(R, 1)\)</span> where <span class="math inline">\(R\)</span> is</p>
<p><span class="math display">\[
R = \frac{f(y|\theta')f(\theta')}{f(y|\theta)f(\theta)} \frac{q(\theta|\theta')}{q(\theta'|\theta)}
\]</span></p>
<p>If the proposed distribution is symmetric, the second term drops out and <span class="math inline">\(R\)</span> is just the ratio of posterior distributions. The symmetric version is called <em>Metropolis</em> instead of <em>Metropolis-Hastings</em>.</p>
<p>Suppose your data is <span class="math inline">\(n = 100\)</span> values from a <span class="math inline">\(N(\mu = 2, \tau = 1/4)\)</span> distribution.</p>
<div class="cell" data-collaps="true">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterations</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Prior parameter values based on intuition or prior studies.</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>mu_0 <span class="ot">&lt;-</span> <span class="dv">175</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>tau_0 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">5</span><span class="sc">^</span><span class="dv">2</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Monitors to track burn-in.</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>monitor_mu <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>monitor_tau <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the algorithm.</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>(n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(howell))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 165</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> howell<span class="sc">$</span>height</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>(y_bar <span class="ot">&lt;-</span> <span class="fu">mean</span>(y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 160.3585</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>(mu <span class="ot">&lt;-</span> <span class="fu">mean</span>(y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 160.3585</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>(tau <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">var</span>(y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.027693</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>ITER) {</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mu</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  new_mu <span class="ot">&lt;-</span> (n <span class="sc">*</span> tau <span class="sc">*</span> y_bar) <span class="sc">/</span> (n <span class="sc">*</span> tau <span class="sc">+</span> tau_0)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  new_tau <span class="ot">&lt;-</span> n <span class="sc">*</span> tau <span class="sc">+</span> tau_0</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  proposed_mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, new_mu, <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(new_tau)) <span class="co"># tentative for now!</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tau</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  new_a <span class="ot">&lt;-</span> a <span class="sc">+</span> n<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  new_b <span class="ot">&lt;-</span> b <span class="sc">+</span> .<span class="dv">5</span> <span class="sc">*</span> <span class="fu">sum</span>((y<span class="sc">-</span>mu)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  monitor_tau[iter] <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, new_a, new_b)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># update state</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># log of the acceptance ratio</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  logR <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">dnorm</span>(y, proposed_mu, <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(tau), <span class="at">log =</span> T)) <span class="sc">-</span> <span class="co"># new likelihood</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sum</span>(<span class="fu">dnorm</span>(y, mu         , <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(tau), <span class="at">log =</span> T)) <span class="sc">+</span> <span class="co"># old likelihood</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>          <span class="fu">dnorm</span>(proposed_mu, mu_0, <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(tau_0), <span class="at">log =</span> T) <span class="sc">-</span> <span class="co"># new prior</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>          <span class="fu">dnorm</span>(mu         , mu_0, <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(tau_0), <span class="at">log =</span> T)   <span class="co"># old prior</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># accept with probability min(R,1)</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  logU <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(logU <span class="sc">&lt;</span> logR) {mu <span class="ot">&lt;-</span> new_mu}</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  monitor_mu[iter] <span class="ot">&lt;-</span> mu <span class="co"># this is either current or the proposed.</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> monitor_tau[iter]</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Discard burn-in and estimate.</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(monitor_mu[<span class="sc">-</span><span class="dv">500</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 158.9385</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(monitor_mu[<span class="sc">-</span><span class="dv">500</span>], <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    2.5%    97.5% 
158.5900 159.2169 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check out the burn-in. Actually looks like it took 1 iteration.</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">index =</span> <span class="dv">1</span><span class="sc">:</span>ITER, <span class="at">M =</span> monitor_mu) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> index, <span class="at">y =</span> M)) <span class="sc">+</span> <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="other-notes" class="level3" data-number="3.3.5">
<h3 data-number="3.3.5" class="anchored" data-anchor-id="other-notes"><span class="header-section-number">3.3.5</span> Other Notes</h3>
<p>One simple Bayesian approach is to run several (we’ll use 1,000) experiments that sample 100 ad impression events from an <code>rbinom()</code> generative model using a uniform prior distribution of 0-30% click probability. The resulting 1,000 row data set of click probabilities is the prior predictive distribution of <span class="math inline">\(D\)</span>, the denominator of Bayes’ Theorem. The subset where <span class="math inline">\(D = 13\)</span> is the likelihood, <span class="math inline">\(P(D|\theta)\)</span>. The sampled <span class="math inline">\(\theta\)</span>’s are the prior, <span class="math inline">\(P(\theta) = \text{unif}(.0, .3)\)</span>. Their product is the joint probability distribution, <span class="math inline">\(P(D|\theta)P(\theta)\)</span>, the numerator of Bayes’ Theorem. This method is called <em>rejection sampling</em> because you sample across the whole parameter space, then condition on the observed evidence.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>df_sim <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">click_prob =</span> <span class="fu">runif</span>(<span class="dv">1000</span>, <span class="fl">0.0</span>, <span class="fl">0.3</span>),</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">click_n =</span> <span class="fu">rbinom</span>(<span class="dv">1000</span>, <span class="dv">100</span>, click_prob)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>df_sim <span class="sc">%&gt;%</span> </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_13 =</span> <span class="fu">factor</span>(click_n <span class="sc">==</span> <span class="dv">13</span>, <span class="at">levels =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> click_prob, <span class="at">y =</span> click_n, <span class="at">color =</span> is_13)) <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">13</span>, <span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">linetype =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"gray80"</span>)) <span class="sc">+</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">40</span>, <span class="dv">10</span>), <span class="dv">13</span>)) <span class="sc">+</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Joint probability of observed clicks and click probability"</span>,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"with conditioning on 13 observed clicks."</span>,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"clicks per 100 ads"</span>,</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(theta))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Condition the joint probability distribution on the 30 rows that produced 13 observed clicks to update the prior. The <code>quantile()</code> function returns the median and the .025 and .975 percentile values - the <em>credible interval</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># median and credible interval</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>(sim_ci <span class="ot">&lt;-</span> df_sim <span class="sc">%&gt;%</span> <span class="fu">filter</span>(click_n <span class="sc">==</span> <span class="dv">13</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(click_prob) <span class="sc">%&gt;%</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quantile</span>(<span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">5</span>, .<span class="dv">975</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     2.5%       50%     97.5% 
0.1030532 0.1428307 0.2028469 </code></pre>
</div>
</div>
<p>The posterior click rate likelihood is 14.3% with 95% credible interval (10.3%, 20.3%). Here is the density plot of the 30 simulations that produced the 13 clicks. The median and 95% credible interval are marked.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>df_sim <span class="sc">%&gt;%</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(click_n <span class="sc">==</span> <span class="dv">13</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> click_prob)) <span class="sc">+</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> sim_ci[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> sim_ci[<span class="dv">1</span>], <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> sim_ci[<span class="dv">3</span>], <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># coord_cartesian(xlim = c(0, .3)) +</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">0</span>, .<span class="dv">3</span>, .<span class="dv">05</span>), sim_ci), <span class="at">labels =</span> <span class="fu">percent_format</span>(.<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Posterior click likelihood distribution"</span>, </span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">glue</span>(<span class="st">"p = {percent(sim_ci[2], .1)}, 95%-CI ("</span>,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>       <span class="st">"{percent(sim_ci[1], .1)}, {percent(sim_ci[3], .1)})"</span>),</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(theta), <span class="at">y =</span> <span class="st">"density (likelihood)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>That’s pretty close to the classical result! Instead of sampling, you could define a discrete set of candidate click probabilities and calculate the click probability density for the 100 ad impressions. This method is called <em>grid approximation</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>df_bayes <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">click_prob =</span> <span class="fu">seq</span>(<span class="fl">0.01</span>, .<span class="dv">30</span>, <span class="at">by =</span> .<span class="dv">001</span>), </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">click_n =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">100</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">dunif</span>(click_prob, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fl">0.3</span>),</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">likelihood =</span> <span class="fu">dbinom</span>(click_n, <span class="dv">100</span>, click_prob),</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">probability =</span> likelihood <span class="sc">*</span> prior <span class="sc">/</span> <span class="fu">sum</span>(likelihood <span class="sc">*</span> prior)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>df_bayes <span class="sc">%&gt;%</span> </span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_13 =</span> <span class="fu">factor</span>(click_n <span class="sc">==</span> <span class="dv">13</span>, <span class="at">levels =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(probability &gt; .0001) %&gt;%</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> click_prob, <span class="at">y =</span> click_n, <span class="at">color =</span> is_13)) <span class="sc">+</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> probability), <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">13</span>, <span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">linetype =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>)) <span class="sc">+</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">10</span>), <span class="dv">13</span>)) <span class="sc">+</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient</span>(<span class="at">low =</span> <span class="st">"#FFFFFF"</span>, <span class="at">high =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale_color_manual(values = c("TRUE" = "steelblue", "FALSE" = "gray20")) +</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Joint probability of clicks and click probability."</span>,</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"with conditioning on 13 observed clicks."</span>,</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"clicks per 100 ads"</span>,</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(theta))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Condition the joint probability distribution on the 13 observed clicks to update your prior. Resample the posterior probability to create a distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df_bayes_13 <span class="ot">&lt;-</span> df_bayes <span class="sc">%&gt;%</span> <span class="fu">filter</span>(click_n <span class="sc">==</span> <span class="dv">13</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">posterior =</span> probability <span class="sc">/</span> <span class="fu">sum</span>(probability))</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>sampling_idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df_bayes_13), </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> <span class="dv">10000</span>, </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">replace =</span> <span class="cn">TRUE</span>, </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob =</span> df_bayes_13<span class="sc">$</span>posterior</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>sampling_vals <span class="ot">&lt;-</span> df_bayes_13[sampling_idx, ]</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>(df_bayes_ci <span class="ot">&lt;-</span> <span class="fu">quantile</span>(sampling_vals<span class="sc">$</span>click_prob, <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">5</span>, .<span class="dv">975</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> 2.5%   50% 97.5% 
0.079 0.135 0.212 </code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can use a Bayesian model to estimate multiple parameters. Suppose you want to predict the water temperature in a lake on Jun 1 based on 5 years of prior water temperatures.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">19</span>, <span class="dv">23</span>, <span class="dv">20</span>, <span class="dv">17</span>, <span class="dv">23</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You model the water temperature as a normal distribution, <span class="math inline">\(\mathrm{N}(\mu, \sigma^2)\)</span> with a prior distribution <span class="math inline">\(\mu = \mathrm{N}(18, 5^2)\)</span> and <span class="math inline">\(\sigma = \mathrm{unif}(0, 10)\)</span> based on past experience.</p>
<p>Using the grid approximation approach, construct a grid of candidate <span class="math inline">\(\mu\)</span> values from 8 to 30 degrees incremented by .5 degrees, and candidate <span class="math inline">\(\sigma\)</span> values from .1 to 10 incremented by .1 - a 4,500 row data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>mdl_grid <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">mu =</span> <span class="fu">seq</span>(<span class="dv">8</span>, <span class="dv">30</span>, <span class="at">by =</span> <span class="fl">0.5</span>),</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">sigma =</span> <span class="fu">seq</span>(.<span class="dv">1</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="fl">0.1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For each combination of <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span>, the <em>prior</em> probabilities are the densities from <span class="math inline">\(\mu = \mathrm{N}(18, 5^2)\)</span> and <span class="math inline">\(\sigma = \mathrm{unif}(0, 10)\)</span>. The combined prior is their product. The <em>likelihoods</em> are the products of the probabilities of observing each <code>temp</code> given the candidate <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span> values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>mdl_grid_2 <span class="ot">&lt;-</span> mdl_grid <span class="sc">%&gt;%</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_prior =</span> <span class="fu">map_dbl</span>(mu, <span class="sc">~</span><span class="fu">dnorm</span>(., <span class="at">mean =</span> <span class="dv">18</span>, <span class="at">sd =</span> <span class="dv">5</span>)),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma_prior =</span> <span class="fu">map_dbl</span>(sigma, <span class="sc">~</span><span class="fu">dunif</span>(., <span class="dv">0</span>, <span class="dv">10</span>)),</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> mu_prior <span class="sc">*</span> sigma_prior, <span class="co"># combined prior,</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">likelihood =</span> <span class="fu">map2_dbl</span>(mu, sigma, <span class="sc">~</span><span class="fu">dnorm</span>(temp, .x, .y) <span class="sc">%&gt;%</span> <span class="fu">prod</span>()),</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">posterior =</span> likelihood <span class="sc">*</span> prior <span class="sc">/</span> <span class="fu">sum</span>(likelihood <span class="sc">*</span> prior)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Calculate a credible interval by drawing 10,000 samples from the grid with sampling probability equal to the calculated posterior probabilities. Use the <code>quantile()</code> function to estimate the median and .025 and .975 quantile values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>sampling_idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(mdl_grid), <span class="at">size =</span> <span class="dv">10000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> mdl_grid<span class="sc">$</span>posterior)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>sampling_vals <span class="ot">&lt;-</span> mdl_grid[sampling_idx, <span class="fu">c</span>(<span class="st">"mu"</span>, <span class="st">"sigma"</span>)]</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>mu_ci <span class="ot">&lt;-</span> <span class="fu">quantile</span>(sampling_vals<span class="sc">$</span>mu, <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">5</span>, .<span class="dv">975</span>))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>sigma_ci <span class="ot">&lt;-</span> <span class="fu">quantile</span>(sampling_vals<span class="sc">$</span>sigma, <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">5</span>, .<span class="dv">975</span>))</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>ci <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(<span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">5</span>, .<span class="dv">975</span>), <span class="at">mean =</span> mu_ci[<span class="dv">2</span>], <span class="at">sd =</span> sigma_ci[<span class="dv">2</span>])</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">temp =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">30</span>, <span class="at">by =</span> .<span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prob =</span> <span class="fu">map_dbl</span>(temp, <span class="sc">~</span><span class="fu">dnorm</span>(., <span class="at">mean =</span> ci[<span class="dv">2</span>], <span class="at">sd =</span> sigma_ci[<span class="dv">2</span>])),</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">ci =</span> <span class="fu">if_else</span>(temp <span class="sc">&gt;=</span> ci[<span class="dv">1</span>] <span class="sc">&amp;</span> temp <span class="sc">&lt;=</span> ci[<span class="dv">3</span>], <span class="st">"Y"</span>, <span class="st">"N"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> temp, <span class="at">y =</span> prob)) <span class="sc">+</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">if_else</span>(ci <span class="sc">==</span> <span class="st">"N"</span>, prob, <span class="dv">0</span>)), </span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> <span class="st">"firebrick"</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> ci[<span class="dv">2</span>], <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">30</span>, <span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Posterior temperature probability"</span>, </span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">glue</span>(<span class="st">"mu = {ci[2] %&gt;% scales::number(accuracy = .1)}, 95%-CI ("</span>,</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>       <span class="st">"{ci[1] %&gt;% scales::number(accuracy = .1)}, "</span>,</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>       <span class="st">"{ci[3] %&gt;% scales::number(accuracy = .1)})"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>What is the probability the temperature is at least 18?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>pred_temp <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="at">mean =</span> sampling_vals<span class="sc">$</span>mu, sampling_vals<span class="sc">$</span>sigma)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>scales<span class="sc">::</span><span class="fu">percent</span>(<span class="fu">sum</span>(pred_temp <span class="sc">&gt;=</span> <span class="dv">18</span>) <span class="sc">/</span> <span class="fu">length</span>(pred_temp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "56%"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>gibbs_normal <span class="ot">&lt;-</span> <span class="cf">function</span>(y, mu_0, tau_0, a, b, n_iter){</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  y_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(y)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  mu_sample <span class="ot">&lt;-</span> tau_sample <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_iter)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># starting values</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  mu_sample[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(y)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  tau_sample[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">var</span>(y)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gibbs sampler</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n_iter){</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mu</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    tau <span class="ot">&lt;-</span> tau_sample[i<span class="dv">-1</span>]</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    mean_mu <span class="ot">&lt;-</span> (n <span class="sc">*</span> y_mean <span class="sc">*</span> tau <span class="sc">+</span> mu_0 <span class="sc">*</span> tau_0) <span class="sc">/</span> (n <span class="sc">*</span> tau <span class="sc">+</span> tau_0)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    precision_mu <span class="ot">&lt;-</span> n <span class="sc">*</span> tau <span class="sc">+</span> tau_0</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    mu_sample[i] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mean_mu, <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(precision_mu))</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tau</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> mu_sample[i<span class="dv">-1</span>]</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    tau_sample[i] <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, a <span class="sc">+</span> n<span class="sc">/</span><span class="dv">2</span>, b <span class="sc">+</span> .<span class="dv">5</span> <span class="sc">*</span> <span class="fu">sum</span>((y <span class="sc">-</span> mu)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mu =</span> mu_sample, <span class="at">tau =</span> tau_sample))</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>sample_m <span class="ot">&lt;-</span> <span class="fu">gibbs_normal</span>(howell[howell<span class="sc">$</span>male <span class="sc">==</span> <span class="st">"men"</span>,]<span class="sc">$</span>height, <span class="dv">175</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">5</span><span class="sc">^</span><span class="dv">2</span>, .<span class="dv">01</span>, .<span class="dv">01</span>, <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="gamma-poisson-and-estimating-counts" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="gamma-poisson-and-estimating-counts"><span class="header-section-number">3.4</span> Gamma Poisson and Estimating Counts</h2>
<p>The gamma and Poisson distributions are used to model count data. Consider the following counts of weekday sandwich sales. What is the expected value of sales?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">65</span>, <span class="dv">72</span>, <span class="dv">63</span>, <span class="dv">70</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Count data have a Poisson distribution, <span class="math inline">\(y_i|\lambda \sim Pois(\lambda)\)</span>, with expected value <span class="math inline">\(\lambda\)</span> and PMF <span class="math inline">\(f(y_i | \lambda) = e^{-\lambda}\frac{\lambda^{y_i}}{y_i!}\)</span>. Using Bayes’ Theorem, the posterior distribution of <span class="math inline">\(\lambda\)</span> given evidence <span class="math inline">\(\textbf{y}\)</span> is the joint likelihood of <span class="math inline">\(\lambda\)</span> and <span class="math inline">\(\textbf{y}\)</span> divided by the likelihood of <span class="math inline">\(\textbf{y}\)</span>.</p>
<p><span class="math display">\[
f(\lambda |\textbf{y}) = \frac{f(\mathbf{y}|\lambda) f(\lambda)}{\int_\Lambda f(\mathbf{y}|\lambda) f(\lambda) d\lambda}
\]</span></p>
<p>The conditional likelihood, <span class="math inline">\(f(\textbf{y}|\lambda)\)</span>, is the sum-product of the Poisson distribution PMF.</p>
<p><span class="math display">\[
\begin{align}
f(\textbf{y}|\lambda) = f(y_i,\ldots, y_n | \lambda) &amp;= \prod_i f(y_i | \lambda) \\
&amp;= \prod_i e^{-\lambda}\frac{\lambda^{y_i}}{y_i!}
\end{align}
\]</span></p>
<p>The prior distribution, <span class="math inline">\(f(\lambda)\)</span>, should take on only positive values. Model it with the <a href="https://mpfoley73.github.io/probability/random-variables-and-distributions.html#gamma">gamma distribution</a>, <span class="math inline">\(\lambda|a,b = \mathrm{Gamma}(a,b)\)</span>.</p>
<p><span class="math display">\[
f(\lambda) = f(\lambda | a,b) = \frac{b^a \lambda^{a-1} e^{-b\lambda}}{\Gamma(a)}
\]</span></p>
<p>where <span class="math inline">\(\Gamma\)</span> is the gamma function<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. Substituting into Bayes’ Theorem and simplifying, you have this nightmare:</p>
<p><span class="math display">\[
f(\lambda |\textbf{y}) = \frac{\lambda^{a + \sum_i y_i-1}e^{-(b+n)\lambda}}{\int_0^\infty \lambda^{a + \sum_i y_i-1}e^{-(b+n)\lambda} d\lambda}
\]</span></p>
<p>However, there is good news. The integration in the denominator removes the dependence on <span class="math inline">\(\lambda\)</span>, so <span class="math inline">\(f(\lambda |\textbf{y}, a, b)\)</span> is proportional to the numerator up to a constant.</p>
<p><span class="math display">\[
f(\lambda |\textbf{y}) \propto f(\textbf{y} | \lambda) f(\lambda)
\]</span></p>
<p>Since <span class="math inline">\(f(\lambda |\textbf{y})\)</span> is a PMF, it integrates (sums) to 1 and you can always figure out the constant later. What makes this good news is that this has the form of the PDF of the gamma distribution.</p>
<p><span class="math display">\[
\begin{equation}
\lambda | \textbf{y}, a, b \sim \mathrm{Gamma}(a + \sum_i y_i, b + n)
(\#eq:gamma-posterior)
\end{equation}
\]</span></p>
<p>Equation @ref(eq:gamma-posterior) is the posterior distribution of <span class="math inline">\(\lambda\)</span>. We combined a gamma prior with the Poisson likelihood of evidence, <span class="math inline">\(\textbf{y}\)</span>, to produce a gamma posterior. We call priors that produce posteriors of the same form, <em>conjugate priors</em> for the likelihood. Conjugate priors are popular because of their computational convenience.</p>
<p>Return to the sandwich sales data. We need values to plug into Equation @ref(eq:gamma-posterior). For the gamma distribution, <span class="math inline">\(E(X) = a / b\)</span> and <span class="math inline">\(\mathrm{Var}(X) = a / b^2\)</span>. You might guess from intuition that mean daily sandwich sales are 70 +/- 5. Interpreting +/- 5 as a 95% CI and using the rule of thumb that a 95% CI is 2 SD, <span class="math inline">\(\mathrm{Var} = (2.5)^2 = 6.25\)</span>. Solve for <span class="math inline">\(a = 784\)</span> and <span class="math inline">\(b = 11.2\)</span>. We also have <span class="math inline">\(\sum_i y_i = 320\)</span> and <span class="math inline">\(n = 5\)</span>.</p>
<p><span class="math display">\[
\lambda | \textbf{y}, a, b \sim \mathrm{Gamma}(784 + 320, 11.2 + 5) \sim \mathrm{Gamma}(1104, 16.2)
\]</span></p>
<p>The posterior <span class="math inline">\(E(y) = 1104 / 16.2 = 68.1\)</span> and <span class="math inline">\(\mathrm{Var}(y) = 1104 / 16.2^2 = 4.2\)</span>. Use the gamma distribution function to get the posterior 95% <em>credible</em> interval.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prior distribution</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qgamma</span>(<span class="at">p =</span> <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>), <span class="dv">784</span>, <span class="fl">11.2</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 65.18520 74.98392</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior distribution</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="fu">qgamma</span>(<span class="at">p =</span> <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>), <span class="dv">784</span> <span class="sc">+</span> <span class="dv">320</span>, <span class="fl">11.2</span> <span class="sc">+</span> <span class="dv">5</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 64.18701 72.22621</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Whereas the prior expected mean daily sandwich sales was 70 (95% CI: 65, 75), the posterior is 68 (95% CI: 64, 72). Compare this to classical statistics: <span class="math inline">\(E(y) = \bar{y} = 64\)</span>, <span class="math inline">\(SE = \sqrt{\bar{y} / n} = 3.6\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Classical estimate</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qnorm</span>(<span class="at">p =</span> <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>), <span class="dv">64</span>, <span class="fl">3.6</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 56.94413 71.05587</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You might think that the reasonable Bayesian outcome was predicated on good <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> priors, but no. Suppose <span class="math inline">\(a = .01\)</span> and <span class="math inline">\(b = .01\)</span>. The posterior is still reasonable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Informal prior</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qgamma</span>(<span class="at">p =</span> <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>), .<span class="dv">01</span> <span class="sc">+</span> <span class="dv">320</span>, .<span class="dv">01</span> <span class="sc">+</span> <span class="dv">5</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 57.06689 71.05964</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">80</span>, .<span class="dv">1</span>),</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Gamma(.01, .01)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">dgamma</span>(lambda, .<span class="dv">01</span>, .<span class="dv">01</span>),</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Gamma(.01 + 320, .01 + 5)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">dgamma</span>(lambda, .<span class="dv">01</span> <span class="sc">+</span> <span class="dv">320</span>, .<span class="dv">01</span> <span class="sc">+</span> <span class="dv">5</span>),</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Gamma(784, 11.2)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">dgamma</span>(lambda, <span class="dv">784</span>, <span class="fl">11.2</span>),</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Gamma(784 + 320, 11.2 + 5)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">dgamma</span>(lambda, <span class="dv">784</span> <span class="sc">+</span> <span class="dv">320</span>, <span class="fl">11.2</span> <span class="sc">+</span> <span class="dv">5</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>lambda) <span class="sc">%&gt;%</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">fct_inorder</span>(name)) <span class="sc">%&gt;%</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prior =</span> <span class="fu">if_else</span>(<span class="fu">str_detect</span>(name, <span class="st">"</span><span class="sc">\\</span><span class="st">+"</span>), <span class="st">"posterior"</span>, <span class="st">"prior"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> lambda, <span class="at">y =</span> value, <span class="at">color =</span> name, <span class="at">linetype =</span> prior)) <span class="sc">+</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"seagreen"</span>, <span class="dv">2</span>), <span class="fu">rep</span>(<span class="st">"firebrick"</span>, <span class="dv">2</span>))) <span class="sc">+</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">color =</span> <span class="cn">NULL</span>, <span class="at">linetype =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"density"</span>,</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Posteriors from Conservative and Informed Priors."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The Bayesian posterior approaches the classical <span class="math inline">\(\bar{y}\)</span> with increasing sample size.</p>
<p><span class="math display">\[
E(\lambda|\textbf{y}, a, b) = \frac{a + \sum_i y_i}{b + n} = \frac{a + n \bar{y}}{b + n}
\]</span></p>
<p>Taking the limit, <span class="math inline">\(\lim_{n \rightarrow \infty} E(\lambda|\textbf{y}, a, b) = \bar{y}\)</span>.</p>
<p>The <em>central</em> credible interval is the standard Bayesian credible interval. But when the posterior distribution is not perfectly symmetric, the shortest credible interval capturing x% of the distribution might have different endpoints. Our example has a pretty symmetric distribution, but let’s calculate the <em>highest density region (HDR)</em> anyway.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>pp <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.01</span>, .<span class="dv">99</span>, <span class="at">by =</span> .<span class="dv">0001</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(pp, <span class="sc">~</span><span class="fu">qgamma</span>(., <span class="dv">784</span> <span class="sc">+</span> <span class="dv">320</span>, <span class="fl">11.2</span> <span class="sc">+</span> <span class="dv">5</span>))</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>hdrcde<span class="sc">::</span><span class="fu">hdr</span>(x, <span class="at">prob =</span> <span class="dv">95</span>)<span class="sc">$</span>hdr</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="do">##         [,1]     [,2]</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 95% 64.40786 71.86587</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The posterior predictive distribution of a predicted value, <span class="math inline">\(\tilde{y}\)</span> is</p>
<p><span class="math display">\[
f(\tilde{y} | x) = \int f(\tilde{y}|\lambda) f(\lambda | \textbf{y}) d\lambda
\]</span></p>
<p>Our sandwich example has a well defined functional solution: the expected value from <span class="math inline">\(\mathrm{Gamma}(1104, 16.2)\)</span> is <span class="math inline">\(1104/16.2 = 68\)</span>. Had we not known this, we could have simulated posterior values (Monte Carlo simulation) and calculated the mean and variance. The procedure is to take a random sample of perhaps 1,000 <span class="math inline">\(\lambda\)</span> values from the gamma posterior distribution, then for each <span class="math inline">\(\lambda\)</span> draw a single random <span class="math inline">\(\tilde{y}\)</span> from the Poisson distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">1104</span> </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fl">16.2</span> </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co"># random sample of lambdas, and a single random y_tilde for each lambda</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>lambda_r <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1000</span>, a, b)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>y_tilde <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="dv">1000</span>, lambda_r)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior predictive distribution</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(y_tilde)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 68.252</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(y_tilde, <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>))</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="do">##   2.5%  97.5% </span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 50.975 85.000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So on any given day, the predicted value of sandwich sales is 68.3 with 95% prediction interval 51.0, 85.0. The probability of exceeding 80 sandwiches, <span class="math inline">\(P(\tilde{y} &gt; 80 | \textbf{y})\)</span>, is <code>mean(y_tilde &gt; 80)</code> = 8.3%, and 99% of the time, sandwich sales will be less than <code>quantile(y_tilde, .99)</code> = 89.</p>
<p>You can also predict individual weekdays. Suppose you take a <span class="math inline">\(\mathrm{Gamma}(700, 10)\)</span> distribution as your prior.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>day_tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">dow =</span> <span class="fu">fct_inorder</span>(<span class="fu">c</span>(<span class="st">"Mon"</span>, <span class="st">"Tue"</span>, <span class="st">"Wed"</span>, <span class="st">"Thu"</span>, <span class="st">"Fri"</span>)),</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">d =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">65</span>, <span class="dv">72</span>, <span class="dv">63</span>, <span class="dv">70</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">post_a =</span> <span class="dv">700</span> <span class="sc">+</span> d,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">post_b =</span> <span class="dv">10</span> <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">post_mean =</span> post_a <span class="sc">/</span> post_b,</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">post_lci =</span> <span class="fu">qgamma</span>(.<span class="dv">025</span>, post_a, post_b),</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">post_uci =</span> <span class="fu">qgamma</span>(.<span class="dv">975</span>, post_a, post_b)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>day_tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 7
  dow       d post_a post_b post_mean post_lci post_uci
  &lt;fct&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 Mon      50    750     11      68.2     63.4     73.1
2 Tue      65    765     11      69.5     64.7     74.6
3 Wed      72    772     11      70.2     65.3     75.2
4 Thu      63    763     11      69.4     64.5     74.4
5 Fri      70    770     11      70       65.1     75.0</code></pre>
</div>
</div>
<p>What is the probability that Mon sales are less than Tue?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>lambda_r_mon <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1000</span>, <span class="dv">750</span>, <span class="dv">11</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>lambda_r_tue <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1000</span>, <span class="dv">765</span>, <span class="dv">11</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior probability </span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(lambda_r_mon <span class="sc">&lt;</span> lambda_r_tue)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.664</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Which day of the week has the highest sandwich sales?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>lambda_r <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_mon =</span> <span class="fu">rgamma</span>(<span class="dv">1000</span>, <span class="dv">750</span>, <span class="dv">11</span>),</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_tue =</span> <span class="fu">rgamma</span>(<span class="dv">1000</span>, <span class="dv">765</span>, <span class="dv">11</span>),</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_wed =</span> <span class="fu">rgamma</span>(<span class="dv">1000</span>, <span class="dv">772</span>, <span class="dv">11</span>),</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_thu =</span> <span class="fu">rgamma</span>(<span class="dv">1000</span>, <span class="dv">763</span>, <span class="dv">11</span>),</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_fri =</span> <span class="fu">rgamma</span>(<span class="dv">1000</span>, <span class="dv">770</span>, <span class="dv">11</span>),</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_dow =</span> <span class="fu">pmap</span>(<span class="fu">list</span>(r_mon, r_tue, r_wed, r_thu, r_fri), </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>                   <span class="cf">function</span>(m, t, w, r, f) <span class="fu">c</span>(m, t, w, r, f)),</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_dow_idx =</span> <span class="fu">map_dbl</span>(r_dow, <span class="sc">~</span><span class="fu">which.max</span>(.)),</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_dow =</span> <span class="fu">map_chr</span>(max_dow_idx, <span class="sc">~</span><span class="fu">c</span>(<span class="st">"Mon"</span>, <span class="st">"Tue"</span>, <span class="st">"Wed"</span>, <span class="st">"Thu"</span>, <span class="st">"Fri"</span>)[.])</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>lambda_r <span class="sc">%&gt;%</span> janitor<span class="sc">::</span><span class="fu">tabyl</span>(max_dow)</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a><span class="do">##  max_dow   n percent</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="do">##      Fri 248   0.248</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a><span class="do">##      Mon  77   0.077</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a><span class="do">##      Thu 188   0.188</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a><span class="do">##      Tue 190   0.190</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a><span class="do">##      Wed 297   0.297</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use the Deviance Information Criterion (DIC) to evaluate whether the day means differ from each other.</p>
<p><span class="math display">\[
DIC = p_D + \overline{D(\theta)}
\]</span></p>
<p>where <span class="math inline">\(p_D = \overline{D(\theta)} - D(\hat{\theta})\)</span> and <span class="math inline">\(D(\theta) = -2 \log (f(y|\theta)) + C\)</span>.</p>
<p>Evaluate <span class="math inline">\(\overline{D(\theta)}\)</span> by producing samples from each distribution and evaluating the likelihoods of the data based on each realization and taking the mean of -2 log-likelihood.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reset the example. Sandwich counts by dow.</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">65</span>, <span class="dv">72</span>, <span class="dv">63</span>, <span class="dv">70</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Priors</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Posteriors</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rgamma</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span>y[<span class="dv">1</span>], b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">1</span>])),</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rgamma</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span>y[<span class="dv">2</span>], b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">2</span>])),</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rgamma</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span>y[<span class="dv">3</span>], b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">3</span>])),</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rgamma</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span>y[<span class="dv">4</span>], b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">4</span>])),</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rgamma</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span>y[<span class="dv">5</span>], b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">5</span>]))</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="co"># -2 * Mean log-likelihood</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>ll <span class="ot">&lt;-</span> </span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">1</span>], post[[<span class="dv">1</span>]], <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">2</span>], post[[<span class="dv">2</span>]], <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">3</span>], post[[<span class="dv">3</span>]], <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">4</span>], post[[<span class="dv">4</span>]], <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">5</span>], post[[<span class="dv">5</span>]], <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>(mean_D <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> ll))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 34.89608</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># D(theta-bar) is the likelihood of the data based on the posterior means of p.</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>(D_mean <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> (</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">1</span>], (a<span class="sc">+</span>y[<span class="dv">1</span>]) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">1</span>])), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">2</span>], (a<span class="sc">+</span>y[<span class="dv">2</span>]) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">2</span>])), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">3</span>], (a<span class="sc">+</span>y[<span class="dv">3</span>]) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">3</span>])), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">4</span>], (a<span class="sc">+</span>y[<span class="dv">4</span>]) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">4</span>])), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">5</span>], (a<span class="sc">+</span>y[<span class="dv">5</span>]) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">5</span>])), <span class="at">log =</span> <span class="cn">TRUE</span>) </span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 29.98793</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">#p_D and DIC from equation</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>(p_D <span class="ot">&lt;-</span> mean_D <span class="sc">-</span> D_mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.908155</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>(DIC <span class="ot">&lt;-</span> p_D <span class="sc">+</span> mean_D)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 39.80424</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Repeat these steps for a single model of all groups</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>post_group <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span><span class="fu">sum</span>(y), b<span class="sc">+</span><span class="fu">length</span>(y))</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>ll_group <span class="ot">&lt;-</span> </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">1</span>], post_group, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">2</span>], post_group, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">3</span>], post_group, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">4</span>], post_group, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">5</span>], post_group, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>(mean_D_group <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> ll_group))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 35.87018</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>(D_mean_group <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> (</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">1</span>], (a<span class="sc">+</span><span class="fu">sum</span>(y)) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y)), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">2</span>], (a<span class="sc">+</span><span class="fu">sum</span>(y)) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y)), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">3</span>], (a<span class="sc">+</span><span class="fu">sum</span>(y)) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y)), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">4</span>], (a<span class="sc">+</span><span class="fu">sum</span>(y)) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y)), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">5</span>], (a<span class="sc">+</span><span class="fu">sum</span>(y)) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y)), <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 34.81027</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>(p_D_group <span class="ot">&lt;-</span> mean_D_group <span class="sc">-</span> D_mean_group)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.059915</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>(DIC_group <span class="ot">&lt;-</span> p_D_group <span class="sc">+</span> mean_D_group)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 36.9301</code></pre>
</div>
</div>
<p>The DIC for the weekday specific model is 39.8042369 and for the one common group model it is 36.9300995. The DIC for one common group model is smaller, so we do not have enough statistical evidence for two groups.</p>
</section>
<section id="normal-and-estimating-means" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="normal-and-estimating-means"><span class="header-section-number">3.5</span> Normal and Estimating Means</h2>
<section id="normal-pop-est" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="normal-pop-est"><span class="header-section-number">3.5.1</span> Population Estimate</h3>
<p>Suppose you have a sample, <span class="math inline">\(\textbf{y}\)</span>, from a normally distribution population of unknown mean and precision, <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\tau\)</span>: <span class="math inline">\(y_i|\mu, \tau \sim N(\mu, \tau)\)</span>.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> Assume a normal prior for <span class="math inline">\(\mu \sim N(\mu_0, \tau_0)\)</span>, and a gamma prior for <span class="math inline">\(\tau \sim \text{Gamma}(a, b)\)</span> since it takes only positive values. The PDF for <span class="math inline">\(y_i\)</span> is <span class="math inline">\(f(y_i | \mu, \tau) = \frac{\tau^{.5}}{\sqrt{2\pi}} \exp\left(-\frac{\tau}{2} (y_i - \mu)^2 \right)\)</span>. We’ll derive posterior distributions for <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\tau\)</span> separately.</p>
<p>Using Bayes’ Theorem, the posterior distribution of <span class="math inline">\(\mu|y\)</span> is the joint likelihood of <span class="math inline">\(y\)</span> and <span class="math inline">\(\mu\)</span> divided by the likelihood of <span class="math inline">\(y\)</span>,</p>
<p><span class="math display">\[
f(\mu|y) = \frac{f(y|\mu)f(\mu)}{\int_\mu f(y|\mu)f(\mu)d\mu}
\]</span></p>
<p>The conditional likelihood, <span class="math inline">\(f(\mu|y)\)</span>, is the sum-product of the normal distribution PDF. We can take <span class="math inline">\(\tau\)</span> as given initially.</p>
<p><span class="math display">\[
\begin{align}
f(y|\mu) &amp;= \prod_i \frac{\tau^{(1/2)}}{\sqrt{2\pi}} \exp\left(-\frac{\tau}{2} (y_i - \mu)^2 \right) \\
&amp;\propto \prod_i \exp\left(-\frac{\tau}{2} (y_i - \mu)^2 \right) \\
&amp;\propto \exp \left( -\frac{\tau}{2} \sum_i(y_i - \mu)^2 \right)
\end{align}
\]</span></p>
<p>The prior PDF for <span class="math inline">\(\mu\)</span> is the normal distribution. Again we take <span class="math inline">\(\tau\)</span> as given initially.</p>
<p><span class="math display">\[
\begin{align}
f(\mu) &amp;= \frac{\tau_0^{1/2}}{\sqrt{2\pi}} \exp\left(-\frac{\tau_0}{2} (\mu - \mu_0)^2 \right) \\
&amp;\propto \exp\left(-\frac{\tau_0}{2} (\mu - \mu_0)^2 \right)  
\end{align}
\]</span></p>
<p>Substitute into Bayes’ Theorem. Since we are working with proportions, we can throw out the denominator and say <span class="math inline">\(f(\mu|y) \propto f(y|\mu)f(\mu)\)</span>. Plugging in and solving, we get</p>
<p><span class="math display">\[
\begin{equation}
\mu|y \sim N\left(\frac{n\tau\bar{y} + \tau_0\mu_0}{n\tau + \tau_0}, n\tau + \tau_0 \right)
(\#eq:mu-posterior)
\end{equation}
\]</span></p>
<p>Using Bayes’ Theorem, the posterior distribution of <span class="math inline">\(\tau|y\)</span> is the joint likelihood of <span class="math inline">\(y\)</span> and <span class="math inline">\(\tau\)</span> divided by the likelihood of <span class="math inline">\(y\)</span>,</p>
<p><span class="math display">\[
f(\tau|y) = \frac{f(y|\tau)f(\tau)}{\int_\tau f(y|\mu)f(\tau)d\tau}
\]</span></p>
<p>The conditional likelihood, <span class="math inline">\(f(\tau|y)\)</span>, is the sum-product of the gamma distribution PDF. This time we take <span class="math inline">\(\mu\)</span> as given.</p>
<p><span class="math display">\[
\begin{align}
f(y|\tau) &amp;= \prod_i \frac{\tau^{(1/2)}}{\sqrt{2\pi}} \exp\left(-\frac{\tau}{2} (y_i - \mu)^2 \right) \\
&amp;= \frac{\tau^{n/2}}{(2\pi)^{n/2}} \exp\left(-\frac{\tau}{2} \sum_i (y_i - \mu)^2 \right) \\
&amp;\propto \tau^{n/2} \exp \left( -\frac{\tau}{2} \sum_i(y_i - \mu)^2 \right)
\end{align}
\]</span></p>
<p>The prior PDF for <span class="math inline">\(\tau\)</span> is the gamma distribution. Pull the constant out to work with proportionality.</p>
<p><span class="math display">\[
\begin{align}
f(\tau) &amp;= \frac{b^a \tau^{a-1} e^{-b\tau}}{\Gamma(a)} \\
&amp;\propto \tau^{a-1}e^{-b\tau}
\end{align}
\]</span></p>
<p>Substitute into Bayes’ Theorem. Since we are working with proportions, we can throw out the denominator and say <span class="math inline">\(f(\tau|y) \propto f(y|\tau)f(\tau)\)</span>. Plugging in and solving, we get</p>
<p><span class="math display">\[
\begin{equation}
\tau|y \sim \text{Gamma}\left(a + n/2, b + \frac{1}{2} \sum_i(y_i - \mu)^2 \right)
(\#eq:tau-posterior)
\end{equation}
\]</span></p>
<p>We have <span class="math inline">\(y_i|\mu,\tau \sim N(\mu,\tau)\)</span> with conjugate priors <span class="math inline">\(\mu \sim N(\mu_0, \tau_0)\)</span> and <span class="math inline">\(\tau \sim \text{Gamma}(a,b)\)</span> and conditional posterior distributions shown in Eqns @ref(eq:mu-posterior) and @ref(eq:tau-posterior). Returning to Eqn @ref(eq:mu-posterior), you can see how <span class="math inline">\(E[\mu] \rightarrow \bar{y}\)</span> as the sample size grows. Below, the terms divided by <span class="math inline">\(n\)</span> disappear, leaving just <span class="math inline">\(\bar{y}\)</span>.</p>
<p><span class="math display">\[
\begin{align}
E[\mu|\tau, y] &amp;= \frac{n\tau\bar{y} + \tau_0\mu_0}{n\tau + \tau_0} \\
&amp;= \frac{\bar{y}\tau + \mu_0\tau_0/n}{\tau + \tau_0/n} \\
&amp;\sim \bar{y}
\end{align}
\]</span></p>
<p>The posterior mean estimator of <span class="math inline">\(\tau\)</span> is the ratio of the posterior gamma distribution parameters. Again, as the sample size increases, terms divided by <span class="math inline">\(n\)</span> disappear.</p>
<p><span class="math display">\[
\begin{align}
E[\tau|\mu,y] &amp;= \frac{a + n/2}{b + \frac{1}{2} \sum_i(y_i - \mu)^2} \\
&amp;= \frac{2a/n + 1}{2b/n + \sum_i(y_i - \mu)^2 / n} \\
&amp;\sim \frac{1}{\sum_i(y_i - \mu)^2}
\end{align}
\]</span></p>
<p>The problem here is that you never know <span class="math inline">\(\mu\)</span> or <span class="math inline">\(\tau\)</span>, so you cannot use the posterior formulas directly. Instead, you need to use sampling. In particular, you use the <em>Gibbs sampler</em>. Set <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\tau\)</span> to some initial values and use the posterior equations to estimate new values for <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\tau\)</span>, then repeat. This is called Markov Chain Monte Carlo (MCMC) simulation because you are chaining the simulations. The method of sampling from a conditional posterior is called the Gibbs sampler.</p>
<p>Let’s apply this using anthropological data collected by Nancy Howell of human height.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># downloaded this from </span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/rmcelreath/rethinking/blob/master/data/Howell1.csv</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>howell <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(<span class="st">"input/Howell1.csv"</span>, <span class="at">delim =</span> <span class="st">";"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age <span class="sc">&gt;=</span> <span class="dv">18</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">male =</span> <span class="fu">factor</span>(male, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"women"</span>, <span class="st">"men"</span>)))</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>howell <span class="sc">%&gt;%</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> height, <span class="at">color =</span> male)) <span class="sc">+</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq</span>() <span class="sc">+</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_qq_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From prior knowledge, we know average human height is about <span class="math inline">\(175 \pm 10\)</span> cm. Using the <span class="math inline">\(\pm\)</span> = 2SD, the variance <span class="math inline">\(5^2\)</span>. Use vague priors of <span class="math inline">\(\mu \sim N(\mu_0 = 175, \tau_0 = 1/5^2)\)</span> and <span class="math inline">\(\tau = \sim \text{Gamma}(a = .01, b = .01)\)</span>. Start by assigning starting values, <span class="math inline">\(\mu*\)</span> and <span class="math inline">\(\tau*\)</span>). Given <span class="math inline">\(\tau = \tau*\)</span>, sample a new value of <span class="math inline">\(\mu*\)</span> from the normal distribution. Given <span class="math inline">\(\mu = \mu*\)</span>, sample a new value of <span class="math inline">\(\tau*\)</span> from the gamma distribution. Then repeat.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>gibbs_normal <span class="ot">&lt;-</span> <span class="cf">function</span>(y, mu_0, tau_0, a, b, n_iter){</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  y_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(y)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  mu_sample <span class="ot">&lt;-</span> tau_sample <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_iter)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># starting values</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  mu_sample[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(y)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  tau_sample[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">var</span>(y)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gibbs sampler</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n_iter){</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mu</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    tau <span class="ot">&lt;-</span> tau_sample[i<span class="dv">-1</span>]</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    mean_mu <span class="ot">&lt;-</span> (n <span class="sc">*</span> y_mean <span class="sc">*</span> tau <span class="sc">+</span> mu_0 <span class="sc">*</span> tau_0) <span class="sc">/</span> (n <span class="sc">*</span> tau <span class="sc">+</span> tau_0)</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>    precision_mu <span class="ot">&lt;-</span> n <span class="sc">*</span> tau <span class="sc">+</span> tau_0</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    mu_sample[i] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mean_mu, <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(precision_mu))</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tau</span></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> mu_sample[i<span class="dv">-1</span>]</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    tau_sample[i] <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, a <span class="sc">+</span> n<span class="sc">/</span><span class="dv">2</span>, b <span class="sc">+</span> .<span class="dv">5</span> <span class="sc">*</span> <span class="fu">sum</span>((y <span class="sc">-</span> mu)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mu =</span> mu_sample, <span class="at">tau =</span> tau_sample))</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>sample_m <span class="ot">&lt;-</span> <span class="fu">gibbs_normal</span>(howell[howell<span class="sc">$</span>male <span class="sc">==</span> <span class="st">"men"</span>,]<span class="sc">$</span>height, <span class="dv">175</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">5</span><span class="sc">^</span><span class="dv">2</span>, .<span class="dv">01</span>, .<span class="dv">01</span>, <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>sample_w <span class="ot">&lt;-</span> <span class="fu">gibbs_normal</span>(howell[howell<span class="sc">$</span>male <span class="sc">==</span> <span class="st">"women"</span>,]<span class="sc">$</span>height, <span class="dv">175</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">5</span><span class="sc">^</span><span class="dv">2</span>, .<span class="dv">01</span>, .<span class="dv">01</span>, <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior mu</span></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(sample_m<span class="sc">$</span>mu); <span class="fu">quantile</span>(sample_m<span class="sc">$</span>mu, <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>))</span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 160.5146</span></span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a><span class="do">##     2.5%    97.5% </span></span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a><span class="do">## 159.6103 161.4231</span></span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(sample_w<span class="sc">$</span>mu); <span class="fu">quantile</span>(sample_w<span class="sc">$</span>mu, <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>))</span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 149.6363</span></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a><span class="do">##     2.5%    97.5% </span></span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a><span class="do">## 148.9256 150.3641</span></span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior probability that men are taller than women on average</span></span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(sample_m<span class="sc">$</span>mu <span class="sc">&gt;</span> sample_w<span class="sc">$</span>mu)</span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1</span></span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior probability that a random man is taller than a random woman</span></span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>tilde_m <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, <span class="fu">mean</span>(sample_m<span class="sc">$</span>mu), <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span><span class="fu">mean</span>(sample_m<span class="sc">$</span>tau)))</span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>tilde_w <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, <span class="fu">mean</span>(sample_w<span class="sc">$</span>mu), <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span><span class="fu">mean</span>(sample_w<span class="sc">$</span>tau)))</span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(tilde_m <span class="sc">&gt;</span> tilde_w)</span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.909</span></span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, <span class="dv">2</span>),</span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">sex =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"men"</span>, <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>), <span class="fu">rep</span>(<span class="st">"women"</span>, <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>)),</span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu =</span> <span class="fu">c</span>(sample_m<span class="sc">$</span>mu, sample_w<span class="sc">$</span>mu),</span>
<span id="cb62-54"><a href="#cb62-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">tau =</span> <span class="fu">c</span>(sample_m<span class="sc">$</span>tau, sample_w<span class="sc">$</span>tau),</span>
<span id="cb62-55"><a href="#cb62-55" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb62-56"><a href="#cb62-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(mu, tau)) <span class="sc">%&gt;%</span> </span>
<span id="cb62-57"><a href="#cb62-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> sex)) <span class="sc">+</span> </span>
<span id="cb62-58"><a href="#cb62-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span> </span>
<span id="cb62-59"><a href="#cb62-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="at">facets =</span> <span class="fu">vars</span>(name), <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb62-60"><a href="#cb62-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Posterior Distributions"</span>, <span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">color =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, <span class="dv">2</span>),</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">sex =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"men"</span>, <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>), <span class="fu">rep</span>(<span class="st">"women"</span>, <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>)),</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">tilde =</span> <span class="fu">c</span>(tilde_m, tilde_w)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> tilde, <span class="at">color =</span> sex)) <span class="sc">+</span> </span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span> </span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Posterior Predictive Distributions"</span>, <span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">color =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-33-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It may take some time to converge on a solution. This convergence is called <em>burn-in</em> and is often discarded when describing the posterior. <em>Slow mixing</em> may occur if there is high autocorrelation in the Gibbs sample, resulting in slow exploration of the sample space of the posterior.</p>
</section>
<section id="regression" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="regression"><span class="header-section-number">3.5.2</span> Regression</h3>
<p>The linear model in Bayesian statistics is</p>
<p>Likelihood:</p>
<p><span class="math display">\[
y_i | \mu_i, \tau \sim N(\mu_i, \tau)
\]</span></p>
<p>where</p>
<p><span class="math display">\[
\mu_i | x_i, \beta_0, \beta_1 = \beta_0 + \beta_1 x
\]</span></p>
<p>Priors:</p>
<p><span class="math display">\[
\begin{align}
\beta_0 &amp; \sim N(0, 10^{-8}) \\
\beta_1 &amp; \sim N(0, 10^{-8}) \\
\tau &amp; \sim \text{Gamma}(.01, .01)
\end{align}
\]</span></p>
<p>Returning to the Howell data, suppose you want to fit a linear model, <span class="math inline">\(\text{Weight}_i = a + b \text{Height} + \epsilon_i\)</span>. In Bayesian regression, this is expressed as <span class="math inline">\(\text{Weight} | \mu_i \sim N(\mu_i, \tau)\)</span> where <span class="math inline">\(\mu_i = a + b\text{Height}\)</span>. You can construct a Gibbs sampler to estimate the model, but there is already a package for that, MCMCglmm.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MCMCglmm)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>mdl_1 <span class="ot">&lt;-</span> <span class="fu">MCMCglmm</span>(</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  weight <span class="sc">~</span> height, </span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> howell,</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">nitt =</span> <span class="dv">11000</span>, <span class="co"># iterations</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">burnin =</span> <span class="dv">1000</span>, <span class="co"># burn-in period to throw out</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span>, </span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># could omit this prior since it is non-informative</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">list</span>(<span class="at">B =</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">V =</span> <span class="fu">c</span>(<span class="dv">100</span><span class="sc">^</span><span class="dv">2</span>, <span class="dv">100</span><span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span><span class="fu">diag</span>(<span class="dv">2</span>))),</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mdl_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Iterations = 1001:10991
 Thinning interval  = 10
 Sample size  = 1000 

 DIC: 2020.205 

 R-structure:  ~units

      post.mean l-95% CI u-95% CI eff.samp
units     18.16    15.73    20.81     1000

 Location effects: weight ~ height 

            post.mean l-95% CI u-95% CI eff.samp  pMCMC    
(Intercept)  -52.5503 -61.9377 -44.0584   1000.0 &lt;0.001 ***
height         0.6309   0.5717   0.6874    912.8 &lt;0.001 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Probability beta is &gt;0</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(mdl_1<span class="sc">$</span>Sol[, <span class="dv">2</span>] <span class="sc">&gt;</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior inference.</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>new_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">height =</span> <span class="fu">seq</span>(<span class="dv">130</span>, <span class="dv">185</span>, .<span class="dv">1</span>), <span class="at">weight =</span> <span class="dv">0</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>cred_intvl <span class="ot">&lt;-</span> <span class="fu">predict</span>(mdl_1, <span class="at">newdata =</span> , <span class="at">type =</span> <span class="st">"response"</span>, <span class="at">interval =</span> <span class="st">"confidence"</span>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>pred_intvl <span class="ot">&lt;-</span> <span class="fu">predict</span>(mdl_1, <span class="at">newdata =</span> , <span class="at">type =</span> <span class="st">"response"</span>, <span class="at">interval =</span> <span class="st">"prediction"</span>)</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>howell <span class="sc">%&gt;%</span> </span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(cred_intvl, pred_intvl, <span class="at">.name_repair =</span> <span class="st">"unique"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> height)) <span class="sc">+</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="st">`</span><span class="at">lwr...9</span><span class="st">`</span>, <span class="at">ymax =</span> <span class="st">`</span><span class="at">upr...10</span><span class="st">`</span>), <span class="at">fill =</span> <span class="st">"lightgoldenrod"</span>, <span class="at">alpha =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="st">`</span><span class="at">lwr...6</span><span class="st">`</span>, <span class="at">ymax =</span> <span class="st">`</span><span class="at">upr...7</span><span class="st">`</span>), <span class="at">fill =</span> <span class="st">"goldenrod"</span>, <span class="at">alpha =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="st">`</span><span class="at">fit...5</span><span class="st">`</span>), <span class="at">color =</span> <span class="st">"goldenrod"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> weight)) <span class="sc">+</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"weight"</span>, <span class="at">title =</span> <span class="st">"95% CI and PI."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can extend this to multivariate models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>mdl_2 <span class="ot">&lt;-</span> <span class="fu">MCMCglmm</span>(</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  weight <span class="sc">~</span> height<span class="sc">*</span>male, </span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> howell,</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">nitt =</span> <span class="dv">11000</span>, <span class="co"># iterations</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">burnin =</span> <span class="dv">1000</span>, <span class="co"># burn-in period to throw out</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span>, </span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#prior = list(B = list(mu = c(0, 0), V = c(100^2, 100^2)*diag(2))), </span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Bayesian statistics has its analog to Akaike’s Information Criterion (AIC) called Deviance Information Criterion (DIC).</p>
<p><span class="math display">\[
DIC = p_D + \overline{D(\theta)}
\]</span></p>
<p>where <span class="math inline">\(p_D = \overline{D(\theta)} - D(\hat{\theta})\)</span> and <span class="math inline">\(D(\theta) = -2 \log (f(y|\theta)) + C\)</span>. The value of DIC has no real meaning, but for comparison purposes, lower is better. A difference of at least 3 is considered sufficient evidence to choose one model over another. Here, <code>mdl_1$DIC</code> = 2020.2047497 and <code>mdl_2$DIC</code> = 2023.9678623. The first model is better, so conclude that there is no statistical evidence that the correlation between weight and height depends on sex (<span class="math inline">\(\Delta\)</span>DIC = 3.7631126).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>mdl_3 <span class="ot">&lt;-</span> <span class="fu">MCMCglmm</span>(</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  weight <span class="sc">~</span> age, </span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> howell,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">nitt =</span> <span class="dv">11000</span>, <span class="co"># iterations</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">burnin =</span> <span class="dv">1000</span>, <span class="co"># burn-in period to throw out</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span>, </span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#prior = list(B = list(mu = c(0, 0), V = c(100^2, 100^2)*diag(2))), </span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mdl_3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Iterations = 1001:10991
 Thinning interval  = 10
 Sample size  = 1000 

 DIC: 2306.323 

 R-structure:  ~units

      post.mean l-95% CI u-95% CI eff.samp
units     40.94    35.44    47.38     1000

 Location effects: weight ~ age 

            post.mean l-95% CI u-95% CI eff.samp  pMCMC    
(Intercept)  47.85552 46.15454 49.74972     1000 &lt;0.001 ***
age          -0.06938 -0.10614 -0.02511     1000 &lt;0.001 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>mdl_1<span class="sc">$</span>DIC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2020.205</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>mdl_3<span class="sc">$</span>DIC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2306.323</code></pre>
</div>
</div>
</section>
<section id="generalized-linear-models" class="level3" data-number="3.5.3">
<h3 data-number="3.5.3" class="anchored" data-anchor-id="generalized-linear-models"><span class="header-section-number">3.5.3</span> Generalized Linear Models</h3>
<p>The generalized linear model in Bayesian statistics is</p>
<p>Likelihood:</p>
<p><span class="math display">\[
y_i | \mu_i, \tau \sim D(\mu_i)
\]</span></p>
<p>where</p>
<p><span class="math display">\[
g(\mu_i | x_i, \beta_0, \beta_1) = \beta_0 + \beta_1 x
\]</span></p>
<p>Priors:</p>
<p><span class="math display">\[
\begin{align}
\beta_0 &amp; \sim N(0, 10^{-8}) \\
\beta_1 &amp; \sim N(0, 10^{-8}) \\
\end{align}
\]</span></p>
<p>Consider a binary response <span class="math inline">\(y_i\)</span>. You would typically model this with logistic regression:</p>
<p><span class="math inline">\(y_i | p_i \sim \text{BIN}(1, p_i)\)</span> where <span class="math inline">\(\log \left( \frac{p_i}{1 - p_i} \right) = \beta_0 + \beta_1 x_i\)</span>. In bivariate statistics, if <span class="math inline">\(x_i\)</span> perfectly predicts <span class="math inline">\(y_i\)</span>, <em>separation of variables</em> has occurred. Here’s an example of separation of variables. In the regression, the standard errors are huge, so the p.value is nearly 1. The classical regression framework has broken down.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>study <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"input/hours_of_study_data.csv"</span>, <span class="at">col_types =</span> <span class="st">"dc"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">factor</span>(y)) <span class="sc">%&gt;%</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>study <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> HoursOfStudy, <span class="at">y =</span> y)) <span class="sc">+</span> <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm</span>(y <span class="sc">~</span> HoursOfStudy, <span class="at">data =</span> study, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Call:</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="do">## glm(formula = y ~ HoursOfStudy, family = "binomial", data = study)</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Coefficients:</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a><span class="do">##              Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="do">## (Intercept)   -1303.9   442563.5  -0.003    0.998</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a><span class="do">## HoursOfStudy     13.1     4448.4   0.003    0.998</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a><span class="do">## (Dispersion parameter for binomial family taken to be 1)</span></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a><span class="do">##     Null deviance: 6.8029e+01  on 49  degrees of freedom</span></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a><span class="do">## Residual deviance: 1.6529e-08  on 48  degrees of freedom</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a><span class="do">## AIC: 4</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a><span class="do">## Number of Fisher Scoring iterations: 25</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The Bayesian framework performs better.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a> m.bayes <span class="ot">&lt;-</span> <span class="fu">MCMCglmm</span>(y <span class="sc">~</span> HoursOfStudy, <span class="at">data =</span> study, <span class="at">family =</span> <span class="st">"categorical"</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Iterations = 3001:12991
 Thinning interval  = 10
 Sample size  = 1000 

 DIC: 2.652789 

 R-structure:  ~units

      post.mean l-95% CI u-95% CI eff.samp
units     9.636 0.008661    44.84    24.55

 Location effects: y ~ HoursOfStudy 

             post.mean  l-95% CI  u-95% CI eff.samp  pMCMC    
(Intercept)  -189.9191 -289.2550  -66.7212    1.966 &lt;0.001 ***
HoursOfStudy    1.9036    0.6402    2.8894    1.889 &lt;0.001 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>Each hour of study is associated with an <span class="math inline">\(\exp (1.9036) \sim 6.7\)</span>-fold increase in the odds of passing. The posterior probability that the association is positive is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(m.bayes<span class="sc">$</span>Sol[, <span class="dv">2</span>] <span class="sc">&gt;</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<p>Let’s try another example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>chase <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"input/TheChase.txt"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="co"># focus on Mark</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>mark <span class="ot">&lt;-</span> chase <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Chaser <span class="sc">==</span> <span class="st">"Mark"</span>)</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>mark <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> TeamScore, <span class="at">y =</span> Win)) <span class="sc">+</span> <span class="fu">geom_jitter</span>(<span class="at">width =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Notice: most scores are between 10 and 25, winning is less common than losing, and winning is more common with higher scores. Fit the following model: <span class="math inline">\(y_i \sim \text{Bin}(1, p_i)\)</span> where <span class="math inline">\(\text{logit}(p_i) = \beta_0 + \beta_1 x_i\)</span> and <span class="math inline">\(x_i\)</span> is the mean score of game <span class="math inline">\(i\)</span>. Assume non-informative normal priors: <span class="math inline">\(\beta_0 \sim N(0, 10^{-8})\)</span> and <span class="math inline">\(\beta_1 \sim N(0, 10^{-8})\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This will take ~1 min</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">stan_glm</span>(Win <span class="sc">~</span> TeamScore, <span class="at">data =</span> mark, </span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>), </span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">prior =</span> <span class="fu">normal</span>(<span class="at">location=</span><span class="dv">0</span>, <span class="at">scale=</span><span class="dv">10</span><span class="sc">^</span><span class="dv">4</span>),</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">prior_intercept =</span> <span class="fu">normal</span>(<span class="at">location=</span><span class="dv">0</span>, <span class="at">scale=</span><span class="dv">10</span><span class="sc">^</span><span class="dv">4</span>),</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">chains=</span><span class="dv">1</span>, <span class="at">iter=</span> <span class="dv">1500</span>,</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span> <span class="dv">12345</span>, <span class="at">refresh=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>m1post <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(m1)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m1post[,<span class="dv">1</span>],<span class="at">ty=</span><span class="st">'l'</span>,<span class="at">ylab=</span><span class="fu">expression</span>(beta[<span class="dv">0</span>]))</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(m1post[,<span class="dv">1</span>]),<span class="at">xlab=</span><span class="fu">expression</span>(beta[<span class="dv">0</span>]),<span class="at">main=</span><span class="st">''</span>)</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m1post[,<span class="dv">2</span>],<span class="at">ty=</span><span class="st">'l'</span>,<span class="at">ylab=</span><span class="fu">expression</span>(beta[<span class="dv">1</span>]))</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(m1post[,<span class="dv">2</span>]),<span class="at">xlab=</span><span class="fu">expression</span>(beta[<span class="dv">1</span>]),<span class="at">main=</span><span class="st">''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The traces look converged, and the estimated posterior densities look smooth.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>df.summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="at">p.means =</span> <span class="fu">round</span>(<span class="fu">apply</span>(m1post,<span class="dv">2</span>,mean),<span class="dv">4</span>),</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="at">p.ci.lo =</span> <span class="fu">round</span>(<span class="fu">apply</span>(m1post,<span class="dv">2</span>,quantile,.<span class="dv">025</span>),<span class="dv">4</span>),</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="at">p.ci.hi =</span> <span class="fu">round</span>(<span class="fu">apply</span>(m1post,<span class="dv">2</span>,quantile,.<span class="dv">975</span>),<span class="dv">4</span>))</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(df.summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            p.means  p.ci.lo p.ci.hi
(Intercept) -9.2615 -11.9893 -6.9141
TeamScore    0.4351   0.3175  0.5711</code></pre>
</div>
</div>
<p>There is a positive correlation between the Team Score and the odds of winning. Calculate the posterior probability.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(m1post[, <span class="dv">2</span>] <span class="sc">&gt;</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<p>Compare this to the classical result. They are pretty close.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  m1c <span class="ot">&lt;-</span> <span class="fu">glm</span>(Win <span class="sc">~</span> TeamScore, <span class="at">data =</span> mark, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = Win ~ TeamScore, family = "binomial", data = mark)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -8.99425    1.28162  -7.018 2.25e-12 ***
TeamScore    0.42199    0.06615   6.379 1.78e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 261.45  on 245  degrees of freedom
Residual deviance: 195.35  on 244  degrees of freedom
AIC: 199.35

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>Let’s also plot the estimated model on a grid of possible Team Score values. Recall <span class="math inline">\(p = \frac{1}{1 + e^{-z}}\)</span>,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># setting a grid of values</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>TeamScoreGrid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">30</span>)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="co"># using posterior samples of beta0 and beta1</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="co"># to produce a posterior sample of probabilities at each value of TeamScoreGrid</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>p.eval <span class="ot">&lt;-</span> <span class="cf">function</span>(Score,b0,b1){<span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>(b0<span class="sc">+</span>b1<span class="sc">*</span>Score)))}</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>p.sample <span class="ot">&lt;-</span> <span class="fu">sapply</span>(TeamScoreGrid,p.eval,<span class="at">b0=</span>m1post[,<span class="dv">1</span>],<span class="at">b1=</span>m1post[,<span class="dv">2</span>])</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a><span class="co"># evaluating posterior mean probability for each score:</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>p.post.mean <span class="ot">&lt;-</span> <span class="fu">apply</span>(p.sample,<span class="dv">2</span>,mean)</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a><span class="co"># evaluating 95% CI for the probability for each score:</span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>p.post.lo <span class="ot">&lt;-</span> <span class="fu">apply</span>(p.sample,<span class="dv">2</span>,quantile,.<span class="dv">025</span>)</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>p.post.hi <span class="ot">&lt;-</span> <span class="fu">apply</span>(p.sample,<span class="dv">2</span>,quantile,.<span class="dv">975</span>)</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>data.post <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">TeamScore=</span>TeamScoreGrid, <span class="at">p.mn=</span>p.post.mean,</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>                        <span class="at">p.lo=</span>p.post.lo, <span class="at">p.hi=</span>p.post.hi)</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>mark,<span class="fu">aes</span>(<span class="at">x=</span>TeamScore,<span class="at">y=</span><span class="fu">jitter</span>(Win)))<span class="sc">+</span></span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data=</span>data.post,<span class="fu">aes</span>(<span class="at">x=</span>TeamScore,<span class="at">y=</span>p.mn,<span class="at">ymin=</span>p.lo,<span class="at">ymax=</span>p.hi),<span class="at">alpha=</span>.<span class="dv">5</span>,<span class="at">fill=</span><span class="st">'salmon'</span>) <span class="sc">+</span></span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span>data.post,<span class="fu">aes</span>(<span class="at">x=</span>TeamScore,<span class="at">y=</span>p.mn),<span class="at">col=</span><span class="st">'red'</span>, <span class="at">linewidth=</span><span class="fl">1.5</span>)<span class="sc">+</span></span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">'Outcome'</span>)<span class="sc">+</span></span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">name=</span><span class="st">''</span>, <span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">labels=</span><span class="fu">c</span>(<span class="st">'Lose'</span>,<span class="st">'Win'</span>),</span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis=</span><span class="fu">sec_axis</span>(<span class="sc">~</span>., <span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,.<span class="dv">2</span>),</span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">name=</span><span class="st">'Probability of Winning'</span>))<span class="sc">+</span></span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">30</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>data.post<span class="sc">$</span>TeamScore[<span class="fu">which</span>(data.post<span class="sc">$</span>ppp <span class="sc">&gt;=</span> .<span class="dv">80</span>)][<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] NA</code></pre>
</div>
</div>
<p>What is the posterior probability that a team score of 25 beats Mark?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">p.eval</span>(<span class="at">Score =</span> <span class="dv">25</span>, <span class="at">b0 =</span> m1post[,<span class="dv">1</span>], <span class="at">b1 =</span> m1post[,<span class="dv">2</span>]) <span class="sc">%&gt;%</span> <span class="fu">mean</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8270518</code></pre>
</div>
</div>
<p>What score do you need in order to win with 80% certainty, <span class="math inline">\(P(y = 1|x) \ge .8)\)</span>. For each <span class="math inline">\(x\)</span> on a grid, take the posterior sample for <span class="math inline">\(p\)</span> and generate <span class="math inline">\(y = \text{Bern}(p)\)</span>. Then get <span class="math inline">\(prob(y == 1)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># simulating the game outcomes (y)</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>y.sample <span class="ot">&lt;-</span> (<span class="fu">array</span>(<span class="fu">runif</span>(<span class="fu">prod</span>(<span class="fu">dim</span>(p.sample))),<span class="at">dim=</span><span class="fu">dim</span>(p.sample)) <span class="sc">&lt;</span> p.sample)<span class="sc">*</span><span class="dv">1</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior predictive probabilities that y=1</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>data.post<span class="sc">$</span>ppp <span class="ot">&lt;-</span> <span class="fu">apply</span>(y.sample,<span class="dv">2</span>,mean)</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>data.post,<span class="fu">aes</span>(<span class="at">x=</span>TeamScore,<span class="at">y=</span>ppp))<span class="sc">+</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">col=</span><span class="st">'red'</span>,<span class="at">size=</span><span class="fl">1.5</span>)<span class="sc">+</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept=</span><span class="fl">0.80</span>),<span class="at">col=</span><span class="st">'blue'</span>,<span class="at">size=</span><span class="fl">1.2</span>,<span class="at">lty=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="dv">24</span>),<span class="at">col=</span><span class="st">'brown'</span>,<span class="at">size=</span><span class="fl">1.1</span>,<span class="at">lty=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="dv">25</span>),<span class="at">col=</span><span class="st">'brown'</span>,<span class="at">size=</span><span class="fl">1.1</span>,<span class="at">lty=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">'Post. Pred. Prob. of Winning'</span>)<span class="sc">+</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">30</span>))<span class="sc">+</span><span class="fu">theme_gray</span>(<span class="at">base_size=</span><span class="dv">18</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="missing-data" class="level3" data-number="3.5.4">
<h3 data-number="3.5.4" class="anchored" data-anchor-id="missing-data"><span class="header-section-number">3.5.4</span> Missing Data</h3>
<p>Consider a situation where 20 customers are surveyed to measure satisfaction. You can model this as <span class="math inline">\(x_i | p \sim \text{Bin}(1, p)\)</span> where <span class="math inline">\(p\)</span> is the probability of satisfaction. The conjugate prior for <span class="math inline">\(p\)</span> is <span class="math inline">\(p \sim \text{Beta}(a, b)\)</span>. However, some observations are missing. You can divide the respondents into <span class="math inline">\(x_{obs}\)</span> and <span class="math inline">\(x_{miss}\)</span>. Then</p>
<p><span class="math display">\[
f(x|p) = \prod_i f(x_i|p) = f(x_{obs}|p) f(x_{miss}|p)
\]</span></p>
<p>When missingness is random, you can smiply discard missing observations. So if there were 4 missing responses, and 10 of the 16 completed surveys were satisfied, <span class="math inline">\(p|x_{obs} \sim \text{Beta}(1 + 10, 1 + 6)\)</span>. The Beta-bimomial conjugate model is</p>
<p><span class="math display">\[
\begin{align}
x_i &amp; \sim \text{Bin}(1, p) \\
p &amp; \sim \text{Beta}(a, b)
\end{align}
\]</span></p>
<p>with posterior <span class="math inline">\(p | x \sim \text{Beta} \left( a + \sum_i x_i, b + \sum_i (1 - x_i) \right)\)</span></p>
<p>But if the data are not missing at random, you need to model the probability of participating. From past experience you might infer that participation rates are 30% for satisfied and 90% for dissatisfied.</p>
<p><span class="math display">\[
\begin{align}
P(z_i = 1 | x_i = 1) &amp;= .3 \\
P(z_i = 1 | x_i = 0) &amp;= .9
\end{align}
\]</span></p>
<p>Combining them, you have <span class="math inline">\(P(x_i = 1 | z_i = 0, p) = \frac{7p}{6p + 1}\)</span>. Set up a Gibbs sampler. Step 0: assign random prior values to the missing <span class="math inline">\(x\)</span>. Step 1: given <span class="math inline">\(x\)</span>, sample <span class="math inline">\(p\)</span> from <span class="math inline">\(\text{Beta}(a + \sum_i x_i, b + \sum_i (1 - x_i))\)</span>. Step 2: given <span class="math inline">\(p\)</span>, assign the missing <span class="math inline">\(x\)</span> to 1 with probability <span class="math inline">\(p|x_{obs} \sim \text{Beta}(1 + 10, 1 + 6)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prior parameters</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">1</span>; b <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="co"># data</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="cn">NA</span>),<span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">6</span>,<span class="dv">4</span>))</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">0</span>,<span class="fu">c</span>(<span class="dv">16</span>,<span class="dv">4</span>))</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="co"># initial values.</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>x.sample <span class="ot">&lt;-</span> x; x.sample[<span class="fu">is.na</span>(x)] <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">size=</span><span class="dv">4</span>,<span class="at">replace=</span>T)</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a><span class="co"># number of iterations</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">4</span><span class="sc">+</span><span class="dv">500</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a><span class="co"># and the monitor for recording the iterations of p</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>mon.p <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ... and one of the missing observations</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>mon.x20 <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Gibbs sampler:</span></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>ITER){</span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sampling p</span></span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>  mon.p[iter] <span class="ot">&lt;-</span> p <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(<span class="dv">1</span>,a<span class="sc">+</span><span class="fu">sum</span>(x.sample),b<span class="sc">+</span><span class="fu">sum</span>(<span class="dv">1</span><span class="sc">-</span>x.sample))</span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sampling (missing x)</span></span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a>  x.sample[<span class="fu">is.na</span>(x)] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="fu">sum</span>(<span class="fu">is.na</span>(x)),<span class="dv">1</span>,<span class="dv">7</span><span class="sc">*</span>p<span class="sc">/</span>(<span class="dv">6</span><span class="sc">*</span>p<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>    mon.x20[iter] <span class="ot">&lt;-</span> x.sample[<span class="dv">20</span>]</span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prior parameters</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">1</span>; b <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="co"># data: 40 satisfied, 10 not satisfied, 50 no-responses</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="cn">NA</span>),<span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">10</span>,<span class="dv">50</span>))</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">0</span>,<span class="fu">c</span>(<span class="dv">50</span>,<span class="dv">50</span>))</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a><span class="co"># what if all 50 were satisfied?</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>),<span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">10</span>,<span class="dv">50</span>))</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">0</span>,<span class="fu">c</span>(<span class="dv">50</span>,<span class="dv">50</span>))</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a><span class="co"># what if all 50 were like the other 50?</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">10</span>,<span class="dv">40</span>,<span class="dv">10</span>))</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">0</span>,<span class="fu">c</span>(<span class="dv">50</span>,<span class="dv">50</span>))</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a><span class="co"># initial values.</span></span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>x.sample <span class="ot">&lt;-</span> x; x.sample[<span class="fu">is.na</span>(x)] <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">size=</span><span class="dv">50</span>,<span class="at">replace=</span>T)</span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a><span class="co"># number of iterations</span></span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">4</span><span class="sc">+</span><span class="dv">500</span></span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a><span class="co"># and the monitor for recording the iterations of p</span></span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a>mon.p <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a><span class="co"># ... and one of the missing observations</span></span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a>mon.x20 <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Gibbs sampler:</span></span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-25"><a href="#cb99-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>ITER){</span>
<span id="cb99-26"><a href="#cb99-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sampling p</span></span>
<span id="cb99-27"><a href="#cb99-27" aria-hidden="true" tabindex="-1"></a>  mon.p[iter] <span class="ot">&lt;-</span> p <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(<span class="dv">1</span>,a<span class="sc">+</span><span class="fu">sum</span>(x.sample),b<span class="sc">+</span><span class="fu">sum</span>(<span class="dv">1</span><span class="sc">-</span>x.sample))</span>
<span id="cb99-28"><a href="#cb99-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sampling (missing x)</span></span>
<span id="cb99-29"><a href="#cb99-29" aria-hidden="true" tabindex="-1"></a>  x.sample[<span class="fu">is.na</span>(x)] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="fu">sum</span>(<span class="fu">is.na</span>(x)),<span class="dv">1</span>,<span class="dv">7</span><span class="sc">*</span>p<span class="sc">/</span>(<span class="dv">6</span><span class="sc">*</span>p<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb99-30"><a href="#cb99-30" aria-hidden="true" tabindex="-1"></a>    mon.x20[iter] <span class="ot">&lt;-</span> x.sample[<span class="dv">20</span>]</span>
<span id="cb99-31"><a href="#cb99-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb99-32"><a href="#cb99-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-33"><a href="#cb99-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior mean probability of being satisfied.</span></span>
<span id="cb99-34"><a href="#cb99-34" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(mon.p[<span class="dv">501</span><span class="sc">:</span><span class="dv">10500</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7947594</code></pre>
</div>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% CI</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(mon.p[<span class="dv">501</span><span class="sc">:</span><span class="dv">10500</span>], <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     2.5%     97.5% 
0.7122337 0.8661632 </code></pre>
</div>
</div>
</section>
<section id="change-point-regression" class="level3" data-number="3.5.5">
<h3 data-number="3.5.5" class="anchored" data-anchor-id="change-point-regression"><span class="header-section-number">3.5.5</span> Change Point Regression</h3>
<p>Let’s try another example. The <code>Nile</code> data set contains Nile flow by year. We want to ask whether the trend changed after 1897. Compare an intercept-only model, <span class="math inline">\(y_t \sim N(\mu_t, \tau)\)</span> where <span class="math inline">\(\mu_t = \alpha\)</span> is a constant, to a linear time trend model where <span class="math inline">\(\mu_t = \alpha + \beta \text{Year}\)</span>. Use conjugate non-informative priors, <span class="math inline">\(\alpha \sim N(0, 10^{-10})\)</span> and <span class="math inline">\(\tau \sim \text{Gamma}(.01, .01)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"Nile"</span>)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>my_nile <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">year =</span> <span class="fu">time</span>(Nile), <span class="at">flow =</span> Nile, <span class="at">after =</span> <span class="fu">as.numeric</span>(year<span class="sc">&gt;</span><span class="dv">1897</span>))</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a><span class="co"># intercept-only</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">MCMCglmm</span>(flow <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> my_nile, </span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">nitt =</span> <span class="dv">1500</span>, <span class="at">burnin =</span> <span class="dv">500</span>, <span class="at">thin =</span> <span class="dv">1</span>,</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">prior =</span> <span class="fu">list</span>(<span class="at">B =</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">V =</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">10</span>)),</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Trend</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">MCMCglmm</span>(flow <span class="sc">~</span> year, <span class="at">data =</span> my_nile, </span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">nitt =</span> <span class="dv">1500</span>, <span class="at">burnin =</span> <span class="dv">500</span>, <span class="at">thin =</span> <span class="dv">1</span>,</span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">prior =</span> <span class="fu">list</span>(<span class="at">B =</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">V =</span> <span class="fu">diag</span>(<span class="dv">2</span>)<span class="sc">*</span><span class="dv">10</span><span class="sc">^</span><span class="dv">10</span>)),</span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a><span class="co"># flow has been decreasing by 2.7 per year (95% CI, 1.6 - 3.7)</span></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m1)<span class="sc">$</span>solutions</span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a><span class="do">##               post.mean    l-95% CI    u-95% CI eff.samp pMCMC</span></span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a><span class="do">## (Intercept) 6180.699732 4183.400324 8268.137317     1000 0.001</span></span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a><span class="do">## year          -2.739952   -3.865672   -1.741701     1000 0.001</span></span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior probability of negative trend</span></span>
<span id="cb103-24"><a href="#cb103-24" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(m1<span class="sc">$</span>Sol[, <span class="dv">2</span>] <span class="sc">&lt;</span> <span class="dv">0</span>)</span>
<span id="cb103-25"><a href="#cb103-25" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1</span></span>
<span id="cb103-26"><a href="#cb103-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-27"><a href="#cb103-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Change Point</span></span>
<span id="cb103-28"><a href="#cb103-28" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">MCMCglmm</span>(flow <span class="sc">~</span> after, <span class="at">data =</span> my_nile, </span>
<span id="cb103-29"><a href="#cb103-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">nitt =</span> <span class="dv">1500</span>, <span class="at">burnin =</span> <span class="dv">500</span>, <span class="at">thin =</span> <span class="dv">1</span>,</span>
<span id="cb103-30"><a href="#cb103-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">prior =</span> <span class="fu">list</span>(<span class="at">B =</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">V =</span> <span class="fu">diag</span>(<span class="dv">2</span>)<span class="sc">*</span><span class="dv">10</span><span class="sc">^</span><span class="dv">10</span>)),</span>
<span id="cb103-31"><a href="#cb103-31" aria-hidden="true" tabindex="-1"></a>               <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb103-32"><a href="#cb103-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-33"><a href="#cb103-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Flow fell 244 from 1098.</span></span>
<span id="cb103-34"><a href="#cb103-34" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m2)<span class="sc">$</span>solutions</span>
<span id="cb103-35"><a href="#cb103-35" aria-hidden="true" tabindex="-1"></a><span class="do">##             post.mean  l-95% CI  u-95% CI eff.samp pMCMC</span></span>
<span id="cb103-36"><a href="#cb103-36" aria-hidden="true" tabindex="-1"></a><span class="do">## (Intercept) 1097.3780 1048.3385 1143.4094     1000 0.001</span></span>
<span id="cb103-37"><a href="#cb103-37" aria-hidden="true" tabindex="-1"></a><span class="do">## after       -243.8701 -300.7758 -193.1304     1000 0.001</span></span>
<span id="cb103-38"><a href="#cb103-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-39"><a href="#cb103-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare the DIC. m2 has smallest DIC.</span></span>
<span id="cb103-40"><a href="#cb103-40" aria-hidden="true" tabindex="-1"></a>m0<span class="sc">$</span>DIC</span>
<span id="cb103-41"><a href="#cb103-41" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1313.057</span></span>
<span id="cb103-42"><a href="#cb103-42" aria-hidden="true" tabindex="-1"></a>m1<span class="sc">$</span>DIC</span>
<span id="cb103-43"><a href="#cb103-43" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1290.783</span></span>
<span id="cb103-44"><a href="#cb103-44" aria-hidden="true" tabindex="-1"></a>m2<span class="sc">$</span>DIC</span>
<span id="cb103-45"><a href="#cb103-45" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1261.396</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This isn’t quite how you would want to do it, however. Instead, you’d like to determine which year the change point occurred. Define <span class="math inline">\(\mu_t = \alpha_0\)</span> for <span class="math inline">\(t&lt;t^*\)</span>, and <span class="math inline">\(\alpha_1\)</span> for <span class="math inline">\(t \ge t^*\)</span>. Use conjugate non-informative priors for both, <span class="math inline">\(\alpha_0 = \alpha_1 \sim N(0, 10^{-8})\)</span> and <span class="math inline">\(\tau \sim \text{Gamma}(.01, .01)\)</span> and a uniform prior for <span class="math inline">\(t^* \sim U(1871.5, 1969.5\)</span>.</p>
<p>The posterior conditional distributions for <span class="math inline">\(\alpha_0\)</span> and <span class="math inline">\(\alpha_1\)</span> are from Eqns @ref(eq:mu-posterior).</p>
<p><span class="math display">\[
\begin{align}
\alpha_0 | y,t^*,\tau &amp; \sim N \left( \frac{\sum_{t&lt;t^*} y_t \tau}{\sum_{t&lt;t^*} 1 \tau + 10^{-8}}, \sum_{t&lt;t^*} 1 \tau + 10^{-8} \right) \\
\alpha_1 | y,t^*,\tau &amp; \sim N \left( \frac{\sum_{t\ge t^*} y_t \tau}{\sum_{t\ge t^*} 1 \tau + 10^{-8}}, \sum_{t\ge t^*} 1 \tau + 10^{-8} \right)
\end{align}
\]</span></p>
<p>The posterior conditional distribution for <span class="math inline">\(\tau\)</span> needs to be derived from Bayes’ formula.</p>
<p><span class="math display">\[
\tau|x, t^*, \alpha_0, \alpha_1 \sim \text{Gamma} \left( .01 + \frac{n}{2}, .01 + .5 \sum_{t&lt;t^*} (x_t - \alpha_0)^2 + .5 \sum_{t \ge t^*} (x_t - \alpha_1)^2 \right)
\]</span></p>
<p>It is not possible to derive a posterior conditional distribution for <span class="math inline">\(t^*\)</span>, so use the Metropolis-Hastings algorithm. Given <span class="math inline">\(\alpha_0\)</span>, <span class="math inline">\(\alpha_1\)</span>, <span class="math inline">\(\tau\)</span>, and <span class="math inline">\(t^*\)</span>, propose a new value from the normal distribution centered at <span class="math inline">\(t^*\)</span>: <span class="math inline">\(t^{*'} \sim N(t^*, \delta)\)</span> and accept the new value with probability <span class="math inline">\(min{1, R}\)</span>,</p>
<p><span class="math display">\[
R = \frac{f(y|\alpha_0, \alpha_1, t^{*'})f(t^{*'})}{f(y|\alpha_0, \alpha_1, t^*)} \frac{q(t^*|t^{*'})}{q(t^{*'}|t^*)}
\]</span></p>
<p>The proposal distribution is symmetric, so you can drop the <span class="math inline">\(q()\)</span> functions from the ratio (Metropolis algorithm).</p>
<p>Let’s start with a toy example to check the code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create toy data set.</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>ALPHA_0 <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>ALPHA_1 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>TAU <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> .<span class="dv">1</span><span class="sc">^</span><span class="dv">2</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>CHGPT <span class="ot">&lt;-</span> <span class="fl">25.5</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">t =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="at">y =</span> <span class="fu">rnorm</span>(<span class="dv">100</span>, ALPHA_0 <span class="sc">+</span> ALPHA_1<span class="sc">*</span>(t<span class="sc">&gt;</span>CHGPT), <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(TAU)))</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick look at the data. A clear change point!</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> y)) <span class="sc">+</span> <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up a 1,500 iteration MCMC</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">1500</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>chgpt_delta <span class="ot">&lt;-</span> .<span class="dv">5</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create monitors for each of the posterior distributions</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>mon_alpha_0 <span class="ot">&lt;-</span> mon_alpha_1 <span class="ot">&lt;-</span> mon_tau <span class="ot">&lt;-</span> mon_chgpt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Set initial values</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dat)</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>alpha_0 <span class="ot">&lt;-</span> alpha_1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>y); tau <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">var</span>(dat<span class="sc">$</span>y); chgpt <span class="ot">&lt;-</span> <span class="fu">median</span>(dat<span class="sc">$</span>t)</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>ITER) {</span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gibbs step</span></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>  alpha_0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="fu">sum</span>(dat<span class="sc">$</span>y[dat<span class="sc">$</span>t <span class="sc">&lt;</span>  chgpt]) <span class="sc">*</span> tau <span class="sc">/</span> (<span class="fu">sum</span>(dat<span class="sc">$</span>t <span class="sc">&lt;</span>  chgpt) <span class="sc">*</span> tau <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">8</span>)),</span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>                   <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(dat<span class="sc">$</span>t <span class="sc">&lt;</span>  chgpt) <span class="sc">*</span> tau <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">8</span>)))</span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>  alpha_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="fu">sum</span>(dat<span class="sc">$</span>y[dat<span class="sc">$</span>t <span class="sc">&gt;=</span> chgpt]) <span class="sc">*</span> tau <span class="sc">/</span> (<span class="fu">sum</span>(dat<span class="sc">$</span>t <span class="sc">&gt;=</span> chgpt) <span class="sc">*</span> tau <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">8</span>)),</span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>                   <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(dat<span class="sc">$</span>t <span class="sc">&gt;=</span> chgpt) <span class="sc">*</span> tau <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">8</span>)))</span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, .<span class="dv">01</span> <span class="sc">+</span> n<span class="sc">/</span><span class="dv">2</span>, </span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>                .<span class="dv">01</span> <span class="sc">+</span> </span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>                  .<span class="dv">5</span> <span class="sc">*</span> <span class="fu">sum</span>(((dat<span class="sc">$</span>y <span class="sc">-</span> alpha_0)<span class="sc">^</span><span class="dv">2</span>)[dat<span class="sc">$</span>t <span class="sc">&lt;</span>  chgpt]) <span class="sc">+</span></span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a>                  .<span class="dv">5</span> <span class="sc">*</span> <span class="fu">sum</span>(((dat<span class="sc">$</span>y <span class="sc">-</span> alpha_1)<span class="sc">^</span><span class="dv">2</span>)[dat<span class="sc">$</span>t <span class="sc">&gt;=</span> chgpt]))</span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># c(alpha_0, alpha_1, tau, chgpt)</span></span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Metropolis step</span></span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a>  chgpt_new <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, chgpt, <span class="at">sd =</span> chgpt_delta)</span>
<span id="cb105-26"><a href="#cb105-26" aria-hidden="true" tabindex="-1"></a>  log_R <span class="ot">&lt;-</span> <span class="co"># difference in log-likelihoods =</span></span>
<span id="cb105-27"><a href="#cb105-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># log-likelihood of new</span></span>
<span id="cb105-28"><a href="#cb105-28" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">sum</span>(<span class="fu">dnorm</span>(dat<span class="sc">$</span>y[dat<span class="sc">$</span>t <span class="sc">&lt;</span>  chgpt_new], alpha_0, <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(tau), <span class="at">log =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb105-29"><a href="#cb105-29" aria-hidden="true" tabindex="-1"></a>     <span class="fu">sum</span>(<span class="fu">dnorm</span>(dat<span class="sc">$</span>y[dat<span class="sc">$</span>t <span class="sc">&gt;=</span> chgpt_new], alpha_1, <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(tau), <span class="at">log =</span> <span class="cn">TRUE</span>))) <span class="sc">-</span></span>
<span id="cb105-30"><a href="#cb105-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># log-likelihood of curr</span></span>
<span id="cb105-31"><a href="#cb105-31" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">sum</span>(<span class="fu">dnorm</span>(dat<span class="sc">$</span>y[dat<span class="sc">$</span>t <span class="sc">&lt;</span>  chgpt],     alpha_0, <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(tau), <span class="at">log =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb105-32"><a href="#cb105-32" aria-hidden="true" tabindex="-1"></a>     <span class="fu">sum</span>(<span class="fu">dnorm</span>(dat<span class="sc">$</span>y[dat<span class="sc">$</span>t <span class="sc">&gt;=</span> chgpt],     alpha_1, <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(tau), <span class="at">log =</span> <span class="cn">TRUE</span>))) </span>
<span id="cb105-33"><a href="#cb105-33" aria-hidden="true" tabindex="-1"></a>  log_U <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb105-34"><a href="#cb105-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(log_U <span class="sc">&lt;</span> log_R) { chgpt <span class="ot">&lt;-</span> chgpt_new}</span>
<span id="cb105-35"><a href="#cb105-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># update monitors</span></span>
<span id="cb105-36"><a href="#cb105-36" aria-hidden="true" tabindex="-1"></a>  mon_alpha_0[iter] <span class="ot">&lt;-</span> alpha_0 </span>
<span id="cb105-37"><a href="#cb105-37" aria-hidden="true" tabindex="-1"></a>  mon_alpha_1[iter] <span class="ot">&lt;-</span> alpha_1</span>
<span id="cb105-38"><a href="#cb105-38" aria-hidden="true" tabindex="-1"></a>  mon_tau[iter] <span class="ot">&lt;-</span> tau</span>
<span id="cb105-39"><a href="#cb105-39" aria-hidden="true" tabindex="-1"></a>  mon_chgpt[iter] <span class="ot">&lt;-</span> chgpt</span>
<span id="cb105-40"><a href="#cb105-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb105-41"><a href="#cb105-41" aria-hidden="true" tabindex="-1"></a><span class="co"># mine &lt;- c(alpha_0, alpha_1, tau, chgpt, chgpt_new, log_R, log_U)</span></span>
<span id="cb105-42"><a href="#cb105-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-43"><a href="#cb105-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for convergence</span></span>
<span id="cb105-44"><a href="#cb105-44" aria-hidden="true" tabindex="-1"></a>mon_tibble <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">index =</span> <span class="dv">1</span><span class="sc">:</span>ITER, <span class="at">alpha_0 =</span> mon_alpha_0, <span class="at">alpha_1 =</span> mon_alpha_1, </span>
<span id="cb105-45"><a href="#cb105-45" aria-hidden="true" tabindex="-1"></a>       <span class="at">tau =</span> mon_tau, <span class="at">chgpt =</span> mon_chgpt) </span>
<span id="cb105-46"><a href="#cb105-46" aria-hidden="true" tabindex="-1"></a>mon_tibble_longer <span class="ot">&lt;-</span></span>
<span id="cb105-47"><a href="#cb105-47" aria-hidden="true" tabindex="-1"></a>  mon_tibble <span class="sc">%&gt;%</span></span>
<span id="cb105-48"><a href="#cb105-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>index)</span>
<span id="cb105-49"><a href="#cb105-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-50"><a href="#cb105-50" aria-hidden="true" tabindex="-1"></a>mon_tibble_longer <span class="sc">%&gt;%</span> </span>
<span id="cb105-51"><a href="#cb105-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> index, <span class="at">y =</span> value)) <span class="sc">+</span> </span>
<span id="cb105-52"><a href="#cb105-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb105-53"><a href="#cb105-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb105-54"><a href="#cb105-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="at">facets =</span> <span class="fu">vars</span>(name), <span class="at">scales =</span> <span class="st">"free_y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-53-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Convergence after 500 iterations, so throw them out.</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior distributions</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>mon_tibble_longer <span class="sc">%&gt;%</span> </span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(index <span class="sc">&gt;</span> <span class="dv">500</span>) <span class="sc">%&gt;%</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">if_else</span>(name <span class="sc">==</span> <span class="st">"tau"</span>, <span class="st">"sigma"</span>, name),</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">value =</span> <span class="fu">if_else</span>(name <span class="sc">==</span> <span class="st">"sigma"</span>, <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(value), value)) <span class="sc">%&gt;%</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> name,</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">M =</span> <span class="fu">mean</span>(value),</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">SD =</span> <span class="fu">sd</span>(value),</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">LCI =</span> <span class="fu">quantile</span>(value, .<span class="dv">025</span>),</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">UCI =</span> <span class="fu">quantile</span>(value, .<span class="dv">975</span>)</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 4 × 5</span></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a><span class="do">##   name           M      SD     LCI     UCI</span></span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 alpha_0  0.00100 0.0225  -0.0431  0.0462</span></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 alpha_1  1.03    0.0125   1.01    1.06  </span></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 sigma    0.113   0.00822  0.0986  0.130 </span></span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 chgpt   25.5     0.287   25.0    26.0</span></span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a><span class="co"># You can summarize the values by t to average the models.</span></span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Recall the model is mu_t = alpha + beta*Year where alpha = alpha_0 or alpha_1</span></span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a>mon_tibble <span class="sc">%&gt;%</span></span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="sc">-</span><span class="dv">500</span>) <span class="sc">%&gt;%</span></span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">series =</span> <span class="fu">pmap</span>(<span class="fu">list</span>(alpha_0, alpha_1, chgpt), <span class="cf">function</span>(a0, a1, c) {</span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a>      t <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span></span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a>      y <span class="ot">&lt;-</span> <span class="fu">if_else</span>(t <span class="sc">&lt;</span> c, a0, a1)</span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a>      rs <span class="ot">&lt;-</span> <span class="fu">tibble</span>(t, y)</span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a>      rs</span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(series) <span class="sc">%&gt;%</span></span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(series) <span class="sc">%&gt;%</span></span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> t, <span class="at">y =</span> <span class="fu">mean</span>(y), <span class="at">lci =</span> <span class="fu">quantile</span>(y, .<span class="dv">025</span>), <span class="at">uci =</span> <span class="fu">quantile</span>(y, .<span class="dv">975</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb106-38"><a href="#cb106-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> t)) <span class="sc">+</span></span>
<span id="cb106-39"><a href="#cb106-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb106-40"><a href="#cb106-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lci, <span class="at">ymax =</span> uci))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-53-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now let’s apply what we’ve learned to the Nile data set. I’ll set the initial change point value at 1900 since that is around where the change seems to have occurred.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> my_nile <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">t =</span> year, <span class="at">y =</span> flow)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick look at the data. A clear change point!</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> y)) <span class="sc">+</span> <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up a 1,500 iteration MCMC</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">1500</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>chgpt_delta <span class="ot">&lt;-</span> .<span class="dv">5</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create monitors for each of the posterior distributions</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>mon_alpha_0 <span class="ot">&lt;-</span> mon_alpha_1 <span class="ot">&lt;-</span> mon_tau <span class="ot">&lt;-</span> mon_chgpt <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Set initial values</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dat)</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>alpha_0 <span class="ot">&lt;-</span> alpha_1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>y); tau <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">var</span>(dat<span class="sc">$</span>y); chgpt <span class="ot">&lt;-</span> <span class="dv">1900</span></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>ITER) {</span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gibbs step</span></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>  alpha_0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="fu">sum</span>(dat<span class="sc">$</span>y[dat<span class="sc">$</span>t <span class="sc">&lt;</span>  chgpt]) <span class="sc">*</span> tau <span class="sc">/</span> (<span class="fu">sum</span>(dat<span class="sc">$</span>t <span class="sc">&lt;</span>  chgpt) <span class="sc">*</span> tau <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">8</span>)),</span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>                   <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(dat<span class="sc">$</span>t <span class="sc">&lt;</span>  chgpt) <span class="sc">*</span> tau <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">8</span>)))</span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a>  alpha_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="fu">sum</span>(dat<span class="sc">$</span>y[dat<span class="sc">$</span>t <span class="sc">&gt;=</span> chgpt]) <span class="sc">*</span> tau <span class="sc">/</span> (<span class="fu">sum</span>(dat<span class="sc">$</span>t <span class="sc">&gt;=</span> chgpt) <span class="sc">*</span> tau <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">8</span>)),</span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a>                   <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(dat<span class="sc">$</span>t <span class="sc">&gt;=</span> chgpt) <span class="sc">*</span> tau <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">8</span>)))</span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, .<span class="dv">01</span> <span class="sc">+</span> n<span class="sc">/</span><span class="dv">2</span>, </span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a>                .<span class="dv">01</span> <span class="sc">+</span> </span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a>                  .<span class="dv">5</span> <span class="sc">*</span> <span class="fu">sum</span>(((dat<span class="sc">$</span>y <span class="sc">-</span> alpha_0)<span class="sc">^</span><span class="dv">2</span>)[dat<span class="sc">$</span>t <span class="sc">&lt;</span>  chgpt]) <span class="sc">+</span></span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a>                  .<span class="dv">5</span> <span class="sc">*</span> <span class="fu">sum</span>(((dat<span class="sc">$</span>y <span class="sc">-</span> alpha_1)<span class="sc">^</span><span class="dv">2</span>)[dat<span class="sc">$</span>t <span class="sc">&gt;=</span> chgpt]))</span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># c(alpha_0, alpha_1, tau, chgpt)</span></span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Metropolis step</span></span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a>  chgpt_new <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, chgpt, <span class="at">sd =</span> chgpt_delta)</span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a>  log_R <span class="ot">&lt;-</span> <span class="co"># difference in log-likelihoods =</span></span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># log-likelihood of new</span></span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">sum</span>(<span class="fu">dnorm</span>(dat<span class="sc">$</span>y[dat<span class="sc">$</span>t <span class="sc">&lt;</span>  chgpt_new], alpha_0, <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(tau), <span class="at">log =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a>     <span class="fu">sum</span>(<span class="fu">dnorm</span>(dat<span class="sc">$</span>y[dat<span class="sc">$</span>t <span class="sc">&gt;=</span> chgpt_new], alpha_1, <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(tau), <span class="at">log =</span> <span class="cn">TRUE</span>))) <span class="sc">-</span></span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># log-likelihood of curr</span></span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">sum</span>(<span class="fu">dnorm</span>(dat<span class="sc">$</span>y[dat<span class="sc">$</span>t <span class="sc">&lt;</span>  chgpt],     alpha_0, <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(tau), <span class="at">log =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a>     <span class="fu">sum</span>(<span class="fu">dnorm</span>(dat<span class="sc">$</span>y[dat<span class="sc">$</span>t <span class="sc">&gt;=</span> chgpt],     alpha_1, <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(tau), <span class="at">log =</span> <span class="cn">TRUE</span>))) </span>
<span id="cb108-33"><a href="#cb108-33" aria-hidden="true" tabindex="-1"></a>  log_U <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb108-34"><a href="#cb108-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(log_U <span class="sc">&lt;</span> log_R) { chgpt <span class="ot">&lt;-</span> chgpt_new}</span>
<span id="cb108-35"><a href="#cb108-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># update monitors</span></span>
<span id="cb108-36"><a href="#cb108-36" aria-hidden="true" tabindex="-1"></a>  mon_alpha_0[iter] <span class="ot">&lt;-</span> alpha_0 </span>
<span id="cb108-37"><a href="#cb108-37" aria-hidden="true" tabindex="-1"></a>  mon_alpha_1[iter] <span class="ot">&lt;-</span> alpha_1</span>
<span id="cb108-38"><a href="#cb108-38" aria-hidden="true" tabindex="-1"></a>  mon_tau[iter] <span class="ot">&lt;-</span> tau</span>
<span id="cb108-39"><a href="#cb108-39" aria-hidden="true" tabindex="-1"></a>  mon_chgpt[iter] <span class="ot">&lt;-</span> chgpt</span>
<span id="cb108-40"><a href="#cb108-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb108-41"><a href="#cb108-41" aria-hidden="true" tabindex="-1"></a><span class="co"># mine &lt;- c(alpha_0, alpha_1, tau, chgpt, chgpt_new, log_R, log_U)</span></span>
<span id="cb108-42"><a href="#cb108-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-43"><a href="#cb108-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for convergence</span></span>
<span id="cb108-44"><a href="#cb108-44" aria-hidden="true" tabindex="-1"></a>mon_tibble <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">index =</span> <span class="dv">1</span><span class="sc">:</span>ITER, <span class="at">alpha_0 =</span> mon_alpha_0, <span class="at">alpha_1 =</span> mon_alpha_1, </span>
<span id="cb108-45"><a href="#cb108-45" aria-hidden="true" tabindex="-1"></a>       <span class="at">tau =</span> mon_tau, <span class="at">chgpt =</span> mon_chgpt) </span>
<span id="cb108-46"><a href="#cb108-46" aria-hidden="true" tabindex="-1"></a>mon_tibble_longer <span class="ot">&lt;-</span></span>
<span id="cb108-47"><a href="#cb108-47" aria-hidden="true" tabindex="-1"></a>  mon_tibble <span class="sc">%&gt;%</span></span>
<span id="cb108-48"><a href="#cb108-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>index)</span>
<span id="cb108-49"><a href="#cb108-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-50"><a href="#cb108-50" aria-hidden="true" tabindex="-1"></a>mon_tibble_longer <span class="sc">%&gt;%</span> </span>
<span id="cb108-51"><a href="#cb108-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> index, <span class="at">y =</span> value)) <span class="sc">+</span> </span>
<span id="cb108-52"><a href="#cb108-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb108-53"><a href="#cb108-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb108-54"><a href="#cb108-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="at">facets =</span> <span class="fu">vars</span>(name), <span class="at">scales =</span> <span class="st">"free_y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-54-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Convergence after 500 iterations, so throw them out.</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior distributions</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>mon_tibble_longer <span class="sc">%&gt;%</span> </span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(index <span class="sc">&gt;</span> <span class="dv">500</span>) <span class="sc">%&gt;%</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">if_else</span>(name <span class="sc">==</span> <span class="st">"tau"</span>, <span class="st">"sigma"</span>, name),</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">value =</span> <span class="fu">if_else</span>(name <span class="sc">==</span> <span class="st">"sigma"</span>, <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(value), value)) <span class="sc">%&gt;%</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> name,</span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">M =</span> <span class="fu">mean</span>(value),</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">SD =</span> <span class="fu">sd</span>(value),</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">LCI =</span> <span class="fu">quantile</span>(value, .<span class="dv">025</span>),</span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">UCI =</span> <span class="fu">quantile</span>(value, .<span class="dv">975</span>)</span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 4 × 5</span></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a><span class="do">##   name        M     SD   LCI   UCI</span></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 alpha_0 1097. 24.3   1049. 1144.</span></span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 alpha_1  850. 15.8    819.  881.</span></span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 sigma    130.  9.31   113.  150.</span></span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 chgpt   1898.  0.728 1896. 1899.</span></span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-23"><a href="#cb109-23" aria-hidden="true" tabindex="-1"></a><span class="co"># You can summarize the values by t to average the models.</span></span>
<span id="cb109-24"><a href="#cb109-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Recall the model is mu_t = alpha + beta*Year where alpha = alpha_0 or alpha_1</span></span>
<span id="cb109-25"><a href="#cb109-25" aria-hidden="true" tabindex="-1"></a>mon_tibble <span class="sc">%&gt;%</span></span>
<span id="cb109-26"><a href="#cb109-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="sc">-</span><span class="dv">500</span>) <span class="sc">%&gt;%</span></span>
<span id="cb109-27"><a href="#cb109-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb109-28"><a href="#cb109-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">series =</span> <span class="fu">pmap</span>(<span class="fu">list</span>(alpha_0, alpha_1, chgpt), <span class="cf">function</span>(a0, a1, c) {</span>
<span id="cb109-29"><a href="#cb109-29" aria-hidden="true" tabindex="-1"></a>      t <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span></span>
<span id="cb109-30"><a href="#cb109-30" aria-hidden="true" tabindex="-1"></a>      y <span class="ot">&lt;-</span> <span class="fu">if_else</span>(t <span class="sc">&lt;</span> c, a0, a1)</span>
<span id="cb109-31"><a href="#cb109-31" aria-hidden="true" tabindex="-1"></a>      rs <span class="ot">&lt;-</span> <span class="fu">tibble</span>(t, y)</span>
<span id="cb109-32"><a href="#cb109-32" aria-hidden="true" tabindex="-1"></a>      rs</span>
<span id="cb109-33"><a href="#cb109-33" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb109-34"><a href="#cb109-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb109-35"><a href="#cb109-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(series) <span class="sc">%&gt;%</span></span>
<span id="cb109-36"><a href="#cb109-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(series) <span class="sc">%&gt;%</span></span>
<span id="cb109-37"><a href="#cb109-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> t, <span class="at">y =</span> <span class="fu">mean</span>(y), <span class="at">lci =</span> <span class="fu">quantile</span>(y, .<span class="dv">025</span>), <span class="at">uci =</span> <span class="fu">quantile</span>(y, .<span class="dv">975</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb109-38"><a href="#cb109-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> t)) <span class="sc">+</span></span>
<span id="cb109-39"><a href="#cb109-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb109-40"><a href="#cb109-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lci, <span class="at">ymax =</span> uci))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-54-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="cluster-analysis" class="level3" data-number="3.5.6">
<h3 data-number="3.5.6" class="anchored" data-anchor-id="cluster-analysis"><span class="header-section-number">3.5.6</span> Cluster Analysis</h3>
<p>You can use Bayes for mixtures. Suppose you have a mixture of <span class="math inline">\(z_i \in [1, 2, 3]\)</span> types of grains with mean diameters of 3.8, 5, and 8mm. Given a grain of diameter <span class="math inline">\(x_i\)</span>, what is its class, <span class="math inline">\(z_i\)</span>?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>cinderella <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">z =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">200</span>), <span class="fu">rep</span>(<span class="dv">2</span>, <span class="dv">100</span>), <span class="fu">rep</span>(<span class="dv">3</span>, <span class="dv">300</span>)),</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(<span class="dv">200</span>, <span class="fl">3.8</span>, .<span class="dv">25</span>), <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="dv">5</span>, .<span class="dv">5</span>), <span class="fu">rnorm</span>(<span class="dv">300</span>, <span class="dv">8</span>, <span class="dv">1</span>))</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You might start with the assumption that <span class="math inline">\((x_i|z_i, \mu_{z_i}, \tau_{z_i}) \sim N(\mu_{z_i}, \tau_{z_i})\)</span> and assign conjugate priors <span class="math inline">\(\mu_k \sim N(\mu_{k0}, \tau_{k0})\)</span> and <span class="math inline">\(\tau_k \sim \text{Gamma}(a_k, b_k)\)</span> for <span class="math inline">\(k = 1, \ldots, 3\)</span>. To estimate the class probabilities of each grain, you need to start with a prior. <span class="math inline">\(Pr(z_i = k) = 1/K = 1/3\)</span> is a good prior.</p>
<p>The problem becomes</p>
<p><span class="math display">\[
\begin{align}
Pr(z_i = k|x_i, \mu_k, \tau_k) &amp;= \frac{f(x_i|z_i = k, \mu_k, \tau_k) Pr(z_i = k)}{\sum_k f(x_i|z_i = k, \mu_k, \tau_k) Pr(z_i = k)} \\
&amp;= \frac{f(x_i|z_i = k, \mu_k, \tau_k)}{\sum_k f(x_i|z_i = k, \mu_k, \tau_k)}
\end{align}
\]</span></p>
<p><code>NMixMCMC()</code> assigns initial values for <span class="math inline">\(\mu s\)</span>, <span class="math inline">\(\tau s\)</span> and <span class="math inline">\(z_i s\)</span>. Given <span class="math inline">\(\mu s\)</span> and <span class="math inline">\(\tau s\)</span>, it samples <span class="math inline">\(z_i s\)</span> from the assumed distribution. For each group, <span class="math inline">\(k\)</span>, sample <span class="math inline">\(\mu_k\)</span> and then <span class="math inline">\(\tau_k\)</span> from the conjugate conditional posterior distribution. Then repeat until convergence.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mixAK)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>mdl_mix <span class="ot">&lt;-</span> <span class="fu">NMixMCMC</span>(</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> cinderella<span class="sc">$</span>x,</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">nMCMC =</span> <span class="fu">c</span>(<span class="at">burn =</span> <span class="dv">1000</span>, <span class="at">keep =</span> <span class="dv">1000</span>, <span class="at">thin =</span> <span class="dv">1</span>, <span class="at">info =</span> <span class="dv">100</span>),</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">list</span>(<span class="at">priorK =</span> <span class="st">"fixed"</span>, <span class="at">Kmax =</span> <span class="dv">3</span>)</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Chain number 1</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a><span class="do">## ==============</span></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a><span class="do">## MCMC sampling started on Wed Mar 26 13:33:56 2025.</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a><span class="do">## Burn-in iteration 1002003004005006007008009001000</span></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Iteration 1100120013001400150016001700180019002000</span></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a><span class="do">## MCMC sampling finished on Wed Mar 26 13:33:56 2025.</span></span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a><span class="do">## Chain number 2</span></span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a><span class="do">## ==============</span></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a><span class="do">## MCMC sampling started on Wed Mar 26 13:33:56 2025.</span></span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a><span class="do">## Burn-in iteration 1002003004005006007008009001000</span></span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a><span class="do">## Iteration 1100120013001400150016001700180019002000</span></span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a><span class="do">## MCMC sampling finished on Wed Mar 26 13:33:56 2025.</span></span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a><span class="do">## Computation of penalized expected deviance started on Wed Mar 26 13:33:56 2025.</span></span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a><span class="do">## Computation of penalized expected deviance finished on Wed Mar 26 13:33:57 2025.</span></span>
<span id="cb111-25"><a href="#cb111-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-26"><a href="#cb111-26" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior means mu</span></span>
<span id="cb111-27"><a href="#cb111-27" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(mdl_mix[[<span class="dv">1</span>]]<span class="sc">$</span>poster.mean.mu <span class="sc">*</span> <span class="fu">sd</span>(cinderella<span class="sc">$</span>x)) <span class="sc">+</span> <span class="fu">mean</span>(cinderella<span class="sc">$</span>x)</span>
<span id="cb111-28"><a href="#cb111-28" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 3.767875 4.914559 8.100875</span></span>
<span id="cb111-29"><a href="#cb111-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-30"><a href="#cb111-30" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior means for SD</span></span>
<span id="cb111-31"><a href="#cb111-31" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>(<span class="fu">c</span>(<span class="fu">unlist</span>(mdl_mix[[<span class="dv">1</span>]]<span class="sc">$</span>poster.mean.Sigma)))<span class="sc">*</span><span class="fu">sd</span>(cinderella<span class="sc">$</span>x)</span>
<span id="cb111-32"><a href="#cb111-32" aria-hidden="true" tabindex="-1"></a><span class="do">##        j1        j2        j3 </span></span>
<span id="cb111-33"><a href="#cb111-33" aria-hidden="true" tabindex="-1"></a><span class="do">## 0.2573165 0.6120158 0.9945381</span></span>
<span id="cb111-34"><a href="#cb111-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-35"><a href="#cb111-35" aria-hidden="true" tabindex="-1"></a><span class="co"># estimated class frequency distribution</span></span>
<span id="cb111-36"><a href="#cb111-36" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(mdl_mix[[<span class="dv">1</span>]]<span class="sc">$</span>poster.mean.w, <span class="dv">2</span>)</span>
<span id="cb111-37"><a href="#cb111-37" aria-hidden="true" tabindex="-1"></a><span class="do">##   w1   w2   w3 </span></span>
<span id="cb111-38"><a href="#cb111-38" aria-hidden="true" tabindex="-1"></a><span class="do">## 0.31 0.20 0.49</span></span>
<span id="cb111-39"><a href="#cb111-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-40"><a href="#cb111-40" aria-hidden="true" tabindex="-1"></a><span class="co"># estimated probability per class of first few seeds</span></span>
<span id="cb111-41"><a href="#cb111-41" aria-hidden="true" tabindex="-1"></a>mdl_mix[[<span class="dv">1</span>]]<span class="sc">$</span>poster.comp.prob_u <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span>
<span id="cb111-42"><a href="#cb111-42" aria-hidden="true" tabindex="-1"></a><span class="do">##       [,1]  [,2]  [,3]</span></span>
<span id="cb111-43"><a href="#cb111-43" aria-hidden="true" tabindex="-1"></a><span class="do">## [1,] 0.951 0.049 0.000</span></span>
<span id="cb111-44"><a href="#cb111-44" aria-hidden="true" tabindex="-1"></a><span class="do">## [2,] 0.697 0.303 0.000</span></span>
<span id="cb111-45"><a href="#cb111-45" aria-hidden="true" tabindex="-1"></a><span class="do">## [3,] 0.932 0.068 0.000</span></span>
<span id="cb111-46"><a href="#cb111-46" aria-hidden="true" tabindex="-1"></a><span class="do">## [4,] 0.916 0.084 0.000</span></span>
<span id="cb111-47"><a href="#cb111-47" aria-hidden="true" tabindex="-1"></a><span class="do">## [5,] 0.477 0.522 0.001</span></span>
<span id="cb111-48"><a href="#cb111-48" aria-hidden="true" tabindex="-1"></a><span class="do">## [6,] 0.921 0.079 0.000</span></span>
<span id="cb111-49"><a href="#cb111-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-50"><a href="#cb111-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Marginal plot</span></span>
<span id="cb111-51"><a href="#cb111-51" aria-hidden="true" tabindex="-1"></a><span class="fu">NMixPredDensMarg</span>(mdl_mix[[<span class="dv">1</span>]], <span class="at">lgrid =</span> <span class="dv">150</span>) <span class="sc">%&gt;%</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In this case we new how many classes were in the data. If that was unknown, you could use reversible-jump MCMC which produces a posterior distribution for the number of components.</p>
</section>
</section>
<section id="beta-binomial-and-estimating-proportions" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="beta-binomial-and-estimating-proportions"><span class="header-section-number">3.6</span> Beta Binomial and Estimating Proportions</h2>
<p>Suppose <span class="math inline">\(y = 35\)</span> of <span class="math inline">\(n = 50\)</span> seeds germinate within 72hrs. What is the expected germination probability of a single seed? Seed germination can be modeled as <span class="math inline">\(n\)</span> Bernoulli trials where events occur with probability, <span class="math inline">\(p\)</span>, and the number of observed events is <span class="math inline">\(y = \sum_i^n y_i\)</span>. The question is estimating the <span class="math inline">\(p\)</span> parameter in the Bernoulli generating process.</p>
<p>The classical approach is to construct a 95% CI around <span class="math inline">\(p\)</span> with a <a href="https://mpfoley73.github.io/statistics/one-sample-proportion-z-test.html">one-sample proportion test</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">35</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.test</span>(y, n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    1-sample proportions test with continuity correction

data:  y out of n, null probability 0.5
X-squared = 7.22, df = 1, p-value = 0.00721
alternative hypothesis: true p is not equal to 0.5
95 percent confidence interval:
 0.5521660 0.8171438
sample estimates:
  p 
0.7 </code></pre>
</div>
</div>
<p>The Bayesian approach is to posit an expected distribution of <span class="math inline">\(p\)</span> <em>prior</em> to observing the data, then update the distribution based on the relative <em>likelihood</em> of observing the data given the values in the distribution. The likelihood of <span class="math inline">\(y\)</span> events in <span class="math inline">\(n\)</span> trials follows the binomial distribution, <span class="math inline">\(y|p \sim \text{Bin}(n, p)\)</span>.</p>
<p><span class="math display">\[
f(y|p) = {n \choose y} p^y (1-p)^{n-y}
\]</span></p>
<p>Start with a uniform prior - all values of <span class="math inline">\(p\)</span> are equally likely. To get a feel for the approach, try this with <em>discrete</em> <span class="math inline">\(p\)</span> values first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore the parameter space [0,1] in discrete .01 increments.</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.01</span>)</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Prior distribution is uniform, 1/101 for all p's.</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span><span class="fu">length</span>(p), <span class="fu">length</span>(p))</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Binomial likelihood of each p given 35/50 successes.</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>likelihood <span class="ot">&lt;-</span> <span class="fu">dbinom</span>(<span class="dv">35</span>, <span class="dv">50</span>, p)</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Bayes' Theorem: posterior = joint density / marginal density.</span></span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>joint_density <span class="ot">&lt;-</span> likelihood <span class="sc">*</span> prior</span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>marginal_density <span class="ot">&lt;-</span> <span class="fu">sum</span>(joint_density)</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>posterior <span class="ot">&lt;-</span> joint_density <span class="sc">/</span> marginal_density</span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% credible interval</span></span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>(pi <span class="ot">&lt;-</span> <span class="fu">sum</span>(posterior <span class="sc">*</span> p) <span class="sc">/</span> <span class="fu">sum</span>(posterior))</span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.6923077</span></span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a>(ci <span class="ot">&lt;-</span> p[<span class="fu">c</span>(<span class="fu">min</span>(<span class="fu">which</span>(<span class="fu">cumsum</span>(posterior) <span class="sc">&gt;</span> .<span class="dv">025</span>)),</span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a>          <span class="fu">max</span>(<span class="fu">which</span>(<span class="fu">cumsum</span>(posterior) <span class="sc">&lt;</span> .<span class="dv">975</span>)))])</span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.56 0.80</span></span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(p, prior, <span class="at">update =</span> likelihood <span class="sc">/</span> marginal_density <span class="sc">/</span> <span class="dv">101</span>, posterior) <span class="sc">%&gt;%</span></span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(prior, update, posterior)) <span class="sc">%&gt;%</span></span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">factor</span>(name, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"prior"</span>, <span class="st">"update"</span>, <span class="st">"posterior"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb114-25"><a href="#cb114-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> p)) <span class="sc">+</span></span>
<span id="cb114-26"><a href="#cb114-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> value, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb114-27"><a href="#cb114-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="at">data =</span> <span class="fu">tibble</span>(p, posterior, <span class="at">y =</span> <span class="fu">if_else</span>(p <span class="sc">&lt;=</span> ci[<span class="dv">1</span>], posterior, <span class="cn">NA_real_</span>)),</span>
<span id="cb114-28"><a href="#cb114-28" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">y =</span> y), <span class="at">fill =</span> <span class="st">"#619CFF"</span>) <span class="sc">+</span></span>
<span id="cb114-29"><a href="#cb114-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="at">data =</span> <span class="fu">tibble</span>(p, posterior, <span class="at">y =</span> <span class="fu">if_else</span>(p <span class="sc">&gt;=</span> ci[<span class="dv">2</span>], posterior, <span class="cn">NA_real_</span>)),</span>
<span id="cb114-30"><a href="#cb114-30" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">y =</span> y), <span class="at">fill =</span> <span class="st">"#619CFF"</span>) <span class="sc">+</span></span>
<span id="cb114-31"><a href="#cb114-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> pi), <span class="at">color =</span> <span class="st">"#619CFF"</span>) <span class="sc">+</span></span>
<span id="cb114-32"><a href="#cb114-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>), ci, pi), <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb114-33"><a href="#cb114-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"density"</span>, <span class="at">color =</span> <span class="cn">NULL</span>, <span class="at">title =</span> <span class="st">"From Prior to Posterior"</span>,</span>
<span id="cb114-34"><a href="#cb114-34" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Data: y=35, n=50. Posterior equals update."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This was good, but we could have done better. The discrete values for the uniform prior limited the precision of the 95% CI. The better path is to model continuous values with the <a href="https://mpfoley73.github.io/probability/random-variables-and-distributions.html#beta">beta</a> distribution, <span class="math inline">\(p \sim \text{Beta}(a, b)\)</span>. The PDF of the beta distribution is</p>
<p><span class="math display">\[
\begin{align}
f(p) &amp;= \frac{1}{\text{B}(a,b)} p^{a-1} (1-p)^{b-1} \\
&amp;\propto p^{a-1} (1 - p)^{b -1}
(\#eq:beta-prior)
\end{align}
\]</span></p>
<p>where <span class="math inline">\(a\)</span> is the success count, <span class="math inline">\(b\)</span> the failure count, and <span class="math inline">\(\text{B} = \frac{\Gamma(a)\Gamma(b)}{\Gamma(a+b)}\)</span> is the beta function. Equation @ref(eq:beta-prior) is called the beta prior. The beta prior is a <em>conjugate</em> prior, meaning the posterior distribution is also a beta distribution, so the <span class="math inline">\(\frac{1}{\text{B}(a,b)}\)</span> cancels out and the proportional form is all you need. The uniform prior distribution would be modeled with <span class="math inline">\(\text{Beta}(1, 1)\)</span>.</p>
<p>The <em>likelihood</em> of observing <span class="math inline">\(y\)</span> successes in <span class="math inline">\(n\)</span> trials given <span class="math inline">\(p\)</span> follows the binomial PMF. The constant binomial coefficient can be discarded.</p>
<p><span class="math display">\[
\begin{align}
f(y|p) &amp;= {n \choose y} p^y (1-p)^{n-y} \\
&amp;\propto p^y (1-p)^{n-y}
(\#eq:beta-likelihood)
\end{align}
\]</span></p>
<p>The product of the prior and likelihood is the joint density. The marginal density is the integral of the joint density over all <span class="math inline">\(p\)</span>.</p>
<p><span class="math display">\[
\begin{equation}
\int_{p=0}^1f(y|p) f(p) dp = \frac{\text{B}(a + y, b + (n-y))}{\text{B}(a, b)}
(\#eq:beta-marginal)
\end{equation}
\]</span></p>
<p>Using the proportional forms, the denominator of Bayes’ Theorem can be discarded, so the posterior distribution is just the joint density.</p>
<p><span class="math display">\[
\begin{align}
f(p|y) &amp; \propto f(y|p)f(p) \\
&amp; \propto p^y (1-p)^{n-y} p^{a-1} (1 - p)^{b -1} \\
&amp; \propto p^{a+y-1}(1-p)^{b+n-y-1} \\
&amp; \sim \text{Beta}(a + y, b + (n - y))
(\#eq:beta-posterior)
\end{align}
\]</span></p>
<p>The expected value of the beta distribution is <span class="math inline">\(a / (a + b)\)</span>. Updated with the observed data, the expected value is</p>
<p><span class="math display">\[
E(p|y) = \frac{a+y}{(a+y)+(b+(n-y))} = \frac{a + y}{a + b + n} = \frac{a + n \bar{y}}{a + b + n}
\]</span></p>
<p>As the sample size increases, the <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> prior parameter values become less important and <span class="math inline">\(E(p|y)\)</span> converges on the classical result of <span class="math inline">\(\bar{y}\)</span>. The code chunk below repeats the exercise above. This time that we can calculate a continuous 95% CI. Notice also that the marginal density never actually factored into the solution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># These discrete p's are for illustrating the distributions now.</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.001</span>)</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The prior distribution is uniform, Beta(1, 1).</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">&lt;-</span> <span class="fu">dbeta</span>(p, a, b)</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Instead of calculating the likelihood, joint density, marginal density, and</span></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a><span class="co"># finally the posterior, we can go straight to the posterior.</span></span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>posterior <span class="ot">&lt;-</span> <span class="fu">dbeta</span>(p, a <span class="sc">+</span> y, b <span class="sc">+</span> (n <span class="sc">-</span> y))</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% credible interval. This time we don't need p - we can go straight to the soln.</span></span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>(pi <span class="ot">&lt;-</span> (a <span class="sc">+</span> y) <span class="sc">/</span> ((a <span class="sc">+</span> y) <span class="sc">+</span> (b <span class="sc">+</span> (n <span class="sc">-</span> y))))</span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.6923077</span></span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>(ci <span class="ot">&lt;-</span> <span class="fu">qbeta</span>(<span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>), a <span class="sc">+</span> y, b <span class="sc">+</span> (n <span class="sc">-</span> y)))</span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.5617113 0.8088960</span></span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct the components anyway, just to graph them.</span></span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a>likelihood <span class="ot">&lt;-</span> <span class="fu">dbinom</span>(y, n, p)</span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a>joint_density <span class="ot">&lt;-</span> likelihood <span class="sc">*</span> prior</span>
<span id="cb115-22"><a href="#cb115-22" aria-hidden="true" tabindex="-1"></a>marginal_density <span class="ot">&lt;-</span> <span class="fu">sum</span>(joint_density)</span>
<span id="cb115-23"><a href="#cb115-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Trickery to get discretely calculated joint and marginal densities to sum to</span></span>
<span id="cb115-24"><a href="#cb115-24" aria-hidden="true" tabindex="-1"></a><span class="co"># same area as prior and posterior distributions.</span></span>
<span id="cb115-25"><a href="#cb115-25" aria-hidden="true" tabindex="-1"></a>update <span class="ot">&lt;-</span> likelihood <span class="sc">/</span> (<span class="fu">sum</span>(likelihood) <span class="sc">/</span> <span class="fu">sum</span>(posterior))</span>
<span id="cb115-26"><a href="#cb115-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-27"><a href="#cb115-27" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(p, prior, update, posterior) <span class="sc">%&gt;%</span></span>
<span id="cb115-28"><a href="#cb115-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(prior, update, posterior)) <span class="sc">%&gt;%</span></span>
<span id="cb115-29"><a href="#cb115-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">factor</span>(name, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"prior"</span>, <span class="st">"update"</span>, <span class="st">"posterior"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb115-30"><a href="#cb115-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> p)) <span class="sc">+</span></span>
<span id="cb115-31"><a href="#cb115-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> value, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb115-32"><a href="#cb115-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="at">data =</span> <span class="fu">tibble</span>(p, posterior, <span class="at">y =</span> <span class="fu">if_else</span>(p <span class="sc">&lt;=</span> ci[<span class="dv">1</span>], posterior, <span class="cn">NA_real_</span>)),</span>
<span id="cb115-33"><a href="#cb115-33" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">y =</span> y), <span class="at">fill =</span> <span class="st">"#619CFF"</span>) <span class="sc">+</span></span>
<span id="cb115-34"><a href="#cb115-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="at">data =</span> <span class="fu">tibble</span>(p, posterior, <span class="at">y =</span> <span class="fu">if_else</span>(p <span class="sc">&gt;=</span> ci[<span class="dv">2</span>], posterior, <span class="cn">NA_real_</span>)),</span>
<span id="cb115-35"><a href="#cb115-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">y =</span> y), <span class="at">fill =</span> <span class="st">"#619CFF"</span>) <span class="sc">+</span></span>
<span id="cb115-36"><a href="#cb115-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> pi), <span class="at">color =</span> <span class="st">"#619CFF"</span>) <span class="sc">+</span></span>
<span id="cb115-37"><a href="#cb115-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>), ci, pi), <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb115-38"><a href="#cb115-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"density"</span>, <span class="at">color =</span> <span class="cn">NULL</span>, <span class="at">title =</span> <span class="fu">glue</span>(<span class="st">"From Prior to Posterior, using Beta({a}, {b}) prior."</span>),</span>
<span id="cb115-39"><a href="#cb115-39" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Data: y=35, n=50."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Suppose your prior was better. You had taken a small sample of 10 and 7 seeds had germinated. The corroborating evidence centers on 70% and the credible interval tightens.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="zero-inflation-and-latent-variables" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="zero-inflation-and-latent-variables"><span class="header-section-number">3.7</span> Zero-Inflation and Latent Variables</h2>
<p>Suppose 100 persons report the number of days per week they consume alcohol (0 - 7). What is the posterior estimated probability of a person having a drink on any given day? Drinking days <em>should</em> follow a binomial distribution, so you <em>should</em> be able to estimate <span class="math inline">\(p\)</span> using a <span class="math inline">\(\text{Beta}(1, 1)\)</span> prior. The beta posterior would be <span class="math inline">\(\text{Beta}(252, 450)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>days <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">7</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>respondents <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">22</span>, <span class="dv">6</span>, <span class="dv">18</span>, <span class="dv">23</span>, <span class="dv">18</span>, <span class="dv">10</span>, <span class="dv">3</span>, <span class="dv">0</span>)</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rep</span>(days, respondents)</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Total events</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>(drinking_days <span class="ot">&lt;-</span> <span class="fu">sum</span>(y))</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 251</span></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Possible events</span></span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>(n <span class="ot">&lt;-</span> <span class="dv">7</span> <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 700</span></span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Beta posterior</span></span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>(a <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> drinking_days)</span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 252</span></span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>(b <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> (n <span class="sc">-</span> drinking_days))</span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 450</span></span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-19"><a href="#cb116-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior mean and 95% CI.</span></span>
<span id="cb116-20"><a href="#cb116-20" aria-hidden="true" tabindex="-1"></a>a <span class="sc">/</span> (a <span class="sc">+</span> b)</span>
<span id="cb116-21"><a href="#cb116-21" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.3589744</span></span>
<span id="cb116-22"><a href="#cb116-22" aria-hidden="true" tabindex="-1"></a><span class="fu">qbeta</span>(<span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>), a, b)</span>
<span id="cb116-23"><a href="#cb116-23" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.3239070 0.3948028</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The predictive distribution of <span class="math inline">\(\tilde{y}\)</span> is <span class="math inline">\(f(\tilde{y}|y) = \int f(\tilde{y}|p) f(p|y) dp\)</span>. The way you would normally solve this is to run a simulation. Sample a thousand <span class="math inline">\(p\)</span>’s from the posterior beta distribution, then use them to sample 100 respondents from the binomial distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>p_given_y <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a, b)</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="co"># For each p, simulate 7 draws from binomial distribution for the 100 respondents.</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">&lt;-</span> <span class="fu">map</span>(p_given_y, <span class="sc">~</span><span class="fu">rbinom</span>(<span class="dv">100</span>, <span class="dv">7</span>, .))</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of times y == [0,7]. Start by converting the 10^3 sims x 100 </span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a><span class="co"># participants list into an 8 days x 10^3 sims list. The three metrics are </span></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a><span class="co"># vectors of length 8.</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>sim_y_per_days <span class="ot">&lt;-</span> <span class="fu">map</span>(days, <span class="cf">function</span>(x) <span class="fu">map_int</span>(sims, <span class="sc">~</span><span class="fu">sum</span>(. <span class="sc">==</span> x)))</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>means <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(sim_y_per_days, mean)</span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>lcl <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(sim_y_per_days, <span class="sc">~</span><span class="fu">quantile</span>(.x, .<span class="dv">025</span>))</span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>ucl <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(sim_y_per_days, <span class="sc">~</span><span class="fu">quantile</span>(.x, .<span class="dv">975</span>))</span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(days, respondents, means, lcl, ucl) <span class="sc">%&gt;%</span></span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> days)) <span class="sc">+</span></span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">y =</span> respondents)) <span class="sc">+</span></span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> means)) <span class="sc">+</span></span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lcl, <span class="at">ymax =</span> ucl), <span class="at">width =</span> .<span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Uh oh! The problem is that the number of drinking days only follows a binomial distribution for drinkers - abstainers have <span class="math inline">\(p\)</span> = 0. This phenomena is called zero-inflation. The solution is to model <span class="math inline">\(p\)</span> conditional on the probability the person drinks, <span class="math inline">\(\omega\)</span>. Let <span class="math inline">\(z_i = 1\)</span> if respondent <span class="math inline">\(i\)</span> drinks alcohol at all. Then <span class="math inline">\((y_i|z_i = 1, p) \sim \text{Bin}(7, p)\)</span>, otherwise <span class="math inline">\(P(y_i =0|z_i = 0) = 1\)</span>. Model the probability of <span class="math inline">\(z_i = 0\)</span> with the Bernoulli distribution, <span class="math inline">\(z_i|\omega \sim \text{Bern}(\omega)\)</span> where <span class="math inline">\(\omega \sim \text{Beta}(a_\omega, b_\omega)\)</span>.</p>
<p>Implement a Gibbs sampler with uniform priors for <span class="math inline">\(p \sim \text{Beta}(a = 1, b = 1)\)</span> and <span class="math inline">\(\omega \sim \text{Beta}(a_\omega = 1, b_\omega = 1)\)</span>. Start with the assumption that if <span class="math inline">\(y_i = 0\)</span> then <span class="math inline">\(z_i = 0\)</span>, so for each respondent</p>
<p><span class="math display">\[
\begin{align}
P(z_i = 1| y_i &gt; 0, p, \omega) &amp;= 1 \\
P(z_i = 1| y_i = 0, p, \omega) &amp;= \frac{(1-p)^7 \omega}{(1-\omega) + (1-p)^7 \omega}
\end{align}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Start with assumption that if they reported 0, they _never_ drink (y_i=0 -&gt; z_i=0).</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(y <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Run 1,000 iterations, updating p, omega, and z each time.</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create monitors to track convergence.</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>sim_p <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>sim_omega <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>sim_z <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="fu">length</span>(y), <span class="at">ncol =</span> ITER)</span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Gibbs sampler.</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>ITER) {</span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Uniform Beta(1,1) prior for probability the person is a drinker. Posterior </span></span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># is based on count of non-zero z's.</span></span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>  omega <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(<span class="dv">1</span>, <span class="dv">1</span> <span class="sc">+</span> <span class="fu">sum</span>(z), <span class="dv">1</span> <span class="sc">+</span> (<span class="fu">length</span>(z) <span class="sc">-</span> <span class="fu">sum</span>(z)))</span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Uniform Beta(1,1) prior for probability of drinking on any given day. Posterior</span></span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># is based on reported drinking days and number of people who are drinkers.</span></span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(<span class="dv">1</span>, <span class="dv">1</span> <span class="sc">+</span> <span class="fu">sum</span>(y), <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">7</span> <span class="sc">*</span> <span class="fu">sum</span>(z) <span class="sc">-</span> <span class="fu">sum</span>(y)))</span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Updated probability that respondent is a drinker. </span></span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># P(z=1|y&gt;0) = 1 or P(z=1|y=0, p, omega).</span></span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a>  prob_z_eq_1 <span class="ot">&lt;-</span> <span class="fu">if_else</span>(y <span class="sc">&gt;=</span> <span class="dv">1</span>, <span class="dv">1</span>, </span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a>                         ((<span class="dv">1</span> <span class="sc">-</span> p)<span class="sc">^</span><span class="dv">7</span> <span class="sc">*</span> omega) <span class="sc">/</span> ((<span class="dv">1</span> <span class="sc">-</span> omega) <span class="sc">+</span> ((<span class="dv">1</span> <span class="sc">-</span> p)<span class="sc">^</span><span class="dv">7</span> <span class="sc">*</span> omega)))</span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-29"><a href="#cb118-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Update z.</span></span>
<span id="cb118-30"><a href="#cb118-30" aria-hidden="true" tabindex="-1"></a>  z <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">100</span>, <span class="dv">1</span>, prob_z_eq_1)</span>
<span id="cb118-31"><a href="#cb118-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-32"><a href="#cb118-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># update monitors</span></span>
<span id="cb118-33"><a href="#cb118-33" aria-hidden="true" tabindex="-1"></a>  sim_p[iter] <span class="ot">&lt;-</span> p</span>
<span id="cb118-34"><a href="#cb118-34" aria-hidden="true" tabindex="-1"></a>  sim_omega[iter] <span class="ot">&lt;-</span> omega</span>
<span id="cb118-35"><a href="#cb118-35" aria-hidden="true" tabindex="-1"></a>  sim_z[, iter] <span class="ot">&lt;-</span> z</span>
<span id="cb118-36"><a href="#cb118-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb118-37"><a href="#cb118-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-38"><a href="#cb118-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimated probability of being an alcohol drinker.</span></span>
<span id="cb118-39"><a href="#cb118-39" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(sim_omega)</span>
<span id="cb118-40"><a href="#cb118-40" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.7863099</span></span>
<span id="cb118-41"><a href="#cb118-41" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(sim_omega, <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>))</span>
<span id="cb118-42"><a href="#cb118-42" aria-hidden="true" tabindex="-1"></a><span class="do">##      2.5%     97.5% </span></span>
<span id="cb118-43"><a href="#cb118-43" aria-hidden="true" tabindex="-1"></a><span class="do">## 0.7051111 0.8581847</span></span>
<span id="cb118-44"><a href="#cb118-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-45"><a href="#cb118-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Of the alcohol drinkers, the probability of drinking on any given day.</span></span>
<span id="cb118-46"><a href="#cb118-46" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(sim_p)</span>
<span id="cb118-47"><a href="#cb118-47" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.4533135</span></span>
<span id="cb118-48"><a href="#cb118-48" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(sim_p, <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>))</span>
<span id="cb118-49"><a href="#cb118-49" aria-hidden="true" tabindex="-1"></a><span class="do">##      2.5%     97.5% </span></span>
<span id="cb118-50"><a href="#cb118-50" aria-hidden="true" tabindex="-1"></a><span class="do">## 0.4121130 0.4949042</span></span>
<span id="cb118-51"><a href="#cb118-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-52"><a href="#cb118-52" aria-hidden="true" tabindex="-1"></a><span class="co"># mean and 95% CI predicted number of [0,7] drinking days.</span></span>
<span id="cb118-53"><a href="#cb118-53" aria-hidden="true" tabindex="-1"></a>z_post_pred <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>ITER, <span class="sc">~</span><span class="fu">rbinom</span>(<span class="dv">100</span>, <span class="dv">1</span>, sim_omega))</span>
<span id="cb118-54"><a href="#cb118-54" aria-hidden="true" tabindex="-1"></a>x_post_pred <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>ITER, <span class="sc">~</span><span class="fu">rbinom</span>(<span class="dv">100</span>, <span class="dv">7</span>, sim_p))</span>
<span id="cb118-55"><a href="#cb118-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Override the probability with zero when z == 0.</span></span>
<span id="cb118-56"><a href="#cb118-56" aria-hidden="true" tabindex="-1"></a>x_post_pred <span class="ot">&lt;-</span> <span class="fu">map2</span>(x_post_pred, z_post_pred, <span class="sc">~</span> <span class="fu">if_else</span>(.y <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, .x))</span>
<span id="cb118-57"><a href="#cb118-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of times [0,7] comes up. Average this across the 10^3 experiments.</span></span>
<span id="cb118-58"><a href="#cb118-58" aria-hidden="true" tabindex="-1"></a>means <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(days, <span class="cf">function</span>(x) <span class="fu">map_int</span>(x_post_pred, <span class="sc">~</span><span class="fu">sum</span>(. <span class="sc">==</span> x)) <span class="sc">%&gt;%</span> <span class="fu">mean</span>())</span>
<span id="cb118-59"><a href="#cb118-59" aria-hidden="true" tabindex="-1"></a>lcl <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(days, <span class="cf">function</span>(x) <span class="fu">map_int</span>(x_post_pred, <span class="sc">~</span><span class="fu">sum</span>(. <span class="sc">==</span> x)) <span class="sc">%&gt;%</span> <span class="fu">quantile</span>(.<span class="dv">025</span>))</span>
<span id="cb118-60"><a href="#cb118-60" aria-hidden="true" tabindex="-1"></a>ucl <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(days, <span class="cf">function</span>(x) <span class="fu">map_int</span>(x_post_pred, <span class="sc">~</span><span class="fu">sum</span>(. <span class="sc">==</span> x)) <span class="sc">%&gt;%</span> <span class="fu">quantile</span>(.<span class="dv">975</span>))</span>
<span id="cb118-61"><a href="#cb118-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-62"><a href="#cb118-62" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(days, respondents, means, lcl, ucl) <span class="sc">%&gt;%</span></span>
<span id="cb118-63"><a href="#cb118-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> days)) <span class="sc">+</span></span>
<span id="cb118-64"><a href="#cb118-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">y =</span> respondents)) <span class="sc">+</span></span>
<span id="cb118-65"><a href="#cb118-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> means)) <span class="sc">+</span></span>
<span id="cb118-66"><a href="#cb118-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lcl, <span class="at">ymax =</span> ucl), <span class="at">width =</span> .<span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb118-67"><a href="#cb118-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Much better. Let’s try another example of modeling with zero inflation. 94 tourists report how many fish they caught during their visit. Estimate the distribution of fish caught. Start with a vague prior, <span class="math inline">\(\lambda \sim \text{Gamma}(a = .1, b = .1)\)</span>. The posterior distribution of <span class="math inline">\(\lambda|y \sim \text{Gamma}(a + \sum_i{y_i}, b + n)\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>fish <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"input/fish.csv"</span>, <span class="at">col_types =</span> <span class="st">"i"</span>) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(catch))</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate 10^3 samples.</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Uniform gamma(a, b) prior.</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample gamma 10^3 times from the posterior distribution</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>sampled_lambda <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a <span class="sc">+</span> <span class="fu">sum</span>(fish<span class="sc">$</span>catch), b <span class="sc">+</span> <span class="fu">nrow</span>(fish))</span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>y_tilde <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, sampled_lambda)</span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a><span class="co"># mean and 95% CI predicted number of expected value of fish caught.</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(y_tilde)</span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 2.875</span></span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(y_tilde, <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>))</span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a><span class="do">##  2.5% 97.5% </span></span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a><span class="do">##     0     6</span></span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a><span class="co"># mean and 95% CI predicted number of [0, 9] fish caught.</span></span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a><span class="co"># For 10^3 lambdas, create 94 samples from Poisson dist. </span></span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">&lt;-</span> <span class="fu">map</span>(sampled_lambda, <span class="sc">~</span><span class="fu">rpois</span>(<span class="fu">nrow</span>(fish), .))</span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of times [0,10] comes up. Average this across the 10^3 experiments. </span></span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a>catch <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">max</span>(fish<span class="sc">$</span>catch)</span>
<span id="cb119-26"><a href="#cb119-26" aria-hidden="true" tabindex="-1"></a>means <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(catch, <span class="cf">function</span>(x) <span class="fu">map_int</span>(sims, <span class="sc">~</span><span class="fu">sum</span>(. <span class="sc">==</span> x)) <span class="sc">%&gt;%</span> <span class="fu">mean</span>())</span>
<span id="cb119-27"><a href="#cb119-27" aria-hidden="true" tabindex="-1"></a>lcl <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(catch, <span class="cf">function</span>(x) <span class="fu">map_int</span>(sims, <span class="sc">~</span><span class="fu">sum</span>(. <span class="sc">==</span> x)) <span class="sc">%&gt;%</span> <span class="fu">quantile</span>(.<span class="dv">025</span>))</span>
<span id="cb119-28"><a href="#cb119-28" aria-hidden="true" tabindex="-1"></a>ucl <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(catch, <span class="cf">function</span>(x) <span class="fu">map_int</span>(sims, <span class="sc">~</span><span class="fu">sum</span>(. <span class="sc">==</span> x)) <span class="sc">%&gt;%</span> <span class="fu">quantile</span>(.<span class="dv">975</span>))</span>
<span id="cb119-29"><a href="#cb119-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-30"><a href="#cb119-30" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(catch, means, lcl, ucl) <span class="sc">%&gt;%</span></span>
<span id="cb119-31"><a href="#cb119-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(fish <span class="sc">%&gt;%</span> <span class="fu">count</span>(catch, <span class="at">name =</span> <span class="st">"y"</span>), <span class="at">by =</span> <span class="fu">join_by</span>(catch)) <span class="sc">%&gt;%</span></span>
<span id="cb119-32"><a href="#cb119-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> catch)) <span class="sc">+</span></span>
<span id="cb119-33"><a href="#cb119-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb119-34"><a href="#cb119-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> means)) <span class="sc">+</span></span>
<span id="cb119-35"><a href="#cb119-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lcl, <span class="at">ymax =</span> ucl), <span class="at">width =</span> .<span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb119-36"><a href="#cb119-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb119-37"><a href="#cb119-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Zero inflation in fish caught."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This doesn’t look good. The probability of 27 people catching 0 fish when the expected number of fish is 2.9 is less than .001.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probability of 27 people with catching 0 fish given lambda = 2.9 is &lt;.001.</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>(lambda_est <span class="ot">&lt;-</span> (a <span class="sc">+</span> <span class="fu">sum</span>(fish<span class="sc">$</span>catch)) <span class="sc">/</span> (b <span class="sc">+</span> <span class="dv">94</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.925327</code></pre>
</div>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ppois</span>(<span class="fu">sum</span>(fish<span class="sc">$</span>catch <span class="sc">==</span> <span class="dv">0</span>), <span class="at">lambda =</span> means[<span class="dv">1</span>], <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.064884e-12</code></pre>
</div>
</div>
<p>Add a binary latent variable to the model describing whether or not the person was fishing Assign a uniform prior to the probability that the person was fishing Derive posterior conditional distributions and construct a Gibbs sampler to estimate your model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Reported number of fish caught by 94 respondents.</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> fish<span class="sc">$</span>catch</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Start with assumption that if they caught 0, they did not fish (y_i=0 -&gt; z_i=0).</span></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(y <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Run 1,000 iterations, updating p, omega, and z each time.</span></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create monitors to track convergence.</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>sim_lambda <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>sim_omega <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>sim_z <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="fu">length</span>(y), <span class="at">ncol =</span> ITER)</span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Gibbs sampler.</span></span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>ITER) {</span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Uniform Beta(1,1) prior probability the person fished. Posterior is based on</span></span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># count of non-zero z's.</span></span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a>  omega <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(<span class="dv">1</span>, <span class="dv">1</span> <span class="sc">+</span> <span class="fu">sum</span>(z), <span class="dv">1</span> <span class="sc">+</span> (<span class="fu">length</span>(y) <span class="sc">-</span> <span class="fu">sum</span>(z)))</span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Vague Gamma(.01,.01) prior for number of fish caught. Posterior is based on</span></span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># reported catch and number of believed fishers.</span></span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, .<span class="dv">01</span> <span class="sc">+</span> <span class="fu">sum</span>(y), .<span class="dv">01</span> <span class="sc">+</span> <span class="fu">sum</span>(z))</span>
<span id="cb124-26"><a href="#cb124-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb124-27"><a href="#cb124-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Updated probability that respondent fishes.</span></span>
<span id="cb124-28"><a href="#cb124-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># E(z=1|x) = 1 or P(1|x=0, p, omega).</span></span>
<span id="cb124-29"><a href="#cb124-29" aria-hidden="true" tabindex="-1"></a>  prob_y_eq_0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>lambda) <span class="sc">*</span> lambda<span class="sc">^</span><span class="dv">0</span> <span class="sc">/</span> <span class="fu">factorial</span>(<span class="dv">0</span>)</span>
<span id="cb124-30"><a href="#cb124-30" aria-hidden="true" tabindex="-1"></a>  prob_z_eq_1 <span class="ot">&lt;-</span> <span class="fu">if_else</span>(y <span class="sc">&gt;=</span> <span class="dv">1</span>, <span class="dv">1</span>,</span>
<span id="cb124-31"><a href="#cb124-31" aria-hidden="true" tabindex="-1"></a>                         (prob_y_eq_0 <span class="sc">*</span> omega) <span class="sc">/</span> ((<span class="dv">1</span> <span class="sc">-</span> omega) <span class="sc">+</span> (prob_y_eq_0 <span class="sc">*</span> omega)))</span>
<span id="cb124-32"><a href="#cb124-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-33"><a href="#cb124-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Update z.</span></span>
<span id="cb124-34"><a href="#cb124-34" aria-hidden="true" tabindex="-1"></a>  z <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="fu">length</span>(y), <span class="dv">1</span>, prob_z_eq_1)</span>
<span id="cb124-35"><a href="#cb124-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-36"><a href="#cb124-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># update monitors</span></span>
<span id="cb124-37"><a href="#cb124-37" aria-hidden="true" tabindex="-1"></a>  sim_lambda[iter] <span class="ot">&lt;-</span> lambda</span>
<span id="cb124-38"><a href="#cb124-38" aria-hidden="true" tabindex="-1"></a>  sim_omega[iter] <span class="ot">&lt;-</span> omega</span>
<span id="cb124-39"><a href="#cb124-39" aria-hidden="true" tabindex="-1"></a>  sim_z[, iter] <span class="ot">&lt;-</span> z</span>
<span id="cb124-40"><a href="#cb124-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb124-41"><a href="#cb124-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-42"><a href="#cb124-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate of tourists who fished. Throw out first 100 as burn-in.</span></span>
<span id="cb124-43"><a href="#cb124-43" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(sim_omega[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>)])</span>
<span id="cb124-44"><a href="#cb124-44" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.7219762</span></span>
<span id="cb124-45"><a href="#cb124-45" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(sim_omega[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>)], <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>))</span>
<span id="cb124-46"><a href="#cb124-46" aria-hidden="true" tabindex="-1"></a><span class="do">##      2.5%     97.5% </span></span>
<span id="cb124-47"><a href="#cb124-47" aria-hidden="true" tabindex="-1"></a><span class="do">## 0.6281519 0.8081336</span></span>
<span id="cb124-48"><a href="#cb124-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-49"><a href="#cb124-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Of those who fished, the expected number caught. Throw out burn-in again.</span></span>
<span id="cb124-50"><a href="#cb124-50" aria-hidden="true" tabindex="-1"></a><span class="co"># tibble(x = 1:1000, y = sim_lambda) %&gt;% ggplot(aes(x = x, y = y)) + geom_point()</span></span>
<span id="cb124-51"><a href="#cb124-51" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(sim_lambda[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>)])</span>
<span id="cb124-52"><a href="#cb124-52" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 4.048745</span></span>
<span id="cb124-53"><a href="#cb124-53" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(sim_lambda[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>)], <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>))</span>
<span id="cb124-54"><a href="#cb124-54" aria-hidden="true" tabindex="-1"></a><span class="do">##     2.5%    97.5% </span></span>
<span id="cb124-55"><a href="#cb124-55" aria-hidden="true" tabindex="-1"></a><span class="do">## 3.573121 4.598533</span></span>
<span id="cb124-56"><a href="#cb124-56" aria-hidden="true" tabindex="-1"></a><span class="co"># or is it this (E(X) = a/b? Not this either.</span></span>
<span id="cb124-57"><a href="#cb124-57" aria-hidden="true" tabindex="-1"></a>(.<span class="dv">01</span> <span class="sc">+</span> <span class="fu">sum</span>(y)) <span class="sc">/</span> (.<span class="dv">01</span> <span class="sc">+</span> <span class="fu">sum</span>(z))</span>
<span id="cb124-58"><a href="#cb124-58" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 4.104014</span></span>
<span id="cb124-59"><a href="#cb124-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-60"><a href="#cb124-60" aria-hidden="true" tabindex="-1"></a><span class="co"># mean and 95% CI predicted number of [0,9] fish caught.</span></span>
<span id="cb124-61"><a href="#cb124-61" aria-hidden="true" tabindex="-1"></a>z_post_pred <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>ITER, <span class="sc">~</span><span class="fu">rbinom</span>(<span class="fu">length</span>(z), <span class="dv">1</span>, sim_omega))</span>
<span id="cb124-62"><a href="#cb124-62" aria-hidden="true" tabindex="-1"></a>y_post_pred <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>ITER, <span class="sc">~</span><span class="fu">rpois</span>(<span class="fu">length</span>(y), sim_lambda))</span>
<span id="cb124-63"><a href="#cb124-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Override the count with zero when z == 0.</span></span>
<span id="cb124-64"><a href="#cb124-64" aria-hidden="true" tabindex="-1"></a>y_post_pred <span class="ot">&lt;-</span> <span class="fu">map2</span>(y_post_pred, z_post_pred, <span class="sc">~</span> <span class="fu">if_else</span>(.y <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, .x))</span>
<span id="cb124-65"><a href="#cb124-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of times [0,9] comes up. Average this across the 10^3 experiments.</span></span>
<span id="cb124-66"><a href="#cb124-66" aria-hidden="true" tabindex="-1"></a>means <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>, <span class="cf">function</span>(x) <span class="fu">map_int</span>(y_post_pred, <span class="sc">~</span><span class="fu">sum</span>(. <span class="sc">==</span> x)) <span class="sc">%&gt;%</span> <span class="fu">mean</span>())</span>
<span id="cb124-67"><a href="#cb124-67" aria-hidden="true" tabindex="-1"></a>lcl <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>, <span class="cf">function</span>(x) <span class="fu">map_int</span>(y_post_pred, <span class="sc">~</span><span class="fu">sum</span>(. <span class="sc">==</span> x)) <span class="sc">%&gt;%</span> <span class="fu">quantile</span>(.<span class="dv">025</span>))</span>
<span id="cb124-68"><a href="#cb124-68" aria-hidden="true" tabindex="-1"></a>ucl <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>, <span class="cf">function</span>(x) <span class="fu">map_int</span>(y_post_pred, <span class="sc">~</span><span class="fu">sum</span>(. <span class="sc">==</span> x)) <span class="sc">%&gt;%</span> <span class="fu">quantile</span>(.<span class="dv">975</span>))</span>
<span id="cb124-69"><a href="#cb124-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-70"><a href="#cb124-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Probability of 27 of 94 people with a catch of 0. Sample the posterior </span></span>
<span id="cb124-71"><a href="#cb124-71" aria-hidden="true" tabindex="-1"></a><span class="co"># predictive distribution.</span></span>
<span id="cb124-72"><a href="#cb124-72" aria-hidden="true" tabindex="-1"></a>posterior_pred <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rpois</span>(ITER <span class="sc">*</span> <span class="fu">length</span>(y), <span class="fu">rep</span>(sim_lambda, <span class="fu">length</span>(y))), <span class="at">ncol =</span> ITER) <span class="sc">*</span> sim_z</span>
<span id="cb124-73"><a href="#cb124-73" aria-hidden="true" tabindex="-1"></a>posterior_zeros <span class="ot">&lt;-</span> <span class="fu">map_int</span>(<span class="dv">1</span><span class="sc">:</span>ITER, <span class="sc">~</span><span class="fu">sum</span>(posterior_pred[, .] <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb124-74"><a href="#cb124-74" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(posterior_zeros[<span class="dv">100</span><span class="sc">:</span>ITER] <span class="sc">&gt;=</span> <span class="fu">sum</span>(y<span class="sc">==</span><span class="dv">0</span>))</span>
<span id="cb124-75"><a href="#cb124-75" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.6492786</span></span>
<span id="cb124-76"><a href="#cb124-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-77"><a href="#cb124-77" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">catch =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>, means, lcl, ucl) <span class="sc">%&gt;%</span></span>
<span id="cb124-78"><a href="#cb124-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(fish <span class="sc">%&gt;%</span> <span class="fu">count</span>(catch, <span class="at">name =</span> <span class="st">"y"</span>), <span class="at">by =</span> <span class="fu">join_by</span>(catch)) <span class="sc">%&gt;%</span></span>
<span id="cb124-79"><a href="#cb124-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> catch)) <span class="sc">+</span></span>
<span id="cb124-80"><a href="#cb124-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb124-81"><a href="#cb124-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> means)) <span class="sc">+</span></span>
<span id="cb124-82"><a href="#cb124-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lcl, <span class="at">ymax =</span> ucl), <span class="at">width =</span> .<span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb124-83"><a href="#cb124-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="dic" class="level2" data-number="3.8">
<h2 data-number="3.8" class="anchored" data-anchor-id="dic"><span class="header-section-number">3.8</span> DIC</h2>
<p>Use the Deviance Information Criterion (DIC) to compare group means.</p>
<p><span class="math display">\[
DIC = p_D + \overline{D(\theta)}
\]</span></p>
<p>where <span class="math inline">\(p_D = \overline{D(\theta)} - D(\hat{\theta})\)</span> and <span class="math inline">\(D(\theta) = -2 \log (f(y|\theta)) + C\)</span>.</p>
<p>Evaluate <span class="math inline">\(\overline{D(\theta)}\)</span> by producing samples from each distribution and evaluating the likelihoods of the data based on each realization and taking the mean of -2 log-likelihood.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Two samples with success rates 35/50 and 15/20</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">35</span>, <span class="dv">15</span>)</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">20</span>)</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Priors</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Posteriors</span></span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbeta</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span>y[<span class="dv">1</span>], b<span class="sc">+</span>n[<span class="dv">1</span>]<span class="sc">-</span>y[<span class="dv">1</span>]),</span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbeta</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span>y[<span class="dv">2</span>], b<span class="sc">+</span>n[<span class="dv">2</span>]<span class="sc">-</span>y[<span class="dv">2</span>])</span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a><span class="co"># -2 * Mean log-likelihood</span></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>ll <span class="ot">&lt;-</span> </span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbinom</span>(y[<span class="dv">1</span>], n[<span class="dv">1</span>], post[[<span class="dv">1</span>]], <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbinom</span>(y[<span class="dv">2</span>], n[<span class="dv">2</span>], post[[<span class="dv">2</span>]], <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb125-19"><a href="#cb125-19" aria-hidden="true" tabindex="-1"></a>(mean_D <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> ll))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9.287665</code></pre>
</div>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># D(theta-bar) is the likelihood of the data based on the posterior means of p.</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>(D_mean <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> (</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbinom</span>(y[<span class="dv">1</span>], n[<span class="dv">1</span>], (a<span class="sc">+</span>y[<span class="dv">1</span>]) <span class="sc">/</span> (a<span class="sc">+</span>y[<span class="dv">1</span>] <span class="sc">+</span> b<span class="sc">+</span>n[<span class="dv">1</span>]<span class="sc">-</span>y[<span class="dv">1</span>]), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbinom</span>(y[<span class="dv">2</span>], n[<span class="dv">2</span>], (a<span class="sc">+</span>y[<span class="dv">2</span>]) <span class="sc">/</span> (a<span class="sc">+</span>y[<span class="dv">2</span>] <span class="sc">+</span> b<span class="sc">+</span>n[<span class="dv">2</span>]<span class="sc">-</span>y[<span class="dv">2</span>]), <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7.46448</code></pre>
</div>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co">#p_D and DIC from equation</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>(p_D <span class="ot">&lt;-</span> mean_D <span class="sc">-</span> D_mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.823185</code></pre>
</div>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>(DIC <span class="ot">&lt;-</span> p_D <span class="sc">+</span> mean_D)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 11.11085</code></pre>
</div>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Repeat these steps for a single model of both groups</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>post_group <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span><span class="fu">sum</span>(y), b<span class="sc">+</span><span class="fu">sum</span>(n)<span class="sc">-</span><span class="fu">sum</span>(y))</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>ll_group <span class="ot">&lt;-</span> </span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbinom</span>(y[<span class="dv">1</span>], n[<span class="dv">1</span>], post_group, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbinom</span>(y[<span class="dv">2</span>], n[<span class="dv">2</span>], post_group, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>(mean_D_group <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> ll_group))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8.576659</code></pre>
</div>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>(D_mean_group <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> (</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbinom</span>(y[<span class="dv">1</span>], n[<span class="dv">1</span>], (a<span class="sc">+</span><span class="fu">sum</span>(y)) <span class="sc">/</span> (a<span class="sc">+</span><span class="fu">sum</span>(y) <span class="sc">+</span> b<span class="sc">+</span><span class="fu">sum</span>(n)<span class="sc">-</span><span class="fu">sum</span>(y)), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbinom</span>(y[<span class="dv">2</span>], n[<span class="dv">2</span>], (a<span class="sc">+</span><span class="fu">sum</span>(y)) <span class="sc">/</span> (a<span class="sc">+</span><span class="fu">sum</span>(y) <span class="sc">+</span> b<span class="sc">+</span><span class="fu">sum</span>(n)<span class="sc">-</span><span class="fu">sum</span>(y)), <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7.587449</code></pre>
</div>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>(p_D_group <span class="ot">&lt;-</span> mean_D_group <span class="sc">-</span> D_mean_group)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9892094</code></pre>
</div>
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>(DIC_group <span class="ot">&lt;-</span> p_D_group <span class="sc">+</span> mean_D_group)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9.565868</code></pre>
</div>
</div>
<p>The DIC for the two group model is 11.1108506 and for the one common group model it is 9.5658681. The DIC for one common group model is smaller, so we do not have enough statistical evidence for two groups. If the DIC for the group-specific model is at least 3 units smaller than that for the common model, there is sufficient statistical evidence for difference between groups.</p>
</section>
<section id="monte-carlo-integration" class="level2" data-number="3.9">
<h2 data-number="3.9" class="anchored" data-anchor-id="monte-carlo-integration"><span class="header-section-number">3.9</span> Monte Carlo Integration</h2>
<p>Monte Carlo integration is an empirical way to solve the integrals related to the posterior mean and variance. The population expectation, <span class="math inline">\(E[X] = \int_{-\infty}^\infty x f(x) dx\)</span>, and variance <span class="math inline">\(Var(X) = E(X-EX)^2 = \int_{-\infty}^\infty (x - EX)^2f(x)dx\)</span>, are both integrals.</p>
<p>You can use Monte Carlo to evaluate an integral such as <span class="math inline">\(A=\int_0^1 20x(1-x)^3dx\)</span>. If you randomly select <span class="math inline">\(n\)</span> points from a defined space <span class="math inline">\(D\)</span>, the number <span class="math inline">\(z\)</span> enclosed by the integral will follow a binomial distribution, <span class="math inline">\(Z \sim \text{Bin} (n, p)\)</span> with <span class="math inline">\(E[Z] = np = n \frac{A}{D}\)</span> and variance <span class="math inline">\(Var[Z] = np(1-p) = n \frac{A}{D} \left(1-\frac{A}{D}\right)\)</span>. If you know the enclosing area, then you can infer the integral area,</p>
<p><span class="math display">\[
\begin{equation}
\hat{A} = \frac{z}{n} D
(\#eq:monte-carlo-est)
\end{equation}
\]</span></p>
<p>The variance of <span class="math inline">\(Var(\hat{A}) = Var\left(\frac{z}{n} D\right) = Var(Z) \left(\frac{z}{n}\right)^2 = \frac{A(D-A)}{n}\)</span>. Of course, you do not know <span class="math inline">\(A\)</span>, so you replace it with <span class="math inline">\(\hat{A}\)</span>. Solve this for the Monte Carlo standard error.</p>
<p><span class="math display">\[
\begin{equation}
\widehat{s.e.} = \frac{D}{\sqrt{n}} \sqrt{\frac{z}{n}\left(1 - \frac{z}{n} \right)}
(\#eq:monte-carlo-se)
\end{equation}
\]</span></p>
<p>Notice how the Monte Carlo standard error increases with D and decreases with <span class="math inline">\(n\)</span>. Let’s try it. Generate 1,000 points uniformly in the domain [0,1] x [0, 3], then check whether they are below the <code>f()</code> curve.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>) </span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {<span class="dv">20</span><span class="sc">*</span>x<span class="sc">*</span>(<span class="dv">1</span> <span class="sc">-</span> x)<span class="sc">^</span><span class="dv">3</span>}</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Defined area</span></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>D <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">*</span> <span class="dv">3</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a><span class="co"># n random points in defined area.</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="dv">0</span>, <span class="dv">3</span>)</span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a>is_under <span class="ot">&lt;-</span> y <span class="sc">&lt;=</span> <span class="fu">f</span>(x)</span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">sum</span>(is_under)</span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Area is percent of points under the curve</span></span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a>(A_hat <span class="ot">&lt;-</span> z <span class="sc">/</span> n <span class="sc">*</span> D)</span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.918</span></span>
<span id="cb141-19"><a href="#cb141-19" aria-hidden="true" tabindex="-1"></a>(se <span class="ot">&lt;-</span> D <span class="sc">/</span> <span class="fu">sqrt</span>(n) <span class="sc">*</span> <span class="fu">sqrt</span>(z<span class="sc">/</span>n <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> z<span class="sc">/</span>n)))</span>
<span id="cb141-20"><a href="#cb141-20" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.04371814</span></span>
<span id="cb141-21"><a href="#cb141-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-22"><a href="#cb141-22" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(x, <span class="at">f =</span> <span class="fu">f</span>(x), <span class="at">rand_y =</span> y, is_under) <span class="sc">%&gt;%</span> </span>
<span id="cb141-23"><a href="#cb141-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span> </span>
<span id="cb141-24"><a href="#cb141-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="fu">aes</span>(<span class="at">y =</span> f)) <span class="sc">+</span> </span>
<span id="cb141-25"><a href="#cb141-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> rand_y, <span class="at">color =</span> is_under), <span class="at">show.legend =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-68-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="inverse-sampling" class="level3" data-number="3.9.1">
<h3 data-number="3.9.1" class="anchored" data-anchor-id="inverse-sampling"><span class="header-section-number">3.9.1</span> Inverse Sampling</h3>
<p>In Bayesian analysis, you do not always have a pre-defined distribution to sample from. In these cases, you may be able to use <em>inverse sampling</em>. Given <span class="math inline">\(f(x)\)</span>, the corresponding CDF is <span class="math inline">\(F(x) = \int_0^x f(x)dx\)</span>. Derive its inverse by solving <span class="math inline">\(F(x)\)</span> for <span class="math inline">\(x\)</span>. To inverse sample, sample from <span class="math inline">\(U(0,1)\)</span> and evaluate <span class="math inline">\(x = F^{-1}(u)\)</span>.</p>
<p>Here is an example. Suppose <span class="math inline">\(f(x) = 2x\)</span> on <span class="math inline">\(x \in [0,1]\)</span> and 0 otherwise. Then <span class="math inline">\(F(x) = x^2 = u\)</span> and solving <span class="math inline">\(F(x)\)</span> for <span class="math inline">\(x\)</span>, <span class="math inline">\(F^{-1}(u) = \sqrt{u}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">4</span>)</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(u)</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(x, <span class="at">c =</span> <span class="dv">2</span><span class="sc">*</span>x) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span> <span class="fu">geom_density</span>(<span class="at">color =</span> <span class="st">"salmon"</span>) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> c))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Suppose <span class="math inline">\(f(x) = \lambda e^{-\lambda x}\)</span> on <span class="math inline">\(x \in [0,1]\)</span> and 0 otherwise. Then <span class="math inline">\(F(x) = 1 - e^{-\lambda x} = u\)</span> and <span class="math inline">\(F^{-1}(u) = - \frac{1}{\lambda} \ln [1-u]\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">4</span>)</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">/</span> lambda) <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">-</span> u)</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(x, <span class="at">c =</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>x)) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span> <span class="fu">geom_density</span>(<span class="at">color =</span> <span class="st">"salmon"</span>) <span class="sc">+</span> </span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> c))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-70-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="rejection-sampling-1" class="level3" data-number="3.9.2">
<h3 data-number="3.9.2" class="anchored" data-anchor-id="rejection-sampling-1"><span class="header-section-number">3.9.2</span> Rejection Sampling</h3>
<p>The problem is that inverse sampling only works when <span class="math inline">\(F(x)\)</span> is invertible. Another option is rejection sampling. Suppose you cannot sample from <span class="math inline">\(f_X(x)\)</span> but you can from <span class="math inline">\(g_X(x)\)</span> and the importance ratio <span class="math inline">\(\frac{f_X(x)}{g_X(x)} &lt;= M\)</span> for all <span class="math inline">\(x\)</span>. Then you can sample <span class="math inline">\(x\)</span> from <span class="math inline">\(g_X(x)\)</span>, then draw from <span class="math inline">\(u \sim U(0,1)\)</span> and accept <span class="math inline">\(y = x\)</span> with probability <span class="math inline">\(\frac{f_X(x)}{M g_X(x)}\)</span>, i.e., if accepts if <span class="math inline">\(u \ge \frac{f_X(x)}{M g_X(x)}\)</span>.</p>
<p>Return to the example where <span class="math inline">\(f(x) = 2x\)</span> on <span class="math inline">\(x \in [0,1]\)</span>. Consider <span class="math inline">\(g(x) = 1\)</span> on <span class="math inline">\(x \in [0,1]\)</span>, the pdf of uniform distribution. The ratio <span class="math inline">\({f(x)}{g(x)} = 2x \le 2\)</span> for <span class="math inline">\(x \in [0,1]\)</span>. So it is bounded by <span class="math inline">\(M = 2\)</span>. Accept <span class="math inline">\(x\)</span> with probability <span class="math inline">\(\frac{f_X(x)}{M g_X(x)} = \frac{2x}{2 \cdot 1} = x\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a><span class="co"># g(x) is uniform dist</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">4</span>)</span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a><span class="co"># probability of acceptance = x</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>p_acc <span class="ot">&lt;-</span> x</span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw from u</span></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">4</span>)</span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>is_in <span class="ot">&lt;-</span> u <span class="sc">&lt;</span> p_acc</span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep the accepted ones</span></span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a>my_sample <span class="ot">&lt;-</span> x[is_in]</span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Only kept a little more than half - no very efficient.</span></span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(my_sample)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5017</code></pre>
</div>
</div>
<p>Suppose <span class="math inline">\(f(x) = 6x(1-x)\)</span> on <span class="math inline">\(x \in [0,1]\)</span>. Consider <span class="math inline">\(g(x) = 1\)</span> on <span class="math inline">\(x \in [0,1]\)</span>, the pdf of uniform distribution. The ratio <span class="math inline">\({f(x)}{g(x)} = 6x(1-x) \le 1.5\)</span> for <span class="math inline">\(x \in [0,1]\)</span>. So it is bounded by <span class="math inline">\(M = 1.5\)</span>. Accept <span class="math inline">\(x\)</span> with probability <span class="math inline">\(\frac{f_X(x)}{M g_X(x)} = \frac{6x(1-x)}{1.5 \cdot 1} = 4x(1 - x)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="co"># g(x) is uniform dist</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">4</span>)</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a><span class="co"># probability of acceptance = </span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>p_acc <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="sc">*</span> x <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> x)</span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw from u</span></span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">4</span>)</span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>is_in <span class="ot">&lt;-</span> u <span class="sc">&lt;</span> p_acc</span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a><span class="co"># The overall acceptance probability </span></span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(is_in)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6728</code></pre>
</div>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep the accepted ones</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>my_sample <span class="ot">&lt;-</span> x[is_in]</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Only kept a little more than half - no very efficient.</span></span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(my_sample)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6728</code></pre>
</div>
</div>
</section>
<section id="importance-sampling" class="level3" data-number="3.9.3">
<h3 data-number="3.9.3" class="anchored" data-anchor-id="importance-sampling"><span class="header-section-number">3.9.3</span> Importance Sampling</h3>
<p>Importance sampling allows to substitute sampling from a “difficult” distribution with sampling from an “easy” one. Suppose you have a random variable <span class="math inline">\(x\)</span> with PDF <span class="math inline">\(f(x)\)</span>. The expected value of a function of <span class="math inline">\(x\)</span>, <span class="math inline">\(h(x)\)</span> is defined by <span class="math inline">\(E(h(x)) = \int h(x)f(x)dx\)</span>. Using the law of large numbers, you can approximate <span class="math inline">\(E(h(x))\)</span> by its average value, <span class="math inline">\(\frac{1}{n} \sum_i h(x_i)\)</span>. So you would sample from <span class="math inline">\(f(x)\)</span>, multiply by <span class="math inline">\(h(x)\)</span>, and take the average.</p>
<p>What would you do if you did not know how to sample from <span class="math inline">\(f(x)\)</span>? Instead you could identify a function you could sample from, and evaluate the integral of the ratio, <span class="math inline">\(E(h(x)) = \int\left[ h(x) \frac{f(x)}{g(x)}\right] g(x) dx\)</span>. With the law of large numbers, <span class="math inline">\(E(h(x)) = \frac{1}{n}\sum_i\left[h(x_i) \frac{f(x_i)}{g(x_i)} \right]\)</span>. The ratios <span class="math inline">\(w(x_i) = \frac{f(x_i)}{g(x_i)}\)</span> are called importance weights. Importance weights tell you how useful each observation is.</p>
<p>Suppose you have a random variable <span class="math inline">\(x\)</span> with PDF <span class="math inline">\(f(x) = 25xe^{-5x} = \text{Gamma}(2,5)\)</span> for <span class="math inline">\(X&gt;0\)</span>. If you wanted to know the expected value of <span class="math inline">\(h(x) = x\)</span> could sample straight from <code>rgamma()</code> and take the average.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">rgamma</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4011863</code></pre>
</div>
</div>
<p>Great, if <code>rgamma()</code> wasn’t an option, how would you evaluate <span class="math inline">\(\int_0^\infty x f(x)dx = \int_0^\infty 25x^2e^{-5x}dx\)</span>? Let <span class="math inline">\(g(x) = 5e^{-5x}\)</span>. Then <span class="math inline">\(E(h(x)) = \frac{1}{n}\sum_i\left[x \frac{25xe^{-5x}}{5e^{-5x}} \right] = \frac{1}{n}\sum_i 5x_i^2\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">rexp</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">5</span>, <span class="dv">5</span>)</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="dv">5</span><span class="sc">*</span>g<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3986298</code></pre>
</div>
</div>
<p>Great, if <code>rgamma()</code> wasn’t an option, how would you evaluate <span class="math inline">\(\int_0^\infty x f(x)dx = \int_0^\infty 25x^2e^{-5x}dx\)</span>? Let <span class="math inline">\(g(x) = 5e^{-5x}\)</span>. Then <span class="math inline">\(E(h(x)) = \frac{1}{n}\sum_i\left[x \frac{25xe^{-5x}}{5e^{-5x}} \right] = \frac{1}{n}\sum_i 5x_i^2\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">rexp</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">5</span>, <span class="dv">5</span>)</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="dv">5</span><span class="sc">*</span>g<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3986298</code></pre>
</div>
</div>
<p>Let’s try another one. Suppose you want to empirically estimate <span class="math inline">\(\int_0^1 x^5(1-x)^5dx\)</span>. First, use the simple Monte Carlo method to estimate the integral.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {x<span class="sc">^</span><span class="dv">5</span><span class="sc">*</span>(<span class="dv">1</span> <span class="sc">-</span> x)<span class="sc">^</span><span class="dv">5</span>}</span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the defined area. Plot f(x) over the range of x to set the appropriate limits.</span></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>y_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span><span class="sc">^-</span><span class="dv">3</span>)</span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>D <span class="ot">&lt;-</span> (x_lim[<span class="dv">2</span>] <span class="sc">-</span> x_lim[<span class="dv">1</span>]) <span class="sc">*</span> (y_lim[<span class="dv">2</span>] <span class="sc">-</span> y_lim[<span class="dv">1</span>])</span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample from D.</span></span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span></span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, x_lim[<span class="dv">1</span>], x_lim[<span class="dv">2</span>])</span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, y_lim[<span class="dv">1</span>], y_lim[<span class="dv">2</span>])</span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Area is percent of points under the curve</span></span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>is_under <span class="ot">&lt;-</span> y <span class="sc">&lt;=</span> <span class="fu">f</span>(x)</span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">sum</span>(is_under)</span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>(A_hat <span class="ot">&lt;-</span> z <span class="sc">/</span> n <span class="sc">*</span> D)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.000366</code></pre>
</div>
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>(se <span class="ot">&lt;-</span> D <span class="sc">/</span> <span class="fu">sqrt</span>(n) <span class="sc">*</span> <span class="fu">sqrt</span>(z<span class="sc">/</span>n <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> z<span class="sc">/</span>n)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.523299e-05</code></pre>
</div>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(x, <span class="at">f =</span> <span class="fu">f</span>(x), <span class="at">rand_y =</span> y, is_under) <span class="sc">%&gt;%</span> </span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span> </span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="fu">aes</span>(<span class="at">y =</span> f)) <span class="sc">+</span> </span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> rand_y, <span class="at">color =</span> is_under), <span class="at">show.legend =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-76-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now let’s do it with direct sampling. <span class="math inline">\(x^5(1-x)^5\)</span> is almost like the beta function. <span class="math inline">\(\int_0^1 x^5(1-x)^5dx = \int_0^1 \frac{x}{1260} 1260x^4(1-x)^5dx = \int_0^1 \frac{x}{1250} g(x)dx\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>(A_hat <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">rbeta</span>(n, <span class="dv">5</span>, <span class="dv">6</span>) <span class="sc">/</span> <span class="dv">1260</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0003606394</code></pre>
</div>
</div>
<p>Now let’s do it with importance sampling. Just define <span class="math inline">\(\int_0^1 x^5(1-x)^5dx = \int_0^1 x^5(1-x)^5g(x)dx\)</span> where <span class="math inline">\(g(x) = 1\)</span> is the uniform pdf.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(g<span class="sc">^</span><span class="dv">5</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>g)<span class="sc">^</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0003651211</code></pre>
</div>
</div>
</section>
</section>
<section id="metropolis-hastings-1" class="level2" data-number="3.10">
<h2 data-number="3.10" class="anchored" data-anchor-id="metropolis-hastings-1"><span class="header-section-number">3.10</span> Metropolis-Hastings</h2>
<p>For any model with likelihood <span class="math inline">\(f(y|\theta)\)</span> and prior <span class="math inline">\(f(\theta)\)</span>, you can use the Metropolis-Hastings step to estimate <span class="math inline">\(\theta\)</span>. Start with an initial <span class="math inline">\(\theta = \theta_0\)</span>. Propose a new <span class="math inline">\(\theta'\)</span> from a proposed distribution <span class="math inline">\(q(\theta'|\theta)\)</span> and evaluate the acceptance ratio,</p>
<p><span class="math display">\[
R = \frac{f(y|\theta')f(\theta')}{f(y|\theta)f(\theta)} \frac{q(\theta|\theta')}{q(\theta'|\theta)}
\]</span></p>
<p>Accept the new value with probability <span class="math inline">\(\min(R, 1)\)</span>, then repeat until convergence. Notice that if the proposed distribution is symmetric, then the second term drops out and <span class="math inline">\(R\)</span> is just the ratio of posterior distributions. The symmetric version is called <em>Metrolopolis</em> instead of <em>Metropolis-Hastings</em>.</p>
<p>If <span class="math inline">\(\theta \in \mathbb{R}\)</span> then the normal is a good proposal distribution, <span class="math inline">\(\theta'|\theta \sim N(\theta, \delta^{-2})\)</span>. The normal distribution is symmetric, so the Metropolis acceptance ratio will work.</p>
<p>Suppose you have a normal data generating process with unknown mean <span class="math inline">\(\mu\)</span> and precision <span class="math inline">\(\tau\)</span>. Your conjugate priors are <span class="math inline">\(y_i \sim N(\mu, \tau)\)</span>, <span class="math inline">\(\mu \sim N(\mu_0, \tau_0)\)</span>, and <span class="math inline">\(\tau \sim \text{Gamma}(a, b)\)</span>. The conditional distributions are those in Eqns @ref(eq:mu-posterior) and @ref(eq:tau-posterior).</p>
<p><span class="math display">\[
\begin{align}
\mu|y &amp; \sim N\left(\frac{n\tau\bar{y} + \tau_0\mu_0}{n\tau + \tau_0}, n\tau + \tau_0 \right) \\
\tau|y &amp; \sim \text{Gamma}\left(a + n/2, b + \frac{1}{2} \sum_i(y_i - \mu)^2 \right)
\end{align}
\]</span></p>
<p>Let’s replace the Gibbs step for <span class="math inline">\(\mu\)</span> with the Metropolis step. Propose a new value <span class="math inline">\(\mu^*\)</span> from the normal distribution centered around the current <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\mu' \sim N(\mu, \delta^{-2})\)</span> and evaluate the acceptance ratio as</p>
<p><span class="math display">\[
R = \frac{f(y|\mu', \tau) f(\mu'|\mu_0, \tau_0)}{f(y|\mu, \tau) f(\mu|\mu_0, \tau_0)}
\]</span></p>
<p>accepting the new value with probability <span class="math inline">\(\min (R, 1)\)</span>.</p>
<p>Suppose your data is <span class="math inline">\(n = 100\)</span> values from a <span class="math inline">\(N(\mu = 2, \tau = 1/4)\)</span> distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Use vague priors</span></span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a>mu_0 <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a>tau_0 <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">4</span>)</span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb165-11"><a href="#cb165-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-12"><a href="#cb165-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we go: Metropolis for mu, Gibbs for tau</span></span>
<span id="cb165-13"><a href="#cb165-13" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span></span>
<span id="cb165-14"><a href="#cb165-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-15"><a href="#cb165-15" aria-hidden="true" tabindex="-1"></a><span class="co"># monitors</span></span>
<span id="cb165-16"><a href="#cb165-16" aria-hidden="true" tabindex="-1"></a>mon_mu <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb165-17"><a href="#cb165-17" aria-hidden="true" tabindex="-1"></a>mon_tau <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb165-18"><a href="#cb165-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-19"><a href="#cb165-19" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize the algorithm</span></span>
<span id="cb165-20"><a href="#cb165-20" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">mean</span>(y)</span>
<span id="cb165-21"><a href="#cb165-21" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">var</span>(y)</span>
<span id="cb165-22"><a href="#cb165-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-23"><a href="#cb165-23" aria-hidden="true" tabindex="-1"></a><span class="co"># width of proposal distribution for mu</span></span>
<span id="cb165-24"><a href="#cb165-24" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb165-25"><a href="#cb165-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-26"><a href="#cb165-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>ITER) {</span>
<span id="cb165-27"><a href="#cb165-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mu step.</span></span>
<span id="cb165-28"><a href="#cb165-28" aria-hidden="true" tabindex="-1"></a>  mu_new <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mu, <span class="at">sd =</span> delta)</span>
<span id="cb165-29"><a href="#cb165-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-30"><a href="#cb165-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># log of the acceptance ratio</span></span>
<span id="cb165-31"><a href="#cb165-31" aria-hidden="true" tabindex="-1"></a>  logR <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">dnorm</span>(y, mu_new, <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(tau), <span class="at">log =</span> T)) <span class="sc">-</span> <span class="co"># new likelihood</span></span>
<span id="cb165-32"><a href="#cb165-32" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sum</span>(<span class="fu">dnorm</span>(y, mu    , <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(tau), <span class="at">log =</span> T)) <span class="sc">+</span> <span class="co"># old likelihood</span></span>
<span id="cb165-33"><a href="#cb165-33" aria-hidden="true" tabindex="-1"></a>          <span class="fu">dnorm</span>(mu_new,mu_0, <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(tau_0), <span class="at">log =</span> T)  <span class="sc">-</span> <span class="co"># new prior</span></span>
<span id="cb165-34"><a href="#cb165-34" aria-hidden="true" tabindex="-1"></a>          <span class="fu">dnorm</span>(mu    ,mu_0, <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(tau_0), <span class="at">log =</span> T)    <span class="co"># old prior</span></span>
<span id="cb165-35"><a href="#cb165-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-36"><a href="#cb165-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># accept with probability min(R,1)</span></span>
<span id="cb165-37"><a href="#cb165-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># draw U from uniform(0,1) and accept if logU &lt; logR</span></span>
<span id="cb165-38"><a href="#cb165-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note: larger delta results in algorithm proposes candidates outside the main</span></span>
<span id="cb165-39"><a href="#cb165-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># support of the posterior and acceptance rate will be low.</span></span>
<span id="cb165-40"><a href="#cb165-40" aria-hidden="true" tabindex="-1"></a>  logU <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb165-41"><a href="#cb165-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(logU <span class="sc">&lt;</span> logR){mu <span class="ot">&lt;-</span> mu_new}</span>
<span id="cb165-42"><a href="#cb165-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-43"><a href="#cb165-43" aria-hidden="true" tabindex="-1"></a>  <span class="do">#### STEP for TAU</span></span>
<span id="cb165-44"><a href="#cb165-44" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, a <span class="sc">+</span> n <span class="sc">/</span> <span class="dv">2</span>, b <span class="sc">+</span> .<span class="dv">5</span> <span class="sc">*</span> <span class="fu">sum</span>((y <span class="sc">-</span> mu)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb165-45"><a href="#cb165-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-46"><a href="#cb165-46" aria-hidden="true" tabindex="-1"></a>  <span class="do">#### UPDATING THE MONITORS:</span></span>
<span id="cb165-47"><a href="#cb165-47" aria-hidden="true" tabindex="-1"></a>  mon_mu[i] <span class="ot">&lt;-</span> mu</span>
<span id="cb165-48"><a href="#cb165-48" aria-hidden="true" tabindex="-1"></a>  mon_tau[i] <span class="ot">&lt;-</span> tau</span>
<span id="cb165-49"><a href="#cb165-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb165-50"><a href="#cb165-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-51"><a href="#cb165-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that if you set delta to .01, there was a lot of autocorrelation in mu</span></span>
<span id="cb165-52"><a href="#cb165-52" aria-hidden="true" tabindex="-1"></a><span class="co"># and it did not converge. But if you set it to .1 it does a little better.</span></span>
<span id="cb165-53"><a href="#cb165-53" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(mon_mu, <span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span>ITER) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> mon_mu)) <span class="sc">+</span> <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-79-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Suppose a study estimates the sex-ratio of bird chicks. From prior studies, you settle on a beta prior <span class="math inline">\(p \sim \text{Beta}(20, 20)\)</span> that a chick is female. From a batch of eggs, 5 are male and 1 is female. The number of expected females is <span class="math inline">\(x|p \sim \text{Bin}(n, p)\)</span>. Using the simple beta-binomial model, the posterior mean for <span class="math inline">\(p = \frac{(a + y)}{(a+y) + (b + (n - y))} = .456\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>(<span class="dv">20</span> <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">/</span> ((<span class="dv">20</span> <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">+</span> (<span class="dv">20</span> <span class="sc">+</span> (<span class="dv">6</span> <span class="sc">-</span> <span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4565217</code></pre>
</div>
</div>
<p>In this case, the <span class="math inline">\(n\)</span> is also uncertain since some eggs may have been lost. From prior studies you expect <span class="math inline">\(n \sim \text{Pois}(12)\)</span>. Use MCMC to estimate posterior distributions of <span class="math inline">\(p\)</span> and <span class="math inline">\(n\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Data: 5 males and 1 female</span></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Prior distributions: beta(20, 20) for p; derived for n.</span></span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a><span class="co"># MCMC algorithm</span></span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span></span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a>p_monitor <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a>n_monitor <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb168-16"><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-17"><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>ITER) {</span>
<span id="cb168-18"><a href="#cb168-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample p.</span></span>
<span id="cb168-19"><a href="#cb168-19" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(<span class="dv">1</span>, a <span class="sc">+</span> y, b <span class="sc">+</span> (n <span class="sc">-</span> y))</span>
<span id="cb168-20"><a href="#cb168-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-21"><a href="#cb168-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sample n</span></span>
<span id="cb168-22"><a href="#cb168-22" aria-hidden="true" tabindex="-1"></a>  n_vals <span class="ot">&lt;-</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">25</span></span>
<span id="cb168-23"><a href="#cb168-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This distribution was derived for me.</span></span>
<span id="cb168-24"><a href="#cb168-24" aria-hidden="true" tabindex="-1"></a>  n_prob <span class="ot">&lt;-</span> (lambda <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> p))<span class="sc">^</span>n_vals <span class="sc">/</span> (<span class="fu">factorial</span>(n_vals <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb168-25"><a href="#cb168-25" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">sample</span>(n_vals, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, n_prob)</span>
<span id="cb168-26"><a href="#cb168-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-27"><a href="#cb168-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Update priors</span></span>
<span id="cb168-28"><a href="#cb168-28" aria-hidden="true" tabindex="-1"></a>  p_monitor[i] <span class="ot">&lt;-</span> p</span>
<span id="cb168-29"><a href="#cb168-29" aria-hidden="true" tabindex="-1"></a>  n_monitor[i] <span class="ot">&lt;-</span> n</span>
<span id="cb168-30"><a href="#cb168-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb168-31"><a href="#cb168-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-32"><a href="#cb168-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop the first 500 observations as burn-in.</span></span>
<span id="cb168-33"><a href="#cb168-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior mean for n</span></span>
<span id="cb168-34"><a href="#cb168-34" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(n_monitor[<span class="dv">501</span><span class="sc">:</span>ITER]) <span class="sc">%&gt;%</span> <span class="fu">which.max</span>()</span>
<span id="cb168-35"><a href="#cb168-35" aria-hidden="true" tabindex="-1"></a><span class="do">## 8 </span></span>
<span id="cb168-36"><a href="#cb168-36" aria-hidden="true" tabindex="-1"></a><span class="do">## 3</span></span>
<span id="cb168-37"><a href="#cb168-37" aria-hidden="true" tabindex="-1"></a><span class="fu">max</span>(<span class="fu">table</span>(n_monitor[<span class="dv">501</span><span class="sc">:</span>ITER])) <span class="sc">/</span> (ITER<span class="dv">-501</span>)</span>
<span id="cb168-38"><a href="#cb168-38" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.1923848</span></span>
<span id="cb168-39"><a href="#cb168-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior mean for p</span></span>
<span id="cb168-40"><a href="#cb168-40" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(p_monitor)</span>
<span id="cb168-41"><a href="#cb168-41" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.4349155</span></span>
<span id="cb168-42"><a href="#cb168-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-43"><a href="#cb168-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for convergence.</span></span>
<span id="cb168-44"><a href="#cb168-44" aria-hidden="true" tabindex="-1"></a><span class="co"># p</span></span>
<span id="cb168-45"><a href="#cb168-45" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">index =</span> <span class="dv">1</span><span class="sc">:</span>ITER, <span class="at">p =</span> p_monitor) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> index, <span class="at">y =</span> p)) <span class="sc">+</span> <span class="fu">geom_line</span>()</span>
<span id="cb168-46"><a href="#cb168-46" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">p =</span> p_monitor) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> p)) <span class="sc">+</span> <span class="fu">geom_density</span>()</span>
<span id="cb168-47"><a href="#cb168-47" aria-hidden="true" tabindex="-1"></a><span class="co"># n</span></span>
<span id="cb168-48"><a href="#cb168-48" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">index =</span> <span class="dv">1</span><span class="sc">:</span>ITER, <span class="at">n =</span> n_monitor) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> index, <span class="at">y =</span> n)) <span class="sc">+</span> <span class="fu">geom_line</span>()</span>
<span id="cb168-49"><a href="#cb168-49" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">p =</span> n_monitor) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> p)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>)</span>
<span id="cb168-50"><a href="#cb168-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-51"><a href="#cb168-51" aria-hidden="true" tabindex="-1"></a>(p1<span class="sc">+</span>p2)<span class="sc">/</span>(p3<span class="sc">+</span>p4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-81-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="mixed-effects-linear-regression" class="level2" data-number="3.11">
<h2 data-number="3.11" class="anchored" data-anchor-id="mixed-effects-linear-regression"><span class="header-section-number">3.11</span> Mixed Effects Linear Regression</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>bp <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"./input/BP.csv"</span>, <span class="at">col_types =</span> <span class="fu">c</span>(<span class="st">"iicd"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The basic mixed effects regression model is</p>
<p><span class="math display">\[
\text{BP}_i = \beta_0 + \beta_1 \text{G}_i + \xi_{\text{PID}_i} + \epsilon_i
\]</span></p>
<p>where <span class="math inline">\(G_i\)</span> is the before/after dummy. <span class="math inline">\(\beta_0\)</span> is the expected BP before the treatment, <span class="math inline">\(\beta_1\)</span> is the average population effect, <span class="math inline">\(\xi_{\text{PID}_i}\)</span> is the patient-specific deviation in BP from the population mean, and <span class="math inline">\(\epsilon_i\)</span> is random error. You can group the terms as <span class="math inline">\(\text{BP}_i = (\beta_0 + \xi_{\text{PID}_i}) + \beta_1 \text{G}_i + \epsilon_i\)</span>. You can rewrite this in Bayesian form, <span class="math inline">\(\text{BP}_i | \mu_i, \tau_i \sim N(\mu_i, \tau_i)\)</span> where <span class="math inline">\(\mu_i = \beta_0 + \xi_{\text{PID}_i} + \beta_1 \text{G}_i\)</span>.</p>
<p>In abscense of other information, use vague priors with large variance, <span class="math inline">\(\beta_0, \beta_1 \sim N(0, 10^{-8})\)</span>, and <span class="math inline">\(\tau \sim \text{Gamma}(a,b)\)</span> with <span class="math inline">\(a=.01\)</span> and <span class="math inline">\(b = .01\)</span>. What about <span class="math inline">\(\xi\)</span>? The deviation can be any value, positive or negative, so go with a normal distribution with zero expected value, <span class="math inline">\(\xi_j \sim N(0, \tau_\xi)\)</span> where <span class="math inline">\(j\)</span> is the patient id with <span class="math inline">\(\tau_\xi \sim \text{Gamma}(a_\xi, b_\xi)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MCMCglmm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">MCMCglmm</span>(BP <span class="sc">~</span> Group, <span class="at">random =</span> <span class="sc">~</span>PID, <span class="at">data =</span> bp, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Iterations = 3001:12991
 Thinning interval  = 10
 Sample size  = 1000 

 DIC: 49.09769 

 G-structure:  ~PID

    post.mean l-95% CI u-95% CI eff.samp
PID     12.69    3.754    26.49    796.7

 R-structure:  ~units

      post.mean l-95% CI u-95% CI eff.samp
units    0.4678   0.1236    1.002    821.8

 Location effects: BP ~ Group 

            post.mean l-95% CI u-95% CI eff.samp  pMCMC    
(Intercept)   138.775  136.322  141.196     1000 &lt;0.001 ***
GroupBefore     2.251    1.671    2.825     1000 &lt;0.001 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>The posterior mean estimated difference in the blood pressure is 2.25 mmHg higher before the treatment than after (95% CI 1.642, 2.917). The pMCMC is not really a p-value (see documentation). Instead, you can get the posterior probability that <span class="math inline">\(\beta_1 &gt; 0\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(m1<span class="sc">$</span>Sol[, <span class="dv">2</span>] <span class="sc">&gt;</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<p>You can report <em>The treatment was estimated to lower the blood pressure by an average 2.25 mmHg, 95%CI: (1.642, 2.917), P&gt;0.999.</em></p>
<p>Convergence diagnostics:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m1<span class="sc">$</span>Sol)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-86-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The random effects <span class="math inline">\(\xi_{PID}\)</span> are usually not of interest and not retained. This much was a sloppy, out-of-the-box, fit. You should be explicit about priors, iterations, burn-in, etc.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>prior<span class="ot">&lt;-</span><span class="fu">list</span>(</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>      <span class="co"># mean and variance-covariance matrix for the normal prior on fixed coefficients</span></span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">B=</span><span class="fu">list</span>(<span class="at">mu=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="at">V=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1000</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1000</span>),<span class="dv">2</span>,<span class="dv">2</span>)),</span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>      <span class="co"># and for the residual variance tau and random effect variance tau.xi</span></span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a>      <span class="co"># this package uses Wishart distribution (not inverse Gamma)</span></span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">R=</span><span class="fu">list</span>(<span class="at">V=</span><span class="dv">1</span>, <span class="at">nu=</span><span class="fl">0.002</span>), <span class="at">G=</span><span class="fu">list</span>(<span class="at">G1=</span><span class="fu">list</span>(<span class="at">V=</span><span class="dv">1</span>, <span class="at">nu=</span><span class="fl">0.002</span>)))</span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">MCMCglmm</span>(BP <span class="sc">~</span> Group, <span class="at">random=</span><span class="sc">~</span>PID, <span class="at">data=</span>bp, <span class="at">verbose=</span>F,</span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">nitt=</span><span class="dv">15000</span>, <span class="at">thin =</span> <span class="dv">10</span>, <span class="at">burnin=</span><span class="dv">5000</span>, <span class="co"># iterations, thinning and burn-in</span></span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">pr=</span><span class="cn">TRUE</span>, <span class="co"># save random effects</span></span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">DIC=</span><span class="cn">TRUE</span>, <span class="co"># evaluate the DIC</span></span>
<span id="cb176-12"><a href="#cb176-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">prior=</span>prior</span>
<span id="cb176-13"><a href="#cb176-13" aria-hidden="true" tabindex="-1"></a>               )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can see the random effects now.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(m2<span class="sc">$</span>Sol)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1000   12</code></pre>
</div>
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">PID =</span> <span class="fu">factor</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>),</span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">xi_mean =</span> <span class="fu">apply</span>(m2<span class="sc">$</span>Sol[, <span class="dv">3</span><span class="sc">:</span><span class="dv">12</span>], <span class="dv">2</span>, mean),</span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">xi_lci =</span> <span class="fu">apply</span>(m2<span class="sc">$</span>Sol[,<span class="dv">3</span><span class="sc">:</span><span class="dv">12</span>], <span class="dv">2</span>, quantile, .<span class="dv">025</span>),</span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">xi_uci =</span> <span class="fu">apply</span>(m2<span class="sc">$</span>Sol[,<span class="dv">3</span><span class="sc">:</span><span class="dv">12</span>], <span class="dv">2</span>, quantile, .<span class="dv">975</span>)</span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> PID)) <span class="sc">+</span></span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">y =</span> xi_lci, <span class="at">yend =</span> xi_uci, <span class="at">xend =</span> PID)) <span class="sc">+</span></span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> xi_mean)) <span class="sc">+</span></span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="fu">aes</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">0</span>), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">str_wrap</span>(</span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Patient-specific posterior means and credible intervals for deviations in BP from population mean"</span>,</span>
<span id="cb179-13"><a href="#cb179-13" aria-hidden="true" tabindex="-1"></a>    <span class="dv">80</span>)</span>
<span id="cb179-14"><a href="#cb179-14" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-bayesian-statistics_files/figure-html/unnamed-chunk-88-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You might now ask how certain we are that participant 2 had a lower BP than participant 4, <span class="math inline">\(P(\xi_2 &lt; \xi_4 | \text{data})\)</span>?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(m2<span class="sc">$</span>Sol[, <span class="dv">2</span><span class="sc">+</span><span class="dv">2</span>] <span class="sc">&lt;</span> m2<span class="sc">$</span>Sol[, <span class="dv">2</span><span class="sc">+</span><span class="dv">4</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<p>It’s nearly certain. How about your certainty that participant 2 is the lowest?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove first 2 cols. Apply which.min() to rows. How often is col 2 the min?</span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">apply</span>(m2<span class="sc">$</span>Sol[, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)], <span class="dv">1</span>, which.min) <span class="sc">==</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.946</code></pre>
</div>
</div>
</section>
<section id="appendix-bayes-factors" class="level2" data-number="3.12">
<h2 data-number="3.12" class="anchored" data-anchor-id="appendix-bayes-factors"><span class="header-section-number">3.12</span> Appendix: Bayes Factors</h2>
<p>The Bayes Factor (BF) is a measure of the relative evidence of one model over another. Take another look at Bayes’ formula:</p>
<p><span class="math display">\[P(\theta|D) = \frac{P(D|\theta)P(\theta)}{P(D)}.\]</span></p>
<p>Suppose you want to compare how two models explain and observed data outcome, <span class="math inline">\(D\)</span>. Model <span class="math inline">\(M_1:f_1(D|\theta_1)\)</span> says the observed data <span class="math inline">\(D\)</span> was produced by a generative model with pdf <span class="math inline">\(f_1\)</span> parameterized by <span class="math inline">\(\theta_2\)</span>. Model <span class="math inline">\(M_2:f_2(D|\theta_2)\)</span> says it was produced by a generative model with pdf <span class="math inline">\(f_2\)</span> parameterized by <span class="math inline">\(\theta_2\)</span>. In each model you specify a prior probability distribution for the parameter</p>
<p>If you take the ratio of the posterior probabilities, the posterior odds, the <span class="math inline">\(P(D)\)</span> terms cancel and you have</p>
<p><span class="math display">\[\frac{P(\theta_1|D)}{P(\theta_2|D)} = \frac{P(D|\theta_1)}{P(D|\theta_2)} \cdot \frac{P(\theta_1)}{P(\theta_2)}\]</span></p>
<p>The posterior odds equals the ratio of the likelihoods multiplied by the prior odds. That likelihood ratio is the Bayes Factor (BF). Rearranging, BF is the odds ratio of the posterior and prior odds.</p>
<p><span class="math display">\[BF = \frac{P(D|\theta_1)}{P(D|\theta_2)} = \mathrm{\frac{Posterior Odds}{Prior Odds}}\]</span></p>
<p>Return to the example of observing <span class="math inline">\(D\)</span> = 7 ones and 3 zeros. You can compare an hypothesized <span class="math inline">\(\theta\)</span> of .5 to a completely agnostic model where <span class="math inline">\(\theta\)</span> is uniform over [0, 1]. The likelihood of observing <span class="math inline">\(D\)</span> when <span class="math inline">\(\theta\)</span> = .5 is <span class="math inline">\(P(D|\theta_1) = 5^7(1-.5)^3\)</span> = 0.117. The likelihood of observing <span class="math inline">\(D\)</span> where <span class="math inline">\(\theta\)</span> is uniform on [0, 1] is <span class="math inline">\(P(D|\theta_2) = \int_0^1 \binom{10}{3}q^7(1-q)^3dq\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>.<span class="dv">5</span><span class="sc">^</span><span class="dv">1</span> <span class="sc">*</span> .<span class="dv">5</span><span class="sc">^</span><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.25</code></pre>
</div>
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, .<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbinom</span>(<span class="dv">11</span>, <span class="dv">11</span>, .<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0004882812</code></pre>
</div>
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="fu">beta</span>(<span class="dv">11</span>, <span class="dv">11</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.577402e-07</code></pre>
</div>
</div>
<p>with a uniform Beta(1, 1) prior (i.e., complete agnosticism).</p>
<p>The Bayes factor at <span class="math inline">\(\theta\)</span> = .7 quantifies how much the odds of H0: <span class="math inline">\(\theta\)</span> = .7 over H1: <span class="math inline">\(\hat{\theta}\)</span> = .7.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, alpha, beta) {</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span> <span class="sc">/</span> <span class="fu">beta</span>(alpha, beta)) <span class="sc">*</span> theta<span class="sc">^</span>(alpha<span class="dv">-1</span>) <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>theta)<span class="sc">^</span>(beta<span class="dv">-1</span>)</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>posterior <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, alpha, beta, a, b) {</span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span> <span class="sc">/</span> <span class="fu">beta</span>(alpha <span class="sc">+</span> a, beta <span class="sc">+</span> b)) <span class="sc">*</span> theta<span class="sc">^</span>(alpha<span class="dv">-1</span><span class="sc">+</span>a) <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>theta)<span class="sc">^</span>(beta<span class="dv">-1</span><span class="sc">+</span>b)</span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a><span class="fu">prior</span>(.<span class="dv">5</span>, <span class="dv">115</span>, <span class="dv">85</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.164377</code></pre>
</div>
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior</span>(.<span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.700138</code></pre>
</div>
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior</span>(.<span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">10</span>) <span class="sc">/</span> <span class="fu">prior</span>(.<span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">1</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.700138</code></pre>
</div>
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">/</span> <span class="fu">beta</span>(<span class="dv">115</span>, <span class="dv">85</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.677704e+59</code></pre>
</div>
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior Distribution </span></span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">/</span><span class="fu">beta</span>(<span class="dv">1</span><span class="sc">+</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">+</span><span class="dv">10</span>) <span class="sc">*</span> .<span class="dv">5</span><span class="sc">^</span>(<span class="dv">1-1</span><span class="sc">+</span><span class="dv">10</span>) <span class="sc">*</span> (<span class="dv">1</span><span class="fl">-.5</span>)<span class="sc">^</span>(<span class="dv">1-1</span><span class="sc">+</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.700138</code></pre>
</div>
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbeta</span>(.<span class="dv">5</span>, <span class="dv">11</span>, <span class="dv">11</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.700138</code></pre>
</div>
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prior Beta Distributions</span></span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">/</span><span class="fu">beta</span>(<span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">*</span> .<span class="dv">5</span><span class="sc">^</span>(<span class="dv">1-1</span>) <span class="sc">*</span> (<span class="dv">1</span><span class="fl">-.5</span>)<span class="sc">^</span>(<span class="dv">1-1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbeta</span>(.<span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbeta</span>(.<span class="dv">5</span>, <span class="dv">115</span>, <span class="dv">85</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.164377</code></pre>
</div>
</div>
<p>The Bayes factor measures how much your prior belief is altered by the evidence. It is the ratio of the likelihoods at some hypothesized value before and after observing the data. In this case, our confidence increased by a factor of…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb210-6"><a href="#cb210-6" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb210-7"><a href="#cb210-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-8"><a href="#cb210-8" aria-hidden="true" tabindex="-1"></a>(prior_likelihood <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">/</span> <span class="fu">beta</span>(alpha, beta)) <span class="sc">*</span> theta<span class="sc">^</span>(alpha<span class="dv">-1</span>) <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>theta)<span class="sc">^</span>(beta<span class="dv">-1</span>))</span>
<span id="cb210-9"><a href="#cb210-9" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1</span></span>
<span id="cb210-10"><a href="#cb210-10" aria-hidden="true" tabindex="-1"></a>(posterior_likelihood <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">/</span> <span class="fu">beta</span>(alpha <span class="sc">+</span> a, beta <span class="sc">+</span> b)) <span class="sc">*</span> theta<span class="sc">^</span>(alpha<span class="dv">-1</span><span class="sc">+</span>a) <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>theta)<span class="sc">^</span>(beta<span class="dv">-1</span><span class="sc">+</span>b))</span>
<span id="cb210-11"><a href="#cb210-11" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 3.700138</span></span>
<span id="cb210-12"><a href="#cb210-12" aria-hidden="true" tabindex="-1"></a>(bayes_factor <span class="ot">&lt;-</span> posterior_likelihood <span class="sc">/</span> prior_likelihood)</span>
<span id="cb210-13"><a href="#cb210-13" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 3.700138</span></span>
<span id="cb210-14"><a href="#cb210-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-15"><a href="#cb210-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.7 on alpha = beta = 1</span></span>
<span id="cb210-16"><a href="#cb210-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 1.91 on alpha = beta = 4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="further-reading" class="level2" data-number="3.13">
<h2 data-number="3.13" class="anchored" data-anchor-id="further-reading"><span class="header-section-number">3.13</span> Further Reading</h2>
<p>Most of my notes are from the two course <a href="https://www.edx.org/certificates/professional-certificate/ucx-bayesian-statistics-using-r">Bayesian Statistics Using R</a> certificate program instructed by Elena Moltchanova. Elena recommends two books as standard reading material for serious Bayesian students. <em>Bayesian Data Analysis</em> <span class="citation" data-cites="Gelman2013">(<a href="#ref-Gelman2013" role="doc-biblioref">Gelman 2013</a>)</span> is considered the definitive textbook on the topic. <em>Statistical rethinking: A Bayesian course with examples in R and Stan</em> <span class="citation" data-cites="McElreath2020">(<a href="#ref-McElreath2020" role="doc-biblioref">McElreath 2020</a>)</span> is a more friendly introduction to Bayesian statistics.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Gelman2013" class="csl-entry" role="listitem">
Gelman, Andrew. 2013. <em>Bayesian Data Analysis</em>. 3rd ed. Chapman &amp; Hall. <a href="https://www.amazon.com/Bayesian-Analysis-Chapman-Statistical-Science-ebook-dp-B00I60M6H6/dp/B00I60M6H6/ref=mt_other?_encoding=UTF8&amp;me=&amp;qid=">https://www.amazon.com/Bayesian-Analysis-Chapman-Statistical-Science-ebook-dp-B00I60M6H6/dp/B00I60M6H6/ref=mt_other?_encoding=UTF8&amp;me=&amp;qid=</a>.
</div>
<div id="ref-McElreath2020" class="csl-entry" role="listitem">
McElreath, Richard. 2020. <em>Statistical Rethinking: A Bayesian Course with Examples in r and STAN</em>. 2nd ed. Chapman &amp; Hall. <a href="https://xcelab.net/rm/statistical-rethinking/">https://xcelab.net/rm/statistical-rethinking/</a>.
</div>
</div>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p><code>dbinom(seq(1, 100, 1), 100, .5)</code> sums to 1, but <code>dnorm(seq(0,50,.001), 10, 10)</code> sums to 841.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Some of these notes are from DataCamp course <a href="https://learn.datacamp.com/courses/fundamentals-of-bayesian-data-analysis-in-r">Fundamentals of Bayesian Data Analysis in R</a>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>The gamma function is a generic function, just like sin, cos, etc., and is a kind of generalized factorial.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>In Bayesian statistics, the normal distribution is parameterized with the inverse of variance, called the <em>precision</em>, <span class="math inline">\(\tau = 1 / \sigma^2\)</span>.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./02-likelihood-statistics.html" class="pagination-link" aria-label="Likelihood Statistics">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Likelihood Statistics</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./04-one-sample.html" class="pagination-link" aria-label="One-Sample">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">One-Sample</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb211" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Bayesian Statistics</span></span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a><span class="in">```{r include=FALSE}</span></span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a><span class="in">library(patchwork)</span></span>
<span id="cb211-6"><a href="#cb211-6" aria-hidden="true" tabindex="-1"></a><span class="in">library(glue)</span></span>
<span id="cb211-7"><a href="#cb211-7" aria-hidden="true" tabindex="-1"></a><span class="in">library(scales)</span></span>
<span id="cb211-8"><a href="#cb211-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-9"><a href="#cb211-9" aria-hidden="true" tabindex="-1"></a><span class="in">source("./setup.R")</span></span>
<span id="cb211-10"><a href="#cb211-10" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-11"><a href="#cb211-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-12"><a href="#cb211-12" aria-hidden="true" tabindex="-1"></a>Bayesian inference is an alternative to classical (aka, frequentist) inference. Both methods assume a data generating mechanism expressed as a likelihood, but while classical inference treats the mechanism as infinitely repeatable, Bayesian inference treats each event as unique. Instead of estimating a single population parameter (usually the mean), Bayesian inference estimates the parameter _distribution_. In fact Bayesian inference insists that *all* uncertainties be described by probabilities. Finally, whereas the machinery of classical inference is maximizing likelihood, Bayesian inference updates a prior probability distribution in light of the new information.</span>
<span id="cb211-13"><a href="#cb211-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-14"><a href="#cb211-14" aria-hidden="true" tabindex="-1"></a><span class="fu">## Bayes' Theorem</span></span>
<span id="cb211-15"><a href="#cb211-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-16"><a href="#cb211-16" aria-hidden="true" tabindex="-1"></a>Bayes' Theorem is the inverse conditional probability, the probability of the condition given the observed outcome. It reorganizes the relationship between joint probability and conditional probability.</span>
<span id="cb211-17"><a href="#cb211-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-18"><a href="#cb211-18" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-19"><a href="#cb211-19" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-20"><a href="#cb211-20" aria-hidden="true" tabindex="-1"></a>P(\theta D) = P(\theta|D)P(D) &amp;= P(D|\theta)P(\theta) <span class="sc">\\</span></span>
<span id="cb211-21"><a href="#cb211-21" aria-hidden="true" tabindex="-1"></a>P(\theta|D) &amp;= \frac{P(D|\theta)P(\theta)}{P(D)}</span>
<span id="cb211-22"><a href="#cb211-22" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-23"><a href="#cb211-23" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-24"><a href="#cb211-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-25"><a href="#cb211-25" aria-hidden="true" tabindex="-1"></a>The probability of $\theta$ after observing $D$ is equal to the probability of observing $D$ when $\theta$ is true divided by the probability of observing $D$ under _any_ circumstance.</span>
<span id="cb211-26"><a href="#cb211-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-27"><a href="#cb211-27" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Think of $P(\theta)$ as the strength of your belief *prior* to considering $D$.</span>
<span id="cb211-28"><a href="#cb211-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-29"><a href="#cb211-29" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$P(D|\theta)$ is the *likelihood* of observing $D$ from a generative model with parameter $\theta$. Likelihoods are probability densities, and are not quite the same as probabilities. For continuous variables, likelihoods will sum to greater than 1.^<span class="co">[</span><span class="ot">`dbinom(seq(1, 100, 1), 100, .5)` sums to `r sum(dbinom(seq(1, 100, 1), 100, .5))`, but `dnorm(seq(0,50,.001), 10, 10)` sums to `r scales::number(sum(dnorm(seq(0,50,.001), 10, 10)), accuracy = 1)`.</span><span class="co">]</span></span>
<span id="cb211-30"><a href="#cb211-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-31"><a href="#cb211-31" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$P(D)$ is the likelihood of observing $D$ from *any* prior. It is the *marginal distribution*, or *prior predictive distribution* of $D$. The likelihood divided by the marginal distribution is the proportional adjustment made to the prior in light of the data.</span>
<span id="cb211-32"><a href="#cb211-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-33"><a href="#cb211-33" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>$P(\theta|D)$ is the strength of your belief *posterior* to considering $D$.</span>
<span id="cb211-34"><a href="#cb211-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-35"><a href="#cb211-35" aria-hidden="true" tabindex="-1"></a>One illustration of Bayes' Theorem is interpreting medical tests. $P(D|\theta)$ is the test's *sensitivity*, the probability of a positive test result $D$ when the condition $\theta$ in fact exists. $P(\theta)$ is the probability prior to testing, the general rate. The numerator of Bayes' Theorem is the joint probability, the probability of having the condition and testing positive, $P(D \theta) = P(D|\theta)P(\theta)$. However, there is another way to test positive - the false positive, $P(D | \hat{\theta})$! A test's *specificity* is the probability of a negative test result when the condition does not exist. Specificity is the compliment of the false positive, $P(\hat{D} | \hat{\theta}) = 1 - P(D | \hat{\theta})$. The denominator of Bayes' Theorem is the overall probability of a positive test result. </span>
<span id="cb211-36"><a href="#cb211-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-37"><a href="#cb211-37" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-38"><a href="#cb211-38" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-39"><a href="#cb211-39" aria-hidden="true" tabindex="-1"></a>P(\theta|D) &amp;= \frac{P(D|\theta)P(\theta)}{P(D)} <span class="sc">\\</span> </span>
<span id="cb211-40"><a href="#cb211-40" aria-hidden="true" tabindex="-1"></a>&amp;= \frac{P(D|\theta)P(\theta)}{P(D|\theta)P(\theta) + P(D|\hat\theta)P(\hat\theta)} <span class="sc">\\</span></span>
<span id="cb211-41"><a href="#cb211-41" aria-hidden="true" tabindex="-1"></a>&amp;= \frac{\text{sensitivity} \cdot \text{prior}}{\text{sensitivity} \cdot \text{prior} + (1 - \text{specificity}) \cdot (1 - \text{prior})}</span>
<span id="cb211-42"><a href="#cb211-42" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-43"><a href="#cb211-43" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-44"><a href="#cb211-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-45"><a href="#cb211-45" aria-hidden="true" tabindex="-1"></a>Suppose E. Coli is typically present in $P(\theta)$ = 4.5% of samples, and an E. Coli screen has a sensitivity of $P(D|\theta)$ = 95% and a specificity of 1 - $P(D|\hat\theta)$ = 99%. Given a positive test result, what is the probability that E. Coli is actually present?</span>
<span id="cb211-46"><a href="#cb211-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-47"><a href="#cb211-47" aria-hidden="true" tabindex="-1"></a>$$P(\theta|D) = \frac{.95\cdot .045}{.95\cdot .045 + (1 - .99)(1 - .045)} = \frac{.04275}{.05230} = 81.7\%.$$</span>
<span id="cb211-48"><a href="#cb211-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-49"><a href="#cb211-49" aria-hidden="true" tabindex="-1"></a>The elements of Bayes' Theorem come directly from the contingency table. The first row is the positive test result. The probability of E. Coli is the joint probability of E. Coli and a positive test divided by the probability of a positive test.</span>
<span id="cb211-50"><a href="#cb211-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-51"><a href="#cb211-51" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE}</span></span>
<span id="cb211-52"><a href="#cb211-52" aria-hidden="true" tabindex="-1"></a><span class="in">tribble(</span></span>
<span id="cb211-53"><a href="#cb211-53" aria-hidden="true" tabindex="-1"></a><span class="in">  ~` `, ~`E. Coli`, ~Safe, ~Total,</span></span>
<span id="cb211-54"><a href="#cb211-54" aria-hidden="true" tabindex="-1"></a><span class="in">  "Positive Test", ".95 * .045 = 0.04275", ".01 * .955 = 0.00955", "0.05230",</span></span>
<span id="cb211-55"><a href="#cb211-55" aria-hidden="true" tabindex="-1"></a><span class="in">  "Negative Test", ".05 * .045 = 0.00225", ".99 * .955 = 0.94545", "0.94770",</span></span>
<span id="cb211-56"><a href="#cb211-56" aria-hidden="true" tabindex="-1"></a><span class="in">  "Total", "0.04500", "0.95500", "1.00000"</span></span>
<span id="cb211-57"><a href="#cb211-57" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;%</span></span>
<span id="cb211-58"><a href="#cb211-58" aria-hidden="true" tabindex="-1"></a><span class="in">  flextable::flextable() %&gt;%</span></span>
<span id="cb211-59"><a href="#cb211-59" aria-hidden="true" tabindex="-1"></a><span class="in">  flextable::theme_box() %&gt;%</span></span>
<span id="cb211-60"><a href="#cb211-60" aria-hidden="true" tabindex="-1"></a><span class="in">  flextable::align(align = "center", part = "header") %&gt;%</span></span>
<span id="cb211-61"><a href="#cb211-61" aria-hidden="true" tabindex="-1"></a><span class="in">  flextable::align(j = 2:4, align = "right") %&gt;%</span></span>
<span id="cb211-62"><a href="#cb211-62" aria-hidden="true" tabindex="-1"></a><span class="in">  flextable::bg(i = 1, j = c(2, 4), bg = "lightgoldenrod") %&gt;%</span></span>
<span id="cb211-63"><a href="#cb211-63" aria-hidden="true" tabindex="-1"></a><span class="in">  flextable::autofit()</span></span>
<span id="cb211-64"><a href="#cb211-64" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-65"><a href="#cb211-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-66"><a href="#cb211-66" aria-hidden="true" tabindex="-1"></a><span class="fu">## Bayesian Inference</span></span>
<span id="cb211-67"><a href="#cb211-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-68"><a href="#cb211-68" aria-hidden="true" tabindex="-1"></a>Bayesian inference extends the logic of Bayes' Theorem by replacing the prior probability *estimate* that $\theta$ is true with a prior probability *distribution* that $\theta$ is true. Rather than saying, "I am *x*% certain $\theta$ is true," you say "I believe the probability that $\theta$ is true is somewhere in a range that has maximum likelihood at *x*%".</span>
<span id="cb211-69"><a href="#cb211-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-70"><a href="#cb211-70" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-71"><a href="#cb211-71" aria-hidden="true" tabindex="-1"></a>f(\theta | D) = \frac{f(D|\theta) f(\theta)}{\int_\Theta f(D|\theta) f(\theta) d\theta}</span>
<span id="cb211-72"><a href="#cb211-72" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-73"><a href="#cb211-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-74"><a href="#cb211-74" aria-hidden="true" tabindex="-1"></a>This formula expresses the posterior distribution of $\theta$ as a function of the prior distribution and new information. Let $\Pi(\theta)$ be the prior probability function. $\Pi(\theta)$ has a PMF or PDF $f(\theta)$, and a set of conditional distributions, $f(D|\theta)$, called the *generative model* that express the *likelihood* of observing $D$ given $\theta$. The *posterior* probability distribution of $\theta$, conditioned on the observance of $D$, is the joint distribution of $D$ and $\theta$ (aka *joint density*, the product of the likelihood and the prior) divided by the *marginal distribution* of $D$ (aka *marginal density* or *prior predictive distribution*). For discrete cases, replace the integral with a sum. The numerator makes the posterior proportional to the prior. The denominator is a normalizing constant that scales the likelihood into a proper density function (whose values sum to 1).</span>
<span id="cb211-75"><a href="#cb211-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-76"><a href="#cb211-76" aria-hidden="true" tabindex="-1"></a>It is easier to see how observed evidence shifts the probabilities of the priors into their posterior probabilities by working with discrete priors first. From there it is straight-forward to grasp the more abstract case of continuous prior and posterior distributions.</span>
<span id="cb211-77"><a href="#cb211-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-78"><a href="#cb211-78" aria-hidden="true" tabindex="-1"></a><span class="fu">## Markov Chain Monte Carlo (MCMC)</span></span>
<span id="cb211-79"><a href="#cb211-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-80"><a href="#cb211-80" aria-hidden="true" tabindex="-1"></a>Markov chain Monte Carlo (MCMC) methods are a class of algorithms for random sampling from high-dimensional probability distributions. Whereas Monte Carlo methods draw independent samples from a distribution, MCMC draw samples where the next value is dependent on the prior sample, creating a chain that zeros in on the target. MCMC improves on the less efficient rejection sampling, grid search, etc. methods. An example will show how Bayesian inference works with the less efficient methods, and the more sophisticated MCMC methods.^<span class="co">[</span><span class="ot">Some of these notes are from DataCamp course [Fundamentals of Bayesian Data Analysis in R](https://learn.datacamp.com/courses/fundamentals-of-bayesian-data-analysis-in-r).</span><span class="co">]</span></span>
<span id="cb211-81"><a href="#cb211-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-82"><a href="#cb211-82" aria-hidden="true" tabindex="-1"></a>The Howell data set contains the height (cm) of 165 adult males. Human height has an $\sim N(\mu, \sigma)$ distribution. What is the expected height of an adult male?</span>
<span id="cb211-83"><a href="#cb211-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-86"><a href="#cb211-86" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-87"><a href="#cb211-87" aria-hidden="true" tabindex="-1"></a><span class="co"># downloaded this from </span></span>
<span id="cb211-88"><a href="#cb211-88" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/rmcelreath/rethinking/blob/master/data/Howell1.csv</span></span>
<span id="cb211-89"><a href="#cb211-89" aria-hidden="true" tabindex="-1"></a>howell <span class="ot">&lt;-</span> </span>
<span id="cb211-90"><a href="#cb211-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_delim</span>(<span class="st">"input/Howell1.csv"</span>, <span class="at">delim =</span> <span class="st">";"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb211-91"><a href="#cb211-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age <span class="sc">&gt;=</span> <span class="dv">18</span>, male <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb211-92"><a href="#cb211-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-93"><a href="#cb211-93" aria-hidden="true" tabindex="-1"></a>howell <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> height)) <span class="sc">+</span> <span class="fu">stat_qq</span>() <span class="sc">+</span> <span class="fu">geom_qq_line</span>() <span class="sc">+</span></span>
<span id="cb211-94"><a href="#cb211-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Adult heights are ~normally distributed."</span>)</span>
<span id="cb211-95"><a href="#cb211-95" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-96"><a href="#cb211-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-97"><a href="#cb211-97" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Classical Approach</span></span>
<span id="cb211-98"><a href="#cb211-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-99"><a href="#cb211-99" aria-hidden="true" tabindex="-1"></a>The classical approach is to construct a 95% CI around the mean with a <span class="co">[</span><span class="ot">one-sample mean _t_ test</span><span class="co">](https://mpfoley73.github.io/statistics/one-sample-mean-t-test.html)</span>. The mean height is 160.4 (95% CI, 159.4 to 161.3) with standard deviation <span class="in">`r sd(howell$height) %&gt;% comma(.1)`</span>.</span>
<span id="cb211-100"><a href="#cb211-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-103"><a href="#cb211-103" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-104"><a href="#cb211-104" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(howell<span class="sc">$</span>height)</span>
<span id="cb211-105"><a href="#cb211-105" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-106"><a href="#cb211-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-107"><a href="#cb211-107" aria-hidden="true" tabindex="-1"></a><span class="fu">### Rejection Sampling</span></span>
<span id="cb211-108"><a href="#cb211-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-109"><a href="#cb211-109" aria-hidden="true" tabindex="-1"></a>Rejection sampling samples the parameter space ($\mu$ and $\tau$), then conditions on the observed evidence ($\bar{y}$).</span>
<span id="cb211-110"><a href="#cb211-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-113"><a href="#cb211-113" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-114"><a href="#cb211-114" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">5</span></span>
<span id="cb211-115"><a href="#cb211-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-116"><a href="#cb211-116" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb211-117"><a href="#cb211-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-118"><a href="#cb211-118" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb211-119"><a href="#cb211-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu =</span> <span class="fu">round</span>(<span class="fu">runif</span>(ITER, <span class="dv">150</span>, <span class="dv">170</span>), <span class="dv">1</span>),</span>
<span id="cb211-120"><a href="#cb211-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">tau =</span> <span class="fu">round</span>(<span class="fu">runif</span>(ITER, .<span class="dv">3</span>, .<span class="dv">6</span>), <span class="dv">2</span>),</span>
<span id="cb211-121"><a href="#cb211-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">sampled_height =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(ITER, mu, <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(tau)), <span class="dv">1</span>)</span>
<span id="cb211-122"><a href="#cb211-122" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb211-123"><a href="#cb211-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-124"><a href="#cb211-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Condition on observed mean (160.4)</span></span>
<span id="cb211-125"><a href="#cb211-125" aria-hidden="true" tabindex="-1"></a>observed_mean <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">mean</span>(howell<span class="sc">$</span>height), <span class="dv">1</span>)</span>
<span id="cb211-126"><a href="#cb211-126" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span> </span>
<span id="cb211-127"><a href="#cb211-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sampled_height <span class="sc">==</span> observed_mean) <span class="sc">%&gt;%</span> </span>
<span id="cb211-128"><a href="#cb211-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mu_mean =</span> <span class="fu">mean</span>(mu), <span class="at">mu_025 =</span> <span class="fu">quantile</span>(mu, .<span class="dv">025</span>), <span class="at">mu_975 =</span> <span class="fu">quantile</span>(mu, .<span class="dv">975</span>))</span>
<span id="cb211-129"><a href="#cb211-129" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-130"><a href="#cb211-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-131"><a href="#cb211-131" aria-hidden="true" tabindex="-1"></a>This is rather inefficient. We generated <span class="in">`r comma(ITER, 1)`</span> data points, then conditioned on just the <span class="in">`r dat %&gt;% filter(sampled_height == observed_mean) %&gt;% nrow() %&gt;% comma(1)`</span> that had the observed mean. Plus, we limited ourselves to one-decimal precision for the search. However, the result, 160.4 (95% CI, 157.3 to 163.4) was close to the classical estimate of 160.4 (95% CI, 159.4 to 161.3)</span>
<span id="cb211-132"><a href="#cb211-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-133"><a href="#cb211-133" aria-hidden="true" tabindex="-1"></a><span class="fu">### Gibbs Sampler</span></span>
<span id="cb211-134"><a href="#cb211-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-135"><a href="#cb211-135" aria-hidden="true" tabindex="-1"></a>Section \@ref(normal-pop-est) explains that if you have data from a normally distributed population $\sim N(\mu, \sigma)$, you can use a normal prior for $\mu \sim N(\mu_0, \tau_0)$ where $\tau = 1 / \sigma^2$, and a gamma prior for $\tau \sim \text{Gamma}(a, b)$. The posterior distributions are</span>
<span id="cb211-136"><a href="#cb211-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-137"><a href="#cb211-137" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-138"><a href="#cb211-138" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-139"><a href="#cb211-139" aria-hidden="true" tabindex="-1"></a>\mu|y &amp; \sim N\left( \frac{n \tau \bar{y}}{n \tau + \tau_0}, n \tau + \tau_0 \right) <span class="sc">\\</span></span>
<span id="cb211-140"><a href="#cb211-140" aria-hidden="true" tabindex="-1"></a>\tau|y &amp; \sim \text{Gamma} \left( a = \frac{n}{2}, b = \frac{1}{2} \sum_i (y_i - \mu)^2 \right)</span>
<span id="cb211-141"><a href="#cb211-141" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-142"><a href="#cb211-142" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-143"><a href="#cb211-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-144"><a href="#cb211-144" aria-hidden="true" tabindex="-1"></a>The Gibbs sampler algorithm is to set priors, randomly sample from <span class="in">`rnorm()`</span> and <span class="in">`rgamma()`</span> to get posteriors, then make the posteriors the new priors for repeated iterations. After some burn-in period, the posteriors should stabilize. Take the mean and quantiles of the posteriors (minus the burn-in). From prior knowledge, we know average height is $\mu_0 = 175 \pm 10$. As a rule of thumb, $\pm$ is 2SD, so $\sigma_0 = 5$ and therefore $\tau_0 = 1 / 5^2$. For gamma, we can use priors $a = .01$ and $b = .01$.</span>
<span id="cb211-145"><a href="#cb211-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-146"><a href="#cb211-146" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-147"><a href="#cb211-147" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345)</span></span>
<span id="cb211-148"><a href="#cb211-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-149"><a href="#cb211-149" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterations</span></span>
<span id="cb211-150"><a href="#cb211-150" aria-hidden="true" tabindex="-1"></a><span class="in">ITER &lt;- 10^3</span></span>
<span id="cb211-151"><a href="#cb211-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-152"><a href="#cb211-152" aria-hidden="true" tabindex="-1"></a><span class="in"># Prior parameter values based on intuition or prior studies.</span></span>
<span id="cb211-153"><a href="#cb211-153" aria-hidden="true" tabindex="-1"></a><span class="in">mu_0 &lt;- 175</span></span>
<span id="cb211-154"><a href="#cb211-154" aria-hidden="true" tabindex="-1"></a><span class="in">tau_0 &lt;- 1 / 5^2</span></span>
<span id="cb211-155"><a href="#cb211-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-156"><a href="#cb211-156" aria-hidden="true" tabindex="-1"></a><span class="in"># Monitors to track burn-in.</span></span>
<span id="cb211-157"><a href="#cb211-157" aria-hidden="true" tabindex="-1"></a><span class="in">monitor_mu &lt;- numeric(ITER)</span></span>
<span id="cb211-158"><a href="#cb211-158" aria-hidden="true" tabindex="-1"></a><span class="in">monitor_tau &lt;- numeric(ITER)</span></span>
<span id="cb211-159"><a href="#cb211-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-160"><a href="#cb211-160" aria-hidden="true" tabindex="-1"></a><span class="in"># Initialize the algorithm.</span></span>
<span id="cb211-161"><a href="#cb211-161" aria-hidden="true" tabindex="-1"></a><span class="in">(n &lt;- nrow(howell))</span></span>
<span id="cb211-162"><a href="#cb211-162" aria-hidden="true" tabindex="-1"></a><span class="in">y &lt;- howell$height</span></span>
<span id="cb211-163"><a href="#cb211-163" aria-hidden="true" tabindex="-1"></a><span class="in">(y_bar &lt;- mean(y))</span></span>
<span id="cb211-164"><a href="#cb211-164" aria-hidden="true" tabindex="-1"></a><span class="in">(mu &lt;- mean(y))</span></span>
<span id="cb211-165"><a href="#cb211-165" aria-hidden="true" tabindex="-1"></a><span class="in">(tau &lt;- 1 / var(y))</span></span>
<span id="cb211-166"><a href="#cb211-166" aria-hidden="true" tabindex="-1"></a><span class="in">a &lt;- .01</span></span>
<span id="cb211-167"><a href="#cb211-167" aria-hidden="true" tabindex="-1"></a><span class="in">b &lt;- .01</span></span>
<span id="cb211-168"><a href="#cb211-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-169"><a href="#cb211-169" aria-hidden="true" tabindex="-1"></a><span class="in">for(iter in 1:ITER) {</span></span>
<span id="cb211-170"><a href="#cb211-170" aria-hidden="true" tabindex="-1"></a><span class="in">  # mu</span></span>
<span id="cb211-171"><a href="#cb211-171" aria-hidden="true" tabindex="-1"></a><span class="in">  new_mu &lt;- (n * tau * y_bar) / (n * tau + tau_0)</span></span>
<span id="cb211-172"><a href="#cb211-172" aria-hidden="true" tabindex="-1"></a><span class="in">  new_tau &lt;- n * tau + tau_0</span></span>
<span id="cb211-173"><a href="#cb211-173" aria-hidden="true" tabindex="-1"></a><span class="in">  monitor_mu[iter] &lt;- rnorm(1, new_mu, 1 / sqrt(new_tau))</span></span>
<span id="cb211-174"><a href="#cb211-174" aria-hidden="true" tabindex="-1"></a><span class="in">  # tau</span></span>
<span id="cb211-175"><a href="#cb211-175" aria-hidden="true" tabindex="-1"></a><span class="in">  new_a &lt;- a + n/2</span></span>
<span id="cb211-176"><a href="#cb211-176" aria-hidden="true" tabindex="-1"></a><span class="in">  new_b &lt;- b + .5 * sum((y-mu)^2)</span></span>
<span id="cb211-177"><a href="#cb211-177" aria-hidden="true" tabindex="-1"></a><span class="in">  monitor_tau[iter] &lt;- rgamma(1, new_a, new_b)</span></span>
<span id="cb211-178"><a href="#cb211-178" aria-hidden="true" tabindex="-1"></a><span class="in">  # update state</span></span>
<span id="cb211-179"><a href="#cb211-179" aria-hidden="true" tabindex="-1"></a><span class="in">  mu &lt;- monitor_mu[iter]</span></span>
<span id="cb211-180"><a href="#cb211-180" aria-hidden="true" tabindex="-1"></a><span class="in">  tau &lt;- monitor_tau[iter]</span></span>
<span id="cb211-181"><a href="#cb211-181" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb211-182"><a href="#cb211-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-183"><a href="#cb211-183" aria-hidden="true" tabindex="-1"></a><span class="in"># Discard burn-in and estimate.</span></span>
<span id="cb211-184"><a href="#cb211-184" aria-hidden="true" tabindex="-1"></a><span class="in">mean(monitor_mu[-500])</span></span>
<span id="cb211-185"><a href="#cb211-185" aria-hidden="true" tabindex="-1"></a><span class="in">quantile(monitor_mu[-500], c(.025, .975))</span></span>
<span id="cb211-186"><a href="#cb211-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-187"><a href="#cb211-187" aria-hidden="true" tabindex="-1"></a><span class="in"># Check out the burn-in. Actually looks like it took 1 iteration.</span></span>
<span id="cb211-188"><a href="#cb211-188" aria-hidden="true" tabindex="-1"></a><span class="in">tibble(index = 1:ITER, M = monitor_mu) %&gt;% ggplot(aes(x = index, y = M)) + geom_line()</span></span>
<span id="cb211-189"><a href="#cb211-189" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-190"><a href="#cb211-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-191"><a href="#cb211-191" aria-hidden="true" tabindex="-1"></a><span class="fu">### Metropolis-Hastings</span></span>
<span id="cb211-192"><a href="#cb211-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-193"><a href="#cb211-193" aria-hidden="true" tabindex="-1"></a>The Metropolis-Hastings model is like MCMC except that the posterior is accepted with probability $\min(R, 1)$ where $R$ is </span>
<span id="cb211-194"><a href="#cb211-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-195"><a href="#cb211-195" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-196"><a href="#cb211-196" aria-hidden="true" tabindex="-1"></a>R = \frac{f(y|\theta')f(\theta')}{f(y|\theta)f(\theta)} \frac{q(\theta|\theta')}{q(\theta'|\theta)}</span>
<span id="cb211-197"><a href="#cb211-197" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-198"><a href="#cb211-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-199"><a href="#cb211-199" aria-hidden="true" tabindex="-1"></a>If the proposed distribution is symmetric, the second term drops out and $R$ is just the ratio of posterior distributions. The symmetric version is called *Metropolis* instead of *Metropolis-Hastings*.</span>
<span id="cb211-200"><a href="#cb211-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-201"><a href="#cb211-201" aria-hidden="true" tabindex="-1"></a>Suppose your data is $n = 100$ values from a $N(\mu = 2, \tau = 1/4)$ distribution.</span>
<span id="cb211-202"><a href="#cb211-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-203"><a href="#cb211-203" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collaps=TRUE}</span></span>
<span id="cb211-204"><a href="#cb211-204" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345)</span></span>
<span id="cb211-205"><a href="#cb211-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-206"><a href="#cb211-206" aria-hidden="true" tabindex="-1"></a><span class="in"># Iterations</span></span>
<span id="cb211-207"><a href="#cb211-207" aria-hidden="true" tabindex="-1"></a><span class="in">ITER &lt;- 10^3</span></span>
<span id="cb211-208"><a href="#cb211-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-209"><a href="#cb211-209" aria-hidden="true" tabindex="-1"></a><span class="in"># Prior parameter values based on intuition or prior studies.</span></span>
<span id="cb211-210"><a href="#cb211-210" aria-hidden="true" tabindex="-1"></a><span class="in">mu_0 &lt;- 175</span></span>
<span id="cb211-211"><a href="#cb211-211" aria-hidden="true" tabindex="-1"></a><span class="in">tau_0 &lt;- 1 / 5^2</span></span>
<span id="cb211-212"><a href="#cb211-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-213"><a href="#cb211-213" aria-hidden="true" tabindex="-1"></a><span class="in"># Monitors to track burn-in.</span></span>
<span id="cb211-214"><a href="#cb211-214" aria-hidden="true" tabindex="-1"></a><span class="in">monitor_mu &lt;- numeric(ITER)</span></span>
<span id="cb211-215"><a href="#cb211-215" aria-hidden="true" tabindex="-1"></a><span class="in">monitor_tau &lt;- numeric(ITER)</span></span>
<span id="cb211-216"><a href="#cb211-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-217"><a href="#cb211-217" aria-hidden="true" tabindex="-1"></a><span class="in"># Initialize the algorithm.</span></span>
<span id="cb211-218"><a href="#cb211-218" aria-hidden="true" tabindex="-1"></a><span class="in">(n &lt;- nrow(howell))</span></span>
<span id="cb211-219"><a href="#cb211-219" aria-hidden="true" tabindex="-1"></a><span class="in">y &lt;- howell$height</span></span>
<span id="cb211-220"><a href="#cb211-220" aria-hidden="true" tabindex="-1"></a><span class="in">(y_bar &lt;- mean(y))</span></span>
<span id="cb211-221"><a href="#cb211-221" aria-hidden="true" tabindex="-1"></a><span class="in">(mu &lt;- mean(y))</span></span>
<span id="cb211-222"><a href="#cb211-222" aria-hidden="true" tabindex="-1"></a><span class="in">(tau &lt;- 1 / var(y))</span></span>
<span id="cb211-223"><a href="#cb211-223" aria-hidden="true" tabindex="-1"></a><span class="in">a &lt;- .01</span></span>
<span id="cb211-224"><a href="#cb211-224" aria-hidden="true" tabindex="-1"></a><span class="in">b &lt;- .01</span></span>
<span id="cb211-225"><a href="#cb211-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-226"><a href="#cb211-226" aria-hidden="true" tabindex="-1"></a><span class="in">for(iter in 1:ITER) {</span></span>
<span id="cb211-227"><a href="#cb211-227" aria-hidden="true" tabindex="-1"></a><span class="in">  # mu</span></span>
<span id="cb211-228"><a href="#cb211-228" aria-hidden="true" tabindex="-1"></a><span class="in">  new_mu &lt;- (n * tau * y_bar) / (n * tau + tau_0)</span></span>
<span id="cb211-229"><a href="#cb211-229" aria-hidden="true" tabindex="-1"></a><span class="in">  new_tau &lt;- n * tau + tau_0</span></span>
<span id="cb211-230"><a href="#cb211-230" aria-hidden="true" tabindex="-1"></a><span class="in">  proposed_mu &lt;- rnorm(1, new_mu, 1 / sqrt(new_tau)) # tentative for now!</span></span>
<span id="cb211-231"><a href="#cb211-231" aria-hidden="true" tabindex="-1"></a><span class="in">  # tau</span></span>
<span id="cb211-232"><a href="#cb211-232" aria-hidden="true" tabindex="-1"></a><span class="in">  new_a &lt;- a + n/2</span></span>
<span id="cb211-233"><a href="#cb211-233" aria-hidden="true" tabindex="-1"></a><span class="in">  new_b &lt;- b + .5 * sum((y-mu)^2)</span></span>
<span id="cb211-234"><a href="#cb211-234" aria-hidden="true" tabindex="-1"></a><span class="in">  monitor_tau[iter] &lt;- rgamma(1, new_a, new_b)</span></span>
<span id="cb211-235"><a href="#cb211-235" aria-hidden="true" tabindex="-1"></a><span class="in">  # update state</span></span>
<span id="cb211-236"><a href="#cb211-236" aria-hidden="true" tabindex="-1"></a><span class="in">  # log of the acceptance ratio</span></span>
<span id="cb211-237"><a href="#cb211-237" aria-hidden="true" tabindex="-1"></a><span class="in">  logR &lt;- sum(dnorm(y, proposed_mu, 1/sqrt(tau), log = T)) - # new likelihood</span></span>
<span id="cb211-238"><a href="#cb211-238" aria-hidden="true" tabindex="-1"></a><span class="in">          sum(dnorm(y, mu         , 1/sqrt(tau), log = T)) + # old likelihood</span></span>
<span id="cb211-239"><a href="#cb211-239" aria-hidden="true" tabindex="-1"></a><span class="in">          dnorm(proposed_mu, mu_0, 1/sqrt(tau_0), log = T) - # new prior</span></span>
<span id="cb211-240"><a href="#cb211-240" aria-hidden="true" tabindex="-1"></a><span class="in">          dnorm(mu         , mu_0, 1/sqrt(tau_0), log = T)   # old prior</span></span>
<span id="cb211-241"><a href="#cb211-241" aria-hidden="true" tabindex="-1"></a><span class="in">  # accept with probability min(R,1)</span></span>
<span id="cb211-242"><a href="#cb211-242" aria-hidden="true" tabindex="-1"></a><span class="in">  logU &lt;- log(runif(1,0,1))</span></span>
<span id="cb211-243"><a href="#cb211-243" aria-hidden="true" tabindex="-1"></a><span class="in">  if(logU &lt; logR) {mu &lt;- new_mu}</span></span>
<span id="cb211-244"><a href="#cb211-244" aria-hidden="true" tabindex="-1"></a><span class="in">  monitor_mu[iter] &lt;- mu # this is either current or the proposed.</span></span>
<span id="cb211-245"><a href="#cb211-245" aria-hidden="true" tabindex="-1"></a><span class="in">  tau &lt;- monitor_tau[iter]</span></span>
<span id="cb211-246"><a href="#cb211-246" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb211-247"><a href="#cb211-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-248"><a href="#cb211-248" aria-hidden="true" tabindex="-1"></a><span class="in"># Discard burn-in and estimate.</span></span>
<span id="cb211-249"><a href="#cb211-249" aria-hidden="true" tabindex="-1"></a><span class="in">mean(monitor_mu[-500])</span></span>
<span id="cb211-250"><a href="#cb211-250" aria-hidden="true" tabindex="-1"></a><span class="in">quantile(monitor_mu[-500], c(.025, .975))</span></span>
<span id="cb211-251"><a href="#cb211-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-252"><a href="#cb211-252" aria-hidden="true" tabindex="-1"></a><span class="in"># Check out the burn-in. Actually looks like it took 1 iteration.</span></span>
<span id="cb211-253"><a href="#cb211-253" aria-hidden="true" tabindex="-1"></a><span class="in">tibble(index = 1:ITER, M = monitor_mu) %&gt;% ggplot(aes(x = index, y = M)) + geom_line()</span></span>
<span id="cb211-254"><a href="#cb211-254" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-255"><a href="#cb211-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-256"><a href="#cb211-256" aria-hidden="true" tabindex="-1"></a><span class="fu">### Other Notes</span></span>
<span id="cb211-257"><a href="#cb211-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-258"><a href="#cb211-258" aria-hidden="true" tabindex="-1"></a>One simple Bayesian approach is to run several (we'll use 1,000) experiments that sample 100 ad impression events from an <span class="in">`rbinom()`</span> generative model using a uniform prior distribution of 0-30% click probability. The resulting 1,000 row data set of click probabilities is the prior predictive distribution of $D$, the denominator of Bayes' Theorem. The subset where $D = 13$ is the likelihood, $P(D|\theta)$. The sampled $\theta$'s are the prior, $P(\theta) = \text{unif}(.0, .3)$. Their product is the joint probability distribution, $P(D|\theta)P(\theta)$, the numerator of Bayes' Theorem. This method is called *rejection sampling* because you sample across the whole parameter space, then condition on the observed evidence.</span>
<span id="cb211-259"><a href="#cb211-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-262"><a href="#cb211-262" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-263"><a href="#cb211-263" aria-hidden="true" tabindex="-1"></a>df_sim <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb211-264"><a href="#cb211-264" aria-hidden="true" tabindex="-1"></a>  <span class="at">click_prob =</span> <span class="fu">runif</span>(<span class="dv">1000</span>, <span class="fl">0.0</span>, <span class="fl">0.3</span>),</span>
<span id="cb211-265"><a href="#cb211-265" aria-hidden="true" tabindex="-1"></a>  <span class="at">click_n =</span> <span class="fu">rbinom</span>(<span class="dv">1000</span>, <span class="dv">100</span>, click_prob)</span>
<span id="cb211-266"><a href="#cb211-266" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb211-267"><a href="#cb211-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-268"><a href="#cb211-268" aria-hidden="true" tabindex="-1"></a>df_sim <span class="sc">%&gt;%</span> </span>
<span id="cb211-269"><a href="#cb211-269" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_13 =</span> <span class="fu">factor</span>(click_n <span class="sc">==</span> <span class="dv">13</span>, <span class="at">levels =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb211-270"><a href="#cb211-270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> click_prob, <span class="at">y =</span> click_n, <span class="at">color =</span> is_13)) <span class="sc">+</span></span>
<span id="cb211-271"><a href="#cb211-271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb211-272"><a href="#cb211-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">13</span>, <span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">linetype =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb211-273"><a href="#cb211-273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"gray80"</span>)) <span class="sc">+</span></span>
<span id="cb211-274"><a href="#cb211-274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">40</span>, <span class="dv">10</span>), <span class="dv">13</span>)) <span class="sc">+</span></span>
<span id="cb211-275"><a href="#cb211-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Joint probability of observed clicks and click probability"</span>,</span>
<span id="cb211-276"><a href="#cb211-276" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"with conditioning on 13 observed clicks."</span>,</span>
<span id="cb211-277"><a href="#cb211-277" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"clicks per 100 ads"</span>,</span>
<span id="cb211-278"><a href="#cb211-278" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(theta))</span>
<span id="cb211-279"><a href="#cb211-279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-280"><a href="#cb211-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-281"><a href="#cb211-281" aria-hidden="true" tabindex="-1"></a>Condition the joint probability distribution on the <span class="in">`r df_sim %&gt;% filter(click_n == 13) %&gt;% nrow()`</span> rows that produced 13 observed clicks to update the prior. The <span class="in">`quantile()`</span> function returns the median and the .025 and .975 percentile values - the *credible interval*.</span>
<span id="cb211-282"><a href="#cb211-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-285"><a href="#cb211-285" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-286"><a href="#cb211-286" aria-hidden="true" tabindex="-1"></a><span class="co"># median and credible interval</span></span>
<span id="cb211-287"><a href="#cb211-287" aria-hidden="true" tabindex="-1"></a>(sim_ci <span class="ot">&lt;-</span> df_sim <span class="sc">%&gt;%</span> <span class="fu">filter</span>(click_n <span class="sc">==</span> <span class="dv">13</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(click_prob) <span class="sc">%&gt;%</span> </span>
<span id="cb211-288"><a href="#cb211-288" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quantile</span>(<span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">5</span>, .<span class="dv">975</span>)))</span>
<span id="cb211-289"><a href="#cb211-289" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-290"><a href="#cb211-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-291"><a href="#cb211-291" aria-hidden="true" tabindex="-1"></a>The posterior click rate likelihood is <span class="in">`r percent(sim_ci[2], .1)`</span> with 95% credible interval (<span class="in">`r percent(sim_ci[1], .1)`</span>, <span class="in">`r percent(sim_ci[3], .1)`</span>). Here is the density plot of the <span class="in">`r df_sim %&gt;% filter(click_n == 13) %&gt;% nrow()`</span> simulations that produced the 13 clicks. The median and 95% credible interval are marked.</span>
<span id="cb211-292"><a href="#cb211-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-295"><a href="#cb211-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-296"><a href="#cb211-296" aria-hidden="true" tabindex="-1"></a>df_sim <span class="sc">%&gt;%</span> </span>
<span id="cb211-297"><a href="#cb211-297" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(click_n <span class="sc">==</span> <span class="dv">13</span>) <span class="sc">%&gt;%</span></span>
<span id="cb211-298"><a href="#cb211-298" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> click_prob)) <span class="sc">+</span></span>
<span id="cb211-299"><a href="#cb211-299" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb211-300"><a href="#cb211-300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> sim_ci[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb211-301"><a href="#cb211-301" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> sim_ci[<span class="dv">1</span>], <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb211-302"><a href="#cb211-302" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> sim_ci[<span class="dv">3</span>], <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb211-303"><a href="#cb211-303" aria-hidden="true" tabindex="-1"></a>  <span class="co"># coord_cartesian(xlim = c(0, .3)) +</span></span>
<span id="cb211-304"><a href="#cb211-304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">0</span>, .<span class="dv">3</span>, .<span class="dv">05</span>), sim_ci), <span class="at">labels =</span> <span class="fu">percent_format</span>(.<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb211-305"><a href="#cb211-305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Posterior click likelihood distribution"</span>, </span>
<span id="cb211-306"><a href="#cb211-306" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">glue</span>(<span class="st">"p = {percent(sim_ci[2], .1)}, 95%-CI ("</span>,</span>
<span id="cb211-307"><a href="#cb211-307" aria-hidden="true" tabindex="-1"></a>       <span class="st">"{percent(sim_ci[1], .1)}, {percent(sim_ci[3], .1)})"</span>),</span>
<span id="cb211-308"><a href="#cb211-308" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(theta), <span class="at">y =</span> <span class="st">"density (likelihood)"</span>)</span>
<span id="cb211-309"><a href="#cb211-309" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-310"><a href="#cb211-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-311"><a href="#cb211-311" aria-hidden="true" tabindex="-1"></a>That's pretty close to the classical result! Instead of sampling, you could define a discrete set of candidate click probabilities and calculate the click probability density for the 100 ad impressions. This method is called *grid approximation*.</span>
<span id="cb211-312"><a href="#cb211-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-315"><a href="#cb211-315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-316"><a href="#cb211-316" aria-hidden="true" tabindex="-1"></a>df_bayes <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb211-317"><a href="#cb211-317" aria-hidden="true" tabindex="-1"></a>  <span class="at">click_prob =</span> <span class="fu">seq</span>(<span class="fl">0.01</span>, .<span class="dv">30</span>, <span class="at">by =</span> .<span class="dv">001</span>), </span>
<span id="cb211-318"><a href="#cb211-318" aria-hidden="true" tabindex="-1"></a>  <span class="at">click_n =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">100</span></span>
<span id="cb211-319"><a href="#cb211-319" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb211-320"><a href="#cb211-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb211-321"><a href="#cb211-321" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">dunif</span>(click_prob, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fl">0.3</span>),</span>
<span id="cb211-322"><a href="#cb211-322" aria-hidden="true" tabindex="-1"></a>    <span class="at">likelihood =</span> <span class="fu">dbinom</span>(click_n, <span class="dv">100</span>, click_prob),</span>
<span id="cb211-323"><a href="#cb211-323" aria-hidden="true" tabindex="-1"></a>    <span class="at">probability =</span> likelihood <span class="sc">*</span> prior <span class="sc">/</span> <span class="fu">sum</span>(likelihood <span class="sc">*</span> prior)</span>
<span id="cb211-324"><a href="#cb211-324" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb211-325"><a href="#cb211-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-326"><a href="#cb211-326" aria-hidden="true" tabindex="-1"></a>df_bayes <span class="sc">%&gt;%</span> </span>
<span id="cb211-327"><a href="#cb211-327" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_13 =</span> <span class="fu">factor</span>(click_n <span class="sc">==</span> <span class="dv">13</span>, <span class="at">levels =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb211-328"><a href="#cb211-328" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(probability &gt; .0001) %&gt;%</span></span>
<span id="cb211-329"><a href="#cb211-329" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> click_prob, <span class="at">y =</span> click_n, <span class="at">color =</span> is_13)) <span class="sc">+</span></span>
<span id="cb211-330"><a href="#cb211-330" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> probability), <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb211-331"><a href="#cb211-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">13</span>, <span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">linetype =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> .<span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb211-332"><a href="#cb211-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>)) <span class="sc">+</span></span>
<span id="cb211-333"><a href="#cb211-333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">10</span>), <span class="dv">13</span>)) <span class="sc">+</span></span>
<span id="cb211-334"><a href="#cb211-334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient</span>(<span class="at">low =</span> <span class="st">"#FFFFFF"</span>, <span class="at">high =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb211-335"><a href="#cb211-335" aria-hidden="true" tabindex="-1"></a>  <span class="co"># scale_color_manual(values = c("TRUE" = "steelblue", "FALSE" = "gray20")) +</span></span>
<span id="cb211-336"><a href="#cb211-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Joint probability of clicks and click probability."</span>,</span>
<span id="cb211-337"><a href="#cb211-337" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"with conditioning on 13 observed clicks."</span>,</span>
<span id="cb211-338"><a href="#cb211-338" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"clicks per 100 ads"</span>,</span>
<span id="cb211-339"><a href="#cb211-339" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(theta))</span>
<span id="cb211-340"><a href="#cb211-340" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-341"><a href="#cb211-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-342"><a href="#cb211-342" aria-hidden="true" tabindex="-1"></a>Condition the joint probability distribution on the 13 observed clicks to update your prior. Resample the posterior probability to create a distribution.</span>
<span id="cb211-343"><a href="#cb211-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-346"><a href="#cb211-346" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-347"><a href="#cb211-347" aria-hidden="true" tabindex="-1"></a>df_bayes_13 <span class="ot">&lt;-</span> df_bayes <span class="sc">%&gt;%</span> <span class="fu">filter</span>(click_n <span class="sc">==</span> <span class="dv">13</span>) <span class="sc">%&gt;%</span></span>
<span id="cb211-348"><a href="#cb211-348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">posterior =</span> probability <span class="sc">/</span> <span class="fu">sum</span>(probability))</span>
<span id="cb211-349"><a href="#cb211-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-350"><a href="#cb211-350" aria-hidden="true" tabindex="-1"></a>sampling_idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(</span>
<span id="cb211-351"><a href="#cb211-351" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df_bayes_13), </span>
<span id="cb211-352"><a href="#cb211-352" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> <span class="dv">10000</span>, </span>
<span id="cb211-353"><a href="#cb211-353" aria-hidden="true" tabindex="-1"></a>  <span class="at">replace =</span> <span class="cn">TRUE</span>, </span>
<span id="cb211-354"><a href="#cb211-354" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob =</span> df_bayes_13<span class="sc">$</span>posterior</span>
<span id="cb211-355"><a href="#cb211-355" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb211-356"><a href="#cb211-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-357"><a href="#cb211-357" aria-hidden="true" tabindex="-1"></a>sampling_vals <span class="ot">&lt;-</span> df_bayes_13[sampling_idx, ]</span>
<span id="cb211-358"><a href="#cb211-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-359"><a href="#cb211-359" aria-hidden="true" tabindex="-1"></a>(df_bayes_ci <span class="ot">&lt;-</span> <span class="fu">quantile</span>(sampling_vals<span class="sc">$</span>click_prob, <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">5</span>, .<span class="dv">975</span>)))</span>
<span id="cb211-360"><a href="#cb211-360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-361"><a href="#cb211-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-362"><a href="#cb211-362" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, warning=FALSE}</span></span>
<span id="cb211-363"><a href="#cb211-363" aria-hidden="true" tabindex="-1"></a><span class="in">df_bayes %&gt;%</span></span>
<span id="cb211-364"><a href="#cb211-364" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(click_n == 13) %&gt;%</span></span>
<span id="cb211-365"><a href="#cb211-365" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(likelihood = probability / sum(probability),</span></span>
<span id="cb211-366"><a href="#cb211-366" aria-hidden="true" tabindex="-1"></a><span class="in">         lcl = if_else(click_prob &lt; df_bayes_ci[1], likelihood, NA_real_),</span></span>
<span id="cb211-367"><a href="#cb211-367" aria-hidden="true" tabindex="-1"></a><span class="in">         ucl = if_else(click_prob &gt; df_bayes_ci[3], likelihood, NA_real_), </span></span>
<span id="cb211-368"><a href="#cb211-368" aria-hidden="true" tabindex="-1"></a><span class="in">         ci = if_else(click_prob &gt;= df_bayes_ci[1] &amp; </span></span>
<span id="cb211-369"><a href="#cb211-369" aria-hidden="true" tabindex="-1"></a><span class="in">                        click_prob &lt;= df_bayes_ci[3], "Y", "N")) %&gt;%</span></span>
<span id="cb211-370"><a href="#cb211-370" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = click_prob, y = likelihood)) +</span></span>
<span id="cb211-371"><a href="#cb211-371" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line() +</span></span>
<span id="cb211-372"><a href="#cb211-372" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_area(aes(y = lcl), fill = "firebrick", alpha = .4) +</span></span>
<span id="cb211-373"><a href="#cb211-373" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_area(aes(y = ucl), fill = "firebrick", alpha = .4) +</span></span>
<span id="cb211-374"><a href="#cb211-374" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = df_bayes_ci[2], linetype = 2) +</span></span>
<span id="cb211-375"><a href="#cb211-375" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal() +</span></span>
<span id="cb211-376"><a href="#cb211-376" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(breaks = seq(0, .3, .05)) +</span></span>
<span id="cb211-377"><a href="#cb211-377" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.minor = element_blank()) +</span></span>
<span id="cb211-378"><a href="#cb211-378" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Posterior click probability", </span></span>
<span id="cb211-379"><a href="#cb211-379" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = glue("p = {df_bayes_ci[2] %&gt;% scales::number(accuracy = .01)}, 95%-CI (",</span></span>
<span id="cb211-380"><a href="#cb211-380" aria-hidden="true" tabindex="-1"></a><span class="in">       "{df_bayes_ci[1] %&gt;% scales::number(accuracy = .01)}, ",</span></span>
<span id="cb211-381"><a href="#cb211-381" aria-hidden="true" tabindex="-1"></a><span class="in">       "{df_bayes_ci[3] %&gt;% scales::number(accuracy = .01)})"),</span></span>
<span id="cb211-382"><a href="#cb211-382" aria-hidden="true" tabindex="-1"></a><span class="in">       x = expression(theta))</span></span>
<span id="cb211-383"><a href="#cb211-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-384"><a href="#cb211-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-385"><a href="#cb211-385" aria-hidden="true" tabindex="-1"></a>You can use a Bayesian model to estimate multiple parameters. Suppose you want to predict the water temperature in a lake on Jun 1 based on 5 years of prior water temperatures. </span>
<span id="cb211-386"><a href="#cb211-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-389"><a href="#cb211-389" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-390"><a href="#cb211-390" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">19</span>, <span class="dv">23</span>, <span class="dv">20</span>, <span class="dv">17</span>, <span class="dv">23</span>)</span>
<span id="cb211-391"><a href="#cb211-391" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-392"><a href="#cb211-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-393"><a href="#cb211-393" aria-hidden="true" tabindex="-1"></a>You model the water temperature as a normal distribution, $\mathrm{N}(\mu, \sigma^2)$ with a prior distribution $\mu = \mathrm{N}(18, 5^2)$ and $\sigma = \mathrm{unif}(0, 10)$ based on past experience.</span>
<span id="cb211-394"><a href="#cb211-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-395"><a href="#cb211-395" aria-hidden="true" tabindex="-1"></a>Using the grid approximation approach, construct a grid of candidate $\mu$ values from 8 to 30 degrees incremented by .5 degrees, and candidate $\sigma$ values from .1 to 10 incremented by .1 - a 4,500 row data frame. </span>
<span id="cb211-396"><a href="#cb211-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-399"><a href="#cb211-399" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-400"><a href="#cb211-400" aria-hidden="true" tabindex="-1"></a>mdl_grid <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">mu =</span> <span class="fu">seq</span>(<span class="dv">8</span>, <span class="dv">30</span>, <span class="at">by =</span> <span class="fl">0.5</span>),</span>
<span id="cb211-401"><a href="#cb211-401" aria-hidden="true" tabindex="-1"></a>                        <span class="at">sigma =</span> <span class="fu">seq</span>(.<span class="dv">1</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="fl">0.1</span>))</span>
<span id="cb211-402"><a href="#cb211-402" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-403"><a href="#cb211-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-404"><a href="#cb211-404" aria-hidden="true" tabindex="-1"></a>For each combination of $\mu$ and $\sigma$, the *prior* probabilities are the densities from $\mu = \mathrm{N}(18, 5^2)$ and $\sigma = \mathrm{unif}(0, 10)$. The combined prior is their product. The *likelihoods* are the products of the probabilities of observing each <span class="in">`temp`</span> given the candidate $\mu$ and $\sigma$ values.</span>
<span id="cb211-405"><a href="#cb211-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-408"><a href="#cb211-408" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-409"><a href="#cb211-409" aria-hidden="true" tabindex="-1"></a>mdl_grid_2 <span class="ot">&lt;-</span> mdl_grid <span class="sc">%&gt;%</span></span>
<span id="cb211-410"><a href="#cb211-410" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb211-411"><a href="#cb211-411" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_prior =</span> <span class="fu">map_dbl</span>(mu, <span class="sc">~</span><span class="fu">dnorm</span>(., <span class="at">mean =</span> <span class="dv">18</span>, <span class="at">sd =</span> <span class="dv">5</span>)),</span>
<span id="cb211-412"><a href="#cb211-412" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma_prior =</span> <span class="fu">map_dbl</span>(sigma, <span class="sc">~</span><span class="fu">dunif</span>(., <span class="dv">0</span>, <span class="dv">10</span>)),</span>
<span id="cb211-413"><a href="#cb211-413" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> mu_prior <span class="sc">*</span> sigma_prior, <span class="co"># combined prior,</span></span>
<span id="cb211-414"><a href="#cb211-414" aria-hidden="true" tabindex="-1"></a>    <span class="at">likelihood =</span> <span class="fu">map2_dbl</span>(mu, sigma, <span class="sc">~</span><span class="fu">dnorm</span>(temp, .x, .y) <span class="sc">%&gt;%</span> <span class="fu">prod</span>()),</span>
<span id="cb211-415"><a href="#cb211-415" aria-hidden="true" tabindex="-1"></a>    <span class="at">posterior =</span> likelihood <span class="sc">*</span> prior <span class="sc">/</span> <span class="fu">sum</span>(likelihood <span class="sc">*</span> prior)</span>
<span id="cb211-416"><a href="#cb211-416" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb211-417"><a href="#cb211-417" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-418"><a href="#cb211-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-419"><a href="#cb211-419" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE}</span></span>
<span id="cb211-420"><a href="#cb211-420" aria-hidden="true" tabindex="-1"></a><span class="in">mdl_grid_2 %&gt;%</span></span>
<span id="cb211-421"><a href="#cb211-421" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = mu, y = sigma, fill = posterior)) +</span></span>
<span id="cb211-422"><a href="#cb211-422" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_tile() +</span></span>
<span id="cb211-423"><a href="#cb211-423" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_gradient(low = "white", high = "steelblue", guide = "colorbar") +</span></span>
<span id="cb211-424"><a href="#cb211-424" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal() +</span></span>
<span id="cb211-425"><a href="#cb211-425" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Joint probability of mu and sigma.",</span></span>
<span id="cb211-426"><a href="#cb211-426" aria-hidden="true" tabindex="-1"></a><span class="in">       x = expression(mu), y = expression(sigma))</span></span>
<span id="cb211-427"><a href="#cb211-427" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-428"><a href="#cb211-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-429"><a href="#cb211-429" aria-hidden="true" tabindex="-1"></a>Calculate a credible interval by drawing 10,000 samples from the grid with sampling probability equal to the calculated posterior probabilities. Use the <span class="in">`quantile()`</span> function to estimate the median and .025 and .975 quantile values.</span>
<span id="cb211-430"><a href="#cb211-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-431"><a href="#cb211-431" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig.height=3}</span></span>
<span id="cb211-432"><a href="#cb211-432" aria-hidden="true" tabindex="-1"></a><span class="in">sampling_idx &lt;- sample(1:nrow(mdl_grid), size = 10000, replace = TRUE, prob = mdl_grid$posterior)</span></span>
<span id="cb211-433"><a href="#cb211-433" aria-hidden="true" tabindex="-1"></a><span class="in">sampling_vals &lt;- mdl_grid[sampling_idx, c("mu", "sigma")]</span></span>
<span id="cb211-434"><a href="#cb211-434" aria-hidden="true" tabindex="-1"></a><span class="in">mu_ci &lt;- quantile(sampling_vals$mu, c(.025, .5, .975))</span></span>
<span id="cb211-435"><a href="#cb211-435" aria-hidden="true" tabindex="-1"></a><span class="in">sigma_ci &lt;- quantile(sampling_vals$sigma, c(.025, .5, .975))</span></span>
<span id="cb211-436"><a href="#cb211-436" aria-hidden="true" tabindex="-1"></a><span class="in">ci &lt;- qnorm(c(.025, .5, .975), mean = mu_ci[2], sd = sigma_ci[2])</span></span>
<span id="cb211-437"><a href="#cb211-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-438"><a href="#cb211-438" aria-hidden="true" tabindex="-1"></a><span class="in">data.frame(temp = seq(0, 30, by = .1)) %&gt;%</span></span>
<span id="cb211-439"><a href="#cb211-439" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(prob = map_dbl(temp, ~dnorm(., mean = ci[2], sd = sigma_ci[2])),</span></span>
<span id="cb211-440"><a href="#cb211-440" aria-hidden="true" tabindex="-1"></a><span class="in">         ci = if_else(temp &gt;= ci[1] &amp; temp &lt;= ci[3], "Y", "N")) %&gt;%</span></span>
<span id="cb211-441"><a href="#cb211-441" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = temp, y = prob)) +</span></span>
<span id="cb211-442"><a href="#cb211-442" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_area(aes(y = if_else(ci == "N", prob, 0)), </span></span>
<span id="cb211-443"><a href="#cb211-443" aria-hidden="true" tabindex="-1"></a><span class="in">            fill = "firebrick", show.legend = FALSE) +</span></span>
<span id="cb211-444"><a href="#cb211-444" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line() +</span></span>
<span id="cb211-445"><a href="#cb211-445" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(xintercept = ci[2], linetype = 2) +</span></span>
<span id="cb211-446"><a href="#cb211-446" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal() +</span></span>
<span id="cb211-447"><a href="#cb211-447" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(breaks = seq(0, 30, 5)) +</span></span>
<span id="cb211-448"><a href="#cb211-448" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.minor = element_blank()) +</span></span>
<span id="cb211-449"><a href="#cb211-449" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Posterior temperature probability", </span></span>
<span id="cb211-450"><a href="#cb211-450" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = glue("mu = {ci[2] %&gt;% scales::number(accuracy = .1)}, 95%-CI (",</span></span>
<span id="cb211-451"><a href="#cb211-451" aria-hidden="true" tabindex="-1"></a><span class="in">       "{ci[1] %&gt;% scales::number(accuracy = .1)}, ",</span></span>
<span id="cb211-452"><a href="#cb211-452" aria-hidden="true" tabindex="-1"></a><span class="in">       "{ci[3] %&gt;% scales::number(accuracy = .1)})"))</span></span>
<span id="cb211-453"><a href="#cb211-453" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-454"><a href="#cb211-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-455"><a href="#cb211-455" aria-hidden="true" tabindex="-1"></a>What is the probability the temperature is at least 18?</span>
<span id="cb211-456"><a href="#cb211-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-459"><a href="#cb211-459" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-460"><a href="#cb211-460" aria-hidden="true" tabindex="-1"></a>pred_temp <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="at">mean =</span> sampling_vals<span class="sc">$</span>mu, sampling_vals<span class="sc">$</span>sigma)</span>
<span id="cb211-461"><a href="#cb211-461" aria-hidden="true" tabindex="-1"></a>scales<span class="sc">::</span><span class="fu">percent</span>(<span class="fu">sum</span>(pred_temp <span class="sc">&gt;=</span> <span class="dv">18</span>) <span class="sc">/</span> <span class="fu">length</span>(pred_temp))</span>
<span id="cb211-462"><a href="#cb211-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-463"><a href="#cb211-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-464"><a href="#cb211-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-465"><a href="#cb211-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-468"><a href="#cb211-468" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-469"><a href="#cb211-469" aria-hidden="true" tabindex="-1"></a>gibbs_normal <span class="ot">&lt;-</span> <span class="cf">function</span>(y, mu_0, tau_0, a, b, n_iter){</span>
<span id="cb211-470"><a href="#cb211-470" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb211-471"><a href="#cb211-471" aria-hidden="true" tabindex="-1"></a>  y_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(y)</span>
<span id="cb211-472"><a href="#cb211-472" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb211-473"><a href="#cb211-473" aria-hidden="true" tabindex="-1"></a>  mu_sample <span class="ot">&lt;-</span> tau_sample <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_iter)</span>
<span id="cb211-474"><a href="#cb211-474" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb211-475"><a href="#cb211-475" aria-hidden="true" tabindex="-1"></a>  <span class="co"># starting values</span></span>
<span id="cb211-476"><a href="#cb211-476" aria-hidden="true" tabindex="-1"></a>  mu_sample[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(y)</span>
<span id="cb211-477"><a href="#cb211-477" aria-hidden="true" tabindex="-1"></a>  tau_sample[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">var</span>(y)</span>
<span id="cb211-478"><a href="#cb211-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-479"><a href="#cb211-479" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gibbs sampler</span></span>
<span id="cb211-480"><a href="#cb211-480" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n_iter){</span>
<span id="cb211-481"><a href="#cb211-481" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mu</span></span>
<span id="cb211-482"><a href="#cb211-482" aria-hidden="true" tabindex="-1"></a>    tau <span class="ot">&lt;-</span> tau_sample[i<span class="dv">-1</span>]</span>
<span id="cb211-483"><a href="#cb211-483" aria-hidden="true" tabindex="-1"></a>    mean_mu <span class="ot">&lt;-</span> (n <span class="sc">*</span> y_mean <span class="sc">*</span> tau <span class="sc">+</span> mu_0 <span class="sc">*</span> tau_0) <span class="sc">/</span> (n <span class="sc">*</span> tau <span class="sc">+</span> tau_0)</span>
<span id="cb211-484"><a href="#cb211-484" aria-hidden="true" tabindex="-1"></a>    precision_mu <span class="ot">&lt;-</span> n <span class="sc">*</span> tau <span class="sc">+</span> tau_0</span>
<span id="cb211-485"><a href="#cb211-485" aria-hidden="true" tabindex="-1"></a>    mu_sample[i] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mean_mu, <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(precision_mu))</span>
<span id="cb211-486"><a href="#cb211-486" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tau</span></span>
<span id="cb211-487"><a href="#cb211-487" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> mu_sample[i<span class="dv">-1</span>]</span>
<span id="cb211-488"><a href="#cb211-488" aria-hidden="true" tabindex="-1"></a>    tau_sample[i] <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, a <span class="sc">+</span> n<span class="sc">/</span><span class="dv">2</span>, b <span class="sc">+</span> .<span class="dv">5</span> <span class="sc">*</span> <span class="fu">sum</span>((y <span class="sc">-</span> mu)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb211-489"><a href="#cb211-489" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb211-490"><a href="#cb211-490" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb211-491"><a href="#cb211-491" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mu =</span> mu_sample, <span class="at">tau =</span> tau_sample))</span>
<span id="cb211-492"><a href="#cb211-492" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb211-493"><a href="#cb211-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-494"><a href="#cb211-494" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb211-495"><a href="#cb211-495" aria-hidden="true" tabindex="-1"></a>sample_m <span class="ot">&lt;-</span> <span class="fu">gibbs_normal</span>(howell[howell<span class="sc">$</span>male <span class="sc">==</span> <span class="st">"men"</span>,]<span class="sc">$</span>height, <span class="dv">175</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">5</span><span class="sc">^</span><span class="dv">2</span>, .<span class="dv">01</span>, .<span class="dv">01</span>, <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb211-496"><a href="#cb211-496" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-497"><a href="#cb211-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-498"><a href="#cb211-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-499"><a href="#cb211-499" aria-hidden="true" tabindex="-1"></a><span class="fu">## Gamma Poisson and Estimating Counts</span></span>
<span id="cb211-500"><a href="#cb211-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-501"><a href="#cb211-501" aria-hidden="true" tabindex="-1"></a>The gamma and Poisson distributions are used to model count data. Consider the following counts of weekday sandwich sales. What is the expected value of sales? </span>
<span id="cb211-502"><a href="#cb211-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-505"><a href="#cb211-505" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-506"><a href="#cb211-506" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">65</span>, <span class="dv">72</span>, <span class="dv">63</span>, <span class="dv">70</span>)</span>
<span id="cb211-507"><a href="#cb211-507" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-508"><a href="#cb211-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-509"><a href="#cb211-509" aria-hidden="true" tabindex="-1"></a>Count data have a Poisson distribution, $y_i|\lambda \sim Pois(\lambda)$, with expected value $\lambda$ and PMF $f(y_i | \lambda) = e^{-\lambda}\frac{\lambda^{y_i}}{y_i!}$. Using Bayes' Theorem, the posterior distribution of $\lambda$ given evidence $\textbf{y}$ is the joint likelihood of $\lambda$ and $\textbf{y}$ divided by the likelihood of $\textbf{y}$.</span>
<span id="cb211-510"><a href="#cb211-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-511"><a href="#cb211-511" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-512"><a href="#cb211-512" aria-hidden="true" tabindex="-1"></a>f(\lambda |\textbf{y}) = \frac{f(\mathbf{y}|\lambda) f(\lambda)}{\int_\Lambda f(\mathbf{y}|\lambda) f(\lambda) d\lambda}</span>
<span id="cb211-513"><a href="#cb211-513" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-514"><a href="#cb211-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-515"><a href="#cb211-515" aria-hidden="true" tabindex="-1"></a>The conditional likelihood, $f(\textbf{y}|\lambda)$, is the sum-product of the Poisson distribution PMF.</span>
<span id="cb211-516"><a href="#cb211-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-517"><a href="#cb211-517" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-518"><a href="#cb211-518" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-519"><a href="#cb211-519" aria-hidden="true" tabindex="-1"></a>f(\textbf{y}|\lambda) = f(y_i,\ldots, y_n | \lambda) &amp;= \prod_i f(y_i | \lambda) <span class="sc">\\</span></span>
<span id="cb211-520"><a href="#cb211-520" aria-hidden="true" tabindex="-1"></a>&amp;= \prod_i e^{-\lambda}\frac{\lambda^{y_i}}{y_i!}</span>
<span id="cb211-521"><a href="#cb211-521" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-522"><a href="#cb211-522" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-523"><a href="#cb211-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-524"><a href="#cb211-524" aria-hidden="true" tabindex="-1"></a>The prior distribution, $f(\lambda)$, should take on only positive values. Model it with the <span class="co">[</span><span class="ot">gamma distribution</span><span class="co">](https://mpfoley73.github.io/probability/random-variables-and-distributions.html#gamma)</span>, $\lambda|a,b = \mathrm{Gamma}(a,b)$.</span>
<span id="cb211-525"><a href="#cb211-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-526"><a href="#cb211-526" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-527"><a href="#cb211-527" aria-hidden="true" tabindex="-1"></a>f(\lambda) = f(\lambda | a,b) = \frac{b^a \lambda^{a-1} e^{-b\lambda}}{\Gamma(a)}</span>
<span id="cb211-528"><a href="#cb211-528" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-529"><a href="#cb211-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-530"><a href="#cb211-530" aria-hidden="true" tabindex="-1"></a>where $\Gamma$ is the gamma function^<span class="co">[</span><span class="ot">The gamma function is a generic function, just like sin, cos, etc., and is a kind of generalized factorial.</span><span class="co">]</span>. Substituting into Bayes' Theorem and simplifying, you have this nightmare:</span>
<span id="cb211-531"><a href="#cb211-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-532"><a href="#cb211-532" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-533"><a href="#cb211-533" aria-hidden="true" tabindex="-1"></a>f(\lambda |\textbf{y}) = \frac{\lambda^{a + \sum_i y_i-1}e^{-(b+n)\lambda}}{\int_0^\infty \lambda^{a + \sum_i y_i-1}e^{-(b+n)\lambda} d\lambda}</span>
<span id="cb211-534"><a href="#cb211-534" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-535"><a href="#cb211-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-536"><a href="#cb211-536" aria-hidden="true" tabindex="-1"></a>However, there is good news. The integration in the denominator removes the dependence on $\lambda$, so $f(\lambda |\textbf{y}, a, b)$ is proportional to the numerator up to a constant.</span>
<span id="cb211-537"><a href="#cb211-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-538"><a href="#cb211-538" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-539"><a href="#cb211-539" aria-hidden="true" tabindex="-1"></a>f(\lambda |\textbf{y}) \propto f(\textbf{y} | \lambda) f(\lambda)</span>
<span id="cb211-540"><a href="#cb211-540" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-541"><a href="#cb211-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-542"><a href="#cb211-542" aria-hidden="true" tabindex="-1"></a>Since $f(\lambda |\textbf{y})$ is a PMF, it integrates (sums) to 1 and you can always figure out the constant later. What makes this good news is that this has the form of the PDF of the gamma distribution. </span>
<span id="cb211-543"><a href="#cb211-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-544"><a href="#cb211-544" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-545"><a href="#cb211-545" aria-hidden="true" tabindex="-1"></a>\begin{equation} </span>
<span id="cb211-546"><a href="#cb211-546" aria-hidden="true" tabindex="-1"></a>\lambda | \textbf{y}, a, b \sim \mathrm{Gamma}(a + \sum_i y_i, b + n)</span>
<span id="cb211-547"><a href="#cb211-547" aria-hidden="true" tabindex="-1"></a>(<span class="sc">\#</span>eq:gamma-posterior)</span>
<span id="cb211-548"><a href="#cb211-548" aria-hidden="true" tabindex="-1"></a>\end{equation} </span>
<span id="cb211-549"><a href="#cb211-549" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-550"><a href="#cb211-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-551"><a href="#cb211-551" aria-hidden="true" tabindex="-1"></a>Equation \@ref(eq:gamma-posterior) is the posterior distribution of $\lambda$. We combined a gamma prior with the Poisson likelihood of evidence, $\textbf{y}$, to produce a gamma posterior. We call priors that produce posteriors of the same form, *conjugate priors* for the likelihood. Conjugate priors are popular because of their computational convenience.</span>
<span id="cb211-552"><a href="#cb211-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-553"><a href="#cb211-553" aria-hidden="true" tabindex="-1"></a>Return to the sandwich sales data. We need values to plug into Equation \@ref(eq:gamma-posterior). For the gamma distribution, $E(X) = a / b$ and $\mathrm{Var}(X) = a / b^2$. You might guess from intuition that mean daily sandwich sales are 70 +/- 5. Interpreting +/- 5 as a 95% CI and using the rule of thumb that a 95% CI is 2 SD, $\mathrm{Var} = (2.5)^2 = 6.25$. Solve for $a = 784$ and $b = 11.2$. We also have $\sum_i y_i = 320$ and $n = 5$.</span>
<span id="cb211-554"><a href="#cb211-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-555"><a href="#cb211-555" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-556"><a href="#cb211-556" aria-hidden="true" tabindex="-1"></a>\lambda | \textbf{y}, a, b \sim \mathrm{Gamma}(784 + 320, 11.2 + 5) \sim \mathrm{Gamma}(1104, 16.2)</span>
<span id="cb211-557"><a href="#cb211-557" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-558"><a href="#cb211-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-559"><a href="#cb211-559" aria-hidden="true" tabindex="-1"></a>The posterior $E(y) = 1104 / 16.2 = 68.1$ and $\mathrm{Var}(y) = 1104 / 16.2^2 = 4.2$. Use the gamma distribution function to get the posterior 95% _credible_ interval.</span>
<span id="cb211-560"><a href="#cb211-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-561"><a href="#cb211-561" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-562"><a href="#cb211-562" aria-hidden="true" tabindex="-1"></a><span class="in"># Prior distribution</span></span>
<span id="cb211-563"><a href="#cb211-563" aria-hidden="true" tabindex="-1"></a><span class="in">qgamma(p = c(.025, .975), 784, 11.2)</span></span>
<span id="cb211-564"><a href="#cb211-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-565"><a href="#cb211-565" aria-hidden="true" tabindex="-1"></a><span class="in"># Posterior distribution</span></span>
<span id="cb211-566"><a href="#cb211-566" aria-hidden="true" tabindex="-1"></a><span class="in">qgamma(p = c(.025, .975), 784 + 320, 11.2 + 5)</span></span>
<span id="cb211-567"><a href="#cb211-567" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-568"><a href="#cb211-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-569"><a href="#cb211-569" aria-hidden="true" tabindex="-1"></a>Whereas the prior expected mean daily sandwich sales was 70 (95% CI: 65, 75), the posterior is 68 (95% CI: 64, 72). Compare this to classical statistics: $E(y) = \bar{y} = 64$, $SE = \sqrt{\bar{y} / n} = 3.6$:</span>
<span id="cb211-570"><a href="#cb211-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-571"><a href="#cb211-571" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-572"><a href="#cb211-572" aria-hidden="true" tabindex="-1"></a><span class="in"># Classical estimate</span></span>
<span id="cb211-573"><a href="#cb211-573" aria-hidden="true" tabindex="-1"></a><span class="in">qnorm(p = c(.025, .975), 64, 3.6)</span></span>
<span id="cb211-574"><a href="#cb211-574" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-575"><a href="#cb211-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-576"><a href="#cb211-576" aria-hidden="true" tabindex="-1"></a>You might think that the reasonable Bayesian outcome was predicated on good $a$ and $b$ priors, but no. Suppose $a = .01$ and $b = .01$. The posterior is still reasonable.</span>
<span id="cb211-577"><a href="#cb211-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-578"><a href="#cb211-578" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-579"><a href="#cb211-579" aria-hidden="true" tabindex="-1"></a><span class="in"># Informal prior</span></span>
<span id="cb211-580"><a href="#cb211-580" aria-hidden="true" tabindex="-1"></a><span class="in">qgamma(p = c(.025, .975), .01 + 320, .01 + 5)</span></span>
<span id="cb211-581"><a href="#cb211-581" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-582"><a href="#cb211-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-585"><a href="#cb211-585" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-586"><a href="#cb211-586" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb211-587"><a href="#cb211-587" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">80</span>, .<span class="dv">1</span>),</span>
<span id="cb211-588"><a href="#cb211-588" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Gamma(.01, .01)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">dgamma</span>(lambda, .<span class="dv">01</span>, .<span class="dv">01</span>),</span>
<span id="cb211-589"><a href="#cb211-589" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Gamma(.01 + 320, .01 + 5)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">dgamma</span>(lambda, .<span class="dv">01</span> <span class="sc">+</span> <span class="dv">320</span>, .<span class="dv">01</span> <span class="sc">+</span> <span class="dv">5</span>),</span>
<span id="cb211-590"><a href="#cb211-590" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Gamma(784, 11.2)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">dgamma</span>(lambda, <span class="dv">784</span>, <span class="fl">11.2</span>),</span>
<span id="cb211-591"><a href="#cb211-591" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Gamma(784 + 320, 11.2 + 5)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">dgamma</span>(lambda, <span class="dv">784</span> <span class="sc">+</span> <span class="dv">320</span>, <span class="fl">11.2</span> <span class="sc">+</span> <span class="dv">5</span>)</span>
<span id="cb211-592"><a href="#cb211-592" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb211-593"><a href="#cb211-593" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>lambda) <span class="sc">%&gt;%</span></span>
<span id="cb211-594"><a href="#cb211-594" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">fct_inorder</span>(name)) <span class="sc">%&gt;%</span></span>
<span id="cb211-595"><a href="#cb211-595" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prior =</span> <span class="fu">if_else</span>(<span class="fu">str_detect</span>(name, <span class="st">"</span><span class="sc">\\</span><span class="st">+"</span>), <span class="st">"posterior"</span>, <span class="st">"prior"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb211-596"><a href="#cb211-596" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> lambda, <span class="at">y =</span> value, <span class="at">color =</span> name, <span class="at">linetype =</span> prior)) <span class="sc">+</span></span>
<span id="cb211-597"><a href="#cb211-597" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb211-598"><a href="#cb211-598" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"seagreen"</span>, <span class="dv">2</span>), <span class="fu">rep</span>(<span class="st">"firebrick"</span>, <span class="dv">2</span>))) <span class="sc">+</span></span>
<span id="cb211-599"><a href="#cb211-599" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">color =</span> <span class="cn">NULL</span>, <span class="at">linetype =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"density"</span>,</span>
<span id="cb211-600"><a href="#cb211-600" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Posteriors from Conservative and Informed Priors."</span>)</span>
<span id="cb211-601"><a href="#cb211-601" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-602"><a href="#cb211-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-603"><a href="#cb211-603" aria-hidden="true" tabindex="-1"></a>The Bayesian posterior approaches the classical $\bar{y}$ with increasing sample size.</span>
<span id="cb211-604"><a href="#cb211-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-605"><a href="#cb211-605" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-606"><a href="#cb211-606" aria-hidden="true" tabindex="-1"></a>E(\lambda|\textbf{y}, a, b) = \frac{a + \sum_i y_i}{b + n} = \frac{a + n \bar{y}}{b + n}</span>
<span id="cb211-607"><a href="#cb211-607" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-608"><a href="#cb211-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-609"><a href="#cb211-609" aria-hidden="true" tabindex="-1"></a>Taking the limit, $\lim_{n \rightarrow \infty} E(\lambda|\textbf{y}, a, b) = \bar{y}$.</span>
<span id="cb211-610"><a href="#cb211-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-611"><a href="#cb211-611" aria-hidden="true" tabindex="-1"></a>The *central* credible interval is the standard Bayesian credible interval. But when the posterior distribution is not perfectly symmetric, the shortest credible interval capturing x% of the distribution might have different endpoints. Our example has a pretty symmetric distribution, but let's calculate the *highest density region (HDR)* anyway.</span>
<span id="cb211-612"><a href="#cb211-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-613"><a href="#cb211-613" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-614"><a href="#cb211-614" aria-hidden="true" tabindex="-1"></a><span class="in">pp &lt;- seq(0.01, .99, by = .0001)</span></span>
<span id="cb211-615"><a href="#cb211-615" aria-hidden="true" tabindex="-1"></a><span class="in">x &lt;- map_dbl(pp, ~qgamma(., 784 + 320, 11.2 + 5))</span></span>
<span id="cb211-616"><a href="#cb211-616" aria-hidden="true" tabindex="-1"></a><span class="in">hdrcde::hdr(x, prob = 95)$hdr</span></span>
<span id="cb211-617"><a href="#cb211-617" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-618"><a href="#cb211-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-619"><a href="#cb211-619" aria-hidden="true" tabindex="-1"></a>The posterior predictive distribution of a predicted value, $\tilde{y}$ is</span>
<span id="cb211-620"><a href="#cb211-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-621"><a href="#cb211-621" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-622"><a href="#cb211-622" aria-hidden="true" tabindex="-1"></a>f(\tilde{y} | x) = \int f(\tilde{y}|\lambda) f(\lambda | \textbf{y}) d\lambda</span>
<span id="cb211-623"><a href="#cb211-623" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-624"><a href="#cb211-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-625"><a href="#cb211-625" aria-hidden="true" tabindex="-1"></a>Our sandwich example has a well defined functional solution: the expected value from $\mathrm{Gamma}(1104, 16.2)$ is $1104/16.2 = 68$. Had we not known this, we could have simulated posterior values (Monte Carlo simulation) and calculated the mean and variance. The procedure is to take a random sample of perhaps 1,000 $\lambda$ values from the gamma posterior distribution, then for each $\lambda$ draw a single random $\tilde{y}$ from the Poisson distribution. </span>
<span id="cb211-626"><a href="#cb211-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-627"><a href="#cb211-627" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-628"><a href="#cb211-628" aria-hidden="true" tabindex="-1"></a><span class="in">a &lt;- 1104 </span></span>
<span id="cb211-629"><a href="#cb211-629" aria-hidden="true" tabindex="-1"></a><span class="in">b &lt;- 16.2 </span></span>
<span id="cb211-630"><a href="#cb211-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-631"><a href="#cb211-631" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(1234)</span></span>
<span id="cb211-632"><a href="#cb211-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-633"><a href="#cb211-633" aria-hidden="true" tabindex="-1"></a><span class="in"># random sample of lambdas, and a single random y_tilde for each lambda</span></span>
<span id="cb211-634"><a href="#cb211-634" aria-hidden="true" tabindex="-1"></a><span class="in">lambda_r &lt;- rgamma(1000, a, b)</span></span>
<span id="cb211-635"><a href="#cb211-635" aria-hidden="true" tabindex="-1"></a><span class="in">y_tilde &lt;- rpois(1000, lambda_r)</span></span>
<span id="cb211-636"><a href="#cb211-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-637"><a href="#cb211-637" aria-hidden="true" tabindex="-1"></a><span class="in"># posterior predictive distribution</span></span>
<span id="cb211-638"><a href="#cb211-638" aria-hidden="true" tabindex="-1"></a><span class="in">mean(y_tilde)</span></span>
<span id="cb211-639"><a href="#cb211-639" aria-hidden="true" tabindex="-1"></a><span class="in">quantile(y_tilde, c(.025, .975))</span></span>
<span id="cb211-640"><a href="#cb211-640" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-641"><a href="#cb211-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-642"><a href="#cb211-642" aria-hidden="true" tabindex="-1"></a>So on any given day, the predicted value of sandwich sales is <span class="in">`r round(mean(y_tilde), 1)`</span> with 95% prediction interval <span class="in">`r quantile(y_tilde, c(.025, .975)) %&gt;% comma(.1) %&gt;% paste(collapse = ", ")`</span>. The probability of exceeding 80 sandwiches, $P(\tilde{y} &gt; 80 | \textbf{y})$, is <span class="in">`mean(y_tilde &gt; 80)`</span> = <span class="in">`r mean(y_tilde &gt; 80) %&gt;% percent(.1)`</span>, and 99% of the time, sandwich sales will be less than <span class="in">`quantile(y_tilde, .99)`</span> = <span class="in">`r quantile(y_tilde, .99)`</span>.</span>
<span id="cb211-643"><a href="#cb211-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-644"><a href="#cb211-644" aria-hidden="true" tabindex="-1"></a>You can also predict individual weekdays. Suppose you take a $\mathrm{Gamma}(700, 10)$ distribution as your prior.</span>
<span id="cb211-645"><a href="#cb211-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-648"><a href="#cb211-648" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-649"><a href="#cb211-649" aria-hidden="true" tabindex="-1"></a>day_tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb211-650"><a href="#cb211-650" aria-hidden="true" tabindex="-1"></a>  <span class="at">dow =</span> <span class="fu">fct_inorder</span>(<span class="fu">c</span>(<span class="st">"Mon"</span>, <span class="st">"Tue"</span>, <span class="st">"Wed"</span>, <span class="st">"Thu"</span>, <span class="st">"Fri"</span>)),</span>
<span id="cb211-651"><a href="#cb211-651" aria-hidden="true" tabindex="-1"></a>  <span class="at">d =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">65</span>, <span class="dv">72</span>, <span class="dv">63</span>, <span class="dv">70</span>)</span>
<span id="cb211-652"><a href="#cb211-652" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb211-653"><a href="#cb211-653" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb211-654"><a href="#cb211-654" aria-hidden="true" tabindex="-1"></a>    <span class="at">post_a =</span> <span class="dv">700</span> <span class="sc">+</span> d,</span>
<span id="cb211-655"><a href="#cb211-655" aria-hidden="true" tabindex="-1"></a>    <span class="at">post_b =</span> <span class="dv">10</span> <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb211-656"><a href="#cb211-656" aria-hidden="true" tabindex="-1"></a>    <span class="at">post_mean =</span> post_a <span class="sc">/</span> post_b,</span>
<span id="cb211-657"><a href="#cb211-657" aria-hidden="true" tabindex="-1"></a>    <span class="at">post_lci =</span> <span class="fu">qgamma</span>(.<span class="dv">025</span>, post_a, post_b),</span>
<span id="cb211-658"><a href="#cb211-658" aria-hidden="true" tabindex="-1"></a>    <span class="at">post_uci =</span> <span class="fu">qgamma</span>(.<span class="dv">975</span>, post_a, post_b)</span>
<span id="cb211-659"><a href="#cb211-659" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb211-660"><a href="#cb211-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-661"><a href="#cb211-661" aria-hidden="true" tabindex="-1"></a>day_tbl</span>
<span id="cb211-662"><a href="#cb211-662" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-663"><a href="#cb211-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-664"><a href="#cb211-664" aria-hidden="true" tabindex="-1"></a>What is the probability that Mon sales are less than Tue?</span>
<span id="cb211-665"><a href="#cb211-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-666"><a href="#cb211-666" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-667"><a href="#cb211-667" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(123)</span></span>
<span id="cb211-668"><a href="#cb211-668" aria-hidden="true" tabindex="-1"></a><span class="in">lambda_r_mon &lt;- rgamma(1000, 750, 11)</span></span>
<span id="cb211-669"><a href="#cb211-669" aria-hidden="true" tabindex="-1"></a><span class="in">lambda_r_tue &lt;- rgamma(1000, 765, 11)</span></span>
<span id="cb211-670"><a href="#cb211-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-671"><a href="#cb211-671" aria-hidden="true" tabindex="-1"></a><span class="in"># posterior probability </span></span>
<span id="cb211-672"><a href="#cb211-672" aria-hidden="true" tabindex="-1"></a><span class="in">mean(lambda_r_mon &lt; lambda_r_tue)</span></span>
<span id="cb211-673"><a href="#cb211-673" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-674"><a href="#cb211-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-675"><a href="#cb211-675" aria-hidden="true" tabindex="-1"></a>Which day of the week has the highest sandwich sales?</span>
<span id="cb211-676"><a href="#cb211-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-677"><a href="#cb211-677" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-678"><a href="#cb211-678" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345)</span></span>
<span id="cb211-679"><a href="#cb211-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-680"><a href="#cb211-680" aria-hidden="true" tabindex="-1"></a><span class="in">lambda_r &lt;- tibble(</span></span>
<span id="cb211-681"><a href="#cb211-681" aria-hidden="true" tabindex="-1"></a><span class="in">  r_mon = rgamma(1000, 750, 11),</span></span>
<span id="cb211-682"><a href="#cb211-682" aria-hidden="true" tabindex="-1"></a><span class="in">  r_tue = rgamma(1000, 765, 11),</span></span>
<span id="cb211-683"><a href="#cb211-683" aria-hidden="true" tabindex="-1"></a><span class="in">  r_wed = rgamma(1000, 772, 11),</span></span>
<span id="cb211-684"><a href="#cb211-684" aria-hidden="true" tabindex="-1"></a><span class="in">  r_thu = rgamma(1000, 763, 11),</span></span>
<span id="cb211-685"><a href="#cb211-685" aria-hidden="true" tabindex="-1"></a><span class="in">  r_fri = rgamma(1000, 770, 11),</span></span>
<span id="cb211-686"><a href="#cb211-686" aria-hidden="true" tabindex="-1"></a><span class="in">  r_dow = pmap(list(r_mon, r_tue, r_wed, r_thu, r_fri), </span></span>
<span id="cb211-687"><a href="#cb211-687" aria-hidden="true" tabindex="-1"></a><span class="in">                   function(m, t, w, r, f) c(m, t, w, r, f)),</span></span>
<span id="cb211-688"><a href="#cb211-688" aria-hidden="true" tabindex="-1"></a><span class="in">  max_dow_idx = map_dbl(r_dow, ~which.max(.)),</span></span>
<span id="cb211-689"><a href="#cb211-689" aria-hidden="true" tabindex="-1"></a><span class="in">  max_dow = map_chr(max_dow_idx, ~c("Mon", "Tue", "Wed", "Thu", "Fri")[.])</span></span>
<span id="cb211-690"><a href="#cb211-690" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb211-691"><a href="#cb211-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-692"><a href="#cb211-692" aria-hidden="true" tabindex="-1"></a><span class="in">lambda_r %&gt;% janitor::tabyl(max_dow)</span></span>
<span id="cb211-693"><a href="#cb211-693" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-694"><a href="#cb211-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-695"><a href="#cb211-695" aria-hidden="true" tabindex="-1"></a>Use the Deviance Information Criterion (DIC) to evaluate whether the day means differ from each other. </span>
<span id="cb211-696"><a href="#cb211-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-697"><a href="#cb211-697" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-698"><a href="#cb211-698" aria-hidden="true" tabindex="-1"></a>DIC = p_D + \overline{D(\theta)}</span>
<span id="cb211-699"><a href="#cb211-699" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-700"><a href="#cb211-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-701"><a href="#cb211-701" aria-hidden="true" tabindex="-1"></a>where $p_D = \overline{D(\theta)} - D(\hat{\theta})$ and $D(\theta) = -2 \log (f(y|\theta)) + C$.</span>
<span id="cb211-702"><a href="#cb211-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-703"><a href="#cb211-703" aria-hidden="true" tabindex="-1"></a>Evaluate $\overline{D(\theta)}$ by producing samples from each distribution and evaluating the likelihoods of the data based on each realization and taking the mean of -2 log-likelihood.</span>
<span id="cb211-704"><a href="#cb211-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-707"><a href="#cb211-707" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-708"><a href="#cb211-708" aria-hidden="true" tabindex="-1"></a><span class="co"># Reset the example. Sandwich counts by dow.</span></span>
<span id="cb211-709"><a href="#cb211-709" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">65</span>, <span class="dv">72</span>, <span class="dv">63</span>, <span class="dv">70</span>)</span>
<span id="cb211-710"><a href="#cb211-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-711"><a href="#cb211-711" aria-hidden="true" tabindex="-1"></a><span class="co"># Priors</span></span>
<span id="cb211-712"><a href="#cb211-712" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb211-713"><a href="#cb211-713" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb211-714"><a href="#cb211-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-715"><a href="#cb211-715" aria-hidden="true" tabindex="-1"></a><span class="co"># Posteriors</span></span>
<span id="cb211-716"><a href="#cb211-716" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb211-717"><a href="#cb211-717" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rgamma</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span>y[<span class="dv">1</span>], b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">1</span>])),</span>
<span id="cb211-718"><a href="#cb211-718" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rgamma</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span>y[<span class="dv">2</span>], b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">2</span>])),</span>
<span id="cb211-719"><a href="#cb211-719" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rgamma</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span>y[<span class="dv">3</span>], b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">3</span>])),</span>
<span id="cb211-720"><a href="#cb211-720" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rgamma</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span>y[<span class="dv">4</span>], b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">4</span>])),</span>
<span id="cb211-721"><a href="#cb211-721" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rgamma</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span>y[<span class="dv">5</span>], b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">5</span>]))</span>
<span id="cb211-722"><a href="#cb211-722" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb211-723"><a href="#cb211-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-724"><a href="#cb211-724" aria-hidden="true" tabindex="-1"></a><span class="co"># -2 * Mean log-likelihood</span></span>
<span id="cb211-725"><a href="#cb211-725" aria-hidden="true" tabindex="-1"></a>ll <span class="ot">&lt;-</span> </span>
<span id="cb211-726"><a href="#cb211-726" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">1</span>], post[[<span class="dv">1</span>]], <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-727"><a href="#cb211-727" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">2</span>], post[[<span class="dv">2</span>]], <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-728"><a href="#cb211-728" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">3</span>], post[[<span class="dv">3</span>]], <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-729"><a href="#cb211-729" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">4</span>], post[[<span class="dv">4</span>]], <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-730"><a href="#cb211-730" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">5</span>], post[[<span class="dv">5</span>]], <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb211-731"><a href="#cb211-731" aria-hidden="true" tabindex="-1"></a>(mean_D <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> ll))</span>
<span id="cb211-732"><a href="#cb211-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-733"><a href="#cb211-733" aria-hidden="true" tabindex="-1"></a><span class="co"># D(theta-bar) is the likelihood of the data based on the posterior means of p.</span></span>
<span id="cb211-734"><a href="#cb211-734" aria-hidden="true" tabindex="-1"></a>(D_mean <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> (</span>
<span id="cb211-735"><a href="#cb211-735" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">1</span>], (a<span class="sc">+</span>y[<span class="dv">1</span>]) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">1</span>])), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-736"><a href="#cb211-736" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">2</span>], (a<span class="sc">+</span>y[<span class="dv">2</span>]) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">2</span>])), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-737"><a href="#cb211-737" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">3</span>], (a<span class="sc">+</span>y[<span class="dv">3</span>]) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">3</span>])), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-738"><a href="#cb211-738" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">4</span>], (a<span class="sc">+</span>y[<span class="dv">4</span>]) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">4</span>])), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-739"><a href="#cb211-739" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">5</span>], (a<span class="sc">+</span>y[<span class="dv">5</span>]) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y[<span class="dv">5</span>])), <span class="at">log =</span> <span class="cn">TRUE</span>) </span>
<span id="cb211-740"><a href="#cb211-740" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb211-741"><a href="#cb211-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-742"><a href="#cb211-742" aria-hidden="true" tabindex="-1"></a><span class="co">#p_D and DIC from equation</span></span>
<span id="cb211-743"><a href="#cb211-743" aria-hidden="true" tabindex="-1"></a>(p_D <span class="ot">&lt;-</span> mean_D <span class="sc">-</span> D_mean)</span>
<span id="cb211-744"><a href="#cb211-744" aria-hidden="true" tabindex="-1"></a>(DIC <span class="ot">&lt;-</span> p_D <span class="sc">+</span> mean_D)</span>
<span id="cb211-745"><a href="#cb211-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-746"><a href="#cb211-746" aria-hidden="true" tabindex="-1"></a><span class="co"># Repeat these steps for a single model of all groups</span></span>
<span id="cb211-747"><a href="#cb211-747" aria-hidden="true" tabindex="-1"></a>post_group <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span><span class="fu">sum</span>(y), b<span class="sc">+</span><span class="fu">length</span>(y))</span>
<span id="cb211-748"><a href="#cb211-748" aria-hidden="true" tabindex="-1"></a>ll_group <span class="ot">&lt;-</span> </span>
<span id="cb211-749"><a href="#cb211-749" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">1</span>], post_group, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-750"><a href="#cb211-750" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">2</span>], post_group, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-751"><a href="#cb211-751" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">3</span>], post_group, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-752"><a href="#cb211-752" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">4</span>], post_group, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-753"><a href="#cb211-753" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">5</span>], post_group, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb211-754"><a href="#cb211-754" aria-hidden="true" tabindex="-1"></a>(mean_D_group <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> ll_group))</span>
<span id="cb211-755"><a href="#cb211-755" aria-hidden="true" tabindex="-1"></a>(D_mean_group <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> (</span>
<span id="cb211-756"><a href="#cb211-756" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">1</span>], (a<span class="sc">+</span><span class="fu">sum</span>(y)) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y)), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-757"><a href="#cb211-757" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">2</span>], (a<span class="sc">+</span><span class="fu">sum</span>(y)) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y)), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-758"><a href="#cb211-758" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">3</span>], (a<span class="sc">+</span><span class="fu">sum</span>(y)) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y)), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-759"><a href="#cb211-759" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">4</span>], (a<span class="sc">+</span><span class="fu">sum</span>(y)) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y)), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-760"><a href="#cb211-760" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dpois</span>(y[<span class="dv">5</span>], (a<span class="sc">+</span><span class="fu">sum</span>(y)) <span class="sc">/</span> (b<span class="sc">+</span><span class="fu">length</span>(y)), <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb211-761"><a href="#cb211-761" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb211-762"><a href="#cb211-762" aria-hidden="true" tabindex="-1"></a>(p_D_group <span class="ot">&lt;-</span> mean_D_group <span class="sc">-</span> D_mean_group)</span>
<span id="cb211-763"><a href="#cb211-763" aria-hidden="true" tabindex="-1"></a>(DIC_group <span class="ot">&lt;-</span> p_D_group <span class="sc">+</span> mean_D_group)</span>
<span id="cb211-764"><a href="#cb211-764" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-765"><a href="#cb211-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-766"><a href="#cb211-766" aria-hidden="true" tabindex="-1"></a>The DIC for the weekday specific model is <span class="in">`r DIC`</span> and for the one common group model it is <span class="in">`r DIC_group`</span>. The DIC for one common group model is smaller, so we do not have enough statistical evidence for two groups. </span>
<span id="cb211-767"><a href="#cb211-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-768"><a href="#cb211-768" aria-hidden="true" tabindex="-1"></a><span class="fu">## Normal and Estimating Means</span></span>
<span id="cb211-769"><a href="#cb211-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-770"><a href="#cb211-770" aria-hidden="true" tabindex="-1"></a><span class="fu">### Population Estimate {#normal-pop-est}</span></span>
<span id="cb211-771"><a href="#cb211-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-772"><a href="#cb211-772" aria-hidden="true" tabindex="-1"></a>Suppose you have a sample, $\textbf{y}$, from a normally distribution population of unknown mean and precision, $\mu$ and $\tau$: $y_i|\mu, \tau \sim N(\mu, \tau)$.^<span class="co">[</span><span class="ot">In Bayesian statistics, the normal distribution is parameterized with the inverse of variance, called the *precision*, $\tau = 1 / \sigma^2$.</span><span class="co">]</span> Assume a normal prior for $\mu \sim N(\mu_0, \tau_0)$, and a gamma prior for $\tau \sim \text{Gamma}(a, b)$ since it takes only positive values. The PDF for $y_i$ is $f(y_i | \mu, \tau) = \frac{\tau^{.5}}{\sqrt{2\pi}} \exp\left(-\frac{\tau}{2} (y_i - \mu)^2 \right)$. We'll derive posterior distributions for $\mu$ and $\tau$ separately. </span>
<span id="cb211-773"><a href="#cb211-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-774"><a href="#cb211-774" aria-hidden="true" tabindex="-1"></a>Using Bayes' Theorem, the posterior distribution of $\mu|y$ is the joint likelihood of $y$ and $\mu$ divided by the likelihood of $y$, </span>
<span id="cb211-775"><a href="#cb211-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-776"><a href="#cb211-776" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-777"><a href="#cb211-777" aria-hidden="true" tabindex="-1"></a>f(\mu|y) = \frac{f(y|\mu)f(\mu)}{\int_\mu f(y|\mu)f(\mu)d\mu}</span>
<span id="cb211-778"><a href="#cb211-778" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-779"><a href="#cb211-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-780"><a href="#cb211-780" aria-hidden="true" tabindex="-1"></a>The conditional likelihood, $f(\mu|y)$, is the sum-product of the normal distribution PDF. We can take $\tau$ as given initially.</span>
<span id="cb211-781"><a href="#cb211-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-782"><a href="#cb211-782" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-783"><a href="#cb211-783" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-784"><a href="#cb211-784" aria-hidden="true" tabindex="-1"></a>f(y|\mu) &amp;= \prod_i \frac{\tau^{(1/2)}}{\sqrt{2\pi}} \exp\left(-\frac{\tau}{2} (y_i - \mu)^2 \right) <span class="sc">\\</span></span>
<span id="cb211-785"><a href="#cb211-785" aria-hidden="true" tabindex="-1"></a>&amp;\propto \prod_i \exp\left(-\frac{\tau}{2} (y_i - \mu)^2 \right) <span class="sc">\\</span></span>
<span id="cb211-786"><a href="#cb211-786" aria-hidden="true" tabindex="-1"></a>&amp;\propto \exp \left( -\frac{\tau}{2} \sum_i(y_i - \mu)^2 \right)</span>
<span id="cb211-787"><a href="#cb211-787" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-788"><a href="#cb211-788" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-789"><a href="#cb211-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-790"><a href="#cb211-790" aria-hidden="true" tabindex="-1"></a>The prior PDF for $\mu$ is the normal distribution. Again we take $\tau$ as given initially.</span>
<span id="cb211-791"><a href="#cb211-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-792"><a href="#cb211-792" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-793"><a href="#cb211-793" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-794"><a href="#cb211-794" aria-hidden="true" tabindex="-1"></a>f(\mu) &amp;= \frac{\tau_0^{1/2}}{\sqrt{2\pi}} \exp\left(-\frac{\tau_0}{2} (\mu - \mu_0)^2 \right) <span class="sc">\\</span></span>
<span id="cb211-795"><a href="#cb211-795" aria-hidden="true" tabindex="-1"></a>&amp;\propto \exp\left(-\frac{\tau_0}{2} (\mu - \mu_0)^2 \right)  </span>
<span id="cb211-796"><a href="#cb211-796" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-797"><a href="#cb211-797" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-798"><a href="#cb211-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-799"><a href="#cb211-799" aria-hidden="true" tabindex="-1"></a>Substitute into Bayes' Theorem. Since we are working with proportions, we can throw out the denominator and say $f(\mu|y) \propto f(y|\mu)f(\mu)$. Plugging in and solving, we get</span>
<span id="cb211-800"><a href="#cb211-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-801"><a href="#cb211-801" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-802"><a href="#cb211-802" aria-hidden="true" tabindex="-1"></a>\begin{equation}</span>
<span id="cb211-803"><a href="#cb211-803" aria-hidden="true" tabindex="-1"></a>\mu|y \sim N\left(\frac{n\tau\bar{y} + \tau_0\mu_0}{n\tau + \tau_0}, n\tau + \tau_0 \right)</span>
<span id="cb211-804"><a href="#cb211-804" aria-hidden="true" tabindex="-1"></a>(<span class="sc">\#</span>eq:mu-posterior)</span>
<span id="cb211-805"><a href="#cb211-805" aria-hidden="true" tabindex="-1"></a>\end{equation}</span>
<span id="cb211-806"><a href="#cb211-806" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-807"><a href="#cb211-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-808"><a href="#cb211-808" aria-hidden="true" tabindex="-1"></a>Using Bayes' Theorem, the posterior distribution of $\tau|y$ is the joint likelihood of $y$ and $\tau$ divided by the likelihood of $y$, </span>
<span id="cb211-809"><a href="#cb211-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-810"><a href="#cb211-810" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-811"><a href="#cb211-811" aria-hidden="true" tabindex="-1"></a>f(\tau|y) = \frac{f(y|\tau)f(\tau)}{\int_\tau f(y|\mu)f(\tau)d\tau}</span>
<span id="cb211-812"><a href="#cb211-812" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-813"><a href="#cb211-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-814"><a href="#cb211-814" aria-hidden="true" tabindex="-1"></a>The conditional likelihood, $f(\tau|y)$, is the sum-product of the gamma distribution PDF. This time we take $\mu$ as given.</span>
<span id="cb211-815"><a href="#cb211-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-816"><a href="#cb211-816" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-817"><a href="#cb211-817" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-818"><a href="#cb211-818" aria-hidden="true" tabindex="-1"></a>f(y|\tau) &amp;= \prod_i \frac{\tau^{(1/2)}}{\sqrt{2\pi}} \exp\left(-\frac{\tau}{2} (y_i - \mu)^2 \right) <span class="sc">\\</span></span>
<span id="cb211-819"><a href="#cb211-819" aria-hidden="true" tabindex="-1"></a>&amp;= \frac{\tau^{n/2}}{(2\pi)^{n/2}} \exp\left(-\frac{\tau}{2} \sum_i (y_i - \mu)^2 \right) <span class="sc">\\</span></span>
<span id="cb211-820"><a href="#cb211-820" aria-hidden="true" tabindex="-1"></a>&amp;\propto \tau^{n/2} \exp \left( -\frac{\tau}{2} \sum_i(y_i - \mu)^2 \right)</span>
<span id="cb211-821"><a href="#cb211-821" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-822"><a href="#cb211-822" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-823"><a href="#cb211-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-824"><a href="#cb211-824" aria-hidden="true" tabindex="-1"></a>The prior PDF for $\tau$ is the gamma distribution. Pull the constant out to work with proportionality.</span>
<span id="cb211-825"><a href="#cb211-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-826"><a href="#cb211-826" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-827"><a href="#cb211-827" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-828"><a href="#cb211-828" aria-hidden="true" tabindex="-1"></a>f(\tau) &amp;= \frac{b^a \tau^{a-1} e^{-b\tau}}{\Gamma(a)} <span class="sc">\\</span></span>
<span id="cb211-829"><a href="#cb211-829" aria-hidden="true" tabindex="-1"></a>&amp;\propto \tau^{a-1}e^{-b\tau}</span>
<span id="cb211-830"><a href="#cb211-830" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-831"><a href="#cb211-831" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-832"><a href="#cb211-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-833"><a href="#cb211-833" aria-hidden="true" tabindex="-1"></a>Substitute into Bayes' Theorem. Since we are working with proportions, we can throw out the denominator and say $f(\tau|y) \propto f(y|\tau)f(\tau)$. Plugging in and solving, we get</span>
<span id="cb211-834"><a href="#cb211-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-835"><a href="#cb211-835" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-836"><a href="#cb211-836" aria-hidden="true" tabindex="-1"></a>\begin{equation}</span>
<span id="cb211-837"><a href="#cb211-837" aria-hidden="true" tabindex="-1"></a>\tau|y \sim \text{Gamma}\left(a + n/2, b + \frac{1}{2} \sum_i(y_i - \mu)^2 \right)</span>
<span id="cb211-838"><a href="#cb211-838" aria-hidden="true" tabindex="-1"></a>(<span class="sc">\#</span>eq:tau-posterior)</span>
<span id="cb211-839"><a href="#cb211-839" aria-hidden="true" tabindex="-1"></a>\end{equation}</span>
<span id="cb211-840"><a href="#cb211-840" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-841"><a href="#cb211-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-842"><a href="#cb211-842" aria-hidden="true" tabindex="-1"></a>We have $y_i|\mu,\tau \sim N(\mu,\tau)$ with conjugate priors $\mu \sim N(\mu_0, \tau_0)$ and $\tau \sim \text{Gamma}(a,b)$ and conditional posterior distributions shown in Eqns \@ref(eq:mu-posterior) and \@ref(eq:tau-posterior). Returning to Eqn \@ref(eq:mu-posterior), you can see how $E<span class="co">[</span><span class="ot">\mu</span><span class="co">]</span> \rightarrow \bar{y}$ as the sample size grows. Below, the terms divided by $n$ disappear, leaving just $\bar{y}$.</span>
<span id="cb211-843"><a href="#cb211-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-844"><a href="#cb211-844" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-845"><a href="#cb211-845" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-846"><a href="#cb211-846" aria-hidden="true" tabindex="-1"></a>E<span class="co">[</span><span class="ot">\mu|\tau, y</span><span class="co">]</span> &amp;= \frac{n\tau\bar{y} + \tau_0\mu_0}{n\tau + \tau_0} <span class="sc">\\</span></span>
<span id="cb211-847"><a href="#cb211-847" aria-hidden="true" tabindex="-1"></a>&amp;= \frac{\bar{y}\tau + \mu_0\tau_0/n}{\tau + \tau_0/n} <span class="sc">\\</span></span>
<span id="cb211-848"><a href="#cb211-848" aria-hidden="true" tabindex="-1"></a>&amp;\sim \bar{y}</span>
<span id="cb211-849"><a href="#cb211-849" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-850"><a href="#cb211-850" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-851"><a href="#cb211-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-852"><a href="#cb211-852" aria-hidden="true" tabindex="-1"></a>The posterior mean estimator of $\tau$ is the ratio of the posterior gamma distribution parameters. Again, as the sample size increases, terms divided by $n$ disappear.</span>
<span id="cb211-853"><a href="#cb211-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-854"><a href="#cb211-854" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-855"><a href="#cb211-855" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-856"><a href="#cb211-856" aria-hidden="true" tabindex="-1"></a>E<span class="co">[</span><span class="ot">\tau|\mu,y</span><span class="co">]</span> &amp;= \frac{a + n/2}{b + \frac{1}{2} \sum_i(y_i - \mu)^2} <span class="sc">\\</span> </span>
<span id="cb211-857"><a href="#cb211-857" aria-hidden="true" tabindex="-1"></a>&amp;= \frac{2a/n + 1}{2b/n + \sum_i(y_i - \mu)^2 / n} <span class="sc">\\</span></span>
<span id="cb211-858"><a href="#cb211-858" aria-hidden="true" tabindex="-1"></a>&amp;\sim \frac{1}{\sum_i(y_i - \mu)^2}</span>
<span id="cb211-859"><a href="#cb211-859" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-860"><a href="#cb211-860" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-861"><a href="#cb211-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-862"><a href="#cb211-862" aria-hidden="true" tabindex="-1"></a>The problem here is that you never know $\mu$ or $\tau$, so you cannot use the posterior formulas directly. Instead, you need to use sampling. In particular, you use the *Gibbs sampler*. Set $\mu$ and $\tau$ to some initial values and use the posterior equations to estimate new values for $\mu$ and $\tau$, then repeat. This is called Markov Chain Monte Carlo (MCMC) simulation because you are chaining the simulations. The method of sampling from a conditional posterior is called the Gibbs sampler.</span>
<span id="cb211-863"><a href="#cb211-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-864"><a href="#cb211-864" aria-hidden="true" tabindex="-1"></a>Let's apply this using anthropological data collected by Nancy Howell of human height. </span>
<span id="cb211-865"><a href="#cb211-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-868"><a href="#cb211-868" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-869"><a href="#cb211-869" aria-hidden="true" tabindex="-1"></a><span class="co"># downloaded this from </span></span>
<span id="cb211-870"><a href="#cb211-870" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/rmcelreath/rethinking/blob/master/data/Howell1.csv</span></span>
<span id="cb211-871"><a href="#cb211-871" aria-hidden="true" tabindex="-1"></a>howell <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(<span class="st">"input/Howell1.csv"</span>, <span class="at">delim =</span> <span class="st">";"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb211-872"><a href="#cb211-872" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age <span class="sc">&gt;=</span> <span class="dv">18</span>) <span class="sc">%&gt;%</span></span>
<span id="cb211-873"><a href="#cb211-873" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">male =</span> <span class="fu">factor</span>(male, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"women"</span>, <span class="st">"men"</span>)))</span>
<span id="cb211-874"><a href="#cb211-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-875"><a href="#cb211-875" aria-hidden="true" tabindex="-1"></a>howell <span class="sc">%&gt;%</span></span>
<span id="cb211-876"><a href="#cb211-876" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> height, <span class="at">color =</span> male)) <span class="sc">+</span></span>
<span id="cb211-877"><a href="#cb211-877" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq</span>() <span class="sc">+</span></span>
<span id="cb211-878"><a href="#cb211-878" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_qq_line</span>()</span>
<span id="cb211-879"><a href="#cb211-879" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-880"><a href="#cb211-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-881"><a href="#cb211-881" aria-hidden="true" tabindex="-1"></a>From prior knowledge, we know average human height is about $175 \pm 10$ cm. Using the $\pm$ = 2SD, the variance $5^2$. Use vague priors of $\mu \sim N(\mu_0 = 175, \tau_0 = 1/5^2)$ and $\tau = \sim \text{Gamma}(a = .01, b = .01)$. Start by assigning starting values, $\mu*$ and $\tau*$). Given $\tau = \tau*$, sample a new value of $\mu*$ from the normal distribution. Given $\mu = \mu*$, sample a new value of $\tau*$ from the gamma distribution. Then repeat.</span>
<span id="cb211-882"><a href="#cb211-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-883"><a href="#cb211-883" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-884"><a href="#cb211-884" aria-hidden="true" tabindex="-1"></a><span class="in">gibbs_normal &lt;- function(y, mu_0, tau_0, a, b, n_iter){</span></span>
<span id="cb211-885"><a href="#cb211-885" aria-hidden="true" tabindex="-1"></a><span class="in">  n &lt;- length(y)</span></span>
<span id="cb211-886"><a href="#cb211-886" aria-hidden="true" tabindex="-1"></a><span class="in">  y_mean &lt;- mean(y)</span></span>
<span id="cb211-887"><a href="#cb211-887" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb211-888"><a href="#cb211-888" aria-hidden="true" tabindex="-1"></a><span class="in">  mu_sample &lt;- tau_sample &lt;- numeric(n_iter)</span></span>
<span id="cb211-889"><a href="#cb211-889" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb211-890"><a href="#cb211-890" aria-hidden="true" tabindex="-1"></a><span class="in">  # starting values</span></span>
<span id="cb211-891"><a href="#cb211-891" aria-hidden="true" tabindex="-1"></a><span class="in">  mu_sample[1] &lt;- mean(y)</span></span>
<span id="cb211-892"><a href="#cb211-892" aria-hidden="true" tabindex="-1"></a><span class="in">  tau_sample[1] &lt;- 1 / var(y)</span></span>
<span id="cb211-893"><a href="#cb211-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-894"><a href="#cb211-894" aria-hidden="true" tabindex="-1"></a><span class="in">  # Gibbs sampler</span></span>
<span id="cb211-895"><a href="#cb211-895" aria-hidden="true" tabindex="-1"></a><span class="in">  for(i in 2:n_iter){</span></span>
<span id="cb211-896"><a href="#cb211-896" aria-hidden="true" tabindex="-1"></a><span class="in">    # mu</span></span>
<span id="cb211-897"><a href="#cb211-897" aria-hidden="true" tabindex="-1"></a><span class="in">    tau &lt;- tau_sample[i-1]</span></span>
<span id="cb211-898"><a href="#cb211-898" aria-hidden="true" tabindex="-1"></a><span class="in">    mean_mu &lt;- (n * y_mean * tau + mu_0 * tau_0) / (n * tau + tau_0)</span></span>
<span id="cb211-899"><a href="#cb211-899" aria-hidden="true" tabindex="-1"></a><span class="in">    precision_mu &lt;- n * tau + tau_0</span></span>
<span id="cb211-900"><a href="#cb211-900" aria-hidden="true" tabindex="-1"></a><span class="in">    mu_sample[i] &lt;- rnorm(1, mean_mu, 1 / sqrt(precision_mu))</span></span>
<span id="cb211-901"><a href="#cb211-901" aria-hidden="true" tabindex="-1"></a><span class="in">    # tau</span></span>
<span id="cb211-902"><a href="#cb211-902" aria-hidden="true" tabindex="-1"></a><span class="in">    mu &lt;- mu_sample[i-1]</span></span>
<span id="cb211-903"><a href="#cb211-903" aria-hidden="true" tabindex="-1"></a><span class="in">    tau_sample[i] &lt;- rgamma(1, a + n/2, b + .5 * sum((y - mu)^2))</span></span>
<span id="cb211-904"><a href="#cb211-904" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb211-905"><a href="#cb211-905" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb211-906"><a href="#cb211-906" aria-hidden="true" tabindex="-1"></a><span class="in">  return(list(mu = mu_sample, tau = tau_sample))</span></span>
<span id="cb211-907"><a href="#cb211-907" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb211-908"><a href="#cb211-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-909"><a href="#cb211-909" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345)</span></span>
<span id="cb211-910"><a href="#cb211-910" aria-hidden="true" tabindex="-1"></a><span class="in">sample_m &lt;- gibbs_normal(howell[howell$male == "men",]$height, 175, 1/5^2, .01, .01, 10^3)</span></span>
<span id="cb211-911"><a href="#cb211-911" aria-hidden="true" tabindex="-1"></a><span class="in">sample_w &lt;- gibbs_normal(howell[howell$male == "women",]$height, 175, 1/5^2, .01, .01, 10^3)</span></span>
<span id="cb211-912"><a href="#cb211-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-913"><a href="#cb211-913" aria-hidden="true" tabindex="-1"></a><span class="in"># posterior mu</span></span>
<span id="cb211-914"><a href="#cb211-914" aria-hidden="true" tabindex="-1"></a><span class="in">mean(sample_m$mu); quantile(sample_m$mu, c(.025, .975))</span></span>
<span id="cb211-915"><a href="#cb211-915" aria-hidden="true" tabindex="-1"></a><span class="in">mean(sample_w$mu); quantile(sample_w$mu, c(.025, .975))</span></span>
<span id="cb211-916"><a href="#cb211-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-917"><a href="#cb211-917" aria-hidden="true" tabindex="-1"></a><span class="in"># posterior probability that men are taller than women on average</span></span>
<span id="cb211-918"><a href="#cb211-918" aria-hidden="true" tabindex="-1"></a><span class="in">mean(sample_m$mu &gt; sample_w$mu)</span></span>
<span id="cb211-919"><a href="#cb211-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-920"><a href="#cb211-920" aria-hidden="true" tabindex="-1"></a><span class="in"># posterior probability that a random man is taller than a random woman</span></span>
<span id="cb211-921"><a href="#cb211-921" aria-hidden="true" tabindex="-1"></a><span class="in">tilde_m &lt;- rnorm(10^3, mean(sample_m$mu), sqrt(1/mean(sample_m$tau)))</span></span>
<span id="cb211-922"><a href="#cb211-922" aria-hidden="true" tabindex="-1"></a><span class="in">tilde_w &lt;- rnorm(10^3, mean(sample_w$mu), sqrt(1/mean(sample_w$tau)))</span></span>
<span id="cb211-923"><a href="#cb211-923" aria-hidden="true" tabindex="-1"></a><span class="in">mean(tilde_m &gt; tilde_w)</span></span>
<span id="cb211-924"><a href="#cb211-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-925"><a href="#cb211-925" aria-hidden="true" tabindex="-1"></a><span class="in">tibble(</span></span>
<span id="cb211-926"><a href="#cb211-926" aria-hidden="true" tabindex="-1"></a><span class="in">  iter = rep(1:10^3, 2),</span></span>
<span id="cb211-927"><a href="#cb211-927" aria-hidden="true" tabindex="-1"></a><span class="in">  sex = c(rep("men", 10^3), rep("women", 10^3)),</span></span>
<span id="cb211-928"><a href="#cb211-928" aria-hidden="true" tabindex="-1"></a><span class="in">  mu = c(sample_m$mu, sample_w$mu),</span></span>
<span id="cb211-929"><a href="#cb211-929" aria-hidden="true" tabindex="-1"></a><span class="in">  tau = c(sample_m$tau, sample_w$tau),</span></span>
<span id="cb211-930"><a href="#cb211-930" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;%</span></span>
<span id="cb211-931"><a href="#cb211-931" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(cols = c(mu, tau)) %&gt;% </span></span>
<span id="cb211-932"><a href="#cb211-932" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = value, color = sex)) + </span></span>
<span id="cb211-933"><a href="#cb211-933" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_density() + </span></span>
<span id="cb211-934"><a href="#cb211-934" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(facets = vars(name), scales = "free") +</span></span>
<span id="cb211-935"><a href="#cb211-935" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Posterior Distributions", x = NULL, color = NULL)</span></span>
<span id="cb211-936"><a href="#cb211-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-937"><a href="#cb211-937" aria-hidden="true" tabindex="-1"></a><span class="in">tibble(</span></span>
<span id="cb211-938"><a href="#cb211-938" aria-hidden="true" tabindex="-1"></a><span class="in">  iter = rep(1:10^3, 2),</span></span>
<span id="cb211-939"><a href="#cb211-939" aria-hidden="true" tabindex="-1"></a><span class="in">  sex = c(rep("men", 10^3), rep("women", 10^3)),</span></span>
<span id="cb211-940"><a href="#cb211-940" aria-hidden="true" tabindex="-1"></a><span class="in">  tilde = c(tilde_m, tilde_w)</span></span>
<span id="cb211-941"><a href="#cb211-941" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;%</span></span>
<span id="cb211-942"><a href="#cb211-942" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = tilde, color = sex)) + </span></span>
<span id="cb211-943"><a href="#cb211-943" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_density() + </span></span>
<span id="cb211-944"><a href="#cb211-944" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Posterior Predictive Distributions", x = NULL, color = NULL)</span></span>
<span id="cb211-945"><a href="#cb211-945" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-946"><a href="#cb211-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-947"><a href="#cb211-947" aria-hidden="true" tabindex="-1"></a>It may take some time to converge on a solution. This convergence is called *burn-in* and is often discarded when describing the posterior. *Slow mixing* may occur if there is high autocorrelation in the Gibbs sample, resulting in slow exploration of the sample space of the posterior.</span>
<span id="cb211-948"><a href="#cb211-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-949"><a href="#cb211-949" aria-hidden="true" tabindex="-1"></a><span class="fu">### Regression</span></span>
<span id="cb211-950"><a href="#cb211-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-951"><a href="#cb211-951" aria-hidden="true" tabindex="-1"></a>The linear model in Bayesian statistics is</span>
<span id="cb211-952"><a href="#cb211-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-953"><a href="#cb211-953" aria-hidden="true" tabindex="-1"></a>Likelihood:</span>
<span id="cb211-954"><a href="#cb211-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-955"><a href="#cb211-955" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-956"><a href="#cb211-956" aria-hidden="true" tabindex="-1"></a>y_i | \mu_i, \tau \sim N(\mu_i, \tau)</span>
<span id="cb211-957"><a href="#cb211-957" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-958"><a href="#cb211-958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-959"><a href="#cb211-959" aria-hidden="true" tabindex="-1"></a>where</span>
<span id="cb211-960"><a href="#cb211-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-961"><a href="#cb211-961" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-962"><a href="#cb211-962" aria-hidden="true" tabindex="-1"></a>\mu_i | x_i, \beta_0, \beta_1 = \beta_0 + \beta_1 x</span>
<span id="cb211-963"><a href="#cb211-963" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-964"><a href="#cb211-964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-965"><a href="#cb211-965" aria-hidden="true" tabindex="-1"></a>Priors:</span>
<span id="cb211-966"><a href="#cb211-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-967"><a href="#cb211-967" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-968"><a href="#cb211-968" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-969"><a href="#cb211-969" aria-hidden="true" tabindex="-1"></a>\beta_0 &amp; \sim N(0, 10^{-8}) <span class="sc">\\</span></span>
<span id="cb211-970"><a href="#cb211-970" aria-hidden="true" tabindex="-1"></a>\beta_1 &amp; \sim N(0, 10^{-8}) <span class="sc">\\</span></span>
<span id="cb211-971"><a href="#cb211-971" aria-hidden="true" tabindex="-1"></a>\tau &amp; \sim \text{Gamma}(.01, .01)</span>
<span id="cb211-972"><a href="#cb211-972" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-973"><a href="#cb211-973" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-974"><a href="#cb211-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-975"><a href="#cb211-975" aria-hidden="true" tabindex="-1"></a>Returning to the Howell data, suppose you want to fit a linear model, $\text{Weight}_i = a + b \text{Height} + \epsilon_i$. In Bayesian regression, this is expressed as $\text{Weight} | \mu_i \sim N(\mu_i, \tau)$ where $\mu_i = a + b\text{Height}$. You can construct a Gibbs sampler to estimate the model, but there is already a package for that, MCMCglmm.</span>
<span id="cb211-976"><a href="#cb211-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-977"><a href="#cb211-977" aria-hidden="true" tabindex="-1"></a><span class="in">```{r warning=FALSE, message=FALSE}</span></span>
<span id="cb211-978"><a href="#cb211-978" aria-hidden="true" tabindex="-1"></a><span class="in">library(MCMCglmm)</span></span>
<span id="cb211-979"><a href="#cb211-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-980"><a href="#cb211-980" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345)</span></span>
<span id="cb211-981"><a href="#cb211-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-982"><a href="#cb211-982" aria-hidden="true" tabindex="-1"></a><span class="in">mdl_1 &lt;- MCMCglmm(</span></span>
<span id="cb211-983"><a href="#cb211-983" aria-hidden="true" tabindex="-1"></a><span class="in">  weight ~ height, </span></span>
<span id="cb211-984"><a href="#cb211-984" aria-hidden="true" tabindex="-1"></a><span class="in">  data = howell,</span></span>
<span id="cb211-985"><a href="#cb211-985" aria-hidden="true" tabindex="-1"></a><span class="in">  family = "gaussian",</span></span>
<span id="cb211-986"><a href="#cb211-986" aria-hidden="true" tabindex="-1"></a><span class="in">  nitt = 11000, # iterations</span></span>
<span id="cb211-987"><a href="#cb211-987" aria-hidden="true" tabindex="-1"></a><span class="in">  burnin = 1000, # burn-in period to throw out</span></span>
<span id="cb211-988"><a href="#cb211-988" aria-hidden="true" tabindex="-1"></a><span class="in">  thin = 10, </span></span>
<span id="cb211-989"><a href="#cb211-989" aria-hidden="true" tabindex="-1"></a><span class="in">  # could omit this prior since it is non-informative</span></span>
<span id="cb211-990"><a href="#cb211-990" aria-hidden="true" tabindex="-1"></a><span class="in">  prior = list(B = list(mu = c(0, 0), V = c(100^2, 100^2)*diag(2))),</span></span>
<span id="cb211-991"><a href="#cb211-991" aria-hidden="true" tabindex="-1"></a><span class="in">  verbose = FALSE</span></span>
<span id="cb211-992"><a href="#cb211-992" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb211-993"><a href="#cb211-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-994"><a href="#cb211-994" aria-hidden="true" tabindex="-1"></a><span class="in">summary(mdl_1)</span></span>
<span id="cb211-995"><a href="#cb211-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-996"><a href="#cb211-996" aria-hidden="true" tabindex="-1"></a><span class="in"># Probability beta is &gt;0</span></span>
<span id="cb211-997"><a href="#cb211-997" aria-hidden="true" tabindex="-1"></a><span class="in">mean(mdl_1$Sol[, 2] &gt; 0)</span></span>
<span id="cb211-998"><a href="#cb211-998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-999"><a href="#cb211-999" aria-hidden="true" tabindex="-1"></a><span class="in"># Posterior inference.</span></span>
<span id="cb211-1000"><a href="#cb211-1000" aria-hidden="true" tabindex="-1"></a><span class="in">new_data &lt;- tibble(height = seq(130, 185, .1), weight = 0)</span></span>
<span id="cb211-1001"><a href="#cb211-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1002"><a href="#cb211-1002" aria-hidden="true" tabindex="-1"></a><span class="in">cred_intvl &lt;- predict(mdl_1, newdata = , type = "response", interval = "confidence")</span></span>
<span id="cb211-1003"><a href="#cb211-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1004"><a href="#cb211-1004" aria-hidden="true" tabindex="-1"></a><span class="in">pred_intvl &lt;- predict(mdl_1, newdata = , type = "response", interval = "prediction")</span></span>
<span id="cb211-1005"><a href="#cb211-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1006"><a href="#cb211-1006" aria-hidden="true" tabindex="-1"></a><span class="in">howell %&gt;% </span></span>
<span id="cb211-1007"><a href="#cb211-1007" aria-hidden="true" tabindex="-1"></a><span class="in">  bind_cols(cred_intvl, pred_intvl, .name_repair = "unique") %&gt;% </span></span>
<span id="cb211-1008"><a href="#cb211-1008" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = height)) +</span></span>
<span id="cb211-1009"><a href="#cb211-1009" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = `lwr...9`, ymax = `upr...10`), fill = "lightgoldenrod", alpha = .5) +</span></span>
<span id="cb211-1010"><a href="#cb211-1010" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = `lwr...6`, ymax = `upr...7`), fill = "goldenrod", alpha = .5) +</span></span>
<span id="cb211-1011"><a href="#cb211-1011" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(aes(y = `fit...5`), color = "goldenrod", linewidth = 1) +</span></span>
<span id="cb211-1012"><a href="#cb211-1012" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(aes(y = weight)) +</span></span>
<span id="cb211-1013"><a href="#cb211-1013" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(y = "weight", title = "95% CI and PI.")</span></span>
<span id="cb211-1014"><a href="#cb211-1014" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1015"><a href="#cb211-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1016"><a href="#cb211-1016" aria-hidden="true" tabindex="-1"></a>You can extend this to multivariate models.</span>
<span id="cb211-1017"><a href="#cb211-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1018"><a href="#cb211-1018" aria-hidden="true" tabindex="-1"></a><span class="in">```{r warning=FALSE}</span></span>
<span id="cb211-1019"><a href="#cb211-1019" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345)</span></span>
<span id="cb211-1020"><a href="#cb211-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1021"><a href="#cb211-1021" aria-hidden="true" tabindex="-1"></a><span class="in">mdl_2 &lt;- MCMCglmm(</span></span>
<span id="cb211-1022"><a href="#cb211-1022" aria-hidden="true" tabindex="-1"></a><span class="in">  weight ~ height*male, </span></span>
<span id="cb211-1023"><a href="#cb211-1023" aria-hidden="true" tabindex="-1"></a><span class="in">  data = howell,</span></span>
<span id="cb211-1024"><a href="#cb211-1024" aria-hidden="true" tabindex="-1"></a><span class="in">  family = "gaussian",</span></span>
<span id="cb211-1025"><a href="#cb211-1025" aria-hidden="true" tabindex="-1"></a><span class="in">  nitt = 11000, # iterations</span></span>
<span id="cb211-1026"><a href="#cb211-1026" aria-hidden="true" tabindex="-1"></a><span class="in">  burnin = 1000, # burn-in period to throw out</span></span>
<span id="cb211-1027"><a href="#cb211-1027" aria-hidden="true" tabindex="-1"></a><span class="in">  thin = 10, </span></span>
<span id="cb211-1028"><a href="#cb211-1028" aria-hidden="true" tabindex="-1"></a><span class="in">  #prior = list(B = list(mu = c(0, 0), V = c(100^2, 100^2)*diag(2))), </span></span>
<span id="cb211-1029"><a href="#cb211-1029" aria-hidden="true" tabindex="-1"></a><span class="in">  verbose = FALSE</span></span>
<span id="cb211-1030"><a href="#cb211-1030" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb211-1031"><a href="#cb211-1031" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1032"><a href="#cb211-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1033"><a href="#cb211-1033" aria-hidden="true" tabindex="-1"></a>Bayesian statistics has its analog to Akaike's Information Criterion (AIC) called Deviance Information Criterion (DIC).</span>
<span id="cb211-1034"><a href="#cb211-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1035"><a href="#cb211-1035" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1036"><a href="#cb211-1036" aria-hidden="true" tabindex="-1"></a>DIC = p_D + \overline{D(\theta)}</span>
<span id="cb211-1037"><a href="#cb211-1037" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1038"><a href="#cb211-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1039"><a href="#cb211-1039" aria-hidden="true" tabindex="-1"></a>where $p_D = \overline{D(\theta)} - D(\hat{\theta})$ and $D(\theta) = -2 \log (f(y|\theta)) + C$. The value of DIC has no real meaning, but for comparison purposes, lower is better. A difference of at least 3 is considered sufficient evidence to choose one model over another. Here, <span class="in">`mdl_1$DIC`</span> = <span class="in">`r mdl_1$DIC`</span> and <span class="in">`mdl_2$DIC`</span> = <span class="in">`r mdl_2$DIC`</span>. The first model is better, so conclude that there is no statistical evidence that the correlation between weight and height depends on sex ($\Delta$DIC = <span class="in">`r mdl_2$DIC - mdl_1$DIC`</span>).</span>
<span id="cb211-1040"><a href="#cb211-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1043"><a href="#cb211-1043" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-1044"><a href="#cb211-1044" aria-hidden="true" tabindex="-1"></a>mdl_3 <span class="ot">&lt;-</span> <span class="fu">MCMCglmm</span>(</span>
<span id="cb211-1045"><a href="#cb211-1045" aria-hidden="true" tabindex="-1"></a>  weight <span class="sc">~</span> age, </span>
<span id="cb211-1046"><a href="#cb211-1046" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> howell,</span>
<span id="cb211-1047"><a href="#cb211-1047" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb211-1048"><a href="#cb211-1048" aria-hidden="true" tabindex="-1"></a>  <span class="at">nitt =</span> <span class="dv">11000</span>, <span class="co"># iterations</span></span>
<span id="cb211-1049"><a href="#cb211-1049" aria-hidden="true" tabindex="-1"></a>  <span class="at">burnin =</span> <span class="dv">1000</span>, <span class="co"># burn-in period to throw out</span></span>
<span id="cb211-1050"><a href="#cb211-1050" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span>, </span>
<span id="cb211-1051"><a href="#cb211-1051" aria-hidden="true" tabindex="-1"></a>  <span class="co">#prior = list(B = list(mu = c(0, 0), V = c(100^2, 100^2)*diag(2))), </span></span>
<span id="cb211-1052"><a href="#cb211-1052" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb211-1053"><a href="#cb211-1053" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb211-1054"><a href="#cb211-1054" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mdl_3)</span>
<span id="cb211-1055"><a href="#cb211-1055" aria-hidden="true" tabindex="-1"></a>mdl_1<span class="sc">$</span>DIC</span>
<span id="cb211-1056"><a href="#cb211-1056" aria-hidden="true" tabindex="-1"></a>mdl_3<span class="sc">$</span>DIC</span>
<span id="cb211-1057"><a href="#cb211-1057" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1058"><a href="#cb211-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1059"><a href="#cb211-1059" aria-hidden="true" tabindex="-1"></a><span class="fu">### Generalized Linear Models</span></span>
<span id="cb211-1060"><a href="#cb211-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1061"><a href="#cb211-1061" aria-hidden="true" tabindex="-1"></a>The generalized linear model in Bayesian statistics is</span>
<span id="cb211-1062"><a href="#cb211-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1063"><a href="#cb211-1063" aria-hidden="true" tabindex="-1"></a>Likelihood:</span>
<span id="cb211-1064"><a href="#cb211-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1065"><a href="#cb211-1065" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1066"><a href="#cb211-1066" aria-hidden="true" tabindex="-1"></a>y_i | \mu_i, \tau \sim D(\mu_i)</span>
<span id="cb211-1067"><a href="#cb211-1067" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1068"><a href="#cb211-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1069"><a href="#cb211-1069" aria-hidden="true" tabindex="-1"></a>where</span>
<span id="cb211-1070"><a href="#cb211-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1071"><a href="#cb211-1071" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1072"><a href="#cb211-1072" aria-hidden="true" tabindex="-1"></a>g(\mu_i | x_i, \beta_0, \beta_1) = \beta_0 + \beta_1 x</span>
<span id="cb211-1073"><a href="#cb211-1073" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1074"><a href="#cb211-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1075"><a href="#cb211-1075" aria-hidden="true" tabindex="-1"></a>Priors:</span>
<span id="cb211-1076"><a href="#cb211-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1077"><a href="#cb211-1077" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1078"><a href="#cb211-1078" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-1079"><a href="#cb211-1079" aria-hidden="true" tabindex="-1"></a>\beta_0 &amp; \sim N(0, 10^{-8}) <span class="sc">\\</span></span>
<span id="cb211-1080"><a href="#cb211-1080" aria-hidden="true" tabindex="-1"></a>\beta_1 &amp; \sim N(0, 10^{-8}) <span class="sc">\\</span></span>
<span id="cb211-1081"><a href="#cb211-1081" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-1082"><a href="#cb211-1082" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1083"><a href="#cb211-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1084"><a href="#cb211-1084" aria-hidden="true" tabindex="-1"></a>Consider a binary response $y_i$. You would typically model this with logistic regression:</span>
<span id="cb211-1085"><a href="#cb211-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1086"><a href="#cb211-1086" aria-hidden="true" tabindex="-1"></a>$y_i | p_i \sim \text{BIN}(1, p_i)$ where $\log \left( \frac{p_i}{1 - p_i} \right) = \beta_0 + \beta_1 x_i$. In bivariate statistics, if $x_i$ perfectly predicts $y_i$, *separation of variables* has occurred. Here's an example of separation of variables. In the regression, the standard errors are huge, so the p.value is nearly 1. The classical regression framework has broken down.</span>
<span id="cb211-1087"><a href="#cb211-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1088"><a href="#cb211-1088" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-1089"><a href="#cb211-1089" aria-hidden="true" tabindex="-1"></a><span class="in">study &lt;- read_csv("input/hours_of_study_data.csv", col_types = "dc") %&gt;%</span></span>
<span id="cb211-1090"><a href="#cb211-1090" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(y = factor(y)) %&gt;%</span></span>
<span id="cb211-1091"><a href="#cb211-1091" aria-hidden="true" tabindex="-1"></a><span class="in">  as.data.frame()</span></span>
<span id="cb211-1092"><a href="#cb211-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1093"><a href="#cb211-1093" aria-hidden="true" tabindex="-1"></a><span class="in">study %&gt;% ggplot(aes(x = HoursOfStudy, y = y)) + geom_point()</span></span>
<span id="cb211-1094"><a href="#cb211-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1095"><a href="#cb211-1095" aria-hidden="true" tabindex="-1"></a><span class="in">summary(</span></span>
<span id="cb211-1096"><a href="#cb211-1096" aria-hidden="true" tabindex="-1"></a><span class="in">  glm(y ~ HoursOfStudy, data = study, family = "binomial")</span></span>
<span id="cb211-1097"><a href="#cb211-1097" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb211-1098"><a href="#cb211-1098" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1099"><a href="#cb211-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1100"><a href="#cb211-1100" aria-hidden="true" tabindex="-1"></a>The Bayesian framework performs better.</span>
<span id="cb211-1101"><a href="#cb211-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1104"><a href="#cb211-1104" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-1105"><a href="#cb211-1105" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb211-1106"><a href="#cb211-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1107"><a href="#cb211-1107" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(</span>
<span id="cb211-1108"><a href="#cb211-1108" aria-hidden="true" tabindex="-1"></a> m.bayes <span class="ot">&lt;-</span> <span class="fu">MCMCglmm</span>(y <span class="sc">~</span> HoursOfStudy, <span class="at">data =</span> study, <span class="at">family =</span> <span class="st">"categorical"</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb211-1109"><a href="#cb211-1109" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb211-1110"><a href="#cb211-1110" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1111"><a href="#cb211-1111" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb211-1112"><a href="#cb211-1112" aria-hidden="true" tabindex="-1"></a> Each hour of study is associated with an $\exp (1.9036) \sim 6.7$-fold increase in the odds of passing. The posterior probability that the association is positive is </span>
<span id="cb211-1113"><a href="#cb211-1113" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb211-1116"><a href="#cb211-1116" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-1117"><a href="#cb211-1117" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(m.bayes<span class="sc">$</span>Sol[, <span class="dv">2</span>] <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb211-1118"><a href="#cb211-1118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1119"><a href="#cb211-1119" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb211-1120"><a href="#cb211-1120" aria-hidden="true" tabindex="-1"></a>Let's try another example. </span>
<span id="cb211-1121"><a href="#cb211-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1122"><a href="#cb211-1122" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-1123"><a href="#cb211-1123" aria-hidden="true" tabindex="-1"></a><span class="in">chase &lt;- read_csv("input/TheChase.txt", show_col_types = FALSE)</span></span>
<span id="cb211-1124"><a href="#cb211-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1125"><a href="#cb211-1125" aria-hidden="true" tabindex="-1"></a><span class="in"># focus on Mark</span></span>
<span id="cb211-1126"><a href="#cb211-1126" aria-hidden="true" tabindex="-1"></a><span class="in">mark &lt;- chase %&gt;% filter(Chaser == "Mark")</span></span>
<span id="cb211-1127"><a href="#cb211-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1128"><a href="#cb211-1128" aria-hidden="true" tabindex="-1"></a><span class="in">mark %&gt;% ggplot(aes(x = TeamScore, y = Win)) + geom_jitter(width = 0)</span></span>
<span id="cb211-1129"><a href="#cb211-1129" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1130"><a href="#cb211-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1131"><a href="#cb211-1131" aria-hidden="true" tabindex="-1"></a>Notice: most scores are between 10 and 25, winning is less common than losing, and winning is more common with higher scores. Fit the following model: $y_i \sim \text{Bin}(1, p_i)$ where $\text{logit}(p_i) = \beta_0 + \beta_1 x_i$ and $x_i$ is the mean score of game $i$. Assume non-informative normal priors: $\beta_0 \sim N(0, 10^{-8})$ and $\beta_1 \sim N(0, 10^{-8})$.</span>
<span id="cb211-1132"><a href="#cb211-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1133"><a href="#cb211-1133" aria-hidden="true" tabindex="-1"></a><span class="in">```{r message=FALSE}</span></span>
<span id="cb211-1134"><a href="#cb211-1134" aria-hidden="true" tabindex="-1"></a><span class="in">library(rstanarm)</span></span>
<span id="cb211-1135"><a href="#cb211-1135" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1136"><a href="#cb211-1136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1139"><a href="#cb211-1139" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-1140"><a href="#cb211-1140" aria-hidden="true" tabindex="-1"></a><span class="co"># This will take ~1 min</span></span>
<span id="cb211-1141"><a href="#cb211-1141" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">stan_glm</span>(Win <span class="sc">~</span> TeamScore, <span class="at">data =</span> mark, </span>
<span id="cb211-1142"><a href="#cb211-1142" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>), </span>
<span id="cb211-1143"><a href="#cb211-1143" aria-hidden="true" tabindex="-1"></a>                 <span class="at">prior =</span> <span class="fu">normal</span>(<span class="at">location=</span><span class="dv">0</span>, <span class="at">scale=</span><span class="dv">10</span><span class="sc">^</span><span class="dv">4</span>),</span>
<span id="cb211-1144"><a href="#cb211-1144" aria-hidden="true" tabindex="-1"></a>                 <span class="at">prior_intercept =</span> <span class="fu">normal</span>(<span class="at">location=</span><span class="dv">0</span>, <span class="at">scale=</span><span class="dv">10</span><span class="sc">^</span><span class="dv">4</span>),</span>
<span id="cb211-1145"><a href="#cb211-1145" aria-hidden="true" tabindex="-1"></a>                 <span class="at">chains=</span><span class="dv">1</span>, <span class="at">iter=</span> <span class="dv">1500</span>,</span>
<span id="cb211-1146"><a href="#cb211-1146" aria-hidden="true" tabindex="-1"></a>                 <span class="at">seed =</span> <span class="dv">12345</span>, <span class="at">refresh=</span><span class="dv">0</span>)</span>
<span id="cb211-1147"><a href="#cb211-1147" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1148"><a href="#cb211-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1151"><a href="#cb211-1151" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-1152"><a href="#cb211-1152" aria-hidden="true" tabindex="-1"></a>m1post <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(m1)</span>
<span id="cb211-1153"><a href="#cb211-1153" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb211-1154"><a href="#cb211-1154" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m1post[,<span class="dv">1</span>],<span class="at">ty=</span><span class="st">'l'</span>,<span class="at">ylab=</span><span class="fu">expression</span>(beta[<span class="dv">0</span>]))</span>
<span id="cb211-1155"><a href="#cb211-1155" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(m1post[,<span class="dv">1</span>]),<span class="at">xlab=</span><span class="fu">expression</span>(beta[<span class="dv">0</span>]),<span class="at">main=</span><span class="st">''</span>)</span>
<span id="cb211-1156"><a href="#cb211-1156" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m1post[,<span class="dv">2</span>],<span class="at">ty=</span><span class="st">'l'</span>,<span class="at">ylab=</span><span class="fu">expression</span>(beta[<span class="dv">1</span>]))</span>
<span id="cb211-1157"><a href="#cb211-1157" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(m1post[,<span class="dv">2</span>]),<span class="at">xlab=</span><span class="fu">expression</span>(beta[<span class="dv">1</span>]),<span class="at">main=</span><span class="st">''</span>)</span>
<span id="cb211-1158"><a href="#cb211-1158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1159"><a href="#cb211-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1160"><a href="#cb211-1160" aria-hidden="true" tabindex="-1"></a>The traces look converged, and the estimated posterior densities look smooth.</span>
<span id="cb211-1161"><a href="#cb211-1161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1164"><a href="#cb211-1164" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-1165"><a href="#cb211-1165" aria-hidden="true" tabindex="-1"></a>df.summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb211-1166"><a href="#cb211-1166" aria-hidden="true" tabindex="-1"></a><span class="at">p.means =</span> <span class="fu">round</span>(<span class="fu">apply</span>(m1post,<span class="dv">2</span>,mean),<span class="dv">4</span>),</span>
<span id="cb211-1167"><a href="#cb211-1167" aria-hidden="true" tabindex="-1"></a><span class="at">p.ci.lo =</span> <span class="fu">round</span>(<span class="fu">apply</span>(m1post,<span class="dv">2</span>,quantile,.<span class="dv">025</span>),<span class="dv">4</span>),</span>
<span id="cb211-1168"><a href="#cb211-1168" aria-hidden="true" tabindex="-1"></a><span class="at">p.ci.hi =</span> <span class="fu">round</span>(<span class="fu">apply</span>(m1post,<span class="dv">2</span>,quantile,.<span class="dv">975</span>),<span class="dv">4</span>))</span>
<span id="cb211-1169"><a href="#cb211-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1170"><a href="#cb211-1170" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(df.summary)</span>
<span id="cb211-1171"><a href="#cb211-1171" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1172"><a href="#cb211-1172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1173"><a href="#cb211-1173" aria-hidden="true" tabindex="-1"></a>There is a positive correlation between the Team Score and the odds of winning. Calculate the posterior probability.</span>
<span id="cb211-1174"><a href="#cb211-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1177"><a href="#cb211-1177" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-1178"><a href="#cb211-1178" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(m1post[, <span class="dv">2</span>] <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb211-1179"><a href="#cb211-1179" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1180"><a href="#cb211-1180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1181"><a href="#cb211-1181" aria-hidden="true" tabindex="-1"></a>Compare this to the classical result. They are pretty close.</span>
<span id="cb211-1182"><a href="#cb211-1182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1185"><a href="#cb211-1185" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-1186"><a href="#cb211-1186" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(</span>
<span id="cb211-1187"><a href="#cb211-1187" aria-hidden="true" tabindex="-1"></a>  m1c <span class="ot">&lt;-</span> <span class="fu">glm</span>(Win <span class="sc">~</span> TeamScore, <span class="at">data =</span> mark, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb211-1188"><a href="#cb211-1188" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb211-1189"><a href="#cb211-1189" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1190"><a href="#cb211-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1191"><a href="#cb211-1191" aria-hidden="true" tabindex="-1"></a>Let's also plot the estimated model on a grid of possible Team Score values. Recall $p = \frac{1}{1 + e^{-z}}$,</span>
<span id="cb211-1192"><a href="#cb211-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1195"><a href="#cb211-1195" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-1196"><a href="#cb211-1196" aria-hidden="true" tabindex="-1"></a><span class="co"># setting a grid of values</span></span>
<span id="cb211-1197"><a href="#cb211-1197" aria-hidden="true" tabindex="-1"></a>TeamScoreGrid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">30</span>)</span>
<span id="cb211-1198"><a href="#cb211-1198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1199"><a href="#cb211-1199" aria-hidden="true" tabindex="-1"></a><span class="co"># using posterior samples of beta0 and beta1</span></span>
<span id="cb211-1200"><a href="#cb211-1200" aria-hidden="true" tabindex="-1"></a><span class="co"># to produce a posterior sample of probabilities at each value of TeamScoreGrid</span></span>
<span id="cb211-1201"><a href="#cb211-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1202"><a href="#cb211-1202" aria-hidden="true" tabindex="-1"></a>p.eval <span class="ot">&lt;-</span> <span class="cf">function</span>(Score,b0,b1){<span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>(b0<span class="sc">+</span>b1<span class="sc">*</span>Score)))}</span>
<span id="cb211-1203"><a href="#cb211-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1204"><a href="#cb211-1204" aria-hidden="true" tabindex="-1"></a>p.sample <span class="ot">&lt;-</span> <span class="fu">sapply</span>(TeamScoreGrid,p.eval,<span class="at">b0=</span>m1post[,<span class="dv">1</span>],<span class="at">b1=</span>m1post[,<span class="dv">2</span>])</span>
<span id="cb211-1205"><a href="#cb211-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1206"><a href="#cb211-1206" aria-hidden="true" tabindex="-1"></a><span class="co"># evaluating posterior mean probability for each score:</span></span>
<span id="cb211-1207"><a href="#cb211-1207" aria-hidden="true" tabindex="-1"></a>p.post.mean <span class="ot">&lt;-</span> <span class="fu">apply</span>(p.sample,<span class="dv">2</span>,mean)</span>
<span id="cb211-1208"><a href="#cb211-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1209"><a href="#cb211-1209" aria-hidden="true" tabindex="-1"></a><span class="co"># evaluating 95% CI for the probability for each score:</span></span>
<span id="cb211-1210"><a href="#cb211-1210" aria-hidden="true" tabindex="-1"></a>p.post.lo <span class="ot">&lt;-</span> <span class="fu">apply</span>(p.sample,<span class="dv">2</span>,quantile,.<span class="dv">025</span>)</span>
<span id="cb211-1211"><a href="#cb211-1211" aria-hidden="true" tabindex="-1"></a>p.post.hi <span class="ot">&lt;-</span> <span class="fu">apply</span>(p.sample,<span class="dv">2</span>,quantile,.<span class="dv">975</span>)</span>
<span id="cb211-1212"><a href="#cb211-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1213"><a href="#cb211-1213" aria-hidden="true" tabindex="-1"></a>data.post <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">TeamScore=</span>TeamScoreGrid, <span class="at">p.mn=</span>p.post.mean,</span>
<span id="cb211-1214"><a href="#cb211-1214" aria-hidden="true" tabindex="-1"></a>                        <span class="at">p.lo=</span>p.post.lo, <span class="at">p.hi=</span>p.post.hi)</span>
<span id="cb211-1215"><a href="#cb211-1215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1216"><a href="#cb211-1216" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>mark,<span class="fu">aes</span>(<span class="at">x=</span>TeamScore,<span class="at">y=</span><span class="fu">jitter</span>(Win)))<span class="sc">+</span></span>
<span id="cb211-1217"><a href="#cb211-1217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb211-1218"><a href="#cb211-1218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data=</span>data.post,<span class="fu">aes</span>(<span class="at">x=</span>TeamScore,<span class="at">y=</span>p.mn,<span class="at">ymin=</span>p.lo,<span class="at">ymax=</span>p.hi),<span class="at">alpha=</span>.<span class="dv">5</span>,<span class="at">fill=</span><span class="st">'salmon'</span>) <span class="sc">+</span></span>
<span id="cb211-1219"><a href="#cb211-1219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span>data.post,<span class="fu">aes</span>(<span class="at">x=</span>TeamScore,<span class="at">y=</span>p.mn),<span class="at">col=</span><span class="st">'red'</span>, <span class="at">linewidth=</span><span class="fl">1.5</span>)<span class="sc">+</span></span>
<span id="cb211-1220"><a href="#cb211-1220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">'Outcome'</span>)<span class="sc">+</span></span>
<span id="cb211-1221"><a href="#cb211-1221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">name=</span><span class="st">''</span>, <span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">labels=</span><span class="fu">c</span>(<span class="st">'Lose'</span>,<span class="st">'Win'</span>),</span>
<span id="cb211-1222"><a href="#cb211-1222" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sec.axis=</span><span class="fu">sec_axis</span>(<span class="sc">~</span>., <span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,.<span class="dv">2</span>),</span>
<span id="cb211-1223"><a href="#cb211-1223" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">name=</span><span class="st">'Probability of Winning'</span>))<span class="sc">+</span></span>
<span id="cb211-1224"><a href="#cb211-1224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">30</span>))</span>
<span id="cb211-1225"><a href="#cb211-1225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1226"><a href="#cb211-1226" aria-hidden="true" tabindex="-1"></a>data.post<span class="sc">$</span>TeamScore[<span class="fu">which</span>(data.post<span class="sc">$</span>ppp <span class="sc">&gt;=</span> .<span class="dv">80</span>)][<span class="dv">1</span>]</span>
<span id="cb211-1227"><a href="#cb211-1227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1228"><a href="#cb211-1228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1229"><a href="#cb211-1229" aria-hidden="true" tabindex="-1"></a>What is the posterior probability that a team score of 25 beats Mark?</span>
<span id="cb211-1230"><a href="#cb211-1230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1233"><a href="#cb211-1233" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-1234"><a href="#cb211-1234" aria-hidden="true" tabindex="-1"></a><span class="fu">p.eval</span>(<span class="at">Score =</span> <span class="dv">25</span>, <span class="at">b0 =</span> m1post[,<span class="dv">1</span>], <span class="at">b1 =</span> m1post[,<span class="dv">2</span>]) <span class="sc">%&gt;%</span> <span class="fu">mean</span>()</span>
<span id="cb211-1235"><a href="#cb211-1235" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1236"><a href="#cb211-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1237"><a href="#cb211-1237" aria-hidden="true" tabindex="-1"></a>What score do you need in order to win with 80% certainty, $P(y = 1|x) \ge .8)$. For each $x$ on a grid, take the posterior sample for $p$ and generate $y = \text{Bern}(p)$. Then get $prob(y == 1)$.</span>
<span id="cb211-1238"><a href="#cb211-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1241"><a href="#cb211-1241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-1242"><a href="#cb211-1242" aria-hidden="true" tabindex="-1"></a><span class="co"># simulating the game outcomes (y)</span></span>
<span id="cb211-1243"><a href="#cb211-1243" aria-hidden="true" tabindex="-1"></a>y.sample <span class="ot">&lt;-</span> (<span class="fu">array</span>(<span class="fu">runif</span>(<span class="fu">prod</span>(<span class="fu">dim</span>(p.sample))),<span class="at">dim=</span><span class="fu">dim</span>(p.sample)) <span class="sc">&lt;</span> p.sample)<span class="sc">*</span><span class="dv">1</span></span>
<span id="cb211-1244"><a href="#cb211-1244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1245"><a href="#cb211-1245" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior predictive probabilities that y=1</span></span>
<span id="cb211-1246"><a href="#cb211-1246" aria-hidden="true" tabindex="-1"></a>data.post<span class="sc">$</span>ppp <span class="ot">&lt;-</span> <span class="fu">apply</span>(y.sample,<span class="dv">2</span>,mean)</span>
<span id="cb211-1247"><a href="#cb211-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1248"><a href="#cb211-1248" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>data.post,<span class="fu">aes</span>(<span class="at">x=</span>TeamScore,<span class="at">y=</span>ppp))<span class="sc">+</span></span>
<span id="cb211-1249"><a href="#cb211-1249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">col=</span><span class="st">'red'</span>,<span class="at">size=</span><span class="fl">1.5</span>)<span class="sc">+</span></span>
<span id="cb211-1250"><a href="#cb211-1250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept=</span><span class="fl">0.80</span>),<span class="at">col=</span><span class="st">'blue'</span>,<span class="at">size=</span><span class="fl">1.2</span>,<span class="at">lty=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb211-1251"><a href="#cb211-1251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="dv">24</span>),<span class="at">col=</span><span class="st">'brown'</span>,<span class="at">size=</span><span class="fl">1.1</span>,<span class="at">lty=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb211-1252"><a href="#cb211-1252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="dv">25</span>),<span class="at">col=</span><span class="st">'brown'</span>,<span class="at">size=</span><span class="fl">1.1</span>,<span class="at">lty=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb211-1253"><a href="#cb211-1253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">'Post. Pred. Prob. of Winning'</span>)<span class="sc">+</span></span>
<span id="cb211-1254"><a href="#cb211-1254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">30</span>))<span class="sc">+</span><span class="fu">theme_gray</span>(<span class="at">base_size=</span><span class="dv">18</span>)</span>
<span id="cb211-1255"><a href="#cb211-1255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1256"><a href="#cb211-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1257"><a href="#cb211-1257" aria-hidden="true" tabindex="-1"></a><span class="fu">### Missing Data</span></span>
<span id="cb211-1258"><a href="#cb211-1258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1259"><a href="#cb211-1259" aria-hidden="true" tabindex="-1"></a>Consider a situation where 20 customers are surveyed to measure satisfaction. You can model this as $x_i | p \sim \text{Bin}(1, p)$ where $p$ is the probability of satisfaction. The conjugate prior for $p$ is $p \sim \text{Beta}(a, b)$. However, some observations are missing. You can divide the respondents into $x_{obs}$ and $x_{miss}$. Then </span>
<span id="cb211-1260"><a href="#cb211-1260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1261"><a href="#cb211-1261" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1262"><a href="#cb211-1262" aria-hidden="true" tabindex="-1"></a>f(x|p) = \prod_i f(x_i|p) = f(x_{obs}|p) f(x_{miss}|p)</span>
<span id="cb211-1263"><a href="#cb211-1263" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1264"><a href="#cb211-1264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1265"><a href="#cb211-1265" aria-hidden="true" tabindex="-1"></a>When missingness is random, you can smiply discard missing observations. So if there were 4 missing responses, and 10 of the 16 completed surveys were satisfied, $p|x_{obs} \sim \text{Beta}(1 + 10, 1 + 6)$. The Beta-bimomial conjugate model is</span>
<span id="cb211-1266"><a href="#cb211-1266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1267"><a href="#cb211-1267" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1268"><a href="#cb211-1268" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-1269"><a href="#cb211-1269" aria-hidden="true" tabindex="-1"></a>x_i &amp; \sim \text{Bin}(1, p) <span class="sc">\\</span></span>
<span id="cb211-1270"><a href="#cb211-1270" aria-hidden="true" tabindex="-1"></a>p &amp; \sim \text{Beta}(a, b)</span>
<span id="cb211-1271"><a href="#cb211-1271" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-1272"><a href="#cb211-1272" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1273"><a href="#cb211-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1274"><a href="#cb211-1274" aria-hidden="true" tabindex="-1"></a>with posterior $p | x \sim \text{Beta} \left( a + \sum_i x_i, b + \sum_i (1 - x_i) \right)$</span>
<span id="cb211-1275"><a href="#cb211-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1276"><a href="#cb211-1276" aria-hidden="true" tabindex="-1"></a>But if the data are not missing at random, you need to model the probability of participating. From past experience you might infer that participation rates are 30% for satisfied and 90% for dissatisfied.</span>
<span id="cb211-1277"><a href="#cb211-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1278"><a href="#cb211-1278" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1279"><a href="#cb211-1279" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-1280"><a href="#cb211-1280" aria-hidden="true" tabindex="-1"></a>P(z_i = 1 | x_i = 1) &amp;= .3 <span class="sc">\\</span></span>
<span id="cb211-1281"><a href="#cb211-1281" aria-hidden="true" tabindex="-1"></a>P(z_i = 1 | x_i = 0) &amp;= .9</span>
<span id="cb211-1282"><a href="#cb211-1282" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-1283"><a href="#cb211-1283" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1284"><a href="#cb211-1284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1285"><a href="#cb211-1285" aria-hidden="true" tabindex="-1"></a>Combining them, you have $P(x_i = 1 | z_i = 0, p) = \frac{7p}{6p + 1}$. Set up a Gibbs sampler. Step 0: assign random prior values to the missing $x$. Step 1: given $x$, sample $p$ from $\text{Beta}(a + \sum_i x_i, b + \sum_i (1 - x_i))$. Step 2: given $p$, assign the missing $x$ to 1 with probability $p|x_{obs} \sim \text{Beta}(1 + 10, 1 + 6)$.</span>
<span id="cb211-1286"><a href="#cb211-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1289"><a href="#cb211-1289" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-1290"><a href="#cb211-1290" aria-hidden="true" tabindex="-1"></a><span class="co"># prior parameters</span></span>
<span id="cb211-1291"><a href="#cb211-1291" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">1</span>; b <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb211-1292"><a href="#cb211-1292" aria-hidden="true" tabindex="-1"></a><span class="co"># data</span></span>
<span id="cb211-1293"><a href="#cb211-1293" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="cn">NA</span>),<span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">6</span>,<span class="dv">4</span>))</span>
<span id="cb211-1294"><a href="#cb211-1294" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">0</span>,<span class="fu">c</span>(<span class="dv">16</span>,<span class="dv">4</span>))</span>
<span id="cb211-1295"><a href="#cb211-1295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1296"><a href="#cb211-1296" aria-hidden="true" tabindex="-1"></a><span class="co"># initial values.</span></span>
<span id="cb211-1297"><a href="#cb211-1297" aria-hidden="true" tabindex="-1"></a>x.sample <span class="ot">&lt;-</span> x; x.sample[<span class="fu">is.na</span>(x)] <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">size=</span><span class="dv">4</span>,<span class="at">replace=</span>T)</span>
<span id="cb211-1298"><a href="#cb211-1298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1299"><a href="#cb211-1299" aria-hidden="true" tabindex="-1"></a><span class="co"># number of iterations</span></span>
<span id="cb211-1300"><a href="#cb211-1300" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">4</span><span class="sc">+</span><span class="dv">500</span></span>
<span id="cb211-1301"><a href="#cb211-1301" aria-hidden="true" tabindex="-1"></a><span class="co"># and the monitor for recording the iterations of p</span></span>
<span id="cb211-1302"><a href="#cb211-1302" aria-hidden="true" tabindex="-1"></a>mon.p <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb211-1303"><a href="#cb211-1303" aria-hidden="true" tabindex="-1"></a><span class="co"># ... and one of the missing observations</span></span>
<span id="cb211-1304"><a href="#cb211-1304" aria-hidden="true" tabindex="-1"></a>mon.x20 <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb211-1305"><a href="#cb211-1305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1306"><a href="#cb211-1306" aria-hidden="true" tabindex="-1"></a><span class="co"># Gibbs sampler:</span></span>
<span id="cb211-1307"><a href="#cb211-1307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1308"><a href="#cb211-1308" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>ITER){</span>
<span id="cb211-1309"><a href="#cb211-1309" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sampling p</span></span>
<span id="cb211-1310"><a href="#cb211-1310" aria-hidden="true" tabindex="-1"></a>  mon.p[iter] <span class="ot">&lt;-</span> p <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(<span class="dv">1</span>,a<span class="sc">+</span><span class="fu">sum</span>(x.sample),b<span class="sc">+</span><span class="fu">sum</span>(<span class="dv">1</span><span class="sc">-</span>x.sample))</span>
<span id="cb211-1311"><a href="#cb211-1311" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sampling (missing x)</span></span>
<span id="cb211-1312"><a href="#cb211-1312" aria-hidden="true" tabindex="-1"></a>  x.sample[<span class="fu">is.na</span>(x)] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="fu">sum</span>(<span class="fu">is.na</span>(x)),<span class="dv">1</span>,<span class="dv">7</span><span class="sc">*</span>p<span class="sc">/</span>(<span class="dv">6</span><span class="sc">*</span>p<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb211-1313"><a href="#cb211-1313" aria-hidden="true" tabindex="-1"></a>    mon.x20[iter] <span class="ot">&lt;-</span> x.sample[<span class="dv">20</span>]</span>
<span id="cb211-1314"><a href="#cb211-1314" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb211-1315"><a href="#cb211-1315" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1316"><a href="#cb211-1316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1319"><a href="#cb211-1319" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-1320"><a href="#cb211-1320" aria-hidden="true" tabindex="-1"></a><span class="co"># prior parameters</span></span>
<span id="cb211-1321"><a href="#cb211-1321" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">1</span>; b <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb211-1322"><a href="#cb211-1322" aria-hidden="true" tabindex="-1"></a><span class="co"># data: 40 satisfied, 10 not satisfied, 50 no-responses</span></span>
<span id="cb211-1323"><a href="#cb211-1323" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="cn">NA</span>),<span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">10</span>,<span class="dv">50</span>))</span>
<span id="cb211-1324"><a href="#cb211-1324" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">0</span>,<span class="fu">c</span>(<span class="dv">50</span>,<span class="dv">50</span>))</span>
<span id="cb211-1325"><a href="#cb211-1325" aria-hidden="true" tabindex="-1"></a><span class="co"># what if all 50 were satisfied?</span></span>
<span id="cb211-1326"><a href="#cb211-1326" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>),<span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">10</span>,<span class="dv">50</span>))</span>
<span id="cb211-1327"><a href="#cb211-1327" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">0</span>,<span class="fu">c</span>(<span class="dv">50</span>,<span class="dv">50</span>))</span>
<span id="cb211-1328"><a href="#cb211-1328" aria-hidden="true" tabindex="-1"></a><span class="co"># what if all 50 were like the other 50?</span></span>
<span id="cb211-1329"><a href="#cb211-1329" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="dv">40</span>,<span class="dv">10</span>,<span class="dv">40</span>,<span class="dv">10</span>))</span>
<span id="cb211-1330"><a href="#cb211-1330" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">0</span>,<span class="fu">c</span>(<span class="dv">50</span>,<span class="dv">50</span>))</span>
<span id="cb211-1331"><a href="#cb211-1331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1332"><a href="#cb211-1332" aria-hidden="true" tabindex="-1"></a><span class="co"># initial values.</span></span>
<span id="cb211-1333"><a href="#cb211-1333" aria-hidden="true" tabindex="-1"></a>x.sample <span class="ot">&lt;-</span> x; x.sample[<span class="fu">is.na</span>(x)] <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">size=</span><span class="dv">50</span>,<span class="at">replace=</span>T)</span>
<span id="cb211-1334"><a href="#cb211-1334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1335"><a href="#cb211-1335" aria-hidden="true" tabindex="-1"></a><span class="co"># number of iterations</span></span>
<span id="cb211-1336"><a href="#cb211-1336" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">4</span><span class="sc">+</span><span class="dv">500</span></span>
<span id="cb211-1337"><a href="#cb211-1337" aria-hidden="true" tabindex="-1"></a><span class="co"># and the monitor for recording the iterations of p</span></span>
<span id="cb211-1338"><a href="#cb211-1338" aria-hidden="true" tabindex="-1"></a>mon.p <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb211-1339"><a href="#cb211-1339" aria-hidden="true" tabindex="-1"></a><span class="co"># ... and one of the missing observations</span></span>
<span id="cb211-1340"><a href="#cb211-1340" aria-hidden="true" tabindex="-1"></a>mon.x20 <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb211-1341"><a href="#cb211-1341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1342"><a href="#cb211-1342" aria-hidden="true" tabindex="-1"></a><span class="co"># Gibbs sampler:</span></span>
<span id="cb211-1343"><a href="#cb211-1343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1344"><a href="#cb211-1344" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>ITER){</span>
<span id="cb211-1345"><a href="#cb211-1345" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sampling p</span></span>
<span id="cb211-1346"><a href="#cb211-1346" aria-hidden="true" tabindex="-1"></a>  mon.p[iter] <span class="ot">&lt;-</span> p <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(<span class="dv">1</span>,a<span class="sc">+</span><span class="fu">sum</span>(x.sample),b<span class="sc">+</span><span class="fu">sum</span>(<span class="dv">1</span><span class="sc">-</span>x.sample))</span>
<span id="cb211-1347"><a href="#cb211-1347" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sampling (missing x)</span></span>
<span id="cb211-1348"><a href="#cb211-1348" aria-hidden="true" tabindex="-1"></a>  x.sample[<span class="fu">is.na</span>(x)] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="fu">sum</span>(<span class="fu">is.na</span>(x)),<span class="dv">1</span>,<span class="dv">7</span><span class="sc">*</span>p<span class="sc">/</span>(<span class="dv">6</span><span class="sc">*</span>p<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb211-1349"><a href="#cb211-1349" aria-hidden="true" tabindex="-1"></a>    mon.x20[iter] <span class="ot">&lt;-</span> x.sample[<span class="dv">20</span>]</span>
<span id="cb211-1350"><a href="#cb211-1350" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb211-1351"><a href="#cb211-1351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1352"><a href="#cb211-1352" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior mean probability of being satisfied.</span></span>
<span id="cb211-1353"><a href="#cb211-1353" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(mon.p[<span class="dv">501</span><span class="sc">:</span><span class="dv">10500</span>])</span>
<span id="cb211-1354"><a href="#cb211-1354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1355"><a href="#cb211-1355" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% CI</span></span>
<span id="cb211-1356"><a href="#cb211-1356" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(mon.p[<span class="dv">501</span><span class="sc">:</span><span class="dv">10500</span>], <span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">975</span>))</span>
<span id="cb211-1357"><a href="#cb211-1357" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1358"><a href="#cb211-1358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1359"><a href="#cb211-1359" aria-hidden="true" tabindex="-1"></a><span class="fu">### Change Point Regression</span></span>
<span id="cb211-1360"><a href="#cb211-1360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1361"><a href="#cb211-1361" aria-hidden="true" tabindex="-1"></a>Let's try another example. The <span class="in">`Nile`</span> data set contains Nile flow by year. We want to ask whether the trend changed after 1897. Compare an intercept-only model, $y_t \sim N(\mu_t, \tau)$ where $\mu_t = \alpha$ is a constant, to a linear time trend model where $\mu_t = \alpha + \beta \text{Year}$. Use conjugate non-informative priors, $\alpha \sim N(0, 10^{-10})$ and $\tau \sim \text{Gamma}(.01, .01)$.</span>
<span id="cb211-1362"><a href="#cb211-1362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1363"><a href="#cb211-1363" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-1364"><a href="#cb211-1364" aria-hidden="true" tabindex="-1"></a><span class="in">data("Nile")</span></span>
<span id="cb211-1365"><a href="#cb211-1365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1366"><a href="#cb211-1366" aria-hidden="true" tabindex="-1"></a><span class="in">my_nile &lt;- tibble(year = time(Nile), flow = Nile, after = as.numeric(year&gt;1897))</span></span>
<span id="cb211-1367"><a href="#cb211-1367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1368"><a href="#cb211-1368" aria-hidden="true" tabindex="-1"></a><span class="in"># intercept-only</span></span>
<span id="cb211-1369"><a href="#cb211-1369" aria-hidden="true" tabindex="-1"></a><span class="in">m0 &lt;- MCMCglmm(flow ~ 1, data = my_nile, </span></span>
<span id="cb211-1370"><a href="#cb211-1370" aria-hidden="true" tabindex="-1"></a><span class="in">               nitt = 1500, burnin = 500, thin = 1,</span></span>
<span id="cb211-1371"><a href="#cb211-1371" aria-hidden="true" tabindex="-1"></a><span class="in">               prior = list(B = list(mu = 0, V = 10^10)),</span></span>
<span id="cb211-1372"><a href="#cb211-1372" aria-hidden="true" tabindex="-1"></a><span class="in">               verbose = FALSE)</span></span>
<span id="cb211-1373"><a href="#cb211-1373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1374"><a href="#cb211-1374" aria-hidden="true" tabindex="-1"></a><span class="in"># Trend</span></span>
<span id="cb211-1375"><a href="#cb211-1375" aria-hidden="true" tabindex="-1"></a><span class="in">m1 &lt;- MCMCglmm(flow ~ year, data = my_nile, </span></span>
<span id="cb211-1376"><a href="#cb211-1376" aria-hidden="true" tabindex="-1"></a><span class="in">               nitt = 1500, burnin = 500, thin = 1,</span></span>
<span id="cb211-1377"><a href="#cb211-1377" aria-hidden="true" tabindex="-1"></a><span class="in">               prior = list(B = list(mu = c(0, 0), V = diag(2)*10^10)),</span></span>
<span id="cb211-1378"><a href="#cb211-1378" aria-hidden="true" tabindex="-1"></a><span class="in">               verbose = FALSE)</span></span>
<span id="cb211-1379"><a href="#cb211-1379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1380"><a href="#cb211-1380" aria-hidden="true" tabindex="-1"></a><span class="in"># flow has been decreasing by 2.7 per year (95% CI, 1.6 - 3.7)</span></span>
<span id="cb211-1381"><a href="#cb211-1381" aria-hidden="true" tabindex="-1"></a><span class="in">summary(m1)$solutions</span></span>
<span id="cb211-1382"><a href="#cb211-1382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1383"><a href="#cb211-1383" aria-hidden="true" tabindex="-1"></a><span class="in"># posterior probability of negative trend</span></span>
<span id="cb211-1384"><a href="#cb211-1384" aria-hidden="true" tabindex="-1"></a><span class="in">mean(m1$Sol[, 2] &lt; 0)</span></span>
<span id="cb211-1385"><a href="#cb211-1385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1386"><a href="#cb211-1386" aria-hidden="true" tabindex="-1"></a><span class="in"># Change Point</span></span>
<span id="cb211-1387"><a href="#cb211-1387" aria-hidden="true" tabindex="-1"></a><span class="in">m2 &lt;- MCMCglmm(flow ~ after, data = my_nile, </span></span>
<span id="cb211-1388"><a href="#cb211-1388" aria-hidden="true" tabindex="-1"></a><span class="in">               nitt = 1500, burnin = 500, thin = 1,</span></span>
<span id="cb211-1389"><a href="#cb211-1389" aria-hidden="true" tabindex="-1"></a><span class="in">               prior = list(B = list(mu = c(0, 0), V = diag(2)*10^10)),</span></span>
<span id="cb211-1390"><a href="#cb211-1390" aria-hidden="true" tabindex="-1"></a><span class="in">               verbose = FALSE)</span></span>
<span id="cb211-1391"><a href="#cb211-1391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1392"><a href="#cb211-1392" aria-hidden="true" tabindex="-1"></a><span class="in"># Flow fell 244 from 1098.</span></span>
<span id="cb211-1393"><a href="#cb211-1393" aria-hidden="true" tabindex="-1"></a><span class="in">summary(m2)$solutions</span></span>
<span id="cb211-1394"><a href="#cb211-1394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1395"><a href="#cb211-1395" aria-hidden="true" tabindex="-1"></a><span class="in"># Compare the DIC. m2 has smallest DIC.</span></span>
<span id="cb211-1396"><a href="#cb211-1396" aria-hidden="true" tabindex="-1"></a><span class="in">m0$DIC</span></span>
<span id="cb211-1397"><a href="#cb211-1397" aria-hidden="true" tabindex="-1"></a><span class="in">m1$DIC</span></span>
<span id="cb211-1398"><a href="#cb211-1398" aria-hidden="true" tabindex="-1"></a><span class="in">m2$DIC</span></span>
<span id="cb211-1399"><a href="#cb211-1399" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1400"><a href="#cb211-1400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1401"><a href="#cb211-1401" aria-hidden="true" tabindex="-1"></a>This isn't quite how you would want to do it, however. Instead, you'd like to determine which year the change point occurred. Define $\mu_t = \alpha_0$ for $t&lt;t^*$, and $\alpha_1$ for $t \ge t^*$. Use conjugate non-informative priors for both, $\alpha_0 = \alpha_1 \sim N(0, 10^{-8})$ and $\tau \sim \text{Gamma}(.01, .01)$ and a uniform prior for $t^* \sim U(1871.5, 1969.5$.</span>
<span id="cb211-1402"><a href="#cb211-1402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1403"><a href="#cb211-1403" aria-hidden="true" tabindex="-1"></a>The posterior conditional distributions for $\alpha_0$ and $\alpha_1$ are from Eqns \@ref(eq:mu-posterior).</span>
<span id="cb211-1404"><a href="#cb211-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1405"><a href="#cb211-1405" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1406"><a href="#cb211-1406" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-1407"><a href="#cb211-1407" aria-hidden="true" tabindex="-1"></a>\alpha_0 | y,t^*,\tau &amp; \sim N \left( \frac{\sum_{t&lt;t^*} y_t \tau}{\sum_{t&lt;t^*} 1 \tau + 10^{-8}}, \sum_{t&lt;t^*} 1 \tau + 10^{-8} \right) <span class="sc">\\</span></span>
<span id="cb211-1408"><a href="#cb211-1408" aria-hidden="true" tabindex="-1"></a>\alpha_1 | y,t^*,\tau &amp; \sim N \left( \frac{\sum_{t\ge t^*} y_t \tau}{\sum_{t\ge t^*} 1 \tau + 10^{-8}}, \sum_{t\ge t^*} 1 \tau + 10^{-8} \right) </span>
<span id="cb211-1409"><a href="#cb211-1409" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-1410"><a href="#cb211-1410" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1411"><a href="#cb211-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1412"><a href="#cb211-1412" aria-hidden="true" tabindex="-1"></a>The posterior conditional distribution for $\tau$ needs to be derived from Bayes' formula.</span>
<span id="cb211-1413"><a href="#cb211-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1414"><a href="#cb211-1414" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1415"><a href="#cb211-1415" aria-hidden="true" tabindex="-1"></a>\tau|x, t^*, \alpha_0, \alpha_1 \sim \text{Gamma} \left( .01 + \frac{n}{2}, .01 + .5 \sum_{t&lt;t^*} (x_t - \alpha_0)^2 + .5 \sum_{t \ge t^*} (x_t - \alpha_1)^2 \right)</span>
<span id="cb211-1416"><a href="#cb211-1416" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1417"><a href="#cb211-1417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1418"><a href="#cb211-1418" aria-hidden="true" tabindex="-1"></a>It is not possible to derive a posterior conditional distribution for $t^*$, so use the Metropolis-Hastings algorithm. Given $\alpha_0$, $\alpha_1$, $\tau$, and $t^*$, propose a new value from the normal distribution centered at $t^*$: $t^{*'} \sim N(t^*, \delta)$ and accept the new value with probability $min{1, R}$, </span>
<span id="cb211-1419"><a href="#cb211-1419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1420"><a href="#cb211-1420" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1421"><a href="#cb211-1421" aria-hidden="true" tabindex="-1"></a>R = \frac{f(y|\alpha_0, \alpha_1, t^{*'})f(t^{*'})}{f(y|\alpha_0, \alpha_1, t^*)} \frac{q(t^*|t^{*'})}{q(t^{*'}|t^*)}</span>
<span id="cb211-1422"><a href="#cb211-1422" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1423"><a href="#cb211-1423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1424"><a href="#cb211-1424" aria-hidden="true" tabindex="-1"></a>The proposal distribution is symmetric, so you can drop the $q()$ functions from the ratio (Metropolis algorithm).</span>
<span id="cb211-1425"><a href="#cb211-1425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1426"><a href="#cb211-1426" aria-hidden="true" tabindex="-1"></a>Let's start with a toy example to check the code.</span>
<span id="cb211-1427"><a href="#cb211-1427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1428"><a href="#cb211-1428" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-1429"><a href="#cb211-1429" aria-hidden="true" tabindex="-1"></a><span class="in"># Create toy data set.</span></span>
<span id="cb211-1430"><a href="#cb211-1430" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345)</span></span>
<span id="cb211-1431"><a href="#cb211-1431" aria-hidden="true" tabindex="-1"></a><span class="in">ALPHA_0 &lt;- 0</span></span>
<span id="cb211-1432"><a href="#cb211-1432" aria-hidden="true" tabindex="-1"></a><span class="in">ALPHA_1 &lt;- 1</span></span>
<span id="cb211-1433"><a href="#cb211-1433" aria-hidden="true" tabindex="-1"></a><span class="in">TAU &lt;- 1 / .1^2</span></span>
<span id="cb211-1434"><a href="#cb211-1434" aria-hidden="true" tabindex="-1"></a><span class="in">CHGPT &lt;- 25.5</span></span>
<span id="cb211-1435"><a href="#cb211-1435" aria-hidden="true" tabindex="-1"></a><span class="in">dat &lt;- tibble(t = 1:100, y = rnorm(100, ALPHA_0 + ALPHA_1*(t&gt;CHGPT), 1 / sqrt(TAU)))</span></span>
<span id="cb211-1436"><a href="#cb211-1436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1437"><a href="#cb211-1437" aria-hidden="true" tabindex="-1"></a><span class="in"># Quick look at the data. A clear change point!</span></span>
<span id="cb211-1438"><a href="#cb211-1438" aria-hidden="true" tabindex="-1"></a><span class="in">dat %&gt;% ggplot(aes(x = t, y = y)) + geom_line()</span></span>
<span id="cb211-1439"><a href="#cb211-1439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1440"><a href="#cb211-1440" aria-hidden="true" tabindex="-1"></a><span class="in"># Set up a 1,500 iteration MCMC</span></span>
<span id="cb211-1441"><a href="#cb211-1441" aria-hidden="true" tabindex="-1"></a><span class="in">ITER &lt;- 1500</span></span>
<span id="cb211-1442"><a href="#cb211-1442" aria-hidden="true" tabindex="-1"></a><span class="in">chgpt_delta &lt;- .5</span></span>
<span id="cb211-1443"><a href="#cb211-1443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1444"><a href="#cb211-1444" aria-hidden="true" tabindex="-1"></a><span class="in"># Create monitors for each of the posterior distributions</span></span>
<span id="cb211-1445"><a href="#cb211-1445" aria-hidden="true" tabindex="-1"></a><span class="in">mon_alpha_0 &lt;- mon_alpha_1 &lt;- mon_tau &lt;- mon_chgpt &lt;- numeric(ITER)</span></span>
<span id="cb211-1446"><a href="#cb211-1446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1447"><a href="#cb211-1447" aria-hidden="true" tabindex="-1"></a><span class="in"># Set initial values</span></span>
<span id="cb211-1448"><a href="#cb211-1448" aria-hidden="true" tabindex="-1"></a><span class="in">n &lt;- nrow(dat)</span></span>
<span id="cb211-1449"><a href="#cb211-1449" aria-hidden="true" tabindex="-1"></a><span class="in">alpha_0 &lt;- alpha_1 &lt;- mean(dat$y); tau &lt;- 1 / var(dat$y); chgpt &lt;- median(dat$t)</span></span>
<span id="cb211-1450"><a href="#cb211-1450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1451"><a href="#cb211-1451" aria-hidden="true" tabindex="-1"></a><span class="in">for(iter in 1:ITER) {</span></span>
<span id="cb211-1452"><a href="#cb211-1452" aria-hidden="true" tabindex="-1"></a><span class="in">  # Gibbs step</span></span>
<span id="cb211-1453"><a href="#cb211-1453" aria-hidden="true" tabindex="-1"></a><span class="in">  alpha_0 &lt;- rnorm(1, sum(dat$y[dat$t &lt;  chgpt]) * tau / (sum(dat$t &lt;  chgpt) * tau + 10^(-8)),</span></span>
<span id="cb211-1454"><a href="#cb211-1454" aria-hidden="true" tabindex="-1"></a><span class="in">                   1 / sqrt(sum(dat$t &lt;  chgpt) * tau + 10^(-8)))</span></span>
<span id="cb211-1455"><a href="#cb211-1455" aria-hidden="true" tabindex="-1"></a><span class="in">  alpha_1 &lt;- rnorm(1, sum(dat$y[dat$t &gt;= chgpt]) * tau / (sum(dat$t &gt;= chgpt) * tau + 10^(-8)),</span></span>
<span id="cb211-1456"><a href="#cb211-1456" aria-hidden="true" tabindex="-1"></a><span class="in">                   1 / sqrt(sum(dat$t &gt;= chgpt) * tau + 10^(-8)))</span></span>
<span id="cb211-1457"><a href="#cb211-1457" aria-hidden="true" tabindex="-1"></a><span class="in">  tau &lt;- rgamma(1, .01 + n/2, </span></span>
<span id="cb211-1458"><a href="#cb211-1458" aria-hidden="true" tabindex="-1"></a><span class="in">                .01 + </span></span>
<span id="cb211-1459"><a href="#cb211-1459" aria-hidden="true" tabindex="-1"></a><span class="in">                  .5 * sum(((dat$y - alpha_0)^2)[dat$t &lt;  chgpt]) +</span></span>
<span id="cb211-1460"><a href="#cb211-1460" aria-hidden="true" tabindex="-1"></a><span class="in">                  .5 * sum(((dat$y - alpha_1)^2)[dat$t &gt;= chgpt]))</span></span>
<span id="cb211-1461"><a href="#cb211-1461" aria-hidden="true" tabindex="-1"></a><span class="in">  # c(alpha_0, alpha_1, tau, chgpt)</span></span>
<span id="cb211-1462"><a href="#cb211-1462" aria-hidden="true" tabindex="-1"></a><span class="in">  # Metropolis step</span></span>
<span id="cb211-1463"><a href="#cb211-1463" aria-hidden="true" tabindex="-1"></a><span class="in">  chgpt_new &lt;- rnorm(1, chgpt, sd = chgpt_delta)</span></span>
<span id="cb211-1464"><a href="#cb211-1464" aria-hidden="true" tabindex="-1"></a><span class="in">  log_R &lt;- # difference in log-likelihoods =</span></span>
<span id="cb211-1465"><a href="#cb211-1465" aria-hidden="true" tabindex="-1"></a><span class="in">    # log-likelihood of new</span></span>
<span id="cb211-1466"><a href="#cb211-1466" aria-hidden="true" tabindex="-1"></a><span class="in">    (sum(dnorm(dat$y[dat$t &lt;  chgpt_new], alpha_0, 1 / sqrt(tau), log = TRUE)) +</span></span>
<span id="cb211-1467"><a href="#cb211-1467" aria-hidden="true" tabindex="-1"></a><span class="in">     sum(dnorm(dat$y[dat$t &gt;= chgpt_new], alpha_1, 1 / sqrt(tau), log = TRUE))) -</span></span>
<span id="cb211-1468"><a href="#cb211-1468" aria-hidden="true" tabindex="-1"></a><span class="in">    # log-likelihood of curr</span></span>
<span id="cb211-1469"><a href="#cb211-1469" aria-hidden="true" tabindex="-1"></a><span class="in">    (sum(dnorm(dat$y[dat$t &lt;  chgpt],     alpha_0, 1 / sqrt(tau), log = TRUE)) +</span></span>
<span id="cb211-1470"><a href="#cb211-1470" aria-hidden="true" tabindex="-1"></a><span class="in">     sum(dnorm(dat$y[dat$t &gt;= chgpt],     alpha_1, 1 / sqrt(tau), log = TRUE))) </span></span>
<span id="cb211-1471"><a href="#cb211-1471" aria-hidden="true" tabindex="-1"></a><span class="in">  log_U &lt;- log(runif(1, 0, 1))</span></span>
<span id="cb211-1472"><a href="#cb211-1472" aria-hidden="true" tabindex="-1"></a><span class="in">  if(log_U &lt; log_R) { chgpt &lt;- chgpt_new}</span></span>
<span id="cb211-1473"><a href="#cb211-1473" aria-hidden="true" tabindex="-1"></a><span class="in">  # update monitors</span></span>
<span id="cb211-1474"><a href="#cb211-1474" aria-hidden="true" tabindex="-1"></a><span class="in">  mon_alpha_0[iter] &lt;- alpha_0 </span></span>
<span id="cb211-1475"><a href="#cb211-1475" aria-hidden="true" tabindex="-1"></a><span class="in">  mon_alpha_1[iter] &lt;- alpha_1</span></span>
<span id="cb211-1476"><a href="#cb211-1476" aria-hidden="true" tabindex="-1"></a><span class="in">  mon_tau[iter] &lt;- tau</span></span>
<span id="cb211-1477"><a href="#cb211-1477" aria-hidden="true" tabindex="-1"></a><span class="in">  mon_chgpt[iter] &lt;- chgpt</span></span>
<span id="cb211-1478"><a href="#cb211-1478" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb211-1479"><a href="#cb211-1479" aria-hidden="true" tabindex="-1"></a><span class="in"># mine &lt;- c(alpha_0, alpha_1, tau, chgpt, chgpt_new, log_R, log_U)</span></span>
<span id="cb211-1480"><a href="#cb211-1480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1481"><a href="#cb211-1481" aria-hidden="true" tabindex="-1"></a><span class="in"># Check for convergence</span></span>
<span id="cb211-1482"><a href="#cb211-1482" aria-hidden="true" tabindex="-1"></a><span class="in">mon_tibble &lt;- tibble(index = 1:ITER, alpha_0 = mon_alpha_0, alpha_1 = mon_alpha_1, </span></span>
<span id="cb211-1483"><a href="#cb211-1483" aria-hidden="true" tabindex="-1"></a><span class="in">       tau = mon_tau, chgpt = mon_chgpt) </span></span>
<span id="cb211-1484"><a href="#cb211-1484" aria-hidden="true" tabindex="-1"></a><span class="in">mon_tibble_longer &lt;-</span></span>
<span id="cb211-1485"><a href="#cb211-1485" aria-hidden="true" tabindex="-1"></a><span class="in">  mon_tibble %&gt;%</span></span>
<span id="cb211-1486"><a href="#cb211-1486" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(cols = -index)</span></span>
<span id="cb211-1487"><a href="#cb211-1487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1488"><a href="#cb211-1488" aria-hidden="true" tabindex="-1"></a><span class="in">mon_tibble_longer %&gt;% </span></span>
<span id="cb211-1489"><a href="#cb211-1489" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = index, y = value)) + </span></span>
<span id="cb211-1490"><a href="#cb211-1490" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line() + </span></span>
<span id="cb211-1491"><a href="#cb211-1491" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(y = NULL) +</span></span>
<span id="cb211-1492"><a href="#cb211-1492" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(facets = vars(name), scales = "free_y")</span></span>
<span id="cb211-1493"><a href="#cb211-1493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1494"><a href="#cb211-1494" aria-hidden="true" tabindex="-1"></a><span class="in"># Convergence after 500 iterations, so throw them out.</span></span>
<span id="cb211-1495"><a href="#cb211-1495" aria-hidden="true" tabindex="-1"></a><span class="in"># Posterior distributions</span></span>
<span id="cb211-1496"><a href="#cb211-1496" aria-hidden="true" tabindex="-1"></a><span class="in">mon_tibble_longer %&gt;% </span></span>
<span id="cb211-1497"><a href="#cb211-1497" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(index &gt; 500) %&gt;%</span></span>
<span id="cb211-1498"><a href="#cb211-1498" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(name = if_else(name == "tau", "sigma", name),</span></span>
<span id="cb211-1499"><a href="#cb211-1499" aria-hidden="true" tabindex="-1"></a><span class="in">         value = if_else(name == "sigma", 1 / sqrt(value), value)) %&gt;%</span></span>
<span id="cb211-1500"><a href="#cb211-1500" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(</span></span>
<span id="cb211-1501"><a href="#cb211-1501" aria-hidden="true" tabindex="-1"></a><span class="in">    .by = name,</span></span>
<span id="cb211-1502"><a href="#cb211-1502" aria-hidden="true" tabindex="-1"></a><span class="in">    M = mean(value),</span></span>
<span id="cb211-1503"><a href="#cb211-1503" aria-hidden="true" tabindex="-1"></a><span class="in">    SD = sd(value),</span></span>
<span id="cb211-1504"><a href="#cb211-1504" aria-hidden="true" tabindex="-1"></a><span class="in">    LCI = quantile(value, .025),</span></span>
<span id="cb211-1505"><a href="#cb211-1505" aria-hidden="true" tabindex="-1"></a><span class="in">    UCI = quantile(value, .975)</span></span>
<span id="cb211-1506"><a href="#cb211-1506" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb211-1507"><a href="#cb211-1507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1508"><a href="#cb211-1508" aria-hidden="true" tabindex="-1"></a><span class="in"># You can summarize the values by t to average the models.</span></span>
<span id="cb211-1509"><a href="#cb211-1509" aria-hidden="true" tabindex="-1"></a><span class="in"># Recall the model is mu_t = alpha + beta*Year where alpha = alpha_0 or alpha_1</span></span>
<span id="cb211-1510"><a href="#cb211-1510" aria-hidden="true" tabindex="-1"></a><span class="in">mon_tibble %&gt;%</span></span>
<span id="cb211-1511"><a href="#cb211-1511" aria-hidden="true" tabindex="-1"></a><span class="in">  head(-500) %&gt;%</span></span>
<span id="cb211-1512"><a href="#cb211-1512" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb211-1513"><a href="#cb211-1513" aria-hidden="true" tabindex="-1"></a><span class="in">    series = pmap(list(alpha_0, alpha_1, chgpt), function(a0, a1, c) {</span></span>
<span id="cb211-1514"><a href="#cb211-1514" aria-hidden="true" tabindex="-1"></a><span class="in">      t &lt;- 1:100</span></span>
<span id="cb211-1515"><a href="#cb211-1515" aria-hidden="true" tabindex="-1"></a><span class="in">      y &lt;- if_else(t &lt; c, a0, a1)</span></span>
<span id="cb211-1516"><a href="#cb211-1516" aria-hidden="true" tabindex="-1"></a><span class="in">      rs &lt;- tibble(t, y)</span></span>
<span id="cb211-1517"><a href="#cb211-1517" aria-hidden="true" tabindex="-1"></a><span class="in">      rs</span></span>
<span id="cb211-1518"><a href="#cb211-1518" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb211-1519"><a href="#cb211-1519" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb211-1520"><a href="#cb211-1520" aria-hidden="true" tabindex="-1"></a><span class="in">  select(series) %&gt;%</span></span>
<span id="cb211-1521"><a href="#cb211-1521" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(series) %&gt;%</span></span>
<span id="cb211-1522"><a href="#cb211-1522" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(.by = t, y = mean(y), lci = quantile(y, .025), uci = quantile(y, .975)) %&gt;%</span></span>
<span id="cb211-1523"><a href="#cb211-1523" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = t)) +</span></span>
<span id="cb211-1524"><a href="#cb211-1524" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(aes(y = y)) +</span></span>
<span id="cb211-1525"><a href="#cb211-1525" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = lci, ymax = uci))</span></span>
<span id="cb211-1526"><a href="#cb211-1526" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1527"><a href="#cb211-1527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1528"><a href="#cb211-1528" aria-hidden="true" tabindex="-1"></a>Now let's apply what we've learned to the Nile data set. I'll set the initial change point value at 1900 since that is around where the change seems to have occurred. </span>
<span id="cb211-1529"><a href="#cb211-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1530"><a href="#cb211-1530" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-1531"><a href="#cb211-1531" aria-hidden="true" tabindex="-1"></a><span class="in">dat &lt;- my_nile %&gt;% rename(t = year, y = flow)</span></span>
<span id="cb211-1532"><a href="#cb211-1532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1533"><a href="#cb211-1533" aria-hidden="true" tabindex="-1"></a><span class="in"># Quick look at the data. A clear change point!</span></span>
<span id="cb211-1534"><a href="#cb211-1534" aria-hidden="true" tabindex="-1"></a><span class="in">dat %&gt;% ggplot(aes(x = t, y = y)) + geom_line()</span></span>
<span id="cb211-1535"><a href="#cb211-1535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1536"><a href="#cb211-1536" aria-hidden="true" tabindex="-1"></a><span class="in"># Set up a 1,500 iteration MCMC</span></span>
<span id="cb211-1537"><a href="#cb211-1537" aria-hidden="true" tabindex="-1"></a><span class="in">ITER &lt;- 1500</span></span>
<span id="cb211-1538"><a href="#cb211-1538" aria-hidden="true" tabindex="-1"></a><span class="in">chgpt_delta &lt;- .5</span></span>
<span id="cb211-1539"><a href="#cb211-1539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1540"><a href="#cb211-1540" aria-hidden="true" tabindex="-1"></a><span class="in"># Create monitors for each of the posterior distributions</span></span>
<span id="cb211-1541"><a href="#cb211-1541" aria-hidden="true" tabindex="-1"></a><span class="in">mon_alpha_0 &lt;- mon_alpha_1 &lt;- mon_tau &lt;- mon_chgpt &lt;- numeric(ITER)</span></span>
<span id="cb211-1542"><a href="#cb211-1542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1543"><a href="#cb211-1543" aria-hidden="true" tabindex="-1"></a><span class="in"># Set initial values</span></span>
<span id="cb211-1544"><a href="#cb211-1544" aria-hidden="true" tabindex="-1"></a><span class="in">n &lt;- nrow(dat)</span></span>
<span id="cb211-1545"><a href="#cb211-1545" aria-hidden="true" tabindex="-1"></a><span class="in">alpha_0 &lt;- alpha_1 &lt;- mean(dat$y); tau &lt;- 1 / var(dat$y); chgpt &lt;- 1900</span></span>
<span id="cb211-1546"><a href="#cb211-1546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1547"><a href="#cb211-1547" aria-hidden="true" tabindex="-1"></a><span class="in">for(iter in 1:ITER) {</span></span>
<span id="cb211-1548"><a href="#cb211-1548" aria-hidden="true" tabindex="-1"></a><span class="in">  # Gibbs step</span></span>
<span id="cb211-1549"><a href="#cb211-1549" aria-hidden="true" tabindex="-1"></a><span class="in">  alpha_0 &lt;- rnorm(1, sum(dat$y[dat$t &lt;  chgpt]) * tau / (sum(dat$t &lt;  chgpt) * tau + 10^(-8)),</span></span>
<span id="cb211-1550"><a href="#cb211-1550" aria-hidden="true" tabindex="-1"></a><span class="in">                   1 / sqrt(sum(dat$t &lt;  chgpt) * tau + 10^(-8)))</span></span>
<span id="cb211-1551"><a href="#cb211-1551" aria-hidden="true" tabindex="-1"></a><span class="in">  alpha_1 &lt;- rnorm(1, sum(dat$y[dat$t &gt;= chgpt]) * tau / (sum(dat$t &gt;= chgpt) * tau + 10^(-8)),</span></span>
<span id="cb211-1552"><a href="#cb211-1552" aria-hidden="true" tabindex="-1"></a><span class="in">                   1 / sqrt(sum(dat$t &gt;= chgpt) * tau + 10^(-8)))</span></span>
<span id="cb211-1553"><a href="#cb211-1553" aria-hidden="true" tabindex="-1"></a><span class="in">  tau &lt;- rgamma(1, .01 + n/2, </span></span>
<span id="cb211-1554"><a href="#cb211-1554" aria-hidden="true" tabindex="-1"></a><span class="in">                .01 + </span></span>
<span id="cb211-1555"><a href="#cb211-1555" aria-hidden="true" tabindex="-1"></a><span class="in">                  .5 * sum(((dat$y - alpha_0)^2)[dat$t &lt;  chgpt]) +</span></span>
<span id="cb211-1556"><a href="#cb211-1556" aria-hidden="true" tabindex="-1"></a><span class="in">                  .5 * sum(((dat$y - alpha_1)^2)[dat$t &gt;= chgpt]))</span></span>
<span id="cb211-1557"><a href="#cb211-1557" aria-hidden="true" tabindex="-1"></a><span class="in">  # c(alpha_0, alpha_1, tau, chgpt)</span></span>
<span id="cb211-1558"><a href="#cb211-1558" aria-hidden="true" tabindex="-1"></a><span class="in">  # Metropolis step</span></span>
<span id="cb211-1559"><a href="#cb211-1559" aria-hidden="true" tabindex="-1"></a><span class="in">  chgpt_new &lt;- rnorm(1, chgpt, sd = chgpt_delta)</span></span>
<span id="cb211-1560"><a href="#cb211-1560" aria-hidden="true" tabindex="-1"></a><span class="in">  log_R &lt;- # difference in log-likelihoods =</span></span>
<span id="cb211-1561"><a href="#cb211-1561" aria-hidden="true" tabindex="-1"></a><span class="in">    # log-likelihood of new</span></span>
<span id="cb211-1562"><a href="#cb211-1562" aria-hidden="true" tabindex="-1"></a><span class="in">    (sum(dnorm(dat$y[dat$t &lt;  chgpt_new], alpha_0, 1 / sqrt(tau), log = TRUE)) +</span></span>
<span id="cb211-1563"><a href="#cb211-1563" aria-hidden="true" tabindex="-1"></a><span class="in">     sum(dnorm(dat$y[dat$t &gt;= chgpt_new], alpha_1, 1 / sqrt(tau), log = TRUE))) -</span></span>
<span id="cb211-1564"><a href="#cb211-1564" aria-hidden="true" tabindex="-1"></a><span class="in">    # log-likelihood of curr</span></span>
<span id="cb211-1565"><a href="#cb211-1565" aria-hidden="true" tabindex="-1"></a><span class="in">    (sum(dnorm(dat$y[dat$t &lt;  chgpt],     alpha_0, 1 / sqrt(tau), log = TRUE)) +</span></span>
<span id="cb211-1566"><a href="#cb211-1566" aria-hidden="true" tabindex="-1"></a><span class="in">     sum(dnorm(dat$y[dat$t &gt;= chgpt],     alpha_1, 1 / sqrt(tau), log = TRUE))) </span></span>
<span id="cb211-1567"><a href="#cb211-1567" aria-hidden="true" tabindex="-1"></a><span class="in">  log_U &lt;- log(runif(1, 0, 1))</span></span>
<span id="cb211-1568"><a href="#cb211-1568" aria-hidden="true" tabindex="-1"></a><span class="in">  if(log_U &lt; log_R) { chgpt &lt;- chgpt_new}</span></span>
<span id="cb211-1569"><a href="#cb211-1569" aria-hidden="true" tabindex="-1"></a><span class="in">  # update monitors</span></span>
<span id="cb211-1570"><a href="#cb211-1570" aria-hidden="true" tabindex="-1"></a><span class="in">  mon_alpha_0[iter] &lt;- alpha_0 </span></span>
<span id="cb211-1571"><a href="#cb211-1571" aria-hidden="true" tabindex="-1"></a><span class="in">  mon_alpha_1[iter] &lt;- alpha_1</span></span>
<span id="cb211-1572"><a href="#cb211-1572" aria-hidden="true" tabindex="-1"></a><span class="in">  mon_tau[iter] &lt;- tau</span></span>
<span id="cb211-1573"><a href="#cb211-1573" aria-hidden="true" tabindex="-1"></a><span class="in">  mon_chgpt[iter] &lt;- chgpt</span></span>
<span id="cb211-1574"><a href="#cb211-1574" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb211-1575"><a href="#cb211-1575" aria-hidden="true" tabindex="-1"></a><span class="in"># mine &lt;- c(alpha_0, alpha_1, tau, chgpt, chgpt_new, log_R, log_U)</span></span>
<span id="cb211-1576"><a href="#cb211-1576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1577"><a href="#cb211-1577" aria-hidden="true" tabindex="-1"></a><span class="in"># Check for convergence</span></span>
<span id="cb211-1578"><a href="#cb211-1578" aria-hidden="true" tabindex="-1"></a><span class="in">mon_tibble &lt;- tibble(index = 1:ITER, alpha_0 = mon_alpha_0, alpha_1 = mon_alpha_1, </span></span>
<span id="cb211-1579"><a href="#cb211-1579" aria-hidden="true" tabindex="-1"></a><span class="in">       tau = mon_tau, chgpt = mon_chgpt) </span></span>
<span id="cb211-1580"><a href="#cb211-1580" aria-hidden="true" tabindex="-1"></a><span class="in">mon_tibble_longer &lt;-</span></span>
<span id="cb211-1581"><a href="#cb211-1581" aria-hidden="true" tabindex="-1"></a><span class="in">  mon_tibble %&gt;%</span></span>
<span id="cb211-1582"><a href="#cb211-1582" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(cols = -index)</span></span>
<span id="cb211-1583"><a href="#cb211-1583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1584"><a href="#cb211-1584" aria-hidden="true" tabindex="-1"></a><span class="in">mon_tibble_longer %&gt;% </span></span>
<span id="cb211-1585"><a href="#cb211-1585" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = index, y = value)) + </span></span>
<span id="cb211-1586"><a href="#cb211-1586" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line() + </span></span>
<span id="cb211-1587"><a href="#cb211-1587" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(y = NULL) +</span></span>
<span id="cb211-1588"><a href="#cb211-1588" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(facets = vars(name), scales = "free_y")</span></span>
<span id="cb211-1589"><a href="#cb211-1589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1590"><a href="#cb211-1590" aria-hidden="true" tabindex="-1"></a><span class="in"># Convergence after 500 iterations, so throw them out.</span></span>
<span id="cb211-1591"><a href="#cb211-1591" aria-hidden="true" tabindex="-1"></a><span class="in"># Posterior distributions</span></span>
<span id="cb211-1592"><a href="#cb211-1592" aria-hidden="true" tabindex="-1"></a><span class="in">mon_tibble_longer %&gt;% </span></span>
<span id="cb211-1593"><a href="#cb211-1593" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(index &gt; 500) %&gt;%</span></span>
<span id="cb211-1594"><a href="#cb211-1594" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(name = if_else(name == "tau", "sigma", name),</span></span>
<span id="cb211-1595"><a href="#cb211-1595" aria-hidden="true" tabindex="-1"></a><span class="in">         value = if_else(name == "sigma", 1 / sqrt(value), value)) %&gt;%</span></span>
<span id="cb211-1596"><a href="#cb211-1596" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(</span></span>
<span id="cb211-1597"><a href="#cb211-1597" aria-hidden="true" tabindex="-1"></a><span class="in">    .by = name,</span></span>
<span id="cb211-1598"><a href="#cb211-1598" aria-hidden="true" tabindex="-1"></a><span class="in">    M = mean(value),</span></span>
<span id="cb211-1599"><a href="#cb211-1599" aria-hidden="true" tabindex="-1"></a><span class="in">    SD = sd(value),</span></span>
<span id="cb211-1600"><a href="#cb211-1600" aria-hidden="true" tabindex="-1"></a><span class="in">    LCI = quantile(value, .025),</span></span>
<span id="cb211-1601"><a href="#cb211-1601" aria-hidden="true" tabindex="-1"></a><span class="in">    UCI = quantile(value, .975)</span></span>
<span id="cb211-1602"><a href="#cb211-1602" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb211-1603"><a href="#cb211-1603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1604"><a href="#cb211-1604" aria-hidden="true" tabindex="-1"></a><span class="in"># You can summarize the values by t to average the models.</span></span>
<span id="cb211-1605"><a href="#cb211-1605" aria-hidden="true" tabindex="-1"></a><span class="in"># Recall the model is mu_t = alpha + beta*Year where alpha = alpha_0 or alpha_1</span></span>
<span id="cb211-1606"><a href="#cb211-1606" aria-hidden="true" tabindex="-1"></a><span class="in">mon_tibble %&gt;%</span></span>
<span id="cb211-1607"><a href="#cb211-1607" aria-hidden="true" tabindex="-1"></a><span class="in">  head(-500) %&gt;%</span></span>
<span id="cb211-1608"><a href="#cb211-1608" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb211-1609"><a href="#cb211-1609" aria-hidden="true" tabindex="-1"></a><span class="in">    series = pmap(list(alpha_0, alpha_1, chgpt), function(a0, a1, c) {</span></span>
<span id="cb211-1610"><a href="#cb211-1610" aria-hidden="true" tabindex="-1"></a><span class="in">      t &lt;- 1:100</span></span>
<span id="cb211-1611"><a href="#cb211-1611" aria-hidden="true" tabindex="-1"></a><span class="in">      y &lt;- if_else(t &lt; c, a0, a1)</span></span>
<span id="cb211-1612"><a href="#cb211-1612" aria-hidden="true" tabindex="-1"></a><span class="in">      rs &lt;- tibble(t, y)</span></span>
<span id="cb211-1613"><a href="#cb211-1613" aria-hidden="true" tabindex="-1"></a><span class="in">      rs</span></span>
<span id="cb211-1614"><a href="#cb211-1614" aria-hidden="true" tabindex="-1"></a><span class="in">    })</span></span>
<span id="cb211-1615"><a href="#cb211-1615" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb211-1616"><a href="#cb211-1616" aria-hidden="true" tabindex="-1"></a><span class="in">  select(series) %&gt;%</span></span>
<span id="cb211-1617"><a href="#cb211-1617" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(series) %&gt;%</span></span>
<span id="cb211-1618"><a href="#cb211-1618" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(.by = t, y = mean(y), lci = quantile(y, .025), uci = quantile(y, .975)) %&gt;%</span></span>
<span id="cb211-1619"><a href="#cb211-1619" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = t)) +</span></span>
<span id="cb211-1620"><a href="#cb211-1620" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(aes(y = y)) +</span></span>
<span id="cb211-1621"><a href="#cb211-1621" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(aes(ymin = lci, ymax = uci))</span></span>
<span id="cb211-1622"><a href="#cb211-1622" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1623"><a href="#cb211-1623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1624"><a href="#cb211-1624" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cluster Analysis</span></span>
<span id="cb211-1625"><a href="#cb211-1625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1626"><a href="#cb211-1626" aria-hidden="true" tabindex="-1"></a>You can use Bayes for mixtures. Suppose you have a mixture of $z_i \in <span class="co">[</span><span class="ot">1, 2, 3</span><span class="co">]</span>$ types of grains with mean diameters of 3.8, 5, and 8mm. Given a grain of diameter $x_i$, what is its class, $z_i$?</span>
<span id="cb211-1627"><a href="#cb211-1627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1630"><a href="#cb211-1630" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-1631"><a href="#cb211-1631" aria-hidden="true" tabindex="-1"></a>cinderella <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb211-1632"><a href="#cb211-1632" aria-hidden="true" tabindex="-1"></a>  <span class="at">z =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">200</span>), <span class="fu">rep</span>(<span class="dv">2</span>, <span class="dv">100</span>), <span class="fu">rep</span>(<span class="dv">3</span>, <span class="dv">300</span>)),</span>
<span id="cb211-1633"><a href="#cb211-1633" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(<span class="dv">200</span>, <span class="fl">3.8</span>, .<span class="dv">25</span>), <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="dv">5</span>, .<span class="dv">5</span>), <span class="fu">rnorm</span>(<span class="dv">300</span>, <span class="dv">8</span>, <span class="dv">1</span>))</span>
<span id="cb211-1634"><a href="#cb211-1634" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb211-1635"><a href="#cb211-1635" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1636"><a href="#cb211-1636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1637"><a href="#cb211-1637" aria-hidden="true" tabindex="-1"></a>You might start with the assumption that $(x_i|z_i, \mu_{z_i}, \tau_{z_i}) \sim N(\mu_{z_i}, \tau_{z_i})$ and assign conjugate priors $\mu_k \sim N(\mu_{k0}, \tau_{k0})$ and $\tau_k \sim \text{Gamma}(a_k, b_k)$ for $k = 1, \ldots, 3$. To estimate the class probabilities of each grain, you need to start with a prior. $Pr(z_i = k) = 1/K = 1/3$ is a good prior.</span>
<span id="cb211-1638"><a href="#cb211-1638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1639"><a href="#cb211-1639" aria-hidden="true" tabindex="-1"></a>The problem becomes</span>
<span id="cb211-1640"><a href="#cb211-1640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1641"><a href="#cb211-1641" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1642"><a href="#cb211-1642" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-1643"><a href="#cb211-1643" aria-hidden="true" tabindex="-1"></a>Pr(z_i = k|x_i, \mu_k, \tau_k) &amp;= \frac{f(x_i|z_i = k, \mu_k, \tau_k) Pr(z_i = k)}{\sum_k f(x_i|z_i = k, \mu_k, \tau_k) Pr(z_i = k)} <span class="sc">\\</span></span>
<span id="cb211-1644"><a href="#cb211-1644" aria-hidden="true" tabindex="-1"></a>&amp;= \frac{f(x_i|z_i = k, \mu_k, \tau_k)}{\sum_k f(x_i|z_i = k, \mu_k, \tau_k)}</span>
<span id="cb211-1645"><a href="#cb211-1645" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-1646"><a href="#cb211-1646" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1647"><a href="#cb211-1647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1648"><a href="#cb211-1648" aria-hidden="true" tabindex="-1"></a><span class="in">`NMixMCMC()`</span> assigns initial values for $\mu s$, $\tau s$ and $z_i s$. Given $\mu s$ and $\tau s$, it samples $z_i s$ from the assumed distribution. For each group, $k$, sample $\mu_k$ and then $\tau_k$ from the conjugate conditional posterior distribution. Then repeat until convergence.</span>
<span id="cb211-1649"><a href="#cb211-1649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1650"><a href="#cb211-1650" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-1651"><a href="#cb211-1651" aria-hidden="true" tabindex="-1"></a><span class="in">library(mixAK)</span></span>
<span id="cb211-1652"><a href="#cb211-1652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1653"><a href="#cb211-1653" aria-hidden="true" tabindex="-1"></a><span class="in">mdl_mix &lt;- NMixMCMC(</span></span>
<span id="cb211-1654"><a href="#cb211-1654" aria-hidden="true" tabindex="-1"></a><span class="in">  y0 = cinderella$x,</span></span>
<span id="cb211-1655"><a href="#cb211-1655" aria-hidden="true" tabindex="-1"></a><span class="in">  nMCMC = c(burn = 1000, keep = 1000, thin = 1, info = 100),</span></span>
<span id="cb211-1656"><a href="#cb211-1656" aria-hidden="true" tabindex="-1"></a><span class="in">  prior = list(priorK = "fixed", Kmax = 3)</span></span>
<span id="cb211-1657"><a href="#cb211-1657" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb211-1658"><a href="#cb211-1658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1659"><a href="#cb211-1659" aria-hidden="true" tabindex="-1"></a><span class="in"># posterior means mu</span></span>
<span id="cb211-1660"><a href="#cb211-1660" aria-hidden="true" tabindex="-1"></a><span class="in">c(mdl_mix[[1]]$poster.mean.mu * sd(cinderella$x)) + mean(cinderella$x)</span></span>
<span id="cb211-1661"><a href="#cb211-1661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1662"><a href="#cb211-1662" aria-hidden="true" tabindex="-1"></a><span class="in"># posterior means for SD</span></span>
<span id="cb211-1663"><a href="#cb211-1663" aria-hidden="true" tabindex="-1"></a><span class="in">sqrt(c(unlist(mdl_mix[[1]]$poster.mean.Sigma)))*sd(cinderella$x)</span></span>
<span id="cb211-1664"><a href="#cb211-1664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1665"><a href="#cb211-1665" aria-hidden="true" tabindex="-1"></a><span class="in"># estimated class frequency distribution</span></span>
<span id="cb211-1666"><a href="#cb211-1666" aria-hidden="true" tabindex="-1"></a><span class="in">round(mdl_mix[[1]]$poster.mean.w, 2)</span></span>
<span id="cb211-1667"><a href="#cb211-1667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1668"><a href="#cb211-1668" aria-hidden="true" tabindex="-1"></a><span class="in"># estimated probability per class of first few seeds</span></span>
<span id="cb211-1669"><a href="#cb211-1669" aria-hidden="true" tabindex="-1"></a><span class="in">mdl_mix[[1]]$poster.comp.prob_u %&gt;% head()</span></span>
<span id="cb211-1670"><a href="#cb211-1670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1671"><a href="#cb211-1671" aria-hidden="true" tabindex="-1"></a><span class="in"># Marginal plot</span></span>
<span id="cb211-1672"><a href="#cb211-1672" aria-hidden="true" tabindex="-1"></a><span class="in">NMixPredDensMarg(mdl_mix[[1]], lgrid = 150) %&gt;% plot()</span></span>
<span id="cb211-1673"><a href="#cb211-1673" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1674"><a href="#cb211-1674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1675"><a href="#cb211-1675" aria-hidden="true" tabindex="-1"></a>In this case we new how many classes were in the data. If that was unknown, you could use reversible-jump MCMC which produces a posterior distribution for the number of components.</span>
<span id="cb211-1676"><a href="#cb211-1676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1677"><a href="#cb211-1677" aria-hidden="true" tabindex="-1"></a><span class="fu">## Beta Binomial and Estimating Proportions</span></span>
<span id="cb211-1678"><a href="#cb211-1678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1679"><a href="#cb211-1679" aria-hidden="true" tabindex="-1"></a>Suppose $y = 35$ of $n = 50$ seeds germinate within 72hrs. What is the expected germination probability of a single seed? Seed germination can be modeled as $n$ Bernoulli trials where events occur with probability, $p$, and the number of observed events is $y = \sum_i^n y_i$. The question is estimating the $p$ parameter in the Bernoulli generating process.</span>
<span id="cb211-1680"><a href="#cb211-1680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1681"><a href="#cb211-1681" aria-hidden="true" tabindex="-1"></a>The classical approach is to construct a 95% CI around $p$ with a <span class="co">[</span><span class="ot">one-sample proportion test</span><span class="co">](https://mpfoley73.github.io/statistics/one-sample-proportion-z-test.html)</span>.</span>
<span id="cb211-1682"><a href="#cb211-1682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1685"><a href="#cb211-1685" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-1686"><a href="#cb211-1686" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">35</span></span>
<span id="cb211-1687"><a href="#cb211-1687" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb211-1688"><a href="#cb211-1688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1689"><a href="#cb211-1689" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.test</span>(y, n)</span>
<span id="cb211-1690"><a href="#cb211-1690" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1691"><a href="#cb211-1691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1692"><a href="#cb211-1692" aria-hidden="true" tabindex="-1"></a>The Bayesian approach is to posit an expected distribution of $p$ *prior* to observing the data, then update the distribution based on the relative *likelihood* of observing the data given the values in the distribution. The likelihood of $y$ events in $n$ trials follows the binomial distribution, $y|p \sim \text{Bin}(n, p)$.</span>
<span id="cb211-1693"><a href="#cb211-1693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1694"><a href="#cb211-1694" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1695"><a href="#cb211-1695" aria-hidden="true" tabindex="-1"></a>f(y|p) = {n \choose y} p^y (1-p)^{n-y}</span>
<span id="cb211-1696"><a href="#cb211-1696" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1697"><a href="#cb211-1697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1698"><a href="#cb211-1698" aria-hidden="true" tabindex="-1"></a>Start with a uniform prior - all values of $p$ are equally likely. To get a feel for the approach, try this with *discrete* $p$ values first.</span>
<span id="cb211-1699"><a href="#cb211-1699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1700"><a href="#cb211-1700" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE, warning=FALSE}</span></span>
<span id="cb211-1701"><a href="#cb211-1701" aria-hidden="true" tabindex="-1"></a><span class="in"># Explore the parameter space [0,1] in discrete .01 increments.</span></span>
<span id="cb211-1702"><a href="#cb211-1702" aria-hidden="true" tabindex="-1"></a><span class="in">p &lt;- seq(0, 1, by = 0.01)</span></span>
<span id="cb211-1703"><a href="#cb211-1703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1704"><a href="#cb211-1704" aria-hidden="true" tabindex="-1"></a><span class="in"># Prior distribution is uniform, 1/101 for all p's.</span></span>
<span id="cb211-1705"><a href="#cb211-1705" aria-hidden="true" tabindex="-1"></a><span class="in">prior &lt;- rep(1/length(p), length(p))</span></span>
<span id="cb211-1706"><a href="#cb211-1706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1707"><a href="#cb211-1707" aria-hidden="true" tabindex="-1"></a><span class="in"># Binomial likelihood of each p given 35/50 successes.</span></span>
<span id="cb211-1708"><a href="#cb211-1708" aria-hidden="true" tabindex="-1"></a><span class="in">likelihood &lt;- dbinom(35, 50, p)</span></span>
<span id="cb211-1709"><a href="#cb211-1709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1710"><a href="#cb211-1710" aria-hidden="true" tabindex="-1"></a><span class="in"># Bayes' Theorem: posterior = joint density / marginal density.</span></span>
<span id="cb211-1711"><a href="#cb211-1711" aria-hidden="true" tabindex="-1"></a><span class="in">joint_density &lt;- likelihood * prior</span></span>
<span id="cb211-1712"><a href="#cb211-1712" aria-hidden="true" tabindex="-1"></a><span class="in">marginal_density &lt;- sum(joint_density)</span></span>
<span id="cb211-1713"><a href="#cb211-1713" aria-hidden="true" tabindex="-1"></a><span class="in">posterior &lt;- joint_density / marginal_density</span></span>
<span id="cb211-1714"><a href="#cb211-1714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1715"><a href="#cb211-1715" aria-hidden="true" tabindex="-1"></a><span class="in"># 95% credible interval</span></span>
<span id="cb211-1716"><a href="#cb211-1716" aria-hidden="true" tabindex="-1"></a><span class="in">(pi &lt;- sum(posterior * p) / sum(posterior))</span></span>
<span id="cb211-1717"><a href="#cb211-1717" aria-hidden="true" tabindex="-1"></a><span class="in">(ci &lt;- p[c(min(which(cumsum(posterior) &gt; .025)),</span></span>
<span id="cb211-1718"><a href="#cb211-1718" aria-hidden="true" tabindex="-1"></a><span class="in">          max(which(cumsum(posterior) &lt; .975)))])</span></span>
<span id="cb211-1719"><a href="#cb211-1719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1720"><a href="#cb211-1720" aria-hidden="true" tabindex="-1"></a><span class="in">tibble(p, prior, update = likelihood / marginal_density / 101, posterior) %&gt;%</span></span>
<span id="cb211-1721"><a href="#cb211-1721" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(c(prior, update, posterior)) %&gt;%</span></span>
<span id="cb211-1722"><a href="#cb211-1722" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(name = factor(name, levels = c("prior", "update", "posterior"))) %&gt;%</span></span>
<span id="cb211-1723"><a href="#cb211-1723" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = p)) +</span></span>
<span id="cb211-1724"><a href="#cb211-1724" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(aes(y = value, color = name)) +</span></span>
<span id="cb211-1725"><a href="#cb211-1725" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_area(data = tibble(p, posterior, y = if_else(p &lt;= ci[1], posterior, NA_real_)),</span></span>
<span id="cb211-1726"><a href="#cb211-1726" aria-hidden="true" tabindex="-1"></a><span class="in">            aes(y = y), fill = "#619CFF") +</span></span>
<span id="cb211-1727"><a href="#cb211-1727" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_area(data = tibble(p, posterior, y = if_else(p &gt;= ci[2], posterior, NA_real_)),</span></span>
<span id="cb211-1728"><a href="#cb211-1728" aria-hidden="true" tabindex="-1"></a><span class="in">            aes(y = y), fill = "#619CFF") +</span></span>
<span id="cb211-1729"><a href="#cb211-1729" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(aes(xintercept = pi), color = "#619CFF") +</span></span>
<span id="cb211-1730"><a href="#cb211-1730" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(breaks = round(c(seq(0, 1, 1), ci, pi), 4)) +</span></span>
<span id="cb211-1731"><a href="#cb211-1731" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(y = "density", color = NULL, title = "From Prior to Posterior",</span></span>
<span id="cb211-1732"><a href="#cb211-1732" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Data: y=35, n=50. Posterior equals update.")</span></span>
<span id="cb211-1733"><a href="#cb211-1733" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1734"><a href="#cb211-1734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1735"><a href="#cb211-1735" aria-hidden="true" tabindex="-1"></a>This was good, but we could have done better. The discrete values for the uniform prior limited the precision of the 95% CI. The better path is to model continuous values with the <span class="co">[</span><span class="ot">beta</span><span class="co">](https://mpfoley73.github.io/probability/random-variables-and-distributions.html#beta)</span> distribution, $p \sim \text{Beta}(a, b)$. The PDF of the beta distribution is</span>
<span id="cb211-1736"><a href="#cb211-1736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1737"><a href="#cb211-1737" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1738"><a href="#cb211-1738" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-1739"><a href="#cb211-1739" aria-hidden="true" tabindex="-1"></a>f(p) &amp;= \frac{1}{\text{B}(a,b)} p^{a-1} (1-p)^{b-1} <span class="sc">\\</span></span>
<span id="cb211-1740"><a href="#cb211-1740" aria-hidden="true" tabindex="-1"></a>&amp;\propto p^{a-1} (1 - p)^{b -1}</span>
<span id="cb211-1741"><a href="#cb211-1741" aria-hidden="true" tabindex="-1"></a>(<span class="sc">\#</span>eq:beta-prior)</span>
<span id="cb211-1742"><a href="#cb211-1742" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-1743"><a href="#cb211-1743" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1744"><a href="#cb211-1744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1745"><a href="#cb211-1745" aria-hidden="true" tabindex="-1"></a>where $a$ is the success count, $b$ the failure count, and $\text{B} = \frac{\Gamma(a)\Gamma(b)}{\Gamma(a+b)}$ is the beta function. Equation \@ref(eq:beta-prior) is called the beta prior. The beta prior is a *conjugate* prior, meaning the posterior distribution is also a beta distribution, so the $\frac{1}{\text{B}(a,b)}$ cancels out and the proportional form is all you need. The uniform prior distribution would be modeled with $\text{Beta}(1, 1)$.</span>
<span id="cb211-1746"><a href="#cb211-1746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1747"><a href="#cb211-1747" aria-hidden="true" tabindex="-1"></a>The *likelihood* of observing $y$ successes in $n$ trials given $p$ follows the binomial PMF. The constant binomial coefficient can be discarded.</span>
<span id="cb211-1748"><a href="#cb211-1748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1749"><a href="#cb211-1749" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1750"><a href="#cb211-1750" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-1751"><a href="#cb211-1751" aria-hidden="true" tabindex="-1"></a>f(y|p) &amp;= {n \choose y} p^y (1-p)^{n-y} <span class="sc">\\</span></span>
<span id="cb211-1752"><a href="#cb211-1752" aria-hidden="true" tabindex="-1"></a>&amp;\propto p^y (1-p)^{n-y}</span>
<span id="cb211-1753"><a href="#cb211-1753" aria-hidden="true" tabindex="-1"></a>(<span class="sc">\#</span>eq:beta-likelihood)</span>
<span id="cb211-1754"><a href="#cb211-1754" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-1755"><a href="#cb211-1755" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1756"><a href="#cb211-1756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1757"><a href="#cb211-1757" aria-hidden="true" tabindex="-1"></a>The product of the prior and likelihood is the joint density. The marginal density is the integral of the joint density over all $p$.</span>
<span id="cb211-1758"><a href="#cb211-1758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1759"><a href="#cb211-1759" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1760"><a href="#cb211-1760" aria-hidden="true" tabindex="-1"></a>\begin{equation}</span>
<span id="cb211-1761"><a href="#cb211-1761" aria-hidden="true" tabindex="-1"></a>\int_{p=0}^1f(y|p) f(p) dp = \frac{\text{B}(a + y, b + (n-y))}{\text{B}(a, b)}</span>
<span id="cb211-1762"><a href="#cb211-1762" aria-hidden="true" tabindex="-1"></a>(<span class="sc">\#</span>eq:beta-marginal)</span>
<span id="cb211-1763"><a href="#cb211-1763" aria-hidden="true" tabindex="-1"></a>\end{equation}</span>
<span id="cb211-1764"><a href="#cb211-1764" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1765"><a href="#cb211-1765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1766"><a href="#cb211-1766" aria-hidden="true" tabindex="-1"></a>Using the proportional forms, the denominator of Bayes' Theorem can be discarded, so the posterior distribution is just the joint density.</span>
<span id="cb211-1767"><a href="#cb211-1767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1768"><a href="#cb211-1768" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1769"><a href="#cb211-1769" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-1770"><a href="#cb211-1770" aria-hidden="true" tabindex="-1"></a>f(p|y) &amp; \propto f(y|p)f(p) <span class="sc">\\</span></span>
<span id="cb211-1771"><a href="#cb211-1771" aria-hidden="true" tabindex="-1"></a>&amp; \propto p^y (1-p)^{n-y} p^{a-1} (1 - p)^{b -1} <span class="sc">\\</span></span>
<span id="cb211-1772"><a href="#cb211-1772" aria-hidden="true" tabindex="-1"></a>&amp; \propto p^{a+y-1}(1-p)^{b+n-y-1} <span class="sc">\\</span></span>
<span id="cb211-1773"><a href="#cb211-1773" aria-hidden="true" tabindex="-1"></a>&amp; \sim \text{Beta}(a + y, b + (n - y))</span>
<span id="cb211-1774"><a href="#cb211-1774" aria-hidden="true" tabindex="-1"></a>(<span class="sc">\#</span>eq:beta-posterior)</span>
<span id="cb211-1775"><a href="#cb211-1775" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-1776"><a href="#cb211-1776" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1777"><a href="#cb211-1777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1778"><a href="#cb211-1778" aria-hidden="true" tabindex="-1"></a>The expected value of the beta distribution is $a / (a + b)$. Updated with the observed data, the expected value is</span>
<span id="cb211-1779"><a href="#cb211-1779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1780"><a href="#cb211-1780" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1781"><a href="#cb211-1781" aria-hidden="true" tabindex="-1"></a>E(p|y) = \frac{a+y}{(a+y)+(b+(n-y))} = \frac{a + y}{a + b + n} = \frac{a + n \bar{y}}{a + b + n}</span>
<span id="cb211-1782"><a href="#cb211-1782" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1783"><a href="#cb211-1783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1784"><a href="#cb211-1784" aria-hidden="true" tabindex="-1"></a>As the sample size increases, the $a$ and $b$ prior parameter values become less important and $E(p|y)$ converges on the classical result of $\bar{y}$. The code chunk below repeats the exercise above. This time that we can calculate a continuous 95% CI. Notice also that the marginal density never actually factored into the solution.</span>
<span id="cb211-1785"><a href="#cb211-1785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1786"><a href="#cb211-1786" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE, warning=FALSE}</span></span>
<span id="cb211-1787"><a href="#cb211-1787" aria-hidden="true" tabindex="-1"></a><span class="in"># These discrete p's are for illustrating the distributions now.</span></span>
<span id="cb211-1788"><a href="#cb211-1788" aria-hidden="true" tabindex="-1"></a><span class="in">p &lt;- seq(0, 1, by = 0.001)</span></span>
<span id="cb211-1789"><a href="#cb211-1789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1790"><a href="#cb211-1790" aria-hidden="true" tabindex="-1"></a><span class="in"># The prior distribution is uniform, Beta(1, 1).</span></span>
<span id="cb211-1791"><a href="#cb211-1791" aria-hidden="true" tabindex="-1"></a><span class="in">a &lt;- 1</span></span>
<span id="cb211-1792"><a href="#cb211-1792" aria-hidden="true" tabindex="-1"></a><span class="in">b &lt;- 1</span></span>
<span id="cb211-1793"><a href="#cb211-1793" aria-hidden="true" tabindex="-1"></a><span class="in">prior &lt;- dbeta(p, a, b)</span></span>
<span id="cb211-1794"><a href="#cb211-1794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1795"><a href="#cb211-1795" aria-hidden="true" tabindex="-1"></a><span class="in"># Instead of calculating the likelihood, joint density, marginal density, and</span></span>
<span id="cb211-1796"><a href="#cb211-1796" aria-hidden="true" tabindex="-1"></a><span class="in"># finally the posterior, we can go straight to the posterior.</span></span>
<span id="cb211-1797"><a href="#cb211-1797" aria-hidden="true" tabindex="-1"></a><span class="in">posterior &lt;- dbeta(p, a + y, b + (n - y))</span></span>
<span id="cb211-1798"><a href="#cb211-1798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1799"><a href="#cb211-1799" aria-hidden="true" tabindex="-1"></a><span class="in"># 95% credible interval. This time we don't need p - we can go straight to the soln.</span></span>
<span id="cb211-1800"><a href="#cb211-1800" aria-hidden="true" tabindex="-1"></a><span class="in">(pi &lt;- (a + y) / ((a + y) + (b + (n - y))))</span></span>
<span id="cb211-1801"><a href="#cb211-1801" aria-hidden="true" tabindex="-1"></a><span class="in">(ci &lt;- qbeta(c(.025, .975), a + y, b + (n - y)))</span></span>
<span id="cb211-1802"><a href="#cb211-1802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1803"><a href="#cb211-1803" aria-hidden="true" tabindex="-1"></a><span class="in"># Construct the components anyway, just to graph them.</span></span>
<span id="cb211-1804"><a href="#cb211-1804" aria-hidden="true" tabindex="-1"></a><span class="in">likelihood &lt;- dbinom(y, n, p)</span></span>
<span id="cb211-1805"><a href="#cb211-1805" aria-hidden="true" tabindex="-1"></a><span class="in">joint_density &lt;- likelihood * prior</span></span>
<span id="cb211-1806"><a href="#cb211-1806" aria-hidden="true" tabindex="-1"></a><span class="in">marginal_density &lt;- sum(joint_density)</span></span>
<span id="cb211-1807"><a href="#cb211-1807" aria-hidden="true" tabindex="-1"></a><span class="in"># Trickery to get discretely calculated joint and marginal densities to sum to</span></span>
<span id="cb211-1808"><a href="#cb211-1808" aria-hidden="true" tabindex="-1"></a><span class="in"># same area as prior and posterior distributions.</span></span>
<span id="cb211-1809"><a href="#cb211-1809" aria-hidden="true" tabindex="-1"></a><span class="in">update &lt;- likelihood / (sum(likelihood) / sum(posterior))</span></span>
<span id="cb211-1810"><a href="#cb211-1810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1811"><a href="#cb211-1811" aria-hidden="true" tabindex="-1"></a><span class="in">tibble(p, prior, update, posterior) %&gt;%</span></span>
<span id="cb211-1812"><a href="#cb211-1812" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(c(prior, update, posterior)) %&gt;%</span></span>
<span id="cb211-1813"><a href="#cb211-1813" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(name = factor(name, levels = c("prior", "update", "posterior"))) %&gt;%</span></span>
<span id="cb211-1814"><a href="#cb211-1814" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = p)) +</span></span>
<span id="cb211-1815"><a href="#cb211-1815" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(aes(y = value, color = name)) +</span></span>
<span id="cb211-1816"><a href="#cb211-1816" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_area(data = tibble(p, posterior, y = if_else(p &lt;= ci[1], posterior, NA_real_)),</span></span>
<span id="cb211-1817"><a href="#cb211-1817" aria-hidden="true" tabindex="-1"></a><span class="in">            aes(y = y), fill = "#619CFF") +</span></span>
<span id="cb211-1818"><a href="#cb211-1818" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_area(data = tibble(p, posterior, y = if_else(p &gt;= ci[2], posterior, NA_real_)),</span></span>
<span id="cb211-1819"><a href="#cb211-1819" aria-hidden="true" tabindex="-1"></a><span class="in">            aes(y = y), fill = "#619CFF") +</span></span>
<span id="cb211-1820"><a href="#cb211-1820" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(aes(xintercept = pi), color = "#619CFF") +</span></span>
<span id="cb211-1821"><a href="#cb211-1821" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(breaks = round(c(seq(0, 1, 1), ci, pi), 4)) +</span></span>
<span id="cb211-1822"><a href="#cb211-1822" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(y = "density", color = NULL, title = glue("From Prior to Posterior, using Beta({a}, {b}) prior."),</span></span>
<span id="cb211-1823"><a href="#cb211-1823" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Data: y=35, n=50.")</span></span>
<span id="cb211-1824"><a href="#cb211-1824" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1825"><a href="#cb211-1825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1826"><a href="#cb211-1826" aria-hidden="true" tabindex="-1"></a>Suppose your prior was better. You had taken a small sample of 10 and 7 seeds had germinated. The corroborating evidence centers on 70% and the credible interval tightens.</span>
<span id="cb211-1827"><a href="#cb211-1827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1828"><a href="#cb211-1828" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, warning=FALSE}</span></span>
<span id="cb211-1829"><a href="#cb211-1829" aria-hidden="true" tabindex="-1"></a><span class="in"># These discrete p's are for illustrating the distributions now.</span></span>
<span id="cb211-1830"><a href="#cb211-1830" aria-hidden="true" tabindex="-1"></a><span class="in">p &lt;- seq(0, 1, by = 0.001)</span></span>
<span id="cb211-1831"><a href="#cb211-1831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1832"><a href="#cb211-1832" aria-hidden="true" tabindex="-1"></a><span class="in"># The prior distribution is uniform, Beta(1, 1).</span></span>
<span id="cb211-1833"><a href="#cb211-1833" aria-hidden="true" tabindex="-1"></a><span class="in">a &lt;- 7</span></span>
<span id="cb211-1834"><a href="#cb211-1834" aria-hidden="true" tabindex="-1"></a><span class="in">b &lt;- 3</span></span>
<span id="cb211-1835"><a href="#cb211-1835" aria-hidden="true" tabindex="-1"></a><span class="in">prior &lt;- dbeta(p, a, b)</span></span>
<span id="cb211-1836"><a href="#cb211-1836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1837"><a href="#cb211-1837" aria-hidden="true" tabindex="-1"></a><span class="in"># Instead of calculating the likelihood, joint density, marginal density, and</span></span>
<span id="cb211-1838"><a href="#cb211-1838" aria-hidden="true" tabindex="-1"></a><span class="in"># finally the posterior, we can go straight to the posterior.</span></span>
<span id="cb211-1839"><a href="#cb211-1839" aria-hidden="true" tabindex="-1"></a><span class="in">posterior &lt;- dbeta(p, a + y, b + (n - y))</span></span>
<span id="cb211-1840"><a href="#cb211-1840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1841"><a href="#cb211-1841" aria-hidden="true" tabindex="-1"></a><span class="in"># 95% credible interval. This time we don't need p - we can go straight to the soln.</span></span>
<span id="cb211-1842"><a href="#cb211-1842" aria-hidden="true" tabindex="-1"></a><span class="in">pi &lt;- (a + y) / ((a + y) + (b + (n - y)))</span></span>
<span id="cb211-1843"><a href="#cb211-1843" aria-hidden="true" tabindex="-1"></a><span class="in">ci &lt;- qbeta(c(.025, .975), a + y, b + (n - y))</span></span>
<span id="cb211-1844"><a href="#cb211-1844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1845"><a href="#cb211-1845" aria-hidden="true" tabindex="-1"></a><span class="in"># Construct the components anyway, just to graph them.</span></span>
<span id="cb211-1846"><a href="#cb211-1846" aria-hidden="true" tabindex="-1"></a><span class="in">likelihood &lt;- dbinom(y, n, p)</span></span>
<span id="cb211-1847"><a href="#cb211-1847" aria-hidden="true" tabindex="-1"></a><span class="in">joint_density &lt;- likelihood * prior</span></span>
<span id="cb211-1848"><a href="#cb211-1848" aria-hidden="true" tabindex="-1"></a><span class="in">marginal_density &lt;- sum(joint_density)</span></span>
<span id="cb211-1849"><a href="#cb211-1849" aria-hidden="true" tabindex="-1"></a><span class="in"># Trickery to get discretely calculated joint and marginal densities to sum to</span></span>
<span id="cb211-1850"><a href="#cb211-1850" aria-hidden="true" tabindex="-1"></a><span class="in"># same area as prior and posterior distributions.</span></span>
<span id="cb211-1851"><a href="#cb211-1851" aria-hidden="true" tabindex="-1"></a><span class="in">update &lt;- likelihood / (sum(likelihood) / sum(posterior))</span></span>
<span id="cb211-1852"><a href="#cb211-1852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1853"><a href="#cb211-1853" aria-hidden="true" tabindex="-1"></a><span class="in">tibble(p, prior, update, posterior) %&gt;%</span></span>
<span id="cb211-1854"><a href="#cb211-1854" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(c(prior, update, posterior)) %&gt;%</span></span>
<span id="cb211-1855"><a href="#cb211-1855" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(name = factor(name, levels = c("prior", "update", "posterior"))) %&gt;%</span></span>
<span id="cb211-1856"><a href="#cb211-1856" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = p)) +</span></span>
<span id="cb211-1857"><a href="#cb211-1857" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(aes(y = value, color = name)) +</span></span>
<span id="cb211-1858"><a href="#cb211-1858" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_area(data = tibble(p, posterior, y = if_else(p &lt;= ci[1], posterior, NA_real_)),</span></span>
<span id="cb211-1859"><a href="#cb211-1859" aria-hidden="true" tabindex="-1"></a><span class="in">            aes(y = y), fill = "#619CFF") +</span></span>
<span id="cb211-1860"><a href="#cb211-1860" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_area(data = tibble(p, posterior, y = if_else(p &gt;= ci[2], posterior, NA_real_)),</span></span>
<span id="cb211-1861"><a href="#cb211-1861" aria-hidden="true" tabindex="-1"></a><span class="in">            aes(y = y), fill = "#619CFF") +</span></span>
<span id="cb211-1862"><a href="#cb211-1862" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(aes(xintercept = pi), color = "#619CFF") +</span></span>
<span id="cb211-1863"><a href="#cb211-1863" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(breaks = round(c(seq(0, 1, 1), ci, pi), 4)) +</span></span>
<span id="cb211-1864"><a href="#cb211-1864" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(y = "density", color = NULL, title = glue("From Prior to Posterior, using Beta({a}, {b}) prior."),</span></span>
<span id="cb211-1865"><a href="#cb211-1865" aria-hidden="true" tabindex="-1"></a><span class="in">       subtitle = "Data: y=35, n=50.")</span></span>
<span id="cb211-1866"><a href="#cb211-1866" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1867"><a href="#cb211-1867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1868"><a href="#cb211-1868" aria-hidden="true" tabindex="-1"></a><span class="fu">## Zero-Inflation and Latent Variables</span></span>
<span id="cb211-1869"><a href="#cb211-1869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1870"><a href="#cb211-1870" aria-hidden="true" tabindex="-1"></a>Suppose 100 persons report the number of days per week they consume alcohol (0 - 7). What is the posterior estimated probability of a person having a drink on any given day? Drinking days _should_ follow a binomial distribution, so you _should_ be able to estimate $p$ using a $\text{Beta}(1, 1)$ prior. The beta posterior would be $\text{Beta}(252, 450)$.</span>
<span id="cb211-1871"><a href="#cb211-1871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1872"><a href="#cb211-1872" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-1873"><a href="#cb211-1873" aria-hidden="true" tabindex="-1"></a><span class="in">days &lt;- 0:7</span></span>
<span id="cb211-1874"><a href="#cb211-1874" aria-hidden="true" tabindex="-1"></a><span class="in">respondents &lt;- c(22, 6, 18, 23, 18, 10, 3, 0)</span></span>
<span id="cb211-1875"><a href="#cb211-1875" aria-hidden="true" tabindex="-1"></a><span class="in">y &lt;- rep(days, respondents)</span></span>
<span id="cb211-1876"><a href="#cb211-1876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1877"><a href="#cb211-1877" aria-hidden="true" tabindex="-1"></a><span class="in"># Total events</span></span>
<span id="cb211-1878"><a href="#cb211-1878" aria-hidden="true" tabindex="-1"></a><span class="in">(drinking_days &lt;- sum(y))</span></span>
<span id="cb211-1879"><a href="#cb211-1879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1880"><a href="#cb211-1880" aria-hidden="true" tabindex="-1"></a><span class="in"># Possible events</span></span>
<span id="cb211-1881"><a href="#cb211-1881" aria-hidden="true" tabindex="-1"></a><span class="in">(n &lt;- 7 * 100)</span></span>
<span id="cb211-1882"><a href="#cb211-1882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1883"><a href="#cb211-1883" aria-hidden="true" tabindex="-1"></a><span class="in"># Beta posterior</span></span>
<span id="cb211-1884"><a href="#cb211-1884" aria-hidden="true" tabindex="-1"></a><span class="in">(a &lt;- 1 + drinking_days)</span></span>
<span id="cb211-1885"><a href="#cb211-1885" aria-hidden="true" tabindex="-1"></a><span class="in">(b &lt;- 1 + (n - drinking_days))</span></span>
<span id="cb211-1886"><a href="#cb211-1886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1887"><a href="#cb211-1887" aria-hidden="true" tabindex="-1"></a><span class="in"># Posterior mean and 95% CI.</span></span>
<span id="cb211-1888"><a href="#cb211-1888" aria-hidden="true" tabindex="-1"></a><span class="in">a / (a + b)</span></span>
<span id="cb211-1889"><a href="#cb211-1889" aria-hidden="true" tabindex="-1"></a><span class="in">qbeta(c(.025, .975), a, b)</span></span>
<span id="cb211-1890"><a href="#cb211-1890" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1891"><a href="#cb211-1891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1892"><a href="#cb211-1892" aria-hidden="true" tabindex="-1"></a>The predictive distribution of $\tilde{y}$ is $f(\tilde{y}|y) = \int f(\tilde{y}|p) f(p|y) dp$. The way you would normally solve this is to run a simulation. Sample a thousand $p$'s from the posterior beta distribution, then use them to sample 100 respondents from the binomial distribution.</span>
<span id="cb211-1893"><a href="#cb211-1893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1894"><a href="#cb211-1894" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-1895"><a href="#cb211-1895" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345)</span></span>
<span id="cb211-1896"><a href="#cb211-1896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1897"><a href="#cb211-1897" aria-hidden="true" tabindex="-1"></a><span class="in">p_given_y &lt;- rbeta(10^3, a, b)</span></span>
<span id="cb211-1898"><a href="#cb211-1898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1899"><a href="#cb211-1899" aria-hidden="true" tabindex="-1"></a><span class="in"># For each p, simulate 7 draws from binomial distribution for the 100 respondents.</span></span>
<span id="cb211-1900"><a href="#cb211-1900" aria-hidden="true" tabindex="-1"></a><span class="in">sims &lt;- map(p_given_y, ~rbinom(100, 7, .))</span></span>
<span id="cb211-1901"><a href="#cb211-1901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1902"><a href="#cb211-1902" aria-hidden="true" tabindex="-1"></a><span class="in"># Count the number of times y == [0,7]. Start by converting the 10^3 sims x 100 </span></span>
<span id="cb211-1903"><a href="#cb211-1903" aria-hidden="true" tabindex="-1"></a><span class="in"># participants list into an 8 days x 10^3 sims list. The three metrics are </span></span>
<span id="cb211-1904"><a href="#cb211-1904" aria-hidden="true" tabindex="-1"></a><span class="in"># vectors of length 8.</span></span>
<span id="cb211-1905"><a href="#cb211-1905" aria-hidden="true" tabindex="-1"></a><span class="in">sim_y_per_days &lt;- map(days, function(x) map_int(sims, ~sum(. == x)))</span></span>
<span id="cb211-1906"><a href="#cb211-1906" aria-hidden="true" tabindex="-1"></a><span class="in">means &lt;- map_dbl(sim_y_per_days, mean)</span></span>
<span id="cb211-1907"><a href="#cb211-1907" aria-hidden="true" tabindex="-1"></a><span class="in">lcl &lt;- map_dbl(sim_y_per_days, ~quantile(.x, .025))</span></span>
<span id="cb211-1908"><a href="#cb211-1908" aria-hidden="true" tabindex="-1"></a><span class="in">ucl &lt;- map_dbl(sim_y_per_days, ~quantile(.x, .975))</span></span>
<span id="cb211-1909"><a href="#cb211-1909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1910"><a href="#cb211-1910" aria-hidden="true" tabindex="-1"></a><span class="in">tibble(days, respondents, means, lcl, ucl) %&gt;%</span></span>
<span id="cb211-1911"><a href="#cb211-1911" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = days)) +</span></span>
<span id="cb211-1912"><a href="#cb211-1912" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_col(aes(y = respondents)) +</span></span>
<span id="cb211-1913"><a href="#cb211-1913" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(aes(y = means)) +</span></span>
<span id="cb211-1914"><a href="#cb211-1914" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(aes(ymin = lcl, ymax = ucl), width = .2) +</span></span>
<span id="cb211-1915"><a href="#cb211-1915" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(breaks = 0:7)</span></span>
<span id="cb211-1916"><a href="#cb211-1916" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1917"><a href="#cb211-1917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1918"><a href="#cb211-1918" aria-hidden="true" tabindex="-1"></a>Uh oh! The problem is that the number of drinking days only follows a binomial distribution for drinkers - abstainers have $p$ = 0. This phenomena is called zero-inflation. The solution is to model $p$ conditional on the probability the person drinks, $\omega$. Let $z_i = 1$ if respondent $i$ drinks alcohol at all. Then $(y_i|z_i = 1, p) \sim \text{Bin}(7, p)$, otherwise $P(y_i =0|z_i = 0) = 1$. Model the probability of $z_i = 0$ with the Bernoulli distribution, $z_i|\omega \sim \text{Bern}(\omega)$ where $\omega \sim \text{Beta}(a_\omega, b_\omega)$.</span>
<span id="cb211-1919"><a href="#cb211-1919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1920"><a href="#cb211-1920" aria-hidden="true" tabindex="-1"></a>Implement a Gibbs sampler with uniform priors for $p \sim \text{Beta}(a = 1, b = 1)$ and $\omega \sim \text{Beta}(a_\omega = 1, b_\omega = 1)$. Start with the assumption that if $y_i = 0$ then $z_i = 0$, so for each respondent</span>
<span id="cb211-1921"><a href="#cb211-1921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1922"><a href="#cb211-1922" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1923"><a href="#cb211-1923" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-1924"><a href="#cb211-1924" aria-hidden="true" tabindex="-1"></a>P(z_i = 1| y_i &gt; 0, p, \omega) &amp;= 1 <span class="sc">\\</span></span>
<span id="cb211-1925"><a href="#cb211-1925" aria-hidden="true" tabindex="-1"></a>P(z_i = 1| y_i = 0, p, \omega) &amp;= \frac{(1-p)^7 \omega}{(1-\omega) + (1-p)^7 \omega}</span>
<span id="cb211-1926"><a href="#cb211-1926" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-1927"><a href="#cb211-1927" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-1928"><a href="#cb211-1928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1929"><a href="#cb211-1929" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-1930"><a href="#cb211-1930" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345)</span></span>
<span id="cb211-1931"><a href="#cb211-1931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1932"><a href="#cb211-1932" aria-hidden="true" tabindex="-1"></a><span class="in"># Start with assumption that if they reported 0, they _never_ drink (y_i=0 -&gt; z_i=0).</span></span>
<span id="cb211-1933"><a href="#cb211-1933" aria-hidden="true" tabindex="-1"></a><span class="in">z &lt;- as.numeric(y &gt;= 1)</span></span>
<span id="cb211-1934"><a href="#cb211-1934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1935"><a href="#cb211-1935" aria-hidden="true" tabindex="-1"></a><span class="in"># Run 1,000 iterations, updating p, omega, and z each time.</span></span>
<span id="cb211-1936"><a href="#cb211-1936" aria-hidden="true" tabindex="-1"></a><span class="in">ITER &lt;- 10^3</span></span>
<span id="cb211-1937"><a href="#cb211-1937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1938"><a href="#cb211-1938" aria-hidden="true" tabindex="-1"></a><span class="in"># Create monitors to track convergence.</span></span>
<span id="cb211-1939"><a href="#cb211-1939" aria-hidden="true" tabindex="-1"></a><span class="in">sim_p &lt;- numeric(ITER)</span></span>
<span id="cb211-1940"><a href="#cb211-1940" aria-hidden="true" tabindex="-1"></a><span class="in">sim_omega &lt;- numeric(ITER)</span></span>
<span id="cb211-1941"><a href="#cb211-1941" aria-hidden="true" tabindex="-1"></a><span class="in">sim_z &lt;- matrix(nrow = length(y), ncol = ITER)</span></span>
<span id="cb211-1942"><a href="#cb211-1942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1943"><a href="#cb211-1943" aria-hidden="true" tabindex="-1"></a><span class="in"># Gibbs sampler.</span></span>
<span id="cb211-1944"><a href="#cb211-1944" aria-hidden="true" tabindex="-1"></a><span class="in">for(iter in 1:ITER) {</span></span>
<span id="cb211-1945"><a href="#cb211-1945" aria-hidden="true" tabindex="-1"></a><span class="in">  # Uniform Beta(1,1) prior for probability the person is a drinker. Posterior </span></span>
<span id="cb211-1946"><a href="#cb211-1946" aria-hidden="true" tabindex="-1"></a><span class="in">  # is based on count of non-zero z's.</span></span>
<span id="cb211-1947"><a href="#cb211-1947" aria-hidden="true" tabindex="-1"></a><span class="in">  omega &lt;- rbeta(1, 1 + sum(z), 1 + (length(z) - sum(z)))</span></span>
<span id="cb211-1948"><a href="#cb211-1948" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb211-1949"><a href="#cb211-1949" aria-hidden="true" tabindex="-1"></a><span class="in">  # Uniform Beta(1,1) prior for probability of drinking on any given day. Posterior</span></span>
<span id="cb211-1950"><a href="#cb211-1950" aria-hidden="true" tabindex="-1"></a><span class="in">  # is based on reported drinking days and number of people who are drinkers.</span></span>
<span id="cb211-1951"><a href="#cb211-1951" aria-hidden="true" tabindex="-1"></a><span class="in">  p &lt;- rbeta(1, 1 + sum(y), 1 + (7 * sum(z) - sum(y)))</span></span>
<span id="cb211-1952"><a href="#cb211-1952" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb211-1953"><a href="#cb211-1953" aria-hidden="true" tabindex="-1"></a><span class="in">  # Updated probability that respondent is a drinker. </span></span>
<span id="cb211-1954"><a href="#cb211-1954" aria-hidden="true" tabindex="-1"></a><span class="in">  # P(z=1|y&gt;0) = 1 or P(z=1|y=0, p, omega).</span></span>
<span id="cb211-1955"><a href="#cb211-1955" aria-hidden="true" tabindex="-1"></a><span class="in">  prob_z_eq_1 &lt;- if_else(y &gt;= 1, 1, </span></span>
<span id="cb211-1956"><a href="#cb211-1956" aria-hidden="true" tabindex="-1"></a><span class="in">                         ((1 - p)^7 * omega) / ((1 - omega) + ((1 - p)^7 * omega)))</span></span>
<span id="cb211-1957"><a href="#cb211-1957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1958"><a href="#cb211-1958" aria-hidden="true" tabindex="-1"></a><span class="in">  # Update z.</span></span>
<span id="cb211-1959"><a href="#cb211-1959" aria-hidden="true" tabindex="-1"></a><span class="in">  z &lt;- rbinom(100, 1, prob_z_eq_1)</span></span>
<span id="cb211-1960"><a href="#cb211-1960" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb211-1961"><a href="#cb211-1961" aria-hidden="true" tabindex="-1"></a><span class="in">  # update monitors</span></span>
<span id="cb211-1962"><a href="#cb211-1962" aria-hidden="true" tabindex="-1"></a><span class="in">  sim_p[iter] &lt;- p</span></span>
<span id="cb211-1963"><a href="#cb211-1963" aria-hidden="true" tabindex="-1"></a><span class="in">  sim_omega[iter] &lt;- omega</span></span>
<span id="cb211-1964"><a href="#cb211-1964" aria-hidden="true" tabindex="-1"></a><span class="in">  sim_z[, iter] &lt;- z</span></span>
<span id="cb211-1965"><a href="#cb211-1965" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb211-1966"><a href="#cb211-1966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1967"><a href="#cb211-1967" aria-hidden="true" tabindex="-1"></a><span class="in"># Estimated probability of being an alcohol drinker.</span></span>
<span id="cb211-1968"><a href="#cb211-1968" aria-hidden="true" tabindex="-1"></a><span class="in">mean(sim_omega)</span></span>
<span id="cb211-1969"><a href="#cb211-1969" aria-hidden="true" tabindex="-1"></a><span class="in">quantile(sim_omega, c(.025, .975))</span></span>
<span id="cb211-1970"><a href="#cb211-1970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1971"><a href="#cb211-1971" aria-hidden="true" tabindex="-1"></a><span class="in"># Of the alcohol drinkers, the probability of drinking on any given day.</span></span>
<span id="cb211-1972"><a href="#cb211-1972" aria-hidden="true" tabindex="-1"></a><span class="in">mean(sim_p)</span></span>
<span id="cb211-1973"><a href="#cb211-1973" aria-hidden="true" tabindex="-1"></a><span class="in">quantile(sim_p, c(.025, .975))</span></span>
<span id="cb211-1974"><a href="#cb211-1974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1975"><a href="#cb211-1975" aria-hidden="true" tabindex="-1"></a><span class="in"># mean and 95% CI predicted number of [0,7] drinking days.</span></span>
<span id="cb211-1976"><a href="#cb211-1976" aria-hidden="true" tabindex="-1"></a><span class="in">z_post_pred &lt;- map(1:ITER, ~rbinom(100, 1, sim_omega))</span></span>
<span id="cb211-1977"><a href="#cb211-1977" aria-hidden="true" tabindex="-1"></a><span class="in">x_post_pred &lt;- map(1:ITER, ~rbinom(100, 7, sim_p))</span></span>
<span id="cb211-1978"><a href="#cb211-1978" aria-hidden="true" tabindex="-1"></a><span class="in"># Override the probability with zero when z == 0.</span></span>
<span id="cb211-1979"><a href="#cb211-1979" aria-hidden="true" tabindex="-1"></a><span class="in">x_post_pred &lt;- map2(x_post_pred, z_post_pred, ~ if_else(.y == 0, 0, .x))</span></span>
<span id="cb211-1980"><a href="#cb211-1980" aria-hidden="true" tabindex="-1"></a><span class="in"># Count the number of times [0,7] comes up. Average this across the 10^3 experiments.</span></span>
<span id="cb211-1981"><a href="#cb211-1981" aria-hidden="true" tabindex="-1"></a><span class="in">means &lt;- map_dbl(days, function(x) map_int(x_post_pred, ~sum(. == x)) %&gt;% mean())</span></span>
<span id="cb211-1982"><a href="#cb211-1982" aria-hidden="true" tabindex="-1"></a><span class="in">lcl &lt;- map_dbl(days, function(x) map_int(x_post_pred, ~sum(. == x)) %&gt;% quantile(.025))</span></span>
<span id="cb211-1983"><a href="#cb211-1983" aria-hidden="true" tabindex="-1"></a><span class="in">ucl &lt;- map_dbl(days, function(x) map_int(x_post_pred, ~sum(. == x)) %&gt;% quantile(.975))</span></span>
<span id="cb211-1984"><a href="#cb211-1984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1985"><a href="#cb211-1985" aria-hidden="true" tabindex="-1"></a><span class="in">tibble(days, respondents, means, lcl, ucl) %&gt;%</span></span>
<span id="cb211-1986"><a href="#cb211-1986" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = days)) +</span></span>
<span id="cb211-1987"><a href="#cb211-1987" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_col(aes(y = respondents)) +</span></span>
<span id="cb211-1988"><a href="#cb211-1988" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(aes(y = means)) +</span></span>
<span id="cb211-1989"><a href="#cb211-1989" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(aes(ymin = lcl, ymax = ucl), width = .2) +</span></span>
<span id="cb211-1990"><a href="#cb211-1990" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(breaks = 0:7)</span></span>
<span id="cb211-1991"><a href="#cb211-1991" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-1992"><a href="#cb211-1992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1993"><a href="#cb211-1993" aria-hidden="true" tabindex="-1"></a>Much better. Let's try another example of modeling with zero inflation. 94 tourists report how many fish they caught during their visit. Estimate the distribution of fish caught. Start with a vague prior, $\lambda \sim \text{Gamma}(a = .1, b = .1)$. The posterior distribution of $\lambda|y \sim \text{Gamma}(a + \sum_i{y_i}, b + n)$</span>
<span id="cb211-1994"><a href="#cb211-1994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1995"><a href="#cb211-1995" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-1996"><a href="#cb211-1996" aria-hidden="true" tabindex="-1"></a><span class="in">fish &lt;- readr::read_csv("input/fish.csv", col_types = "i") %&gt;% filter(!is.na(catch))</span></span>
<span id="cb211-1997"><a href="#cb211-1997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-1998"><a href="#cb211-1998" aria-hidden="true" tabindex="-1"></a><span class="in"># Simulate 10^3 samples.</span></span>
<span id="cb211-1999"><a href="#cb211-1999" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345)</span></span>
<span id="cb211-2000"><a href="#cb211-2000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2001"><a href="#cb211-2001" aria-hidden="true" tabindex="-1"></a><span class="in"># Uniform gamma(a, b) prior.</span></span>
<span id="cb211-2002"><a href="#cb211-2002" aria-hidden="true" tabindex="-1"></a><span class="in">a &lt;- .01</span></span>
<span id="cb211-2003"><a href="#cb211-2003" aria-hidden="true" tabindex="-1"></a><span class="in">b &lt;- .01</span></span>
<span id="cb211-2004"><a href="#cb211-2004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2005"><a href="#cb211-2005" aria-hidden="true" tabindex="-1"></a><span class="in"># Sample gamma 10^3 times from the posterior distribution</span></span>
<span id="cb211-2006"><a href="#cb211-2006" aria-hidden="true" tabindex="-1"></a><span class="in">sampled_lambda &lt;- rgamma(10^3, a + sum(fish$catch), b + nrow(fish))</span></span>
<span id="cb211-2007"><a href="#cb211-2007" aria-hidden="true" tabindex="-1"></a><span class="in">y_tilde &lt;- rpois(10^3, sampled_lambda)</span></span>
<span id="cb211-2008"><a href="#cb211-2008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2009"><a href="#cb211-2009" aria-hidden="true" tabindex="-1"></a><span class="in"># mean and 95% CI predicted number of expected value of fish caught.</span></span>
<span id="cb211-2010"><a href="#cb211-2010" aria-hidden="true" tabindex="-1"></a><span class="in">mean(y_tilde)</span></span>
<span id="cb211-2011"><a href="#cb211-2011" aria-hidden="true" tabindex="-1"></a><span class="in">quantile(y_tilde, c(.025, .975))</span></span>
<span id="cb211-2012"><a href="#cb211-2012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2013"><a href="#cb211-2013" aria-hidden="true" tabindex="-1"></a><span class="in"># mean and 95% CI predicted number of [0, 9] fish caught.</span></span>
<span id="cb211-2014"><a href="#cb211-2014" aria-hidden="true" tabindex="-1"></a><span class="in"># For 10^3 lambdas, create 94 samples from Poisson dist. </span></span>
<span id="cb211-2015"><a href="#cb211-2015" aria-hidden="true" tabindex="-1"></a><span class="in">sims &lt;- map(sampled_lambda, ~rpois(nrow(fish), .))</span></span>
<span id="cb211-2016"><a href="#cb211-2016" aria-hidden="true" tabindex="-1"></a><span class="in"># Count the number of times [0,10] comes up. Average this across the 10^3 experiments. </span></span>
<span id="cb211-2017"><a href="#cb211-2017" aria-hidden="true" tabindex="-1"></a><span class="in">catch &lt;- 0:max(fish$catch)</span></span>
<span id="cb211-2018"><a href="#cb211-2018" aria-hidden="true" tabindex="-1"></a><span class="in">means &lt;- map_dbl(catch, function(x) map_int(sims, ~sum(. == x)) %&gt;% mean())</span></span>
<span id="cb211-2019"><a href="#cb211-2019" aria-hidden="true" tabindex="-1"></a><span class="in">lcl &lt;- map_dbl(catch, function(x) map_int(sims, ~sum(. == x)) %&gt;% quantile(.025))</span></span>
<span id="cb211-2020"><a href="#cb211-2020" aria-hidden="true" tabindex="-1"></a><span class="in">ucl &lt;- map_dbl(catch, function(x) map_int(sims, ~sum(. == x)) %&gt;% quantile(.975))</span></span>
<span id="cb211-2021"><a href="#cb211-2021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2022"><a href="#cb211-2022" aria-hidden="true" tabindex="-1"></a><span class="in">tibble(catch, means, lcl, ucl) %&gt;%</span></span>
<span id="cb211-2023"><a href="#cb211-2023" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(fish %&gt;% count(catch, name = "y"), by = join_by(catch)) %&gt;%</span></span>
<span id="cb211-2024"><a href="#cb211-2024" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = catch)) +</span></span>
<span id="cb211-2025"><a href="#cb211-2025" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_col(aes(y = y)) +</span></span>
<span id="cb211-2026"><a href="#cb211-2026" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(aes(y = means)) +</span></span>
<span id="cb211-2027"><a href="#cb211-2027" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(aes(ymin = lcl, ymax = ucl), width = .2) +</span></span>
<span id="cb211-2028"><a href="#cb211-2028" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(breaks = 0:10) +</span></span>
<span id="cb211-2029"><a href="#cb211-2029" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(title = "Zero inflation in fish caught.")</span></span>
<span id="cb211-2030"><a href="#cb211-2030" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2031"><a href="#cb211-2031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2032"><a href="#cb211-2032" aria-hidden="true" tabindex="-1"></a>This doesn't look good. The probability of 27 people catching 0 fish when the expected number of fish is 2.9 is less than .001.</span>
<span id="cb211-2033"><a href="#cb211-2033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2036"><a href="#cb211-2036" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2037"><a href="#cb211-2037" aria-hidden="true" tabindex="-1"></a><span class="co"># probability of 27 people with catching 0 fish given lambda = 2.9 is &lt;.001.</span></span>
<span id="cb211-2038"><a href="#cb211-2038" aria-hidden="true" tabindex="-1"></a>(lambda_est <span class="ot">&lt;-</span> (a <span class="sc">+</span> <span class="fu">sum</span>(fish<span class="sc">$</span>catch)) <span class="sc">/</span> (b <span class="sc">+</span> <span class="dv">94</span>))</span>
<span id="cb211-2039"><a href="#cb211-2039" aria-hidden="true" tabindex="-1"></a><span class="fu">ppois</span>(<span class="fu">sum</span>(fish<span class="sc">$</span>catch <span class="sc">==</span> <span class="dv">0</span>), <span class="at">lambda =</span> means[<span class="dv">1</span>], <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span>
<span id="cb211-2040"><a href="#cb211-2040" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2041"><a href="#cb211-2041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2042"><a href="#cb211-2042" aria-hidden="true" tabindex="-1"></a>Add a binary latent variable to the model describing whether or not the person was fishing</span>
<span id="cb211-2043"><a href="#cb211-2043" aria-hidden="true" tabindex="-1"></a>Assign a uniform prior to the probability that the person was fishing</span>
<span id="cb211-2044"><a href="#cb211-2044" aria-hidden="true" tabindex="-1"></a>Derive posterior conditional distributions and construct a Gibbs sampler to estimate your model</span>
<span id="cb211-2045"><a href="#cb211-2045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2046"><a href="#cb211-2046" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-2047"><a href="#cb211-2047" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345)</span></span>
<span id="cb211-2048"><a href="#cb211-2048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2049"><a href="#cb211-2049" aria-hidden="true" tabindex="-1"></a><span class="in"># Reported number of fish caught by 94 respondents.</span></span>
<span id="cb211-2050"><a href="#cb211-2050" aria-hidden="true" tabindex="-1"></a><span class="in">y &lt;- fish$catch</span></span>
<span id="cb211-2051"><a href="#cb211-2051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2052"><a href="#cb211-2052" aria-hidden="true" tabindex="-1"></a><span class="in"># Start with assumption that if they caught 0, they did not fish (y_i=0 -&gt; z_i=0).</span></span>
<span id="cb211-2053"><a href="#cb211-2053" aria-hidden="true" tabindex="-1"></a><span class="in">z &lt;- as.numeric(y &gt;= 1)</span></span>
<span id="cb211-2054"><a href="#cb211-2054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2055"><a href="#cb211-2055" aria-hidden="true" tabindex="-1"></a><span class="in"># Run 1,000 iterations, updating p, omega, and z each time.</span></span>
<span id="cb211-2056"><a href="#cb211-2056" aria-hidden="true" tabindex="-1"></a><span class="in">ITER &lt;- 10^3</span></span>
<span id="cb211-2057"><a href="#cb211-2057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2058"><a href="#cb211-2058" aria-hidden="true" tabindex="-1"></a><span class="in"># Create monitors to track convergence.</span></span>
<span id="cb211-2059"><a href="#cb211-2059" aria-hidden="true" tabindex="-1"></a><span class="in">sim_lambda &lt;- numeric(ITER)</span></span>
<span id="cb211-2060"><a href="#cb211-2060" aria-hidden="true" tabindex="-1"></a><span class="in">sim_omega &lt;- numeric(ITER)</span></span>
<span id="cb211-2061"><a href="#cb211-2061" aria-hidden="true" tabindex="-1"></a><span class="in">sim_z &lt;- matrix(nrow = length(y), ncol = ITER)</span></span>
<span id="cb211-2062"><a href="#cb211-2062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2063"><a href="#cb211-2063" aria-hidden="true" tabindex="-1"></a><span class="in"># Gibbs sampler.</span></span>
<span id="cb211-2064"><a href="#cb211-2064" aria-hidden="true" tabindex="-1"></a><span class="in">for(iter in 1:ITER) {</span></span>
<span id="cb211-2065"><a href="#cb211-2065" aria-hidden="true" tabindex="-1"></a><span class="in">  # Uniform Beta(1,1) prior probability the person fished. Posterior is based on</span></span>
<span id="cb211-2066"><a href="#cb211-2066" aria-hidden="true" tabindex="-1"></a><span class="in">  # count of non-zero z's.</span></span>
<span id="cb211-2067"><a href="#cb211-2067" aria-hidden="true" tabindex="-1"></a><span class="in">  omega &lt;- rbeta(1, 1 + sum(z), 1 + (length(y) - sum(z)))</span></span>
<span id="cb211-2068"><a href="#cb211-2068" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb211-2069"><a href="#cb211-2069" aria-hidden="true" tabindex="-1"></a><span class="in">  # Vague Gamma(.01,.01) prior for number of fish caught. Posterior is based on</span></span>
<span id="cb211-2070"><a href="#cb211-2070" aria-hidden="true" tabindex="-1"></a><span class="in">  # reported catch and number of believed fishers.</span></span>
<span id="cb211-2071"><a href="#cb211-2071" aria-hidden="true" tabindex="-1"></a><span class="in">  lambda &lt;- rgamma(1, .01 + sum(y), .01 + sum(z))</span></span>
<span id="cb211-2072"><a href="#cb211-2072" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb211-2073"><a href="#cb211-2073" aria-hidden="true" tabindex="-1"></a><span class="in">  # Updated probability that respondent fishes.</span></span>
<span id="cb211-2074"><a href="#cb211-2074" aria-hidden="true" tabindex="-1"></a><span class="in">  # E(z=1|x) = 1 or P(1|x=0, p, omega).</span></span>
<span id="cb211-2075"><a href="#cb211-2075" aria-hidden="true" tabindex="-1"></a><span class="in">  prob_y_eq_0 &lt;- exp(-lambda) * lambda^0 / factorial(0)</span></span>
<span id="cb211-2076"><a href="#cb211-2076" aria-hidden="true" tabindex="-1"></a><span class="in">  prob_z_eq_1 &lt;- if_else(y &gt;= 1, 1,</span></span>
<span id="cb211-2077"><a href="#cb211-2077" aria-hidden="true" tabindex="-1"></a><span class="in">                         (prob_y_eq_0 * omega) / ((1 - omega) + (prob_y_eq_0 * omega)))</span></span>
<span id="cb211-2078"><a href="#cb211-2078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2079"><a href="#cb211-2079" aria-hidden="true" tabindex="-1"></a><span class="in">  # Update z.</span></span>
<span id="cb211-2080"><a href="#cb211-2080" aria-hidden="true" tabindex="-1"></a><span class="in">  z &lt;- rbinom(length(y), 1, prob_z_eq_1)</span></span>
<span id="cb211-2081"><a href="#cb211-2081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2082"><a href="#cb211-2082" aria-hidden="true" tabindex="-1"></a><span class="in">  # update monitors</span></span>
<span id="cb211-2083"><a href="#cb211-2083" aria-hidden="true" tabindex="-1"></a><span class="in">  sim_lambda[iter] &lt;- lambda</span></span>
<span id="cb211-2084"><a href="#cb211-2084" aria-hidden="true" tabindex="-1"></a><span class="in">  sim_omega[iter] &lt;- omega</span></span>
<span id="cb211-2085"><a href="#cb211-2085" aria-hidden="true" tabindex="-1"></a><span class="in">  sim_z[, iter] &lt;- z</span></span>
<span id="cb211-2086"><a href="#cb211-2086" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb211-2087"><a href="#cb211-2087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2088"><a href="#cb211-2088" aria-hidden="true" tabindex="-1"></a><span class="in"># Estimate of tourists who fished. Throw out first 100 as burn-in.</span></span>
<span id="cb211-2089"><a href="#cb211-2089" aria-hidden="true" tabindex="-1"></a><span class="in">mean(sim_omega[-c(1:100)])</span></span>
<span id="cb211-2090"><a href="#cb211-2090" aria-hidden="true" tabindex="-1"></a><span class="in">quantile(sim_omega[-c(1:100)], c(.025, .975))</span></span>
<span id="cb211-2091"><a href="#cb211-2091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2092"><a href="#cb211-2092" aria-hidden="true" tabindex="-1"></a><span class="in"># Of those who fished, the expected number caught. Throw out burn-in again.</span></span>
<span id="cb211-2093"><a href="#cb211-2093" aria-hidden="true" tabindex="-1"></a><span class="in"># tibble(x = 1:1000, y = sim_lambda) %&gt;% ggplot(aes(x = x, y = y)) + geom_point()</span></span>
<span id="cb211-2094"><a href="#cb211-2094" aria-hidden="true" tabindex="-1"></a><span class="in">mean(sim_lambda[-c(1:100)])</span></span>
<span id="cb211-2095"><a href="#cb211-2095" aria-hidden="true" tabindex="-1"></a><span class="in">quantile(sim_lambda[-c(1:100)], c(.025, .975))</span></span>
<span id="cb211-2096"><a href="#cb211-2096" aria-hidden="true" tabindex="-1"></a><span class="in"># or is it this (E(X) = a/b? Not this either.</span></span>
<span id="cb211-2097"><a href="#cb211-2097" aria-hidden="true" tabindex="-1"></a><span class="in">(.01 + sum(y)) / (.01 + sum(z))</span></span>
<span id="cb211-2098"><a href="#cb211-2098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2099"><a href="#cb211-2099" aria-hidden="true" tabindex="-1"></a><span class="in"># mean and 95% CI predicted number of [0,9] fish caught.</span></span>
<span id="cb211-2100"><a href="#cb211-2100" aria-hidden="true" tabindex="-1"></a><span class="in">z_post_pred &lt;- map(1:ITER, ~rbinom(length(z), 1, sim_omega))</span></span>
<span id="cb211-2101"><a href="#cb211-2101" aria-hidden="true" tabindex="-1"></a><span class="in">y_post_pred &lt;- map(1:ITER, ~rpois(length(y), sim_lambda))</span></span>
<span id="cb211-2102"><a href="#cb211-2102" aria-hidden="true" tabindex="-1"></a><span class="in"># Override the count with zero when z == 0.</span></span>
<span id="cb211-2103"><a href="#cb211-2103" aria-hidden="true" tabindex="-1"></a><span class="in">y_post_pred &lt;- map2(y_post_pred, z_post_pred, ~ if_else(.y == 0, 0, .x))</span></span>
<span id="cb211-2104"><a href="#cb211-2104" aria-hidden="true" tabindex="-1"></a><span class="in"># Count the number of times [0,9] comes up. Average this across the 10^3 experiments.</span></span>
<span id="cb211-2105"><a href="#cb211-2105" aria-hidden="true" tabindex="-1"></a><span class="in">means &lt;- map_dbl(0:9, function(x) map_int(y_post_pred, ~sum(. == x)) %&gt;% mean())</span></span>
<span id="cb211-2106"><a href="#cb211-2106" aria-hidden="true" tabindex="-1"></a><span class="in">lcl &lt;- map_dbl(0:9, function(x) map_int(y_post_pred, ~sum(. == x)) %&gt;% quantile(.025))</span></span>
<span id="cb211-2107"><a href="#cb211-2107" aria-hidden="true" tabindex="-1"></a><span class="in">ucl &lt;- map_dbl(0:9, function(x) map_int(y_post_pred, ~sum(. == x)) %&gt;% quantile(.975))</span></span>
<span id="cb211-2108"><a href="#cb211-2108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2109"><a href="#cb211-2109" aria-hidden="true" tabindex="-1"></a><span class="in"># Probability of 27 of 94 people with a catch of 0. Sample the posterior </span></span>
<span id="cb211-2110"><a href="#cb211-2110" aria-hidden="true" tabindex="-1"></a><span class="in"># predictive distribution.</span></span>
<span id="cb211-2111"><a href="#cb211-2111" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_pred &lt;- matrix(rpois(ITER * length(y), rep(sim_lambda, length(y))), ncol = ITER) * sim_z</span></span>
<span id="cb211-2112"><a href="#cb211-2112" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_zeros &lt;- map_int(1:ITER, ~sum(posterior_pred[, .] == 0))</span></span>
<span id="cb211-2113"><a href="#cb211-2113" aria-hidden="true" tabindex="-1"></a><span class="in">mean(posterior_zeros[100:ITER] &gt;= sum(y==0))</span></span>
<span id="cb211-2114"><a href="#cb211-2114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2115"><a href="#cb211-2115" aria-hidden="true" tabindex="-1"></a><span class="in">tibble(catch = 0:9, means, lcl, ucl) %&gt;%</span></span>
<span id="cb211-2116"><a href="#cb211-2116" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(fish %&gt;% count(catch, name = "y"), by = join_by(catch)) %&gt;%</span></span>
<span id="cb211-2117"><a href="#cb211-2117" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = catch)) +</span></span>
<span id="cb211-2118"><a href="#cb211-2118" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_col(aes(y = y)) +</span></span>
<span id="cb211-2119"><a href="#cb211-2119" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(aes(y = means)) +</span></span>
<span id="cb211-2120"><a href="#cb211-2120" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(aes(ymin = lcl, ymax = ucl), width = .2) +</span></span>
<span id="cb211-2121"><a href="#cb211-2121" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(breaks = 0:10)</span></span>
<span id="cb211-2122"><a href="#cb211-2122" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2123"><a href="#cb211-2123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2124"><a href="#cb211-2124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2125"><a href="#cb211-2125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2126"><a href="#cb211-2126" aria-hidden="true" tabindex="-1"></a><span class="fu">## DIC</span></span>
<span id="cb211-2127"><a href="#cb211-2127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2128"><a href="#cb211-2128" aria-hidden="true" tabindex="-1"></a>Use the Deviance Information Criterion (DIC) to compare group means. </span>
<span id="cb211-2129"><a href="#cb211-2129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2130"><a href="#cb211-2130" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-2131"><a href="#cb211-2131" aria-hidden="true" tabindex="-1"></a>DIC = p_D + \overline{D(\theta)}</span>
<span id="cb211-2132"><a href="#cb211-2132" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-2133"><a href="#cb211-2133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2134"><a href="#cb211-2134" aria-hidden="true" tabindex="-1"></a>where $p_D = \overline{D(\theta)} - D(\hat{\theta})$ and $D(\theta) = -2 \log (f(y|\theta)) + C$.</span>
<span id="cb211-2135"><a href="#cb211-2135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2136"><a href="#cb211-2136" aria-hidden="true" tabindex="-1"></a>Evaluate $\overline{D(\theta)}$ by producing samples from each distribution and evaluating the likelihoods of the data based on each realization and taking the mean of -2 log-likelihood.</span>
<span id="cb211-2137"><a href="#cb211-2137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2140"><a href="#cb211-2140" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2141"><a href="#cb211-2141" aria-hidden="true" tabindex="-1"></a><span class="co"># Two samples with success rates 35/50 and 15/20</span></span>
<span id="cb211-2142"><a href="#cb211-2142" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">35</span>, <span class="dv">15</span>)</span>
<span id="cb211-2143"><a href="#cb211-2143" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">20</span>)</span>
<span id="cb211-2144"><a href="#cb211-2144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2145"><a href="#cb211-2145" aria-hidden="true" tabindex="-1"></a><span class="co"># Priors</span></span>
<span id="cb211-2146"><a href="#cb211-2146" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb211-2147"><a href="#cb211-2147" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb211-2148"><a href="#cb211-2148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2149"><a href="#cb211-2149" aria-hidden="true" tabindex="-1"></a><span class="co"># Posteriors</span></span>
<span id="cb211-2150"><a href="#cb211-2150" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb211-2151"><a href="#cb211-2151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbeta</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span>y[<span class="dv">1</span>], b<span class="sc">+</span>n[<span class="dv">1</span>]<span class="sc">-</span>y[<span class="dv">1</span>]),</span>
<span id="cb211-2152"><a href="#cb211-2152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbeta</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span>y[<span class="dv">2</span>], b<span class="sc">+</span>n[<span class="dv">2</span>]<span class="sc">-</span>y[<span class="dv">2</span>])</span>
<span id="cb211-2153"><a href="#cb211-2153" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb211-2154"><a href="#cb211-2154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2155"><a href="#cb211-2155" aria-hidden="true" tabindex="-1"></a><span class="co"># -2 * Mean log-likelihood</span></span>
<span id="cb211-2156"><a href="#cb211-2156" aria-hidden="true" tabindex="-1"></a>ll <span class="ot">&lt;-</span> </span>
<span id="cb211-2157"><a href="#cb211-2157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbinom</span>(y[<span class="dv">1</span>], n[<span class="dv">1</span>], post[[<span class="dv">1</span>]], <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-2158"><a href="#cb211-2158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbinom</span>(y[<span class="dv">2</span>], n[<span class="dv">2</span>], post[[<span class="dv">2</span>]], <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb211-2159"><a href="#cb211-2159" aria-hidden="true" tabindex="-1"></a>(mean_D <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> ll))</span>
<span id="cb211-2160"><a href="#cb211-2160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2161"><a href="#cb211-2161" aria-hidden="true" tabindex="-1"></a><span class="co"># D(theta-bar) is the likelihood of the data based on the posterior means of p.</span></span>
<span id="cb211-2162"><a href="#cb211-2162" aria-hidden="true" tabindex="-1"></a>(D_mean <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> (</span>
<span id="cb211-2163"><a href="#cb211-2163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbinom</span>(y[<span class="dv">1</span>], n[<span class="dv">1</span>], (a<span class="sc">+</span>y[<span class="dv">1</span>]) <span class="sc">/</span> (a<span class="sc">+</span>y[<span class="dv">1</span>] <span class="sc">+</span> b<span class="sc">+</span>n[<span class="dv">1</span>]<span class="sc">-</span>y[<span class="dv">1</span>]), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-2164"><a href="#cb211-2164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbinom</span>(y[<span class="dv">2</span>], n[<span class="dv">2</span>], (a<span class="sc">+</span>y[<span class="dv">2</span>]) <span class="sc">/</span> (a<span class="sc">+</span>y[<span class="dv">2</span>] <span class="sc">+</span> b<span class="sc">+</span>n[<span class="dv">2</span>]<span class="sc">-</span>y[<span class="dv">2</span>]), <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb211-2165"><a href="#cb211-2165" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb211-2166"><a href="#cb211-2166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2167"><a href="#cb211-2167" aria-hidden="true" tabindex="-1"></a><span class="co">#p_D and DIC from equation</span></span>
<span id="cb211-2168"><a href="#cb211-2168" aria-hidden="true" tabindex="-1"></a>(p_D <span class="ot">&lt;-</span> mean_D <span class="sc">-</span> D_mean)</span>
<span id="cb211-2169"><a href="#cb211-2169" aria-hidden="true" tabindex="-1"></a>(DIC <span class="ot">&lt;-</span> p_D <span class="sc">+</span> mean_D)</span>
<span id="cb211-2170"><a href="#cb211-2170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2171"><a href="#cb211-2171" aria-hidden="true" tabindex="-1"></a><span class="co"># Repeat these steps for a single model of both groups</span></span>
<span id="cb211-2172"><a href="#cb211-2172" aria-hidden="true" tabindex="-1"></a>post_group <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>, a<span class="sc">+</span><span class="fu">sum</span>(y), b<span class="sc">+</span><span class="fu">sum</span>(n)<span class="sc">-</span><span class="fu">sum</span>(y))</span>
<span id="cb211-2173"><a href="#cb211-2173" aria-hidden="true" tabindex="-1"></a>ll_group <span class="ot">&lt;-</span> </span>
<span id="cb211-2174"><a href="#cb211-2174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbinom</span>(y[<span class="dv">1</span>], n[<span class="dv">1</span>], post_group, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-2175"><a href="#cb211-2175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbinom</span>(y[<span class="dv">2</span>], n[<span class="dv">2</span>], post_group, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb211-2176"><a href="#cb211-2176" aria-hidden="true" tabindex="-1"></a>(mean_D_group <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> ll_group))</span>
<span id="cb211-2177"><a href="#cb211-2177" aria-hidden="true" tabindex="-1"></a>(D_mean_group <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> (</span>
<span id="cb211-2178"><a href="#cb211-2178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbinom</span>(y[<span class="dv">1</span>], n[<span class="dv">1</span>], (a<span class="sc">+</span><span class="fu">sum</span>(y)) <span class="sc">/</span> (a<span class="sc">+</span><span class="fu">sum</span>(y) <span class="sc">+</span> b<span class="sc">+</span><span class="fu">sum</span>(n)<span class="sc">-</span><span class="fu">sum</span>(y)), <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb211-2179"><a href="#cb211-2179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbinom</span>(y[<span class="dv">2</span>], n[<span class="dv">2</span>], (a<span class="sc">+</span><span class="fu">sum</span>(y)) <span class="sc">/</span> (a<span class="sc">+</span><span class="fu">sum</span>(y) <span class="sc">+</span> b<span class="sc">+</span><span class="fu">sum</span>(n)<span class="sc">-</span><span class="fu">sum</span>(y)), <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb211-2180"><a href="#cb211-2180" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb211-2181"><a href="#cb211-2181" aria-hidden="true" tabindex="-1"></a>(p_D_group <span class="ot">&lt;-</span> mean_D_group <span class="sc">-</span> D_mean_group)</span>
<span id="cb211-2182"><a href="#cb211-2182" aria-hidden="true" tabindex="-1"></a>(DIC_group <span class="ot">&lt;-</span> p_D_group <span class="sc">+</span> mean_D_group)</span>
<span id="cb211-2183"><a href="#cb211-2183" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2184"><a href="#cb211-2184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2185"><a href="#cb211-2185" aria-hidden="true" tabindex="-1"></a>The DIC for the two group model is <span class="in">`r DIC`</span> and for the one common group model it is <span class="in">`r DIC_group`</span>. The DIC for one common group model is smaller, so we do not have enough statistical evidence for two groups. If the DIC for the group-specific model is at least 3 units smaller than that for the common model, there is sufficient statistical evidence for difference between groups.</span>
<span id="cb211-2186"><a href="#cb211-2186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2187"><a href="#cb211-2187" aria-hidden="true" tabindex="-1"></a><span class="fu">## Monte Carlo Integration</span></span>
<span id="cb211-2188"><a href="#cb211-2188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2189"><a href="#cb211-2189" aria-hidden="true" tabindex="-1"></a>Monte Carlo integration is an empirical way to solve the integrals related to the posterior mean and variance. The population expectation, $E<span class="co">[</span><span class="ot">X</span><span class="co">]</span> = \int_{-\infty}^\infty x f(x) dx$, and variance $Var(X) = E(X-EX)^2 = \int_{-\infty}^\infty (x - EX)^2f(x)dx$, are both integrals.</span>
<span id="cb211-2190"><a href="#cb211-2190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2191"><a href="#cb211-2191" aria-hidden="true" tabindex="-1"></a>You can use Monte Carlo to evaluate an integral such as $A=\int_0^1 20x(1-x)^3dx$. If you randomly select $n$ points from a defined space $D$, the number $z$ enclosed by the integral will follow a binomial distribution, $Z \sim \text{Bin} (n, p)$ with $E<span class="co">[</span><span class="ot">Z</span><span class="co">]</span> = np = n \frac{A}{D}$ and variance $Var<span class="co">[</span><span class="ot">Z</span><span class="co">]</span> = np(1-p) = n \frac{A}{D} \left(1-\frac{A}{D}\right)$. If you know the enclosing area, then you can infer the integral area, </span>
<span id="cb211-2192"><a href="#cb211-2192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2193"><a href="#cb211-2193" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-2194"><a href="#cb211-2194" aria-hidden="true" tabindex="-1"></a>\begin{equation}</span>
<span id="cb211-2195"><a href="#cb211-2195" aria-hidden="true" tabindex="-1"></a>\hat{A} = \frac{z}{n} D</span>
<span id="cb211-2196"><a href="#cb211-2196" aria-hidden="true" tabindex="-1"></a>(<span class="sc">\#</span>eq:monte-carlo-est)</span>
<span id="cb211-2197"><a href="#cb211-2197" aria-hidden="true" tabindex="-1"></a>\end{equation}</span>
<span id="cb211-2198"><a href="#cb211-2198" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-2199"><a href="#cb211-2199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2200"><a href="#cb211-2200" aria-hidden="true" tabindex="-1"></a>The variance of $Var(\hat{A}) = Var\left(\frac{z}{n} D\right) = Var(Z) \left(\frac{z}{n}\right)^2 = \frac{A(D-A)}{n}$. Of course, you do not know $A$, so you replace it with $\hat{A}$. Solve this for the Monte Carlo standard error.</span>
<span id="cb211-2201"><a href="#cb211-2201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2202"><a href="#cb211-2202" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-2203"><a href="#cb211-2203" aria-hidden="true" tabindex="-1"></a>\begin{equation}</span>
<span id="cb211-2204"><a href="#cb211-2204" aria-hidden="true" tabindex="-1"></a>\widehat{s.e.} = \frac{D}{\sqrt{n}} \sqrt{\frac{z}{n}\left(1 - \frac{z}{n} \right)}</span>
<span id="cb211-2205"><a href="#cb211-2205" aria-hidden="true" tabindex="-1"></a>(<span class="sc">\#</span>eq:monte-carlo-se)</span>
<span id="cb211-2206"><a href="#cb211-2206" aria-hidden="true" tabindex="-1"></a>\end{equation}</span>
<span id="cb211-2207"><a href="#cb211-2207" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-2208"><a href="#cb211-2208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2209"><a href="#cb211-2209" aria-hidden="true" tabindex="-1"></a>Notice how the Monte Carlo standard error increases with D and decreases with $n$. Let's try it. Generate 1,000 points uniformly in the domain <span class="co">[</span><span class="ot">0,1</span><span class="co">]</span> x <span class="co">[</span><span class="ot">0, 3</span><span class="co">]</span>, then check whether they are below the <span class="in">`f()`</span> curve.</span>
<span id="cb211-2210"><a href="#cb211-2210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2211"><a href="#cb211-2211" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-2212"><a href="#cb211-2212" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345) </span></span>
<span id="cb211-2213"><a href="#cb211-2213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2214"><a href="#cb211-2214" aria-hidden="true" tabindex="-1"></a><span class="in">f &lt;- function(x) {20*x*(1 - x)^3}</span></span>
<span id="cb211-2215"><a href="#cb211-2215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2216"><a href="#cb211-2216" aria-hidden="true" tabindex="-1"></a><span class="in"># Defined area</span></span>
<span id="cb211-2217"><a href="#cb211-2217" aria-hidden="true" tabindex="-1"></a><span class="in">D &lt;- 1 * 3</span></span>
<span id="cb211-2218"><a href="#cb211-2218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2219"><a href="#cb211-2219" aria-hidden="true" tabindex="-1"></a><span class="in"># n random points in defined area.</span></span>
<span id="cb211-2220"><a href="#cb211-2220" aria-hidden="true" tabindex="-1"></a><span class="in">n &lt;- 1000</span></span>
<span id="cb211-2221"><a href="#cb211-2221" aria-hidden="true" tabindex="-1"></a><span class="in">x &lt;- runif(n, 0, 1)</span></span>
<span id="cb211-2222"><a href="#cb211-2222" aria-hidden="true" tabindex="-1"></a><span class="in">y &lt;- runif(n, 0, 3)</span></span>
<span id="cb211-2223"><a href="#cb211-2223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2224"><a href="#cb211-2224" aria-hidden="true" tabindex="-1"></a><span class="in">is_under &lt;- y &lt;= f(x)</span></span>
<span id="cb211-2225"><a href="#cb211-2225" aria-hidden="true" tabindex="-1"></a><span class="in">z &lt;- sum(is_under)</span></span>
<span id="cb211-2226"><a href="#cb211-2226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2227"><a href="#cb211-2227" aria-hidden="true" tabindex="-1"></a><span class="in"># Area is percent of points under the curve</span></span>
<span id="cb211-2228"><a href="#cb211-2228" aria-hidden="true" tabindex="-1"></a><span class="in">(A_hat &lt;- z / n * D)</span></span>
<span id="cb211-2229"><a href="#cb211-2229" aria-hidden="true" tabindex="-1"></a><span class="in">(se &lt;- D / sqrt(n) * sqrt(z/n * (1 - z/n)))</span></span>
<span id="cb211-2230"><a href="#cb211-2230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2231"><a href="#cb211-2231" aria-hidden="true" tabindex="-1"></a><span class="in">tibble(x, f = f(x), rand_y = y, is_under) %&gt;% </span></span>
<span id="cb211-2232"><a href="#cb211-2232" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x = x)) + </span></span>
<span id="cb211-2233"><a href="#cb211-2233" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_area(aes(y = f)) + </span></span>
<span id="cb211-2234"><a href="#cb211-2234" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(aes(y = rand_y, color = is_under), show.legend = FALSE)</span></span>
<span id="cb211-2235"><a href="#cb211-2235" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2236"><a href="#cb211-2236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2237"><a href="#cb211-2237" aria-hidden="true" tabindex="-1"></a><span class="fu">### Inverse Sampling</span></span>
<span id="cb211-2238"><a href="#cb211-2238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2239"><a href="#cb211-2239" aria-hidden="true" tabindex="-1"></a>In Bayesian analysis, you do not always have a pre-defined distribution to sample from. In these cases, you may be able to use *inverse sampling*. Given $f(x)$, the corresponding CDF is $F(x) = \int_0^x f(x)dx$. Derive its inverse by solving $F(x)$ for $x$. To inverse sample, sample from $U(0,1)$ and evaluate $x = F^{-1}(u)$. </span>
<span id="cb211-2240"><a href="#cb211-2240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2241"><a href="#cb211-2241" aria-hidden="true" tabindex="-1"></a>Here is an example. Suppose $f(x) = 2x$ on $x \in <span class="co">[</span><span class="ot">0,1</span><span class="co">]</span>$ and 0 otherwise. Then $F(x) = x^2 = u$ and solving $F(x)$ for $x$, $F^{-1}(u) = \sqrt{u}$.</span>
<span id="cb211-2242"><a href="#cb211-2242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2245"><a href="#cb211-2245" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2246"><a href="#cb211-2246" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb211-2247"><a href="#cb211-2247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2248"><a href="#cb211-2248" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">4</span>)</span>
<span id="cb211-2249"><a href="#cb211-2249" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(u)</span>
<span id="cb211-2250"><a href="#cb211-2250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2251"><a href="#cb211-2251" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(x, <span class="at">c =</span> <span class="dv">2</span><span class="sc">*</span>x) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span> <span class="fu">geom_density</span>(<span class="at">color =</span> <span class="st">"salmon"</span>) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> c))</span>
<span id="cb211-2252"><a href="#cb211-2252" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2253"><a href="#cb211-2253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2254"><a href="#cb211-2254" aria-hidden="true" tabindex="-1"></a>Suppose $f(x) = \lambda e^{-\lambda x}$ on $x \in <span class="co">[</span><span class="ot">0,1</span><span class="co">]</span>$ and 0 otherwise. Then $F(x) = 1 - e^{-\lambda x} = u$ and $F^{-1}(u) = - \frac{1}{\lambda} \ln <span class="co">[</span><span class="ot">1-u</span><span class="co">]</span>$.</span>
<span id="cb211-2255"><a href="#cb211-2255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2258"><a href="#cb211-2258" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2259"><a href="#cb211-2259" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb211-2260"><a href="#cb211-2260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2261"><a href="#cb211-2261" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">4</span>)</span>
<span id="cb211-2262"><a href="#cb211-2262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2263"><a href="#cb211-2263" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb211-2264"><a href="#cb211-2264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2265"><a href="#cb211-2265" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">/</span> lambda) <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">-</span> u)</span>
<span id="cb211-2266"><a href="#cb211-2266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2267"><a href="#cb211-2267" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(x, <span class="at">c =</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>x)) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span> <span class="fu">geom_density</span>(<span class="at">color =</span> <span class="st">"salmon"</span>) <span class="sc">+</span> </span>
<span id="cb211-2268"><a href="#cb211-2268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> c))</span>
<span id="cb211-2269"><a href="#cb211-2269" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2270"><a href="#cb211-2270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2271"><a href="#cb211-2271" aria-hidden="true" tabindex="-1"></a><span class="fu">### Rejection Sampling</span></span>
<span id="cb211-2272"><a href="#cb211-2272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2273"><a href="#cb211-2273" aria-hidden="true" tabindex="-1"></a>The problem is that inverse sampling only works when $F(x)$ is invertible. Another option is rejection sampling. Suppose you cannot sample from $f_X(x)$ but you can from $g_X(x)$ and the importance ratio $\frac{f_X(x)}{g_X(x)} &lt;= M$ for all $x$. Then you can sample $x$ from $g_X(x)$, then draw from $u \sim U(0,1)$ and accept $y = x$ with probability $\frac{f_X(x)}{M g_X(x)}$, i.e., if accepts if $u \ge \frac{f_X(x)}{M g_X(x)}$.</span>
<span id="cb211-2274"><a href="#cb211-2274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2275"><a href="#cb211-2275" aria-hidden="true" tabindex="-1"></a>Return to the example where $f(x) = 2x$ on $x \in <span class="co">[</span><span class="ot">0,1</span><span class="co">]</span>$. Consider $g(x) = 1$ on $x \in <span class="co">[</span><span class="ot">0,1</span><span class="co">]</span>$, the pdf of uniform distribution. The ratio ${f(x)}{g(x)} = 2x \le 2$ for $x \in <span class="co">[</span><span class="ot">0,1</span><span class="co">]</span>$. So it is bounded by $M = 2$. Accept $x$ with probability $\frac{f_X(x)}{M g_X(x)} = \frac{2x}{2 \cdot 1} = x$.</span>
<span id="cb211-2276"><a href="#cb211-2276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2279"><a href="#cb211-2279" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2280"><a href="#cb211-2280" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb211-2281"><a href="#cb211-2281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2282"><a href="#cb211-2282" aria-hidden="true" tabindex="-1"></a><span class="co"># g(x) is uniform dist</span></span>
<span id="cb211-2283"><a href="#cb211-2283" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">4</span>)</span>
<span id="cb211-2284"><a href="#cb211-2284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2285"><a href="#cb211-2285" aria-hidden="true" tabindex="-1"></a><span class="co"># probability of acceptance = x</span></span>
<span id="cb211-2286"><a href="#cb211-2286" aria-hidden="true" tabindex="-1"></a>p_acc <span class="ot">&lt;-</span> x</span>
<span id="cb211-2287"><a href="#cb211-2287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2288"><a href="#cb211-2288" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw from u</span></span>
<span id="cb211-2289"><a href="#cb211-2289" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">4</span>)</span>
<span id="cb211-2290"><a href="#cb211-2290" aria-hidden="true" tabindex="-1"></a>is_in <span class="ot">&lt;-</span> u <span class="sc">&lt;</span> p_acc</span>
<span id="cb211-2291"><a href="#cb211-2291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2292"><a href="#cb211-2292" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep the accepted ones</span></span>
<span id="cb211-2293"><a href="#cb211-2293" aria-hidden="true" tabindex="-1"></a>my_sample <span class="ot">&lt;-</span> x[is_in]</span>
<span id="cb211-2294"><a href="#cb211-2294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2295"><a href="#cb211-2295" aria-hidden="true" tabindex="-1"></a><span class="co"># Only kept a little more than half - no very efficient.</span></span>
<span id="cb211-2296"><a href="#cb211-2296" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(my_sample)</span>
<span id="cb211-2297"><a href="#cb211-2297" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2298"><a href="#cb211-2298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2299"><a href="#cb211-2299" aria-hidden="true" tabindex="-1"></a>Suppose $f(x) = 6x(1-x)$ on $x \in <span class="co">[</span><span class="ot">0,1</span><span class="co">]</span>$. Consider $g(x) = 1$ on $x \in <span class="co">[</span><span class="ot">0,1</span><span class="co">]</span>$, the pdf of uniform distribution. The ratio ${f(x)}{g(x)} = 6x(1-x) \le 1.5$ for $x \in <span class="co">[</span><span class="ot">0,1</span><span class="co">]</span>$. So it is bounded by $M = 1.5$. Accept $x$ with probability $\frac{f_X(x)}{M g_X(x)} = \frac{6x(1-x)}{1.5 \cdot 1} = 4x(1 - x)$.</span>
<span id="cb211-2300"><a href="#cb211-2300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2303"><a href="#cb211-2303" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2304"><a href="#cb211-2304" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb211-2305"><a href="#cb211-2305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2306"><a href="#cb211-2306" aria-hidden="true" tabindex="-1"></a><span class="co"># g(x) is uniform dist</span></span>
<span id="cb211-2307"><a href="#cb211-2307" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">4</span>)</span>
<span id="cb211-2308"><a href="#cb211-2308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2309"><a href="#cb211-2309" aria-hidden="true" tabindex="-1"></a><span class="co"># probability of acceptance = </span></span>
<span id="cb211-2310"><a href="#cb211-2310" aria-hidden="true" tabindex="-1"></a>p_acc <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="sc">*</span> x <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> x)</span>
<span id="cb211-2311"><a href="#cb211-2311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2312"><a href="#cb211-2312" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw from u</span></span>
<span id="cb211-2313"><a href="#cb211-2313" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">4</span>)</span>
<span id="cb211-2314"><a href="#cb211-2314" aria-hidden="true" tabindex="-1"></a>is_in <span class="ot">&lt;-</span> u <span class="sc">&lt;</span> p_acc</span>
<span id="cb211-2315"><a href="#cb211-2315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2316"><a href="#cb211-2316" aria-hidden="true" tabindex="-1"></a><span class="co"># The overall acceptance probability </span></span>
<span id="cb211-2317"><a href="#cb211-2317" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(is_in)</span>
<span id="cb211-2318"><a href="#cb211-2318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2319"><a href="#cb211-2319" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep the accepted ones</span></span>
<span id="cb211-2320"><a href="#cb211-2320" aria-hidden="true" tabindex="-1"></a>my_sample <span class="ot">&lt;-</span> x[is_in]</span>
<span id="cb211-2321"><a href="#cb211-2321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2322"><a href="#cb211-2322" aria-hidden="true" tabindex="-1"></a><span class="co"># Only kept a little more than half - no very efficient.</span></span>
<span id="cb211-2323"><a href="#cb211-2323" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(my_sample)</span>
<span id="cb211-2324"><a href="#cb211-2324" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2325"><a href="#cb211-2325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2326"><a href="#cb211-2326" aria-hidden="true" tabindex="-1"></a><span class="fu">### Importance Sampling</span></span>
<span id="cb211-2327"><a href="#cb211-2327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2328"><a href="#cb211-2328" aria-hidden="true" tabindex="-1"></a>Importance sampling allows to substitute sampling from a “difficult” distribution with sampling from an “easy” one. Suppose you have a random variable $x$ with PDF $f(x)$. The expected value of a function of $x$, $h(x)$ is defined by $E(h(x)) = \int h(x)f(x)dx$. Using the law of large numbers, you can approximate $E(h(x))$ by its average value, $\frac{1}{n} \sum_i h(x_i)$. So you would sample from $f(x)$, multiply by $h(x)$, and take the average.</span>
<span id="cb211-2329"><a href="#cb211-2329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2330"><a href="#cb211-2330" aria-hidden="true" tabindex="-1"></a>What would you do if you did not know how to sample from $f(x)$? Instead you could identify a function you could sample from, and evaluate the integral of the ratio, $E(h(x)) = \int\left<span class="co">[</span><span class="ot"> h(x) \frac{f(x)}{g(x)}\right</span><span class="co">]</span> g(x) dx$. With the law of large numbers, $E(h(x)) = \frac{1}{n}\sum_i\left<span class="co">[</span><span class="ot">h(x_i) \frac{f(x_i)}{g(x_i)} \right</span><span class="co">]</span>$. The ratios $w(x_i) = \frac{f(x_i)}{g(x_i)}$ are called importance weights. Importance weights tell you how useful each observation is. </span>
<span id="cb211-2331"><a href="#cb211-2331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2332"><a href="#cb211-2332" aria-hidden="true" tabindex="-1"></a>Suppose you have a random variable $x$ with PDF $f(x) = 25xe^{-5x} = \text{Gamma}(2,5)$ for $X&gt;0$. If you wanted to know the expected value of $h(x) = x$ could sample straight from <span class="in">`rgamma()`</span> and take the average.</span>
<span id="cb211-2333"><a href="#cb211-2333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2336"><a href="#cb211-2336" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2337"><a href="#cb211-2337" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">rgamma</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">5</span>))</span>
<span id="cb211-2338"><a href="#cb211-2338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2339"><a href="#cb211-2339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2340"><a href="#cb211-2340" aria-hidden="true" tabindex="-1"></a>Great, if <span class="in">`rgamma()`</span> wasn't an option, how would you evaluate $\int_0^\infty x f(x)dx = \int_0^\infty 25x^2e^{-5x}dx$? Let $g(x) = 5e^{-5x}$. Then $E(h(x)) = \frac{1}{n}\sum_i\left<span class="co">[</span><span class="ot">x \frac{25xe^{-5x}}{5e^{-5x}} \right</span><span class="co">]</span> = \frac{1}{n}\sum_i 5x_i^2$</span>
<span id="cb211-2341"><a href="#cb211-2341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2344"><a href="#cb211-2344" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2345"><a href="#cb211-2345" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb211-2346"><a href="#cb211-2346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2347"><a href="#cb211-2347" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">rexp</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">5</span>, <span class="dv">5</span>)</span>
<span id="cb211-2348"><a href="#cb211-2348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2349"><a href="#cb211-2349" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="dv">5</span><span class="sc">*</span>g<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb211-2350"><a href="#cb211-2350" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2351"><a href="#cb211-2351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2352"><a href="#cb211-2352" aria-hidden="true" tabindex="-1"></a>Great, if <span class="in">`rgamma()`</span> wasn't an option, how would you evaluate $\int_0^\infty x f(x)dx = \int_0^\infty 25x^2e^{-5x}dx$? Let $g(x) = 5e^{-5x}$. Then $E(h(x)) = \frac{1}{n}\sum_i\left<span class="co">[</span><span class="ot">x \frac{25xe^{-5x}}{5e^{-5x}} \right</span><span class="co">]</span> = \frac{1}{n}\sum_i 5x_i^2$</span>
<span id="cb211-2353"><a href="#cb211-2353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2356"><a href="#cb211-2356" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2357"><a href="#cb211-2357" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb211-2358"><a href="#cb211-2358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2359"><a href="#cb211-2359" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">rexp</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">5</span>, <span class="dv">5</span>)</span>
<span id="cb211-2360"><a href="#cb211-2360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2361"><a href="#cb211-2361" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="dv">5</span><span class="sc">*</span>g<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb211-2362"><a href="#cb211-2362" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2363"><a href="#cb211-2363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2364"><a href="#cb211-2364" aria-hidden="true" tabindex="-1"></a>Let's try another one. Suppose you want to empirically estimate $\int_0^1 x^5(1-x)^5dx$. First, use the simple Monte Carlo method to estimate the integral.</span>
<span id="cb211-2365"><a href="#cb211-2365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2368"><a href="#cb211-2368" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2369"><a href="#cb211-2369" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb211-2370"><a href="#cb211-2370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2371"><a href="#cb211-2371" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {x<span class="sc">^</span><span class="dv">5</span><span class="sc">*</span>(<span class="dv">1</span> <span class="sc">-</span> x)<span class="sc">^</span><span class="dv">5</span>}</span>
<span id="cb211-2372"><a href="#cb211-2372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2373"><a href="#cb211-2373" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the defined area. Plot f(x) over the range of x to set the appropriate limits.</span></span>
<span id="cb211-2374"><a href="#cb211-2374" aria-hidden="true" tabindex="-1"></a>x_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb211-2375"><a href="#cb211-2375" aria-hidden="true" tabindex="-1"></a>y_lim <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span><span class="sc">^-</span><span class="dv">3</span>)</span>
<span id="cb211-2376"><a href="#cb211-2376" aria-hidden="true" tabindex="-1"></a>D <span class="ot">&lt;-</span> (x_lim[<span class="dv">2</span>] <span class="sc">-</span> x_lim[<span class="dv">1</span>]) <span class="sc">*</span> (y_lim[<span class="dv">2</span>] <span class="sc">-</span> y_lim[<span class="dv">1</span>])</span>
<span id="cb211-2377"><a href="#cb211-2377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2378"><a href="#cb211-2378" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample from D.</span></span>
<span id="cb211-2379"><a href="#cb211-2379" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span></span>
<span id="cb211-2380"><a href="#cb211-2380" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, x_lim[<span class="dv">1</span>], x_lim[<span class="dv">2</span>])</span>
<span id="cb211-2381"><a href="#cb211-2381" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, y_lim[<span class="dv">1</span>], y_lim[<span class="dv">2</span>])</span>
<span id="cb211-2382"><a href="#cb211-2382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2383"><a href="#cb211-2383" aria-hidden="true" tabindex="-1"></a><span class="co"># Area is percent of points under the curve</span></span>
<span id="cb211-2384"><a href="#cb211-2384" aria-hidden="true" tabindex="-1"></a>is_under <span class="ot">&lt;-</span> y <span class="sc">&lt;=</span> <span class="fu">f</span>(x)</span>
<span id="cb211-2385"><a href="#cb211-2385" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">sum</span>(is_under)</span>
<span id="cb211-2386"><a href="#cb211-2386" aria-hidden="true" tabindex="-1"></a>(A_hat <span class="ot">&lt;-</span> z <span class="sc">/</span> n <span class="sc">*</span> D)</span>
<span id="cb211-2387"><a href="#cb211-2387" aria-hidden="true" tabindex="-1"></a>(se <span class="ot">&lt;-</span> D <span class="sc">/</span> <span class="fu">sqrt</span>(n) <span class="sc">*</span> <span class="fu">sqrt</span>(z<span class="sc">/</span>n <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> z<span class="sc">/</span>n)))</span>
<span id="cb211-2388"><a href="#cb211-2388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2389"><a href="#cb211-2389" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(x, <span class="at">f =</span> <span class="fu">f</span>(x), <span class="at">rand_y =</span> y, is_under) <span class="sc">%&gt;%</span> </span>
<span id="cb211-2390"><a href="#cb211-2390" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span> </span>
<span id="cb211-2391"><a href="#cb211-2391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="fu">aes</span>(<span class="at">y =</span> f)) <span class="sc">+</span> </span>
<span id="cb211-2392"><a href="#cb211-2392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> rand_y, <span class="at">color =</span> is_under), <span class="at">show.legend =</span> <span class="cn">FALSE</span>)</span>
<span id="cb211-2393"><a href="#cb211-2393" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2394"><a href="#cb211-2394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2395"><a href="#cb211-2395" aria-hidden="true" tabindex="-1"></a>Now let's do it with direct sampling. $x^5(1-x)^5$ is almost like the beta function. $\int_0^1 x^5(1-x)^5dx = \int_0^1 \frac{x}{1260} 1260x^4(1-x)^5dx = \int_0^1 \frac{x}{1250} g(x)dx$.</span>
<span id="cb211-2396"><a href="#cb211-2396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2399"><a href="#cb211-2399" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2400"><a href="#cb211-2400" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb211-2401"><a href="#cb211-2401" aria-hidden="true" tabindex="-1"></a>(A_hat <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">rbeta</span>(n, <span class="dv">5</span>, <span class="dv">6</span>) <span class="sc">/</span> <span class="dv">1260</span>))</span>
<span id="cb211-2402"><a href="#cb211-2402" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2403"><a href="#cb211-2403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2404"><a href="#cb211-2404" aria-hidden="true" tabindex="-1"></a>Now let's do it with importance sampling. Just define $\int_0^1 x^5(1-x)^5dx = \int_0^1 x^5(1-x)^5g(x)dx$ where $g(x) = 1$ is the uniform pdf.</span>
<span id="cb211-2405"><a href="#cb211-2405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2408"><a href="#cb211-2408" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2409"><a href="#cb211-2409" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb211-2410"><a href="#cb211-2410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2411"><a href="#cb211-2411" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb211-2412"><a href="#cb211-2412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2413"><a href="#cb211-2413" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(g<span class="sc">^</span><span class="dv">5</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>g)<span class="sc">^</span><span class="dv">5</span>)</span>
<span id="cb211-2414"><a href="#cb211-2414" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2415"><a href="#cb211-2415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2416"><a href="#cb211-2416" aria-hidden="true" tabindex="-1"></a><span class="fu">## Metropolis-Hastings</span></span>
<span id="cb211-2417"><a href="#cb211-2417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2418"><a href="#cb211-2418" aria-hidden="true" tabindex="-1"></a>For any model with likelihood $f(y|\theta)$ and prior $f(\theta)$, you can use the Metropolis-Hastings step to estimate $\theta$. Start with an initial $\theta = \theta_0$. Propose a new $\theta'$ from a proposed distribution $q(\theta'|\theta)$ and evaluate the acceptance ratio, </span>
<span id="cb211-2419"><a href="#cb211-2419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2420"><a href="#cb211-2420" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-2421"><a href="#cb211-2421" aria-hidden="true" tabindex="-1"></a>R = \frac{f(y|\theta')f(\theta')}{f(y|\theta)f(\theta)} \frac{q(\theta|\theta')}{q(\theta'|\theta)}</span>
<span id="cb211-2422"><a href="#cb211-2422" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-2423"><a href="#cb211-2423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2424"><a href="#cb211-2424" aria-hidden="true" tabindex="-1"></a>Accept the new value with probability $\min(R, 1)$, then repeat until convergence. Notice that if the proposed distribution is symmetric, then the second term drops out and $R$ is just the ratio of posterior distributions. The symmetric version is called *Metrolopolis* instead of *Metropolis-Hastings*.</span>
<span id="cb211-2425"><a href="#cb211-2425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2426"><a href="#cb211-2426" aria-hidden="true" tabindex="-1"></a>If $\theta \in \mathbb{R}$ then the normal is a good proposal distribution, $\theta'|\theta \sim N(\theta, \delta^{-2})$. The normal distribution is symmetric, so the Metropolis acceptance ratio will work.</span>
<span id="cb211-2427"><a href="#cb211-2427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2428"><a href="#cb211-2428" aria-hidden="true" tabindex="-1"></a>Suppose you have a normal data generating process with unknown mean $\mu$ and precision $\tau$. Your conjugate priors are $y_i \sim N(\mu, \tau)$, $\mu \sim N(\mu_0, \tau_0)$, and $\tau \sim \text{Gamma}(a, b)$. The conditional distributions are those in Eqns \@ref(eq:mu-posterior) and \@ref(eq:tau-posterior).</span>
<span id="cb211-2429"><a href="#cb211-2429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2430"><a href="#cb211-2430" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-2431"><a href="#cb211-2431" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb211-2432"><a href="#cb211-2432" aria-hidden="true" tabindex="-1"></a>\mu|y &amp; \sim N\left(\frac{n\tau\bar{y} + \tau_0\mu_0}{n\tau + \tau_0}, n\tau + \tau_0 \right) <span class="sc">\\</span></span>
<span id="cb211-2433"><a href="#cb211-2433" aria-hidden="true" tabindex="-1"></a>\tau|y &amp; \sim \text{Gamma}\left(a + n/2, b + \frac{1}{2} \sum_i(y_i - \mu)^2 \right)</span>
<span id="cb211-2434"><a href="#cb211-2434" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb211-2435"><a href="#cb211-2435" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-2436"><a href="#cb211-2436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2437"><a href="#cb211-2437" aria-hidden="true" tabindex="-1"></a>Let's replace the Gibbs step for $\mu$ with the Metropolis step. Propose a new value $\mu^*$ from the normal distribution centered around the current $\mu$, $\mu' \sim N(\mu, \delta^{-2})$ and evaluate the acceptance ratio as </span>
<span id="cb211-2438"><a href="#cb211-2438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2439"><a href="#cb211-2439" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-2440"><a href="#cb211-2440" aria-hidden="true" tabindex="-1"></a>R = \frac{f(y|\mu', \tau) f(\mu'|\mu_0, \tau_0)}{f(y|\mu, \tau) f(\mu|\mu_0, \tau_0)}</span>
<span id="cb211-2441"><a href="#cb211-2441" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-2442"><a href="#cb211-2442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2443"><a href="#cb211-2443" aria-hidden="true" tabindex="-1"></a>accepting the new value with probability $\min (R, 1)$.</span>
<span id="cb211-2444"><a href="#cb211-2444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2445"><a href="#cb211-2445" aria-hidden="true" tabindex="-1"></a>Suppose your data is $n = 100$ values from a $N(\mu = 2, \tau = 1/4)$ distribution.</span>
<span id="cb211-2446"><a href="#cb211-2446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2449"><a href="#cb211-2449" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2450"><a href="#cb211-2450" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb211-2451"><a href="#cb211-2451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2452"><a href="#cb211-2452" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb211-2453"><a href="#cb211-2453" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb211-2454"><a href="#cb211-2454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2455"><a href="#cb211-2455" aria-hidden="true" tabindex="-1"></a><span class="co"># Use vague priors</span></span>
<span id="cb211-2456"><a href="#cb211-2456" aria-hidden="true" tabindex="-1"></a>mu_0 <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb211-2457"><a href="#cb211-2457" aria-hidden="true" tabindex="-1"></a>tau_0 <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">4</span>)</span>
<span id="cb211-2458"><a href="#cb211-2458" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb211-2459"><a href="#cb211-2459" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb211-2460"><a href="#cb211-2460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2461"><a href="#cb211-2461" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we go: Metropolis for mu, Gibbs for tau</span></span>
<span id="cb211-2462"><a href="#cb211-2462" aria-hidden="true" tabindex="-1"></a>ITER <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">3</span></span>
<span id="cb211-2463"><a href="#cb211-2463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2464"><a href="#cb211-2464" aria-hidden="true" tabindex="-1"></a><span class="co"># monitors</span></span>
<span id="cb211-2465"><a href="#cb211-2465" aria-hidden="true" tabindex="-1"></a>mon_mu <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb211-2466"><a href="#cb211-2466" aria-hidden="true" tabindex="-1"></a>mon_tau <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ITER)</span>
<span id="cb211-2467"><a href="#cb211-2467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2468"><a href="#cb211-2468" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize the algorithm</span></span>
<span id="cb211-2469"><a href="#cb211-2469" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">mean</span>(y)</span>
<span id="cb211-2470"><a href="#cb211-2470" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">var</span>(y)</span>
<span id="cb211-2471"><a href="#cb211-2471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2472"><a href="#cb211-2472" aria-hidden="true" tabindex="-1"></a><span class="co"># width of proposal distribution for mu</span></span>
<span id="cb211-2473"><a href="#cb211-2473" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb211-2474"><a href="#cb211-2474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2475"><a href="#cb211-2475" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>ITER) {</span>
<span id="cb211-2476"><a href="#cb211-2476" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mu step.</span></span>
<span id="cb211-2477"><a href="#cb211-2477" aria-hidden="true" tabindex="-1"></a>  mu_new <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mu, <span class="at">sd =</span> delta)</span>
<span id="cb211-2478"><a href="#cb211-2478" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb211-2479"><a href="#cb211-2479" aria-hidden="true" tabindex="-1"></a>  <span class="co"># log of the acceptance ratio</span></span>
<span id="cb211-2480"><a href="#cb211-2480" aria-hidden="true" tabindex="-1"></a>  logR <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">dnorm</span>(y, mu_new, <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(tau), <span class="at">log =</span> T)) <span class="sc">-</span> <span class="co"># new likelihood</span></span>
<span id="cb211-2481"><a href="#cb211-2481" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sum</span>(<span class="fu">dnorm</span>(y, mu    , <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(tau), <span class="at">log =</span> T)) <span class="sc">+</span> <span class="co"># old likelihood</span></span>
<span id="cb211-2482"><a href="#cb211-2482" aria-hidden="true" tabindex="-1"></a>          <span class="fu">dnorm</span>(mu_new,mu_0, <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(tau_0), <span class="at">log =</span> T)  <span class="sc">-</span> <span class="co"># new prior</span></span>
<span id="cb211-2483"><a href="#cb211-2483" aria-hidden="true" tabindex="-1"></a>          <span class="fu">dnorm</span>(mu    ,mu_0, <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(tau_0), <span class="at">log =</span> T)    <span class="co"># old prior</span></span>
<span id="cb211-2484"><a href="#cb211-2484" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb211-2485"><a href="#cb211-2485" aria-hidden="true" tabindex="-1"></a>  <span class="co"># accept with probability min(R,1)</span></span>
<span id="cb211-2486"><a href="#cb211-2486" aria-hidden="true" tabindex="-1"></a>  <span class="co"># draw U from uniform(0,1) and accept if logU &lt; logR</span></span>
<span id="cb211-2487"><a href="#cb211-2487" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note: larger delta results in algorithm proposes candidates outside the main</span></span>
<span id="cb211-2488"><a href="#cb211-2488" aria-hidden="true" tabindex="-1"></a>  <span class="co"># support of the posterior and acceptance rate will be low.</span></span>
<span id="cb211-2489"><a href="#cb211-2489" aria-hidden="true" tabindex="-1"></a>  logU <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb211-2490"><a href="#cb211-2490" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(logU <span class="sc">&lt;</span> logR){mu <span class="ot">&lt;-</span> mu_new}</span>
<span id="cb211-2491"><a href="#cb211-2491" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb211-2492"><a href="#cb211-2492" aria-hidden="true" tabindex="-1"></a>  <span class="do">#### STEP for TAU</span></span>
<span id="cb211-2493"><a href="#cb211-2493" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, a <span class="sc">+</span> n <span class="sc">/</span> <span class="dv">2</span>, b <span class="sc">+</span> .<span class="dv">5</span> <span class="sc">*</span> <span class="fu">sum</span>((y <span class="sc">-</span> mu)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb211-2494"><a href="#cb211-2494" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb211-2495"><a href="#cb211-2495" aria-hidden="true" tabindex="-1"></a>  <span class="do">#### UPDATING THE MONITORS:</span></span>
<span id="cb211-2496"><a href="#cb211-2496" aria-hidden="true" tabindex="-1"></a>  mon_mu[i] <span class="ot">&lt;-</span> mu</span>
<span id="cb211-2497"><a href="#cb211-2497" aria-hidden="true" tabindex="-1"></a>  mon_tau[i] <span class="ot">&lt;-</span> tau</span>
<span id="cb211-2498"><a href="#cb211-2498" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb211-2499"><a href="#cb211-2499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2500"><a href="#cb211-2500" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that if you set delta to .01, there was a lot of autocorrelation in mu</span></span>
<span id="cb211-2501"><a href="#cb211-2501" aria-hidden="true" tabindex="-1"></a><span class="co"># and it did not converge. But if you set it to .1 it does a little better.</span></span>
<span id="cb211-2502"><a href="#cb211-2502" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(mon_mu, <span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span>ITER) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> mon_mu)) <span class="sc">+</span> <span class="fu">geom_point</span>()</span>
<span id="cb211-2503"><a href="#cb211-2503" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2504"><a href="#cb211-2504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2505"><a href="#cb211-2505" aria-hidden="true" tabindex="-1"></a>Suppose a study estimates the sex-ratio of bird chicks. From prior studies, you settle on a beta prior $p \sim \text{Beta}(20, 20)$ that a chick is female. From a batch of eggs, 5 are male and 1 is female. The number of expected females is $x|p \sim \text{Bin}(n, p)$. Using the simple beta-binomial model, the posterior mean for $p = \frac{(a + y)}{(a+y) + (b + (n - y))} = .456$.</span>
<span id="cb211-2506"><a href="#cb211-2506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2509"><a href="#cb211-2509" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2510"><a href="#cb211-2510" aria-hidden="true" tabindex="-1"></a>(<span class="dv">20</span> <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">/</span> ((<span class="dv">20</span> <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">+</span> (<span class="dv">20</span> <span class="sc">+</span> (<span class="dv">6</span> <span class="sc">-</span> <span class="dv">1</span>)))</span>
<span id="cb211-2511"><a href="#cb211-2511" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2512"><a href="#cb211-2512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2513"><a href="#cb211-2513" aria-hidden="true" tabindex="-1"></a>In this case, the $n$ is also uncertain since some eggs may have been lost. From prior studies you expect $n \sim \text{Pois}(12)$. Use MCMC to estimate posterior distributions of $p$ and $n$.</span>
<span id="cb211-2514"><a href="#cb211-2514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2515"><a href="#cb211-2515" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-2516"><a href="#cb211-2516" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(12345)</span></span>
<span id="cb211-2517"><a href="#cb211-2517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2518"><a href="#cb211-2518" aria-hidden="true" tabindex="-1"></a><span class="in"># Data: 5 males and 1 female</span></span>
<span id="cb211-2519"><a href="#cb211-2519" aria-hidden="true" tabindex="-1"></a><span class="in">y &lt;- 1</span></span>
<span id="cb211-2520"><a href="#cb211-2520" aria-hidden="true" tabindex="-1"></a><span class="in">n &lt;- 6</span></span>
<span id="cb211-2521"><a href="#cb211-2521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2522"><a href="#cb211-2522" aria-hidden="true" tabindex="-1"></a><span class="in"># Prior distributions: beta(20, 20) for p; derived for n.</span></span>
<span id="cb211-2523"><a href="#cb211-2523" aria-hidden="true" tabindex="-1"></a><span class="in">a &lt;- 20</span></span>
<span id="cb211-2524"><a href="#cb211-2524" aria-hidden="true" tabindex="-1"></a><span class="in">b &lt;- 20</span></span>
<span id="cb211-2525"><a href="#cb211-2525" aria-hidden="true" tabindex="-1"></a><span class="in">lambda &lt;- 12</span></span>
<span id="cb211-2526"><a href="#cb211-2526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2527"><a href="#cb211-2527" aria-hidden="true" tabindex="-1"></a><span class="in"># MCMC algorithm</span></span>
<span id="cb211-2528"><a href="#cb211-2528" aria-hidden="true" tabindex="-1"></a><span class="in">ITER &lt;- 10^3</span></span>
<span id="cb211-2529"><a href="#cb211-2529" aria-hidden="true" tabindex="-1"></a><span class="in">p_monitor &lt;- numeric(ITER)</span></span>
<span id="cb211-2530"><a href="#cb211-2530" aria-hidden="true" tabindex="-1"></a><span class="in">n_monitor &lt;- numeric(ITER)</span></span>
<span id="cb211-2531"><a href="#cb211-2531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2532"><a href="#cb211-2532" aria-hidden="true" tabindex="-1"></a><span class="in">for(i in 1:ITER) {</span></span>
<span id="cb211-2533"><a href="#cb211-2533" aria-hidden="true" tabindex="-1"></a><span class="in">  # Sample p.</span></span>
<span id="cb211-2534"><a href="#cb211-2534" aria-hidden="true" tabindex="-1"></a><span class="in">  p &lt;- rbeta(1, a + y, b + (n - y))</span></span>
<span id="cb211-2535"><a href="#cb211-2535" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb211-2536"><a href="#cb211-2536" aria-hidden="true" tabindex="-1"></a><span class="in">  # Sample n</span></span>
<span id="cb211-2537"><a href="#cb211-2537" aria-hidden="true" tabindex="-1"></a><span class="in">  n_vals &lt;- 6:25</span></span>
<span id="cb211-2538"><a href="#cb211-2538" aria-hidden="true" tabindex="-1"></a><span class="in">  # This distribution was derived for me.</span></span>
<span id="cb211-2539"><a href="#cb211-2539" aria-hidden="true" tabindex="-1"></a><span class="in">  n_prob &lt;- (lambda * (1 - p))^n_vals / (factorial(n_vals - 1))</span></span>
<span id="cb211-2540"><a href="#cb211-2540" aria-hidden="true" tabindex="-1"></a><span class="in">  n &lt;- sample(n_vals, size = 1, replace = TRUE, n_prob)</span></span>
<span id="cb211-2541"><a href="#cb211-2541" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb211-2542"><a href="#cb211-2542" aria-hidden="true" tabindex="-1"></a><span class="in">  # Update priors</span></span>
<span id="cb211-2543"><a href="#cb211-2543" aria-hidden="true" tabindex="-1"></a><span class="in">  p_monitor[i] &lt;- p</span></span>
<span id="cb211-2544"><a href="#cb211-2544" aria-hidden="true" tabindex="-1"></a><span class="in">  n_monitor[i] &lt;- n</span></span>
<span id="cb211-2545"><a href="#cb211-2545" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb211-2546"><a href="#cb211-2546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2547"><a href="#cb211-2547" aria-hidden="true" tabindex="-1"></a><span class="in"># Drop the first 500 observations as burn-in.</span></span>
<span id="cb211-2548"><a href="#cb211-2548" aria-hidden="true" tabindex="-1"></a><span class="in"># Posterior mean for n</span></span>
<span id="cb211-2549"><a href="#cb211-2549" aria-hidden="true" tabindex="-1"></a><span class="in">table(n_monitor[501:ITER]) %&gt;% which.max()</span></span>
<span id="cb211-2550"><a href="#cb211-2550" aria-hidden="true" tabindex="-1"></a><span class="in">max(table(n_monitor[501:ITER])) / (ITER-501)</span></span>
<span id="cb211-2551"><a href="#cb211-2551" aria-hidden="true" tabindex="-1"></a><span class="in"># Posterior mean for p</span></span>
<span id="cb211-2552"><a href="#cb211-2552" aria-hidden="true" tabindex="-1"></a><span class="in">mean(p_monitor)</span></span>
<span id="cb211-2553"><a href="#cb211-2553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2554"><a href="#cb211-2554" aria-hidden="true" tabindex="-1"></a><span class="in"># Check for convergence.</span></span>
<span id="cb211-2555"><a href="#cb211-2555" aria-hidden="true" tabindex="-1"></a><span class="in"># p</span></span>
<span id="cb211-2556"><a href="#cb211-2556" aria-hidden="true" tabindex="-1"></a><span class="in">p1 &lt;- tibble(index = 1:ITER, p = p_monitor) %&gt;% ggplot(aes(x = index, y = p)) + geom_line()</span></span>
<span id="cb211-2557"><a href="#cb211-2557" aria-hidden="true" tabindex="-1"></a><span class="in">p2 &lt;- tibble(p = p_monitor) %&gt;% ggplot(aes(x = p)) + geom_density()</span></span>
<span id="cb211-2558"><a href="#cb211-2558" aria-hidden="true" tabindex="-1"></a><span class="in"># n</span></span>
<span id="cb211-2559"><a href="#cb211-2559" aria-hidden="true" tabindex="-1"></a><span class="in">p3 &lt;- tibble(index = 1:ITER, n = n_monitor) %&gt;% ggplot(aes(x = index, y = n)) + geom_line()</span></span>
<span id="cb211-2560"><a href="#cb211-2560" aria-hidden="true" tabindex="-1"></a><span class="in">p4 &lt;- tibble(p = n_monitor) %&gt;% ggplot(aes(x = p)) + geom_histogram(binwidth = 1)</span></span>
<span id="cb211-2561"><a href="#cb211-2561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2562"><a href="#cb211-2562" aria-hidden="true" tabindex="-1"></a><span class="in">(p1+p2)/(p3+p4)</span></span>
<span id="cb211-2563"><a href="#cb211-2563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2564"><a href="#cb211-2564" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2565"><a href="#cb211-2565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2566"><a href="#cb211-2566" aria-hidden="true" tabindex="-1"></a><span class="fu">## Mixed Effects Linear Regression</span></span>
<span id="cb211-2567"><a href="#cb211-2567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2570"><a href="#cb211-2570" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2571"><a href="#cb211-2571" aria-hidden="true" tabindex="-1"></a>bp <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"./input/BP.csv"</span>, <span class="at">col_types =</span> <span class="fu">c</span>(<span class="st">"iicd"</span>))</span>
<span id="cb211-2572"><a href="#cb211-2572" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2573"><a href="#cb211-2573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2574"><a href="#cb211-2574" aria-hidden="true" tabindex="-1"></a>The basic mixed effects regression model is</span>
<span id="cb211-2575"><a href="#cb211-2575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2576"><a href="#cb211-2576" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-2577"><a href="#cb211-2577" aria-hidden="true" tabindex="-1"></a>\text{BP}_i = \beta_0 + \beta_1 \text{G}_i + \xi_{\text{PID}_i} + \epsilon_i</span>
<span id="cb211-2578"><a href="#cb211-2578" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb211-2579"><a href="#cb211-2579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2580"><a href="#cb211-2580" aria-hidden="true" tabindex="-1"></a>where $G_i$ is the before/after dummy. $\beta_0$ is the expected BP before the treatment, $\beta_1$ is the average population effect, $\xi_{\text{PID}_i}$ is the patient-specific deviation in BP from the population mean, and $\epsilon_i$ is random error. You can group the terms as $\text{BP}_i = (\beta_0 + \xi_{\text{PID}_i}) + \beta_1 \text{G}_i + \epsilon_i$. You can rewrite this in Bayesian form, $\text{BP}_i | \mu_i, \tau_i \sim N(\mu_i, \tau_i)$ where $\mu_i = \beta_0 + \xi_{\text{PID}_i} + \beta_1 \text{G}_i$.</span>
<span id="cb211-2581"><a href="#cb211-2581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2582"><a href="#cb211-2582" aria-hidden="true" tabindex="-1"></a>In abscense of other information, use vague priors with large variance, $\beta_0, \beta_1 \sim N(0, 10^{-8})$, and $\tau \sim \text{Gamma}(a,b)$ with $a=.01$ and $b = .01$. What about $\xi$? The deviation can be any value, positive or negative, so go with a normal distribution with zero expected value, $\xi_j \sim N(0, \tau_\xi)$ where $j$ is the patient id with $\tau_\xi \sim \text{Gamma}(a_\xi, b_\xi)$. </span>
<span id="cb211-2583"><a href="#cb211-2583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2584"><a href="#cb211-2584" aria-hidden="true" tabindex="-1"></a><span class="in">```{r warning=FALSE, message=FALSE}</span></span>
<span id="cb211-2585"><a href="#cb211-2585" aria-hidden="true" tabindex="-1"></a><span class="in">library(MCMCglmm)</span></span>
<span id="cb211-2586"><a href="#cb211-2586" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2587"><a href="#cb211-2587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2590"><a href="#cb211-2590" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2591"><a href="#cb211-2591" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">MCMCglmm</span>(BP <span class="sc">~</span> Group, <span class="at">random =</span> <span class="sc">~</span>PID, <span class="at">data =</span> bp, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb211-2592"><a href="#cb211-2592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2593"><a href="#cb211-2593" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m1)</span>
<span id="cb211-2594"><a href="#cb211-2594" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2595"><a href="#cb211-2595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2596"><a href="#cb211-2596" aria-hidden="true" tabindex="-1"></a>The posterior mean estimated difference in the blood pressure is 2.25 mmHg higher before the treatment than after (95% CI 1.642, 2.917). The pMCMC is not really a p-value (see documentation). Instead, you can get the posterior probability that $\beta_1 &gt; 0$.</span>
<span id="cb211-2597"><a href="#cb211-2597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2600"><a href="#cb211-2600" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2601"><a href="#cb211-2601" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(m1<span class="sc">$</span>Sol[, <span class="dv">2</span>] <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb211-2602"><a href="#cb211-2602" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2603"><a href="#cb211-2603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2604"><a href="#cb211-2604" aria-hidden="true" tabindex="-1"></a>You can report *The treatment was estimated to lower the blood pressure by an average 2.25 mmHg, 95%CI: (1.642, 2.917), P&gt;0.999.*</span>
<span id="cb211-2605"><a href="#cb211-2605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2606"><a href="#cb211-2606" aria-hidden="true" tabindex="-1"></a>Convergence diagnostics:</span>
<span id="cb211-2607"><a href="#cb211-2607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2610"><a href="#cb211-2610" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2611"><a href="#cb211-2611" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m1<span class="sc">$</span>Sol)</span>
<span id="cb211-2612"><a href="#cb211-2612" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2613"><a href="#cb211-2613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2614"><a href="#cb211-2614" aria-hidden="true" tabindex="-1"></a>The random effects $\xi_{PID}$ are usually not of interest and not retained. This much was a sloppy, out-of-the-box, fit. You should be explicit about priors, iterations, burn-in, etc.</span>
<span id="cb211-2615"><a href="#cb211-2615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2618"><a href="#cb211-2618" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2619"><a href="#cb211-2619" aria-hidden="true" tabindex="-1"></a>prior<span class="ot">&lt;-</span><span class="fu">list</span>(</span>
<span id="cb211-2620"><a href="#cb211-2620" aria-hidden="true" tabindex="-1"></a>      <span class="co"># mean and variance-covariance matrix for the normal prior on fixed coefficients</span></span>
<span id="cb211-2621"><a href="#cb211-2621" aria-hidden="true" tabindex="-1"></a>      <span class="at">B=</span><span class="fu">list</span>(<span class="at">mu=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="at">V=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1000</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1000</span>),<span class="dv">2</span>,<span class="dv">2</span>)),</span>
<span id="cb211-2622"><a href="#cb211-2622" aria-hidden="true" tabindex="-1"></a>      <span class="co"># and for the residual variance tau and random effect variance tau.xi</span></span>
<span id="cb211-2623"><a href="#cb211-2623" aria-hidden="true" tabindex="-1"></a>      <span class="co"># this package uses Wishart distribution (not inverse Gamma)</span></span>
<span id="cb211-2624"><a href="#cb211-2624" aria-hidden="true" tabindex="-1"></a>      <span class="at">R=</span><span class="fu">list</span>(<span class="at">V=</span><span class="dv">1</span>, <span class="at">nu=</span><span class="fl">0.002</span>), <span class="at">G=</span><span class="fu">list</span>(<span class="at">G1=</span><span class="fu">list</span>(<span class="at">V=</span><span class="dv">1</span>, <span class="at">nu=</span><span class="fl">0.002</span>)))</span>
<span id="cb211-2625"><a href="#cb211-2625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2626"><a href="#cb211-2626" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">MCMCglmm</span>(BP <span class="sc">~</span> Group, <span class="at">random=</span><span class="sc">~</span>PID, <span class="at">data=</span>bp, <span class="at">verbose=</span>F,</span>
<span id="cb211-2627"><a href="#cb211-2627" aria-hidden="true" tabindex="-1"></a>               <span class="at">nitt=</span><span class="dv">15000</span>, <span class="at">thin =</span> <span class="dv">10</span>, <span class="at">burnin=</span><span class="dv">5000</span>, <span class="co"># iterations, thinning and burn-in</span></span>
<span id="cb211-2628"><a href="#cb211-2628" aria-hidden="true" tabindex="-1"></a>               <span class="at">pr=</span><span class="cn">TRUE</span>, <span class="co"># save random effects</span></span>
<span id="cb211-2629"><a href="#cb211-2629" aria-hidden="true" tabindex="-1"></a>               <span class="at">DIC=</span><span class="cn">TRUE</span>, <span class="co"># evaluate the DIC</span></span>
<span id="cb211-2630"><a href="#cb211-2630" aria-hidden="true" tabindex="-1"></a>               <span class="at">prior=</span>prior</span>
<span id="cb211-2631"><a href="#cb211-2631" aria-hidden="true" tabindex="-1"></a>               )</span>
<span id="cb211-2632"><a href="#cb211-2632" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2633"><a href="#cb211-2633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2634"><a href="#cb211-2634" aria-hidden="true" tabindex="-1"></a>You can see the random effects now.</span>
<span id="cb211-2635"><a href="#cb211-2635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2638"><a href="#cb211-2638" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2639"><a href="#cb211-2639" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(m2<span class="sc">$</span>Sol)</span>
<span id="cb211-2640"><a href="#cb211-2640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2641"><a href="#cb211-2641" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb211-2642"><a href="#cb211-2642" aria-hidden="true" tabindex="-1"></a>  <span class="at">PID =</span> <span class="fu">factor</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>),</span>
<span id="cb211-2643"><a href="#cb211-2643" aria-hidden="true" tabindex="-1"></a>  <span class="at">xi_mean =</span> <span class="fu">apply</span>(m2<span class="sc">$</span>Sol[, <span class="dv">3</span><span class="sc">:</span><span class="dv">12</span>], <span class="dv">2</span>, mean),</span>
<span id="cb211-2644"><a href="#cb211-2644" aria-hidden="true" tabindex="-1"></a>  <span class="at">xi_lci =</span> <span class="fu">apply</span>(m2<span class="sc">$</span>Sol[,<span class="dv">3</span><span class="sc">:</span><span class="dv">12</span>], <span class="dv">2</span>, quantile, .<span class="dv">025</span>),</span>
<span id="cb211-2645"><a href="#cb211-2645" aria-hidden="true" tabindex="-1"></a>  <span class="at">xi_uci =</span> <span class="fu">apply</span>(m2<span class="sc">$</span>Sol[,<span class="dv">3</span><span class="sc">:</span><span class="dv">12</span>], <span class="dv">2</span>, quantile, .<span class="dv">975</span>)</span>
<span id="cb211-2646"><a href="#cb211-2646" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb211-2647"><a href="#cb211-2647" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> PID)) <span class="sc">+</span></span>
<span id="cb211-2648"><a href="#cb211-2648" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">y =</span> xi_lci, <span class="at">yend =</span> xi_uci, <span class="at">xend =</span> PID)) <span class="sc">+</span></span>
<span id="cb211-2649"><a href="#cb211-2649" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> xi_mean)) <span class="sc">+</span></span>
<span id="cb211-2650"><a href="#cb211-2650" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="fu">aes</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">0</span>), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb211-2651"><a href="#cb211-2651" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">str_wrap</span>(</span>
<span id="cb211-2652"><a href="#cb211-2652" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Patient-specific posterior means and credible intervals for deviations in BP from population mean"</span>,</span>
<span id="cb211-2653"><a href="#cb211-2653" aria-hidden="true" tabindex="-1"></a>    <span class="dv">80</span>)</span>
<span id="cb211-2654"><a href="#cb211-2654" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb211-2655"><a href="#cb211-2655" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2656"><a href="#cb211-2656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2657"><a href="#cb211-2657" aria-hidden="true" tabindex="-1"></a>You might now ask how certain we are that participant 2 had a lower BP than participant 4, $P(\xi_2 &lt; \xi_4 | \text{data})$?</span>
<span id="cb211-2658"><a href="#cb211-2658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2661"><a href="#cb211-2661" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2662"><a href="#cb211-2662" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(m2<span class="sc">$</span>Sol[, <span class="dv">2</span><span class="sc">+</span><span class="dv">2</span>] <span class="sc">&lt;</span> m2<span class="sc">$</span>Sol[, <span class="dv">2</span><span class="sc">+</span><span class="dv">4</span>])</span>
<span id="cb211-2663"><a href="#cb211-2663" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2664"><a href="#cb211-2664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2665"><a href="#cb211-2665" aria-hidden="true" tabindex="-1"></a>It's nearly certain. How about your certainty that participant 2 is the lowest?</span>
<span id="cb211-2666"><a href="#cb211-2666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2669"><a href="#cb211-2669" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2670"><a href="#cb211-2670" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove first 2 cols. Apply which.min() to rows. How often is col 2 the min?</span></span>
<span id="cb211-2671"><a href="#cb211-2671" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">apply</span>(m2<span class="sc">$</span>Sol[, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)], <span class="dv">1</span>, which.min) <span class="sc">==</span> <span class="dv">2</span>)</span>
<span id="cb211-2672"><a href="#cb211-2672" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2673"><a href="#cb211-2673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2674"><a href="#cb211-2674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2675"><a href="#cb211-2675" aria-hidden="true" tabindex="-1"></a><span class="fu">## Appendix: Bayes Factors</span></span>
<span id="cb211-2676"><a href="#cb211-2676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2677"><a href="#cb211-2677" aria-hidden="true" tabindex="-1"></a>The Bayes Factor (BF) is a measure of the relative evidence of one model over another. Take another look at Bayes' formula:</span>
<span id="cb211-2678"><a href="#cb211-2678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2679"><a href="#cb211-2679" aria-hidden="true" tabindex="-1"></a>$$P(\theta|D) = \frac{P(D|\theta)P(\theta)}{P(D)}.$$</span>
<span id="cb211-2680"><a href="#cb211-2680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2681"><a href="#cb211-2681" aria-hidden="true" tabindex="-1"></a>Suppose you want to compare how two models explain and observed data outcome, $D$. Model $M_1:f_1(D|\theta_1)$ says the observed data $D$ was produced by a generative model with pdf $f_1$ parameterized by $\theta_2$. Model $M_2:f_2(D|\theta_2)$ says it was produced by a generative model with pdf $f_2$ parameterized by $\theta_2$. In each model you specify a prior probability distribution for the parameter</span>
<span id="cb211-2682"><a href="#cb211-2682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2683"><a href="#cb211-2683" aria-hidden="true" tabindex="-1"></a>If you take the ratio of the posterior probabilities, the posterior odds, the $P(D)$ terms cancel and you have</span>
<span id="cb211-2684"><a href="#cb211-2684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2685"><a href="#cb211-2685" aria-hidden="true" tabindex="-1"></a>$$\frac{P(\theta_1|D)}{P(\theta_2|D)} = \frac{P(D|\theta_1)}{P(D|\theta_2)} \cdot \frac{P(\theta_1)}{P(\theta_2)}$$</span>
<span id="cb211-2686"><a href="#cb211-2686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2687"><a href="#cb211-2687" aria-hidden="true" tabindex="-1"></a>The posterior odds equals the ratio of the likelihoods multiplied by the prior odds. That likelihood ratio is the Bayes Factor (BF). Rearranging, BF is the odds ratio of the posterior and prior odds.</span>
<span id="cb211-2688"><a href="#cb211-2688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2689"><a href="#cb211-2689" aria-hidden="true" tabindex="-1"></a>$$BF = \frac{P(D|\theta_1)}{P(D|\theta_2)} = \mathrm{\frac{Posterior Odds}{Prior Odds}}$$</span>
<span id="cb211-2690"><a href="#cb211-2690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2691"><a href="#cb211-2691" aria-hidden="true" tabindex="-1"></a>Return to the example of observing $D$ = 7 ones and 3 zeros. You can compare an hypothesized $\theta$ of .5 to a completely agnostic model where $\theta$ is uniform over <span class="co">[</span><span class="ot">0, 1</span><span class="co">]</span>. The likelihood of observing $D$ when $\theta$ = .5 is $P(D|\theta_1) = 5^7(1-.5)^3$ = <span class="in">`r scales::number(dbinom(7, 10, .5), accuracy = .001)`</span>. The likelihood of observing $D$ where $\theta$ is uniform on <span class="co">[</span><span class="ot">0, 1</span><span class="co">]</span> is $P(D|\theta_2) = \int_0^1 \binom{10}{3}q^7(1-q)^3dq$</span>
<span id="cb211-2692"><a href="#cb211-2692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2695"><a href="#cb211-2695" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2696"><a href="#cb211-2696" aria-hidden="true" tabindex="-1"></a>.<span class="dv">5</span><span class="sc">^</span><span class="dv">1</span> <span class="sc">*</span> .<span class="dv">5</span><span class="sc">^</span><span class="dv">1</span></span>
<span id="cb211-2697"><a href="#cb211-2697" aria-hidden="true" tabindex="-1"></a><span class="fu">dbinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, .<span class="dv">5</span>)</span>
<span id="cb211-2698"><a href="#cb211-2698" aria-hidden="true" tabindex="-1"></a><span class="fu">dbinom</span>(<span class="dv">11</span>, <span class="dv">11</span>, .<span class="dv">5</span>)</span>
<span id="cb211-2699"><a href="#cb211-2699" aria-hidden="true" tabindex="-1"></a><span class="fu">beta</span>(<span class="dv">11</span>, <span class="dv">11</span>)</span>
<span id="cb211-2700"><a href="#cb211-2700" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2701"><a href="#cb211-2701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2702"><a href="#cb211-2702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2703"><a href="#cb211-2703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2704"><a href="#cb211-2704" aria-hidden="true" tabindex="-1"></a>with a uniform Beta(1, 1) prior (i.e., complete agnosticism). </span>
<span id="cb211-2705"><a href="#cb211-2705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2706"><a href="#cb211-2706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2707"><a href="#cb211-2707" aria-hidden="true" tabindex="-1"></a>The Bayes factor at $\theta$ = .7 quantifies how much the odds of H0: $\theta$ = .7 over H1: $\hat{\theta}$ = .7.</span>
<span id="cb211-2708"><a href="#cb211-2708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2711"><a href="#cb211-2711" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb211-2712"><a href="#cb211-2712" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, alpha, beta) {</span>
<span id="cb211-2713"><a href="#cb211-2713" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span> <span class="sc">/</span> <span class="fu">beta</span>(alpha, beta)) <span class="sc">*</span> theta<span class="sc">^</span>(alpha<span class="dv">-1</span>) <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>theta)<span class="sc">^</span>(beta<span class="dv">-1</span>)</span>
<span id="cb211-2714"><a href="#cb211-2714" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb211-2715"><a href="#cb211-2715" aria-hidden="true" tabindex="-1"></a>posterior <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, alpha, beta, a, b) {</span>
<span id="cb211-2716"><a href="#cb211-2716" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">1</span> <span class="sc">/</span> <span class="fu">beta</span>(alpha <span class="sc">+</span> a, beta <span class="sc">+</span> b)) <span class="sc">*</span> theta<span class="sc">^</span>(alpha<span class="dv">-1</span><span class="sc">+</span>a) <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>theta)<span class="sc">^</span>(beta<span class="dv">-1</span><span class="sc">+</span>b)</span>
<span id="cb211-2717"><a href="#cb211-2717" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb211-2718"><a href="#cb211-2718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2719"><a href="#cb211-2719" aria-hidden="true" tabindex="-1"></a><span class="fu">prior</span>(.<span class="dv">5</span>, <span class="dv">115</span>, <span class="dv">85</span>) </span>
<span id="cb211-2720"><a href="#cb211-2720" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior</span>(.<span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">10</span>)</span>
<span id="cb211-2721"><a href="#cb211-2721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2722"><a href="#cb211-2722" aria-hidden="true" tabindex="-1"></a><span class="fu">posterior</span>(.<span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">10</span>) <span class="sc">/</span> <span class="fu">prior</span>(.<span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">1</span>) </span>
<span id="cb211-2723"><a href="#cb211-2723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2724"><a href="#cb211-2724" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">/</span> <span class="fu">beta</span>(<span class="dv">115</span>, <span class="dv">85</span>)</span>
<span id="cb211-2725"><a href="#cb211-2725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2726"><a href="#cb211-2726" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior Distribution </span></span>
<span id="cb211-2727"><a href="#cb211-2727" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">/</span><span class="fu">beta</span>(<span class="dv">1</span><span class="sc">+</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">+</span><span class="dv">10</span>) <span class="sc">*</span> .<span class="dv">5</span><span class="sc">^</span>(<span class="dv">1-1</span><span class="sc">+</span><span class="dv">10</span>) <span class="sc">*</span> (<span class="dv">1</span><span class="fl">-.5</span>)<span class="sc">^</span>(<span class="dv">1-1</span><span class="sc">+</span><span class="dv">10</span>)</span>
<span id="cb211-2728"><a href="#cb211-2728" aria-hidden="true" tabindex="-1"></a><span class="fu">dbeta</span>(.<span class="dv">5</span>, <span class="dv">11</span>, <span class="dv">11</span>)</span>
<span id="cb211-2729"><a href="#cb211-2729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2730"><a href="#cb211-2730" aria-hidden="true" tabindex="-1"></a><span class="co"># Prior Beta Distributions</span></span>
<span id="cb211-2731"><a href="#cb211-2731" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">/</span><span class="fu">beta</span>(<span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">*</span> .<span class="dv">5</span><span class="sc">^</span>(<span class="dv">1-1</span>) <span class="sc">*</span> (<span class="dv">1</span><span class="fl">-.5</span>)<span class="sc">^</span>(<span class="dv">1-1</span>)</span>
<span id="cb211-2732"><a href="#cb211-2732" aria-hidden="true" tabindex="-1"></a><span class="fu">dbeta</span>(.<span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb211-2733"><a href="#cb211-2733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2734"><a href="#cb211-2734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2735"><a href="#cb211-2735" aria-hidden="true" tabindex="-1"></a><span class="fu">dbeta</span>(.<span class="dv">5</span>, <span class="dv">115</span>, <span class="dv">85</span>)</span>
<span id="cb211-2736"><a href="#cb211-2736" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2737"><a href="#cb211-2737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2738"><a href="#cb211-2738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2739"><a href="#cb211-2739" aria-hidden="true" tabindex="-1"></a>The Bayes factor measures how much your prior belief is altered by the evidence. It is the ratio of the likelihoods at some hypothesized value before and after observing the data. In this case, our confidence increased by a factor of...</span>
<span id="cb211-2740"><a href="#cb211-2740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2741"><a href="#cb211-2741" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collapse=TRUE}</span></span>
<span id="cb211-2742"><a href="#cb211-2742" aria-hidden="true" tabindex="-1"></a><span class="in">theta &lt;- 0.5</span></span>
<span id="cb211-2743"><a href="#cb211-2743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2744"><a href="#cb211-2744" aria-hidden="true" tabindex="-1"></a><span class="in">alpha &lt;- 1</span></span>
<span id="cb211-2745"><a href="#cb211-2745" aria-hidden="true" tabindex="-1"></a><span class="in">beta &lt;- 1</span></span>
<span id="cb211-2746"><a href="#cb211-2746" aria-hidden="true" tabindex="-1"></a><span class="in">a &lt;- 10</span></span>
<span id="cb211-2747"><a href="#cb211-2747" aria-hidden="true" tabindex="-1"></a><span class="in">b &lt;- 10</span></span>
<span id="cb211-2748"><a href="#cb211-2748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2749"><a href="#cb211-2749" aria-hidden="true" tabindex="-1"></a><span class="in">(prior_likelihood &lt;- (1 / beta(alpha, beta)) * theta^(alpha-1) * (1-theta)^(beta-1))</span></span>
<span id="cb211-2750"><a href="#cb211-2750" aria-hidden="true" tabindex="-1"></a><span class="in">(posterior_likelihood &lt;- (1 / beta(alpha + a, beta + b)) * theta^(alpha-1+a) * (1-theta)^(beta-1+b))</span></span>
<span id="cb211-2751"><a href="#cb211-2751" aria-hidden="true" tabindex="-1"></a><span class="in">(bayes_factor &lt;- posterior_likelihood / prior_likelihood)</span></span>
<span id="cb211-2752"><a href="#cb211-2752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2753"><a href="#cb211-2753" aria-hidden="true" tabindex="-1"></a><span class="in"># 3.7 on alpha = beta = 1</span></span>
<span id="cb211-2754"><a href="#cb211-2754" aria-hidden="true" tabindex="-1"></a><span class="in"># 1.91 on alpha = beta = 4</span></span>
<span id="cb211-2755"><a href="#cb211-2755" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb211-2756"><a href="#cb211-2756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2757"><a href="#cb211-2757" aria-hidden="true" tabindex="-1"></a><span class="fu">## Further Reading</span></span>
<span id="cb211-2758"><a href="#cb211-2758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-2759"><a href="#cb211-2759" aria-hidden="true" tabindex="-1"></a>Most of my notes are from the two course <span class="co">[</span><span class="ot">Bayesian Statistics Using R</span><span class="co">](https://www.edx.org/certificates/professional-certificate/ucx-bayesian-statistics-using-r)</span> certificate program instructed by Elena Moltchanova. Elena recommends two books as standard reading material for serious Bayesian students. *Bayesian Data Analysis* [@Gelman2013] is considered the definitive textbook on the topic. *Statistical rethinking: A Bayesian course with examples in R and Stan* <span class="co">[</span><span class="ot">@McElreath2020</span><span class="co">]</span> is a more friendly introduction to Bayesian statistics.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>